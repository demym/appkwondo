function refreshTkdtNew(a,b){var c=null;if(""==a.trim())if(jGara&&jGara.gara&&(c=jGara.gara.rows[0].doc),c){if(c.tkdt_id)console.log("found tkdt_id for this gara",c.tkdt_id),a=c.tkdt_id;else if(a=prompt("Inserisci id gara TKDT","44"),console.log("tkdt_garaid",a),!a)return}else if(a=prompt("Inserisci id gara TKDT","44"),console.log("tkdt_garaid",a),!a)return;console.log("tkdt_garaid",a);var d="https://www.tkdtechnology.it/index.php/welcome/",f=d+"tabulati_giorni?id="+a;tkdtnew={atleti_iscritti:[],giorni:[]};var h=rooturl+"/crossd";h=rooturl+"/crossd",$.ajax({type:"POST",url:h,data:{url:f,format:""}}).done(function(c){var d=$(c).find("#banner"),e=d.find(".bs-component");$(e).each(function(a){var b={titolo:"",tabulati:[],medagliere:[],atleti:[],enabled:!0,hasContent:!1},c=$(this).find("a"),d=c.attr("href");if("disabled"==c.attr("disabled"))d=c.text(),d=d.replace("I tabulati per questa giornata non sono ancora stati pubblicati",""),b.enabled=!1,b.titolo=d,b.hasContent=!1;else{var e=getQsFromUrl(d,"id_giornata");console.log("giornatagara",e),b.id_giornata=e,b.enabled=!0,b.titolo=c.text(),b.hasContent=!0}tkdtnew.giorni.push(b)}),console.log("tkdtnew2",tkdtnew),$(tkdtnew.giorni).each(function(a){var b=tkdtnew.giorni[a];getTkdtGiorno(b.id_giornata,b.titolo,function(b){console.log(b),tkdtnew.giorni[a]=b})}),console.log("tkdtnew3",tkdtnew),tkdt_atleti=[],$(tkdtnew.giorni).each(function(a){var b=tkdtnew.giorni[a];$(b.elenco_societa.rows).each(function(a){var c=b.elenco_societa.rows[a],d=c.atleti;$(d).each(function(a){var b=d[a];tkdt_atleti.push(b)})})}),tkdt_tabulati=[],$(tkdtnew.giorni).each(function(a){var b=tkdtnew.giorni[a];$(b.tabulati.rows).each(function(a){var c=b.tabulati.rows[a];tkdt_tabulati.push(c)})}),console.log("Iscritti Tkdt",tkdt_atleti.length),getTkdtIscritti(a,function(a){var c=tkdtnew;c.tabulati=tkdt_tabulati,c.atleti=tkdt_atleti,b&&b(tkdtnew)})})}function getTkdtIscritti(a,b){var c="https://www.tkdtechnology.it/index.php/welcome/",d=c+"elenco_iscritti?id="+a,e=rooturl+"/crossd";$.ajax({type:"POST",url:e,data:{url:d,format:""}}).done(function(a){a=a.replAll("<br>","");var c=$(a).find("#elenco-societa"),d=c.find("span,h4"),e="";$(d).each(function(a){var b=$(this),c=b.get(0).tagName;if("H4"==c&&(e=b.text().trim(),colog("h4 squadra",e)),"SPAN"==c){var d=b.find("a").text().trim(),f=b.text().trim();f=f.replace(d,"").replace("|","").trim(),colog("span atleta",d,"cat",f);var g=f.replace("kg","").trim().split(")");g.length<3&&(g=f.replace("kg","").trim().split("Dan"));var h=g[g.length-1].trim();f=f.replace("kg",""),f=f.replace(h,"").trim();var i=f.split(" - "),j=i[0].trim(),k=i[1].trim(),l=i[2].replace("kg","").split("->"),m=l[0].trim(),n=l[1].trim(),o=m.trim()+" -> "+n.trim(),p={sesso:j,cateta:k,cintura_da:m,cintura_a:n,catcintura:o,catpeso:h,nome:d,societa:e};tkdtnew.atleti_iscritti.push(p)}tkdt_atleti_iscritti=tkdtnew.atleti_iscritti}),console.log("tkdtnew",tkdtnew),b&&b(tkdtnew.atleti_iscritti)})}function getTkdtGiorno(a,b,c){if(console.log("GETTKDTGIORNO"),!a){var d=$("#page_tkdtnew_giorno");a=d.find("input:hidden#idgiornata").val(),b=d.find("input:hidden#titolo").val()}var e="https://www.tkdtechnology.it/index.php/welcome/",f=e+"dettaglio_tabulati?id_giornata="+a;b||(b="Giornata");var g={id:a,titolo:b,tabulati:{html:"",rows:[]},medagliere:{rows:[],html:""},elenco_societa:{rows:[],html:""}},h=rooturl+"/crossd";$.ajax({type:"POST",url:h,data:{url:f,format:""},async:!1}).done(function(a){for(var b=["tabulati","medagliere","elenco_societa"],d="",e=0;e<b.length;e++){var f=b[e],h=$(a).find("#"+b[e]);h.find("table").attr("table-layout","fixed"),h.find("table").attr("width","100%").attr("border","1"),h.find("table").find("th").css("font-size","10px"),h.find("table").find("td").css("font-size","10px");var i="";if("medagliere"==f){var j="40px",k=h.find("table").find("thead").find("tr").find("th:eq(1)");k.attr("width",j);var l=h.find("table").find("tbody").find("tr");colog("tr",l.length),l.each(function(){var b=({posizione:$(this).find("td:eq(0)"),societa:$(this).find("td:eq(1)"),ori:$(this).find("td:eq(2)"),argenti:$(this).find("td:eq(3)"),bronzi:$(this).find("td:eq(4)")},$(this).find("td:eq(1)")),c=b.text(),d=c.substring(0,30)+"...";b.text(d),b.attr("width",j).css("word-wrap","break-word").css("max-width","20%")})}if("tabulati"==f){var l=h.find("table").find("tbody").find("tr"),k=h.find("table").find("thead").find("tr").find("th:eq(3)");k.remove(),l.each(function(){var a=$(this).find("td:eq(5)"),b=$(this).find("td:eq(0)");b.attr("onclick","greenifyMe(this,false)"),a.html(a.html().replace("Vedi","")),a.find("a").addClass("ui-btn"),a.find("a").attr("onclick","greenifyMe(this,true)");var c=$(this).find("td:eq(0)").text(),d=$(this).find("td:eq(1)").text(),e=$(this).find("td:eq(2)").text(),f=$(this).find("td:eq(3)").text(),h=$(this).find("td:eq(4)").text();$(this).find("td:eq(2)").html(e+"<br>"+f);var i=a.find("a");i.removeAttr("target");var j=i.attr("href"),k="javascript:openTabulatoPageNew('"+j+"')";i.attr("href",k);var l={href:k,oldhref:j,sesso:c,categoria_eta:d,cintura_da:e,cintura_a:f,categoria_peso:h};$(this).find("td:eq(3)").remove(),g.tabulati.rows.push(l)})}if("elenco_societa"==f){var m=h.find("div[style='border:solid; border-radius:40px; text-align: center']");m.each(function(){var a=$(this);a.attr("style","width: 100%; font-size: 12px;");var b=a.find("h3").text(),c=!1;if($(g[f].rows).each(function(a){var d=g[f].rows[a],e=d.societaname;e.trim().toLowerCase()==b.trim().toLowerCase()&&(c=!0)}),!c){var d={societaname:b,atleti:[]},e=a.find("div");e.each(function(a){var c=$(this),e=c.find("a").text().trim(),f=c.text();f=f.replace("kg","").trim();var g=f.split(" - ");$(g).each(function(a){});var h=g[1],i=g[2],j=g[3],k=j.split(" "),l=k[k.length-1].trim(),m=j.replace(l,"").trim(),n={nome:e,sesso:h,cateta:i,catpeso:l,catcintura:m,societa:b};d.atleti.push(n)}),g[f].rows.push(d)}}),i=" style='display: none;' "}var n="<div class='xxx'>"+h.html()+"</div>";g[f].html=n}d="<div>"+d+"</div>",g.elenco_societa.rows.sort(function(a,b){var c=a.societaname,d=b.societaname;return c>d?1:c<d?-1:0}),c&&c(g)})}function getTkdtAtleta(a){colog("getTkdtAtleta searching this atleta",a);var b={nome:"atleta non trovato",catcintura:"--",catpeso:"--",cateta:"--",societa:"--",sesso:"--",giorno:"--"},c=a.nome.toLowerCase(),d=a.cognome.toLowerCase();c=c.replace("à","a'"),c=c.replace("è","e'"),c=c.replace("ì","i'"),c=c.replace("ò","o'"),c=c.replace("ù","u'"),d=d.replace("à","a'"),d=d.replace("è","e'"),d=d.replace("ì","i'"),d=d.replace("ò","o'"),d=d.replace("ù","u'");var e=tkdt_atleti;return 0==tkdt_atleti.length&&(e=tkdt_atleti_iscritti),$(e).each(function(a){var f=c+" "+d,g=d+" "+c,h=e[a],i=h.nome.toLowerCase().trim();i!=f.trim()&&i!=g.trim()||(colog("TROVATO !!"),b=h)}),b}function getTkdtAtletiCategoria(a,b,c,d){colog("getTkdtAtletiCategoria searching atleti in categoria",a+" "+b+" "+c+" "+d);var f=[],g=tkdt_atleti;return 0==tkdt_atleti.length&&(g=tkdt_atleti_iscritti),$(g).each(function(e){var h=g[e],i=h.catpeso.toLowerCase(),j=h.catcintura.toLowerCase(),k=h.cateta.toLowerCase(),l=h.sesso.toLowerCase(),m=!0;i!=c.toLowerCase()&&(m=m&&!1),j!=b.toLowerCase()&&(m=m&&!1),k!=a.toLowerCase()&&(m=m&&!1),l!=d.toLowerCase()&&(m=m&&!1),m&&f.push(h)}),f}function getTkdtTabulatiCategoria(a,b,c,d){colog("getTkdtTabulatiCategoria searching tabulato in categoria",a+" "+b+" "+c+" "+d);var e=d+" - "+a+" - "+b+" - "+c+" kg",f={categoria_peso:"--",categoria_eta:"--",cintura_da:"--",cintura_a:"--",sesso:"--"};return $(tkdt_tabulati).each(function(g){var h=tkdt_tabulati[g],i=h.categoria_peso.replace("kg","").trim().toLowerCase(),j=h.cintura_da.toLowerCase()+" -> "+h.cintura_a.toLowerCase(),k=h.categoria_eta.toLowerCase(),l=h.sesso.toLowerCase(),m=!0;i!=c.toLowerCase()&&(m=m&&!1),j!=b.toLowerCase()&&(m=m&&!1),k!=a.toLowerCase()&&(m=m&&!1),l!=d.toLowerCase()&&(m=m&&!1),m&&(colog("TROVATO TABULATO !!"),h.tabname=e,f=h)}),f}function retrieveTkdt(a){var b=$(a).closest("div[data-role=content]"),c=b.find("#tkdt_id").val(),d=b.find("#tkdt");progressStart("Recupero dati ufficiali di gara "+c+" ...."),refreshTkdtNew(c,function(){d.empty(),progressStop(),toast("Dati ufficiali di gara garicati per gara tkdt_id "+c),d.append("Atleti iscritti: "+tkdt_atleti_iscritti.length+"<br>"),d.append("Atleti effettivi in gara: "+tkdt_atleti.length+"<br>"),d.append("Tabulati trovati: "+tkdt_tabulati.length+"<br>");var a={atleti:tkdt_atleti,tabulati:tkdt_tabulati,atleti_iscritti:tkdt_atleti_iscritti};d.append('<br><label><input type="checkbox" name="ck_tkdt" id="ck_tkdt">&nbsp;Salva TKDT</label><br>'),d.append("<textarea id='tatkdt'>"+JSON.stringify(a)+"</textarea><br>")})}function matchTkdtIscritti(a){var b=$(a).closest("div[data-role=content]"),c=b.find("textarea");if(c.length>0){var d=c.val(),e=JSON.parse(d);console.log(e)}var f=0,g=0,h=0,i="",j=[];$(e.atleti_iscritti).each(function(a){var b=e.atleti_iscritti[a],c=b.nome.toLowerCase().trim(),d=b.societa;if("A.S.D. TAEKWONDO ROZZANO"==d){h++;var k=getAtletaByCognoNome(c);k.length>0?(""!=i.trim()&&(i+=","),i+=k[0].id,f++):(console.log("atleta non trovato: ",c),g++,j.push(c))}}),console.log("trovati "+f+" su "+h+" ("+g+" non trovati)"),console.log("new iscritti string",i);var k=confirm("trovati "+f+" su "+h+" ("+g+" non trovati)\n\nVuoi sostituire il campo iscritti ?");if(1==k){var l=$("#page_editgara #iscritti");l.val(i)}var m=$("#page_editgara #tkdtmatchnotfound");if(j.length>0){m.empty(),m.append("<h3>Atleti TKDT non trovati</h3><br><br>");for(var n=0;n<j.length;n++)m.append("<span>"+j[n]+"</span><br>")}}function getAtletaByCognoNome(a){var b=[];return a=a.toLowerCase().trim(),a=a.replace("à","a"),a=a.replace("è","e"),a=a.replace("ì","i"),a=a.replace("ò","o"),a=a.replace("ù","u"),a=a.replace("a'","a"),a=a.replace("e'","e"),a=a.replace("i'","i"),a=a.replace("o'","o"),a=a.replace("u'","u"),$($atleti.rows).each(function(c){var d=$atleti.rows[c].doc,f=(d.id,d.cognome.toLowerCase().trim()),g=d.nome.toLowerCase().trim();g=g.replace("à","a"),g=g.replace("è","e"),g=g.replace("ì","i"),g=g.replace("ò","o"),g=g.replace("ù","u"),g=g.replace("a'","a"),g=g.replace("e'","e"),g=g.replace("i'","i"),g=g.replace("o'","o"),g=g.replace("u'","u"),f=f.replace("à","a"),f=f.replace("è","e"),f=f.replace("ì","i"),f=f.replace("ò","o"),f=f.replace("ù","u"),f=f.replace("a'","a"),f=f.replace("e'","e"),f=f.replace("i'","i"),f=f.replace("o'","o"),f=f.replace("u'","u");var h=f+" "+g,i=g+" "+f,j=!1;if(h==a&&(j=!0),i==a&&(j=!0),j)return b.push(d),b}),b}function loadInlineTabulato(a){colog("loadInlineTabulato "+a);var b=rooturl+"/crossd";$.ajax({type:"POST",url:b,data:{url:a,format:""},dataType:"html"}).done(function(a){var b=$(a).find("#banner").find("img");colog(b.attr("src"));"<a href='"+b.attr("src")+"' target='_blank' >Apri nel browser</a><br><br>";$("#matchesatleta #inlinetabulato").empty().append(b).css("border","1px solid silver")})}var rooturl="http://tkdr.herokuapp.com",tkdt_atleti=[],tkdt_atleti_iscritti=[],tkdt_tabulati=[],tkdtnew={giorni:[]};String.prototype.replAll=function(a,b){var c=this;return c.replace(new RegExp(a,"g"),b)};