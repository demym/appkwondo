var NEWLINE = '\n';
var IGNORE_FRAMES = {};
var creationTrace = '__creationTrace__';
var ERROR_TAG = 'STACKTRACE TRACKING';
var SEP_TAG = '__SEP_TAG__';
var sepTemplate = SEP_TAG + '@[native]';
var LongStackTrace = (function () {
    function LongStackTrace() {
        this.error = getStacktrace();
        this.timestamp = new Date();
    }
    return LongStackTrace;
}());
function getStacktraceWithUncaughtError() {
    return new Error(ERROR_TAG);
}
function getStacktraceWithCaughtError() {
    try {
        throw getStacktraceWithUncaughtError();
    }
    catch (err) {
        return err;
    }
}
var error = getStacktraceWithUncaughtError();
var caughtError = getStacktraceWithCaughtError();
var getStacktrace = error.stack ?
    getStacktraceWithUncaughtError :
    (caughtError.stack ? getStacktraceWithCaughtError : getStacktraceWithUncaughtError);
function getFrames(error) {
    return error.stack ? error.stack.split(NEWLINE) : [];
}
function addErrorStack(lines, error) {
    var trace = getFrames(error);
    for (var i = 0; i < trace.length; i++) {
        var frame = trace[i];
        if (!IGNORE_FRAMES.hasOwnProperty(frame)) {
            lines.push(trace[i]);
        }
    }
}
function renderLongStackTrace(frames, stack) {
    var longTrace = [stack ? stack.trim() : ''];
    if (frames) {
        var timestamp = new Date().getTime();
        for (var i = 0; i < frames.length; i++) {
            var traceFrames = frames[i];
            var lastTime = traceFrames.timestamp;
            var separator = "____________________Elapsed " + (timestamp - lastTime.getTime()) + " ms; At: " + lastTime;
            separator = separator.replace(/[^\w\d]/g, '_');
            longTrace.push(sepTemplate.replace(SEP_TAG, separator));
            addErrorStack(longTrace, traceFrames.error);
            timestamp = lastTime.getTime();
        }
    }
    return longTrace.join(NEWLINE);
}
Zone['longStackTraceZoneSpec'] = {
    name: 'long-stack-trace',
    longStackTraceLimit: 10,
    getLongStackTrace: function (error) {
        if (!error) {
            return undefined;
        }
        var task = error[Zone.__symbol__('currentTask')];
        var trace = task && task.data && task.data[creationTrace];
        if (!trace) {
            return error.stack;
        }
        return renderLongStackTrace(trace, error.stack);
    },
    onScheduleTask: function (parentZoneDelegate, currentZone, targetZone, task) {
        if (Error.stackTraceLimit > 0) {
            var currentTask = Zone.currentTask;
            var trace = currentTask && currentTask.data && currentTask.data[creationTrace] || [];
            trace = [new LongStackTrace()].concat(trace);
            if (trace.length > this.longStackTraceLimit) {
                trace.length = this.longStackTraceLimit;
            }
            if (!task.data)
                task.data = {};
            task.data[creationTrace] = trace;
        }
        return parentZoneDelegate.scheduleTask(targetZone, task);
    },
    onHandleError: function (parentZoneDelegate, currentZone, targetZone, error) {
        if (Error.stackTraceLimit > 0) {
            var parentTask = Zone.currentTask || error.task;
            if (error instanceof Error && parentTask) {
                var longStack = renderLongStackTrace(parentTask.data && parentTask.data[creationTrace], error.stack);
                try {
                    error.stack = error.longStack = longStack;
                }
                catch (err) {
                }
            }
        }
        return parentZoneDelegate.handleError(targetZone, error);
    }
};
function captureStackTraces(stackTraces, count) {
    if (count > 0) {
        stackTraces.push(getFrames((new LongStackTrace()).error));
        captureStackTraces(stackTraces, count - 1);
    }
}
function computeIgnoreFrames() {
    if (Error.stackTraceLimit <= 0) {
        return;
    }
    var frames = [];
    captureStackTraces(frames, 2);
    var frames1 = frames[0];
    var frames2 = frames[1];
    for (var i = 0; i < frames1.length; i++) {
        var frame1 = frames1[i];
        if (frame1.indexOf(ERROR_TAG) == -1) {
            var match = frame1.match(/^\s*at\s+/);
            if (match) {
                sepTemplate = match[0] + SEP_TAG + ' (http://localhost)';
                break;
            }
        }
    }
    for (var i = 0; i < frames1.length; i++) {
        var frame1 = frames1[i];
        var frame2 = frames2[i];
        if (frame1 === frame2) {
            IGNORE_FRAMES[frame1] = true;
        }
        else {
            break;
        }
    }
}
computeIgnoreFrames();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9uZy1zdGFjay10cmFjZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxvbmctc3RhY2stdHJhY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBWUEsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDO0FBQ3JCLElBQU0sYUFBYSxHQUF3QixFQUFFLENBQUM7QUFDOUMsSUFBTSxhQUFhLEdBQUcsbUJBQW1CLENBQUM7QUFDMUMsSUFBTSxTQUFTLEdBQUcscUJBQXFCLENBQUM7QUFDeEMsSUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDO0FBQzlCLElBQUksV0FBVyxHQUFXLE9BQU8sR0FBRyxXQUFXLENBQUM7QUFFaEQ7SUFBQTtRQUNFLFVBQUssR0FBVSxhQUFhLEVBQUUsQ0FBQztRQUMvQixjQUFTLEdBQVMsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBQUQscUJBQUM7QUFBRCxDQUFDLEFBSEQsSUFHQztBQUVEO0lBQ0UsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzlCLENBQUM7QUFFRDtJQUNFLElBQUksQ0FBQztRQUNILE1BQU0sOEJBQThCLEVBQUUsQ0FBQztJQUN6QyxDQUFDO0lBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNiLE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDYixDQUFDO0FBQ0gsQ0FBQztBQUlELElBQU0sS0FBSyxHQUFHLDhCQUE4QixFQUFFLENBQUM7QUFDL0MsSUFBTSxXQUFXLEdBQUcsNEJBQTRCLEVBQUUsQ0FBQztBQUNuRCxJQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsS0FBSztJQUM3Qiw4QkFBOEI7SUFDOUIsQ0FBQyxXQUFXLENBQUMsS0FBSyxHQUFHLDRCQUE0QixHQUFHLDhCQUE4QixDQUFDLENBQUM7QUFFeEYsbUJBQW1CLEtBQVk7SUFDN0IsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFL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QztRQUMxQixFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQyxJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3RDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ1YsV0FBVyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLEdBQUcscUJBQXFCLENBQUM7Z0JBQ3pELEtBQUssQ0FBQztZQUNSLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVELEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3hDLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQixJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUIsRUFBRSxDQUFDLENBQUMsTUFBTSxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDdEIsYUFBYSxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQztRQUMvQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixLQUFLLENBQUM7UUFDUixDQUFDO0lBQ0gsQ0FBQztBQUNILENBQUM7QUFDRCxtQkFBbUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuLyoqXG4gKiBAZmlsZW92ZXJ2aWV3XG4gKiBAc3VwcHJlc3Mge2dsb2JhbFRoaXN9XG4gKi9cblxuY29uc3QgTkVXTElORSA9ICdcXG4nO1xuY29uc3QgSUdOT1JFX0ZSQU1FUzoge1trOiBzdHJpbmddOiB0cnVlfSA9IHt9O1xuY29uc3QgY3JlYXRpb25UcmFjZSA9ICdfX2NyZWF0aW9uVHJhY2VfXyc7XG5jb25zdCBFUlJPUl9UQUcgPSAnU1RBQ0tUUkFDRSBUUkFDS0lORyc7XG5jb25zdCBTRVBfVEFHID0gJ19fU0VQX1RBR19fJztcbmxldCBzZXBUZW1wbGF0ZTogc3RyaW5nID0gU0VQX1RBRyArICdAW25hdGl2ZV0nO1xuXG5jbGFzcyBMb25nU3RhY2tUcmFjZSB7XG4gIGVycm9yOiBFcnJvciA9IGdldFN0YWNrdHJhY2UoKTtcbiAgdGltZXN0YW1wOiBEYXRlID0gbmV3IERhdGUoKTtcbn1cblxuZnVuY3Rpb24gZ2V0U3RhY2t0cmFjZVdpdGhVbmNhdWdodEVycm9yKCk6IEVycm9yIHtcbiAgcmV0dXJuIG5ldyBFcnJvcihFUlJPUl9UQUcpO1xufVxuXG5mdW5jdGlvbiBnZXRTdGFja3RyYWNlV2l0aENhdWdodEVycm9yKCk6IEVycm9yIHtcbiAgdHJ5IHtcbiAgICB0aHJvdyBnZXRTdGFja3RyYWNlV2l0aFVuY2F1Z2h0RXJyb3IoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmV0dXJuIGVycjtcbiAgfVxufVxuXG4vLyBTb21lIGltcGxlbWVudGF0aW9ucyBvZiBleGNlcHRpb24gaGFuZGxpbmcgZG9uJ3QgY3JlYXRlIGEgc3RhY2sgdHJhY2UgaWYgdGhlIGV4Y2VwdGlvblxuLy8gaXNuJ3QgdGhyb3duLCBob3dldmVyIGl0J3MgZmFzdGVyIG5vdCB0byBhY3R1YWxseSB0aHJvdyB0aGUgZXhjZXB0aW9uLlxuY29uc3QgZXJyb3IgPSBnZXRTdGFja3RyYWNlV2l0aFVuY2F1Z2h0RXJyb3IoKTtcbmNvbnN0IGNhdWdodEVycm9yID0gZ2V0U3RhY2t0cmFjZVdpdGhDYXVnaHRFcnJvcigpO1xuY29uc3QgZ2V0U3RhY2t0cmFjZSA9IGVycm9yLnN0YWNrID9cbiAgICBnZXRTdGFja3RyYWNlV2l0aFVuY2F1Z2h0RXJyb3IgOlxuICAgIChjYXVnaHRFcnJvci5zdGFjayA/IGdldFN0YWNrdHJhY2VXaXRoQ2F1Z2h0RXJyb3IgOiBnZXRTdGFja3RyYWNlV2l0aFVuY2F1Z2h0RXJyb3IpO1xuXG5mdW5jdGlvbiBnZXRGcmFtZXMoZXJyb3I6IEVycm9yKTogc3RyaW5nW10ge1xuICByZXR1cm4gZXJyb3Iuc3RhY2sgPyBlcnJvci5zdGFjay5zcGxpdChORVdMSU5FKSA6IFtdO1xufVxuXG5mdW5jdGlvbiBhZGRFcnJvclN0YWNrKGxpbmVzOiBzdHJpbmdbXSwgZXJyb3I6IEVycm9yKTogdm9pZCB7XG4gIGxldCB0cmFjZTogc3RyaW5nW10gPSBnZXRGcmFtZXMoZXJyb3IpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHRyYWNlLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgZnJhbWUgPSB0cmFjZVtpXTtcbiAgICAvLyBGaWx0ZXIgb3V0IHRoZSBGcmFtZXMgd2hpY2ggYXJlIHBhcnQgb2Ygc3RhY2sgY2FwdHVyaW5nLlxuICAgIGlmICghSUdOT1JFX0ZSQU1FUy5oYXNPd25Qcm9wZXJ0eShmcmFtZSkpIHtcbiAgICAgIGxpbmVzLnB1c2godHJhY2VbaV0pO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiByZW5kZXJMb25nU3RhY2tUcmFjZShmcmFtZXM6IExvbmdTdGFja1RyYWNlW10sIHN0YWNrOiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBsb25nVHJhY2U6IHN0cmluZ1tdID0gW3N0YWNrID8gc3RhY2sudHJpbSgpIDogJyddO1xuXG4gIGlmIChmcmFtZXMpIHtcbiAgICBsZXQgdGltZXN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHRyYWNlRnJhbWVzOiBMb25nU3RhY2tUcmFjZSA9IGZyYW1lc1tpXTtcbiAgICAgIGNvbnN0IGxhc3RUaW1lID0gdHJhY2VGcmFtZXMudGltZXN0YW1wO1xuICAgICAgbGV0IHNlcGFyYXRvciA9XG4gICAgICAgICAgYF9fX19fX19fX19fX19fX19fX19fRWxhcHNlZCAke3RpbWVzdGFtcCAtIGxhc3RUaW1lLmdldFRpbWUoKX0gbXM7IEF0OiAke2xhc3RUaW1lfWA7XG4gICAgICBzZXBhcmF0b3IgPSBzZXBhcmF0b3IucmVwbGFjZSgvW15cXHdcXGRdL2csICdfJyk7XG4gICAgICBsb25nVHJhY2UucHVzaChzZXBUZW1wbGF0ZS5yZXBsYWNlKFNFUF9UQUcsIHNlcGFyYXRvcikpO1xuICAgICAgYWRkRXJyb3JTdGFjayhsb25nVHJhY2UsIHRyYWNlRnJhbWVzLmVycm9yKTtcblxuICAgICAgdGltZXN0YW1wID0gbGFzdFRpbWUuZ2V0VGltZSgpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBsb25nVHJhY2Uuam9pbihORVdMSU5FKTtcbn1cblxuKFpvbmUgYXMgYW55KVsnbG9uZ1N0YWNrVHJhY2Vab25lU3BlYyddID0gPFpvbmVTcGVjPntcbiAgbmFtZTogJ2xvbmctc3RhY2stdHJhY2UnLFxuICBsb25nU3RhY2tUcmFjZUxpbWl0OiAxMCwgIC8vIE1heCBudW1iZXIgb2YgdGFzayB0byBrZWVwIHRoZSBzdGFjayB0cmFjZSBmb3IuXG4gIC8vIGFkZCBhIGdldExvbmdTdGFja1RyYWNlIG1ldGhvZCBpbiBzcGVjIHRvXG4gIC8vIGhhbmRsZSBoYW5kbGVkIHJlamVjdCBwcm9taXNlIGVycm9yLlxuICBnZXRMb25nU3RhY2tUcmFjZTogZnVuY3Rpb24oZXJyb3I6IEVycm9yKTogc3RyaW5nIHtcbiAgICBpZiAoIWVycm9yKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjb25zdCB0YXNrID0gKGVycm9yIGFzIGFueSlbKFpvbmUgYXMgYW55KS5fX3N5bWJvbF9fKCdjdXJyZW50VGFzaycpXTtcbiAgICBjb25zdCB0cmFjZSA9IHRhc2sgJiYgdGFzay5kYXRhICYmIHRhc2suZGF0YVtjcmVhdGlvblRyYWNlXTtcbiAgICBpZiAoIXRyYWNlKSB7XG4gICAgICByZXR1cm4gZXJyb3Iuc3RhY2s7XG4gICAgfVxuICAgIHJldHVybiByZW5kZXJMb25nU3RhY2tUcmFjZSh0cmFjZSwgZXJyb3Iuc3RhY2spO1xuICB9LFxuXG4gIG9uU2NoZWR1bGVUYXNrOiBmdW5jdGlvbihcbiAgICAgIHBhcmVudFpvbmVEZWxlZ2F0ZTogWm9uZURlbGVnYXRlLCBjdXJyZW50Wm9uZTogWm9uZSwgdGFyZ2V0Wm9uZTogWm9uZSwgdGFzazogVGFzayk6IGFueSB7XG4gICAgaWYgKEVycm9yLnN0YWNrVHJhY2VMaW1pdCA+IDApIHtcbiAgICAgIC8vIGlmIEVycm9yLnN0YWNrVHJhY2VMaW1pdCBpcyAwLCBtZWFucyBzdGFjayB0cmFjZVxuICAgICAgLy8gaXMgZGlzYWJsZWQsIHNvIHdlIGRvbid0IG5lZWQgdG8gZ2VuZXJhdGUgbG9uZyBzdGFjayB0cmFjZVxuICAgICAgLy8gdGhpcyB3aWxsIGltcHJvdmUgcGVyZm9ybWFuY2UgaW4gc29tZSB0ZXN0KHNvbWUgdGVzdCB3aWxsXG4gICAgICAvLyBzZXQgc3RhY2tUcmFjZUxpbWl0IHRvIDAsIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL3pvbmUuanMvaXNzdWVzLzY5OFxuICAgICAgY29uc3QgY3VycmVudFRhc2sgPSBab25lLmN1cnJlbnRUYXNrO1xuICAgICAgbGV0IHRyYWNlID0gY3VycmVudFRhc2sgJiYgY3VycmVudFRhc2suZGF0YSAmJiAoY3VycmVudFRhc2suZGF0YSBhcyBhbnkpW2NyZWF0aW9uVHJhY2VdIHx8IFtdO1xuICAgICAgdHJhY2UgPSBbbmV3IExvbmdTdGFja1RyYWNlKCldLmNvbmNhdCh0cmFjZSk7XG4gICAgICBpZiAodHJhY2UubGVuZ3RoID4gdGhpcy5sb25nU3RhY2tUcmFjZUxpbWl0KSB7XG4gICAgICAgIHRyYWNlLmxlbmd0aCA9IHRoaXMubG9uZ1N0YWNrVHJhY2VMaW1pdDtcbiAgICAgIH1cbiAgICAgIGlmICghdGFzay5kYXRhKSB0YXNrLmRhdGEgPSB7fTtcbiAgICAgICh0YXNrLmRhdGEgYXMgYW55KVtjcmVhdGlvblRyYWNlXSA9IHRyYWNlO1xuICAgIH1cbiAgICByZXR1cm4gcGFyZW50Wm9uZURlbGVnYXRlLnNjaGVkdWxlVGFzayh0YXJnZXRab25lLCB0YXNrKTtcbiAgfSxcblxuICBvbkhhbmRsZUVycm9yOiBmdW5jdGlvbihcbiAgICAgIHBhcmVudFpvbmVEZWxlZ2F0ZTogWm9uZURlbGVnYXRlLCBjdXJyZW50Wm9uZTogWm9uZSwgdGFyZ2V0Wm9uZTogWm9uZSwgZXJyb3I6IGFueSk6IGJvb2xlYW4ge1xuICAgIGlmIChFcnJvci5zdGFja1RyYWNlTGltaXQgPiAwKSB7XG4gICAgICAvLyBpZiBFcnJvci5zdGFja1RyYWNlTGltaXQgaXMgMCwgbWVhbnMgc3RhY2sgdHJhY2VcbiAgICAgIC8vIGlzIGRpc2FibGVkLCBzbyB3ZSBkb24ndCBuZWVkIHRvIGdlbmVyYXRlIGxvbmcgc3RhY2sgdHJhY2VcbiAgICAgIC8vIHRoaXMgd2lsbCBpbXByb3ZlIHBlcmZvcm1hbmNlIGluIHNvbWUgdGVzdChzb21lIHRlc3Qgd2lsbFxuICAgICAgLy8gc2V0IHN0YWNrVHJhY2VMaW1pdCB0byAwLCBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci96b25lLmpzL2lzc3Vlcy82OThcbiAgICAgIGNvbnN0IHBhcmVudFRhc2sgPSBab25lLmN1cnJlbnRUYXNrIHx8IGVycm9yLnRhc2s7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJiBwYXJlbnRUYXNrKSB7XG4gICAgICAgIGNvbnN0IGxvbmdTdGFjayA9XG4gICAgICAgICAgICByZW5kZXJMb25nU3RhY2tUcmFjZShwYXJlbnRUYXNrLmRhdGEgJiYgcGFyZW50VGFzay5kYXRhW2NyZWF0aW9uVHJhY2VdLCBlcnJvci5zdGFjayk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgZXJyb3Iuc3RhY2sgPSAoZXJyb3IgYXMgYW55KS5sb25nU3RhY2sgPSBsb25nU3RhY2s7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBwYXJlbnRab25lRGVsZWdhdGUuaGFuZGxlRXJyb3IodGFyZ2V0Wm9uZSwgZXJyb3IpO1xuICB9XG59O1xuXG5mdW5jdGlvbiBjYXB0dXJlU3RhY2tUcmFjZXMoc3RhY2tUcmFjZXM6IHN0cmluZ1tdW10sIGNvdW50OiBudW1iZXIpOiB2b2lkIHtcbiAgaWYgKGNvdW50ID4gMCkge1xuICAgIHN0YWNrVHJhY2VzLnB1c2goZ2V0RnJhbWVzKChuZXcgTG9uZ1N0YWNrVHJhY2UoKSkuZXJyb3IpKTtcbiAgICBjYXB0dXJlU3RhY2tUcmFjZXMoc3RhY2tUcmFjZXMsIGNvdW50IC0gMSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY29tcHV0ZUlnbm9yZUZyYW1lcygpIHtcbiAgaWYgKEVycm9yLnN0YWNrVHJhY2VMaW1pdCA8PSAwKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IGZyYW1lczogc3RyaW5nW11bXSA9IFtdO1xuICBjYXB0dXJlU3RhY2tUcmFjZXMoZnJhbWVzLCAyKTtcbiAgY29uc3QgZnJhbWVzMSA9IGZyYW1lc1swXTtcbiAgY29uc3QgZnJhbWVzMiA9IGZyYW1lc1sxXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZXMxLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgZnJhbWUxID0gZnJhbWVzMVtpXTtcbiAgICBpZiAoZnJhbWUxLmluZGV4T2YoRVJST1JfVEFHKSA9PSAtMSkge1xuICAgICAgbGV0IG1hdGNoID0gZnJhbWUxLm1hdGNoKC9eXFxzKmF0XFxzKy8pO1xuICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgIHNlcFRlbXBsYXRlID0gbWF0Y2hbMF0gKyBTRVBfVEFHICsgJyAoaHR0cDovL2xvY2FsaG9zdCknO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lczEubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBmcmFtZTEgPSBmcmFtZXMxW2ldO1xuICAgIGNvbnN0IGZyYW1lMiA9IGZyYW1lczJbaV07XG4gICAgaWYgKGZyYW1lMSA9PT0gZnJhbWUyKSB7XG4gICAgICBJR05PUkVfRlJBTUVTW2ZyYW1lMV0gPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbn1cbmNvbXB1dGVJZ25vcmVGcmFtZXMoKTtcbiJdfQ==