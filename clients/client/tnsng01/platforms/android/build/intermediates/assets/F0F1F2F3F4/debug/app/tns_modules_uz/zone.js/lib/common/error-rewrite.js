Zone.__load_patch('Error', function (global, Zone, api) {
    var blacklistedStackFramesSymbol = api.symbol('blacklistedStackFrames');
    var NativeError = global[api.symbol('Error')] = global['Error'];
    var blackListedStackFrames = {};
    var zoneAwareFrame1;
    var zoneAwareFrame2;
    global['Error'] = ZoneAwareError;
    var stackRewrite = 'stackRewrite';
    function ZoneAwareError() {
        var _this = this;
        var error = NativeError.apply(this, arguments);
        var originalStack = error['originalStack'] = error.stack;
        if (ZoneAwareError[stackRewrite] && originalStack) {
            var frames_1 = originalStack.split('\n');
            var zoneFrame = api.currentZoneFrame();
            var i = 0;
            while (!(frames_1[i] === zoneAwareFrame1 || frames_1[i] === zoneAwareFrame2) &&
                i < frames_1.length) {
                i++;
            }
            for (; i < frames_1.length && zoneFrame; i++) {
                var frame = frames_1[i];
                if (frame.trim()) {
                    switch (blackListedStackFrames[frame]) {
                        case 0:
                            frames_1.splice(i, 1);
                            i--;
                            break;
                        case 1:
                            if (zoneFrame.parent) {
                                zoneFrame = zoneFrame.parent;
                            }
                            else {
                                zoneFrame = null;
                            }
                            frames_1.splice(i, 1);
                            i--;
                            break;
                        default:
                            frames_1[i] += " [" + zoneFrame.zone.name + "]";
                    }
                }
            }
            try {
                error.stack = error.zoneAwareStack = frames_1.join('\n');
            }
            catch (e) {
            }
        }
        if (this instanceof NativeError && this.constructor != NativeError) {
            Object.keys(error).concat('stack', 'message').forEach(function (key) {
                var value = error[key];
                if (value !== undefined) {
                    try {
                        _this[key] = value;
                    }
                    catch (e) {
                    }
                }
            });
            return this;
        }
        return error;
    }
    ZoneAwareError.prototype = NativeError.prototype;
    ZoneAwareError[blacklistedStackFramesSymbol] = blackListedStackFrames;
    ZoneAwareError[stackRewrite] = false;
    var specialPropertyNames = ['stackTraceLimit', 'captureStackTrace', 'prepareStackTrace'];
    var nativeErrorProperties = Object.keys(NativeError);
    if (nativeErrorProperties) {
        nativeErrorProperties.forEach(function (prop) {
            if (specialPropertyNames.filter(function (sp) { return sp === prop; }).length === 0) {
                Object.defineProperty(ZoneAwareError, prop, {
                    get: function () {
                        return NativeError[prop];
                    },
                    set: function (value) {
                        NativeError[prop] = value;
                    }
                });
            }
        });
    }
    if (NativeError.hasOwnProperty('stackTraceLimit')) {
        NativeError.stackTraceLimit = Math.max(NativeError.stackTraceLimit, 15);
        Object.defineProperty(ZoneAwareError, 'stackTraceLimit', {
            get: function () {
                return NativeError.stackTraceLimit;
            },
            set: function (value) {
                return NativeError.stackTraceLimit = value;
            }
        });
    }
    if (NativeError.hasOwnProperty('captureStackTrace')) {
        Object.defineProperty(ZoneAwareError, 'captureStackTrace', {
            value: function zoneCaptureStackTrace(targetObject, constructorOpt) {
                NativeError.captureStackTrace(targetObject, constructorOpt);
            }
        });
    }
    var ZONE_CAPTURESTACKTRACE = 'zoneCaptureStackTrace';
    Object.defineProperty(ZoneAwareError, 'prepareStackTrace', {
        get: function () {
            return NativeError.prepareStackTrace;
        },
        set: function (value) {
            if (!value || typeof value !== 'function') {
                return NativeError.prepareStackTrace = value;
            }
            return NativeError.prepareStackTrace = function (error, structuredStackTrace) {
                if (structuredStackTrace) {
                    for (var i = 0; i < structuredStackTrace.length; i++) {
                        var st = structuredStackTrace[i];
                        if (st.getFunctionName() === ZONE_CAPTURESTACKTRACE) {
                            structuredStackTrace.splice(i, 1);
                            break;
                        }
                    }
                }
                return value.apply(this, [error, structuredStackTrace]);
            };
        }
    });
    var ZONE_AWARE_ERROR = 'ZoneAwareError';
    var ERROR_DOT = 'Error.';
    var EMPTY = '';
    var RUN_GUARDED = 'runGuarded';
    var RUN_TASK = 'runTask';
    var RUN = 'run';
    var BRACKETS = '(';
    var AT = '@';
    var detectZone = Zone.current.fork({
        name: 'detect',
        onHandleError: function (parentZD, current, target, error) {
            if (error.originalStack && Error === ZoneAwareError) {
                var frames_2 = error.originalStack.split(/\n/);
                var runFrame = false, runGuardedFrame = false, runTaskFrame = false;
                while (frames_2.length) {
                    var frame = frames_2.shift();
                    if (/:\d+:\d+/.test(frame)) {
                        var fnName = frame.split(BRACKETS)[0].split(AT)[0];
                        var frameType = 1;
                        if (fnName.indexOf(ZONE_AWARE_ERROR) !== -1) {
                            zoneAwareFrame1 = frame;
                            zoneAwareFrame2 = frame.replace(ERROR_DOT, EMPTY);
                            blackListedStackFrames[zoneAwareFrame2] = 0;
                        }
                        if (fnName.indexOf(RUN_GUARDED) !== -1) {
                            runGuardedFrame = true;
                        }
                        else if (fnName.indexOf(RUN_TASK) !== -1) {
                            runTaskFrame = true;
                        }
                        else if (fnName.indexOf(RUN) !== -1) {
                            runFrame = true;
                        }
                        else {
                            frameType = 0;
                        }
                        blackListedStackFrames[frame] = frameType;
                        if (runFrame && runGuardedFrame && runTaskFrame) {
                            ZoneAwareError[stackRewrite] = true;
                            break;
                        }
                    }
                }
            }
            return false;
        }
    });
    var childDetectZone = detectZone.fork({
        name: 'child',
        onScheduleTask: function (delegate, curr, target, task) {
            return delegate.scheduleTask(target, task);
        },
        onInvokeTask: function (delegate, curr, target, task, applyThis, applyArgs) {
            return delegate.invokeTask(target, task, applyThis, applyArgs);
        },
        onCancelTask: function (delegate, curr, target, task) {
            return delegate.cancelTask(target, task);
        },
        onInvoke: function (delegate, curr, target, callback, applyThis, applyArgs, source) {
            return delegate.invoke(target, callback, applyThis, applyArgs, source);
        }
    });
    var originalStackTraceLimit = Error.stackTraceLimit;
    Error.stackTraceLimit = 100;
    childDetectZone.run(function () {
        childDetectZone.runGuarded(function () {
            var fakeTransitionTo = function (toState, fromState1, fromState2) { };
            childDetectZone.scheduleEventTask(blacklistedStackFramesSymbol, function () {
                childDetectZone.scheduleMacroTask(blacklistedStackFramesSymbol, function () {
                    childDetectZone.scheduleMicroTask(blacklistedStackFramesSymbol, function () {
                        throw new ZoneAwareError(ZoneAwareError, NativeError);
                    }, null, function (t) {
                        t._transitionTo = fakeTransitionTo;
                        t.invoke();
                    });
                }, null, function (t) {
                    t._transitionTo = fakeTransitionTo;
                    t.invoke();
                }, function () { });
            }, null, function (t) {
                t._transitionTo = fakeTransitionTo;
                t.invoke();
            }, function () { });
        });
    });
    Error.stackTraceLimit = originalStackTraceLimit;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXJyb3ItcmV3cml0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImVycm9yLXJld3JpdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBMkJBLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLFVBQUMsTUFBVyxFQUFFLElBQWMsRUFBRSxHQUFpQjtJQWN4RSxJQUFNLDRCQUE0QixHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsd0JBQXdCLENBQUMsQ0FBQztJQUMxRSxJQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUVsRSxJQUFNLHNCQUFzQixHQUFpQyxFQUFFLENBQUM7SUFFaEUsSUFBSSxlQUF1QixDQUFDO0lBQzVCLElBQUksZUFBdUIsQ0FBQztJQUU1QixNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsY0FBYyxDQUFDO0lBQ2pDLElBQU0sWUFBWSxHQUFHLGNBQWMsQ0FBQztJQU1wQztRQUFBLGlCQThEQztRQTVEQyxJQUFJLEtBQUssR0FBVSxXQUFXLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztRQUV0RCxJQUFNLGFBQWEsR0FBSSxLQUFhLENBQUMsZUFBZSxDQUFDLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUdwRSxFQUFFLENBQUMsQ0FBRSxjQUFzQixDQUFDLFlBQVksQ0FBQyxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUM7WUFDM0QsSUFBSSxRQUFNLEdBQWEsYUFBYSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNqRCxJQUFJLFNBQVMsR0FBRyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUN2QyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFVixPQUFPLENBQUMsQ0FBQyxRQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssZUFBZSxJQUFJLFFBQU0sQ0FBQyxD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QixFQUFFLFVBQXFCLEVBQUUsVUFBcUIsSUFBTSxDQUFDLENBQUM7WUFDN0UsZUFBZSxDQUFDLGlCQUFpQixDQUM3Qiw0QkFBNEIsRUFDNUI7Z0JBQ0UsZUFBZSxDQUFDLGlCQUFpQixDQUM3Qiw0QkFBNEIsRUFDNUI7b0JBQ0UsZUFBZSxDQUFDLGlCQUFpQixDQUM3Qiw0QkFBNEIsRUFDNUI7d0JBQ0UsTUFBTSxJQUFLLGNBQXNCLENBQUMsY0FBYyxFQUFFLFdBQVcsQ0FBQyxDQUFDO29CQUNqRSxDQUFDLEVBQ0QsSUFBSSxFQUNKLFVBQUMsQ0FBTzt3QkFDTCxDQUFTLENBQUMsYUFBYSxHQUFHLGdCQUFnQixDQUFDO3dCQUM1QyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7b0JBQ2IsQ0FBQyxDQUFDLENBQUM7Z0JBQ1QsQ0FBQyxFQUNELElBQUksRUFDSixVQUFDLENBQUM7b0JBQ0MsQ0FBUyxDQUFDLGFBQWEsR0FBRyxnQkFBZ0IsQ0FBQztvQkFDNUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNiLENBQUMsRUFDRCxjQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLENBQUMsRUFDRCxJQUFJLEVBQ0osVUFBQyxDQUFDO2dCQUNDLENBQVMsQ0FBQyxhQUFhLEdBQUcsZ0JBQWdCLENBQUM7Z0JBQzVDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNiLENBQUMsRUFDRCxjQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDSCxLQUFLLENBQUMsZUFBZSxHQUFHLHVCQUF1QixDQUFDO0FBQ2xELENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuLyoqXG4gKiBAZmlsZW92ZXJ2aWV3XG4gKiBAc3VwcHJlc3Mge2dsb2JhbFRoaXMsdW5kZWZpbmVkVmFyc31cbiAqL1xuXG4vKipcbiAqIEV4dGVuZCB0aGUgRXJyb3Igd2l0aCBhZGRpdGlvbmFsIGZpZWxkcyBmb3IgcmV3cml0dGVuIHN0YWNrIGZyYW1lc1xuICovXG5pbnRlcmZhY2UgRXJyb3Ige1xuICAvKipcbiAgICogU3RhY2sgdHJhY2Ugd2hlcmUgZXh0cmEgZnJhbWVzIGhhdmUgYmVlbiByZW1vdmVkIGFuZCB6b25lIG5hbWVzIGFkZGVkLlxuICAgKi9cbiAgem9uZUF3YXJlU3RhY2s/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIE9yaWdpbmFsIHN0YWNrIHRyYWNlIHdpdGggbm8gbW9kaWZpY2F0aW9uc1xuICAgKi9cbiAgb3JpZ2luYWxTdGFjaz86IHN0cmluZztcbn1cblxuWm9uZS5fX2xvYWRfcGF0Y2goJ0Vycm9yJywgKGdsb2JhbDogYW55LCBab25lOiBab25lVHlwZSwgYXBpOiBfWm9uZVByaXZhdGUpID0+IHtcbiAgLypcbiAgICogVGhpcyBjb2RlIHBhdGNoZXMgRXJyb3Igc28gdGhhdDpcbiAgICogICAtIEl0IGlnbm9yZXMgdW4tbmVlZGVkIHN0YWNrIGZyYW1lcy5cbiAgICogICAtIEl0IFNob3dzIHRoZSBhc3NvY2lhdGVkIFpvbmUgZm9yIHJlYWNoIGZyYW1lLlxuICAgKi9cblxuICBjb25zdCBlbnVtIEZyYW1lVHlwZSB7XG4gICAgLy8vIFNraXAgdGhpcyBmcmFtZSB3aGVuIHByaW50aW5nIG91dCBzdGFja1xuICAgIGJsYWNrTGlzdCxcbiAgICAvLy8gVGhpcyBmcmFtZSBtYXJrcyB6b25lIHRyYW5zaXRpb25cbiAgICB0cmFuc2l0aW9uXG4gIH1cblxuICBjb25zdCBibGFja2xpc3RlZFN0YWNrRnJhbWVzU3ltYm9sID0gYXBpLnN5bWJvbCgnYmxhY2tsaXN0ZWRTdGFja0ZyYW1lcycpO1xuICBjb25zdCBOYXRpdmVFcnJvciA9IGdsb2JhbFthcGkuc3ltYm9sKCdFcnJvcicpXSA9IGdsb2JhbFsnRXJyb3InXTtcbiAgLy8gU3RvcmUgdGhlIGZyYW1lcyB3aGljaCBzaG91bGQgYmUgcmVtb3ZlZCBmcm9tIHRoZSBzdGFjayBmcmFtZXNcbiAgY29uc3QgYmxhY2tMaXN0ZWRTdGFja0ZyYW1lczoge1tmcmFtZTogc3RyaW5nXTogRnJhbWVUeXBlfSA9IHt9O1xuICAvLyBXZSBtdXN0IGZpbmQgdGhlIGZyYW1lIHdoZXJlIEVycm9yIHdhcyBjcmVhdGVkLCBvdGhlcndpc2Ugd2UgYXNzdW1lIHdlIGRvbid0IHVuZGVyc3RhbmQgc3RhY2tcbiAgbGV0IHpvbmVBd2FyZUZyYW1lMTogc3RyaW5nO1xuICBsZXQgem9uZUF3YXJlRnJhbWUyOiBzdHJpbmc7XG5cbiAgZ2xvYmFsWydFcnJvciddID0gWm9uZUF3YXJlRXJyb3I7XG4gIGNvbnN0IHN0YWNrUmV3cml0ZSA9ICdzdGFja1Jld3JpdGUnO1xuXG4gIC8qKlxuICAgKiBUaGlzIGlzIFpvbmVBd2FyZUVycm9yIHdoaWNoIHByb2Nlc3NlcyB0aGUgc3RhY2sgZnJhbWUgYW5kIGNsZWFucyB1cCBleHRyYSBmcmFtZXMgYXMgd2VsbCBhc1xuICAgKiBhZGRzIHpvbmUgaW5mb3JtYXRpb24gdG8gaXQuXG4gICAqL1xuICBmdW5jdGlvbiBab25lQXdhcmVFcnJvcigpOiBFcnJvciB7XG4gICAgLy8gV2UgYWx3YXlzIGhhdmUgdG8gcmV0dXJuIG5hdGl2ZSBlcnJvciBvdGhlcndpc2UgdGhlIGJyb3dzZXIgY29uc29sZSB3aWxsIG5vdCB3b3JrLlxuICAgIGxldCBlcnJvcjogRXJyb3IgPSBOYXRpdmVFcnJvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgIC8vIFNhdmUgb3JpZ2luYWwgc3RhY2sgdHJhY2VcbiAgICBjb25zdCBvcmlnaW5hbFN0YWNrID0gKGVycm9yIGFzIGFueSlbJ29yaWdpbmFsU3RhY2snXSA9IGVycm9yLnN0YWNrO1xuXG4gICAgLy8gUHJvY2VzcyB0aGUgc3RhY2sgdHJhY2UgYW5kIHJld3JpdGUgdGhlIGZyYW1lcy5cbiAgICBpZiAoKFpvbmVBd2FyZUVycm9yIGFzIGFueSlbc3RhY2tSZXdyaXRlXSAmJiBvcmlnaW5hbFN0YWNrKSB7XG4gICAgICBsZXQgZnJhbWVzOiBzdHJpbmdbXSA9IG9yaWdpbmFsU3RhY2suc3BsaXQoJ1xcbicpO1xuICAgICAgbGV0IHpvbmVGcmFtZSA9IGFwaS5jdXJyZW50Wm9uZUZyYW1lKCk7XG4gICAgICBsZXQgaSA9IDA7XG4gICAgICAvLyBGaW5kIHRoZSBmaXJzdCBmcmFtZVxuICAgICAgd2hpbGUgKCEoZnJhbWVzW2ldID09PSB6b25lQXdhcmVGcmFtZTEgfHwgZnJhbWVzW2ldID09PSB6b25lQXdhcmVGcmFtZTIpICYmXG4gICAgICAgICAgICAgaSA8IGZyYW1lcy5sZW5ndGgpIHtcbiAgICAgICAgaSsrO1xuICAgICAgfVxuICAgICAgZm9yICg7IGkgPCBmcmFtZXMubGVuZ3RoICYmIHpvbmVGcmFtZTsgaSsrKSB7XG4gICAgICAgIGxldCBmcmFtZSA9IGZyYW1lc1tpXTtcbiAgICAgICAgaWYgKGZyYW1lLnRyaW0oKSkge1xuICAgICAgICAgIHN3aXRjaCAoYmxhY2tMaXN0ZWRTdGFja0ZyYW1lc1tmcmFtZV0pIHtcbiAgICAgICAgICAgIGNhc2UgRnJhbWVUeXBlLmJsYWNrTGlzdDpcbiAgICAgICAgICAgICAgZnJhbWVzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgICAgaS0tO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRnJhbWVUeXBlLnRyYW5zaXRpb246XG4gICAgICAgICAgICAgIGlmICh6b25lRnJhbWUucGFyZW50KSB7XG4gICAgICAgICAgICAgICAgLy8gVGhpcyBpcyB0aGUgc3BlY2lhbCBmcmFtZSB3aGVyZSB6b25lIGNoYW5nZWQuIFByaW50IGFuZCBwcm9jZXNzIGl0IGFjY29yZGluZ2x5XG4gICAgICAgICAgICAgICAgem9uZUZyYW1lID0gem9uZUZyYW1lLnBhcmVudDtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB6b25lRnJhbWUgPSBudWxsO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGZyYW1lcy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICAgIGktLTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICBmcmFtZXNbaV0gKz0gYCBbJHt6b25lRnJhbWUuem9uZS5uYW1lfV1gO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgZXJyb3Iuc3RhY2sgPSBlcnJvci56b25lQXdhcmVTdGFjayA9IGZyYW1lcy5qb2luKCdcXG4nKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLy8gaWdub3JlIGFzIHNvbWUgYnJvd3NlcnMgZG9uJ3QgYWxsb3cgb3ZlcnJpZGluZyBvZiBzdGFja1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzIGluc3RhbmNlb2YgTmF0aXZlRXJyb3IgJiYgdGhpcy5jb25zdHJ1Y3RvciAhPSBOYXRpdmVFcnJvcikge1xuICAgICAgLy8gV2UgZ290IGNhbGxlZCB3aXRoIGEgYG5ld2Agb3BlcmF0b3IgQU5EIHdlIGFyZSBzdWJjbGFzcyBvZiBab25lQXdhcmVFcnJvclxuICAgICAgLy8gaW4gdGhhdCBjYXNlIHdlIGhhdmUgdG8gY29weSBhbGwgb2Ygb3VyIHByb3BlcnRpZXMgdG8gYHRoaXNgLlxuICAgICAgT2JqZWN0LmtleXMoZXJyb3IpLmNvbmNhdCgnc3RhY2snLCAnbWVzc2FnZScpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IChlcnJvciBhcyBhbnkpW2tleV07XG4gICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlO1xuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIC8vIGlnbm9yZSB0aGUgYXNzaWdubWVudCBpbiBjYXNlIGl0IGlzIGEgc2V0dGVyIGFuZCBpdCB0aHJvd3MuXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICByZXR1cm4gZXJyb3I7XG4gIH1cblxuICAvLyBDb3B5IHRoZSBwcm90b3R5cGUgc28gdGhhdCBpbnN0YW5jZW9mIG9wZXJhdG9yIHdvcmtzIGFzIGV4cGVjdGVkXG4gIFpvbmVBd2FyZUVycm9yLnByb3RvdHlwZSA9IE5hdGl2ZUVycm9yLnByb3RvdHlwZTtcbiAgKFpvbmVBd2FyZUVycm9yIGFzIGFueSlbYmxhY2tsaXN0ZWRTdGFja0ZyYW1lc1N5bWJvbF0gPSBibGFja0xpc3RlZFN0YWNrRnJhbWVzO1xuICAoWm9uZUF3YXJlRXJyb3IgYXMgYW55KVtzdGFja1Jld3JpdGVdID0gZmFsc2U7XG5cbiAgLy8gdGhvc2UgcHJvcGVydGllcyBuZWVkIHNwZWNpYWwgaGFuZGxpbmdcbiAgY29uc3Qgc3BlY2lhbFByb3BlcnR5TmFtZXMgPSBbJ3N0YWNrVHJhY2VMaW1pdCcsICdjYXB0dXJlU3RhY2tUcmFjZScsICdwcmVwYXJlU3RhY2tUcmFjZSddO1xuICAvLyB0aG9zZSBwcm9wZXJ0aWVzIG9mIE5hdGl2ZUVycm9yIHNob3VsZCBiZSBzZXQgdG8gWm9uZUF3YXJlRXJyb3JcbiAgY29uc3QgbmF0aXZlRXJyb3JQcm9wZXJ0aWVzID0gT2JqZWN0LmtleXMoTmF0aXZlRXJyb3IpO1xuICBpZiAobmF0aXZlRXJyb3JQcm9wZXJ0aWVzKSB7XG4gICAgbmF0aXZlRXJyb3JQcm9wZXJ0aWVzLmZvckVhY2gocHJvcCA9PiB7XG4gICAgICBpZiAoc3BlY2lhbFByb3BlcnR5TmFtZXMuZmlsdGVyKHNwID0+IHNwID09PSBwcm9wKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFpvbmVBd2FyZUVycm9yLCBwcm9wLCB7XG4gICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldHVybiBOYXRpdmVFcnJvcltwcm9wXTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgICAgICAgIE5hdGl2ZUVycm9yW3Byb3BdID0gdmFsdWU7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGlmIChOYXRpdmVFcnJvci5oYXNPd25Qcm9wZXJ0eSgnc3RhY2tUcmFjZUxpbWl0JykpIHtcbiAgICAvLyBFeHRlbmQgZGVmYXVsdCBzdGFjayBsaW1pdCBhcyB3ZSB3aWxsIGJlIHJlbW92aW5nIGZldyBmcmFtZXMuXG4gICAgTmF0aXZlRXJyb3Iuc3RhY2tUcmFjZUxpbWl0ID0gTWF0aC5tYXgoTmF0aXZlRXJyb3Iuc3RhY2tUcmFjZUxpbWl0LCAxNSk7XG5cbiAgICAvLyBtYWtlIHN1cmUgdGhhdCBab25lQXdhcmVFcnJvciBoYXMgdGhlIHNhbWUgcHJvcGVydHkgd2hpY2ggZm9yd2FyZHMgdG8gTmF0aXZlRXJyb3IuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFpvbmVBd2FyZUVycm9yLCAnc3RhY2tUcmFjZUxpbWl0Jywge1xuICAgICAgZ2V0OiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIE5hdGl2ZUVycm9yLnN0YWNrVHJhY2VMaW1pdDtcbiAgICAgIH0sXG4gICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICAgIHJldHVybiBOYXRpdmVFcnJvci5zdGFja1RyYWNlTGltaXQgPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGlmIChOYXRpdmVFcnJvci5oYXNPd25Qcm9wZXJ0eSgnY2FwdHVyZVN0YWNrVHJhY2UnKSkge1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShab25lQXdhcmVFcnJvciwgJ2NhcHR1cmVTdGFja1RyYWNlJywge1xuICAgICAgLy8gYWRkIG5hbWVkIGZ1bmN0aW9uIGhlcmUgYmVjYXVzZSB3ZSBuZWVkIHRvIHJlbW92ZSB0aGlzXG4gICAgICAvLyBzdGFjayBmcmFtZSB3aGVuIHByZXBhcmVTdGFja1RyYWNlIGJlbG93XG4gICAgICB2YWx1ZTogZnVuY3Rpb24gem9uZUNhcHR1cmVTdGFja1RyYWNlKHRhcmdldE9iamVjdDogT2JqZWN0LCBjb25zdHJ1Y3Rvck9wdD86IEZ1bmN0aW9uKSB7XG4gICAgICAgIE5hdGl2ZUVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRhcmdldE9iamVjdCwgY29uc3RydWN0b3JPcHQpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgWk9ORV9DQVBUVVJFU1RBQ0tUUkFDRSA9ICd6b25lQ2FwdHVyZVN0YWNrVHJhY2UnO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoWm9uZUF3YXJlRXJyb3IsICdwcmVwYXJlU3RhY2tUcmFjZScsIHtcbiAgICBnZXQ6IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIE5hdGl2ZUVycm9yLnByZXBhcmVTdGFja1RyYWNlO1xuICAgIH0sXG4gICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgaWYgKCF2YWx1ZSB8fCB0eXBlb2YgdmFsdWUgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgcmV0dXJuIE5hdGl2ZUVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdmFsdWU7XG4gICAgICB9XG4gICAgICByZXR1cm4gTmF0aXZlRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBmdW5jdGlvbihcbiAgICAgICAgICAgICAgICAgZXJyb3I6IEVycm9yLCBzdHJ1Y3R1cmVkU3RhY2tUcmFjZToge2dldEZ1bmN0aW9uTmFtZTogRnVuY3Rpb259W10pIHtcbiAgICAgICAgLy8gcmVtb3ZlIGFkZGl0aW9uYWwgc3RhY2sgaW5mb3JtYXRpb24gZnJvbSBab25lQXdhcmVFcnJvci5jYXB0dXJlU3RhY2tUcmFjZVxuICAgICAgICBpZiAoc3RydWN0dXJlZFN0YWNrVHJhY2UpIHtcbiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0cnVjdHVyZWRTdGFja1RyYWNlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBzdCA9IHN0cnVjdHVyZWRTdGFja1RyYWNlW2ldO1xuICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBmaXJzdCBmdW5jdGlvbiB3aGljaCBuYW1lIGlzIHpvbmVDYXB0dXJlU3RhY2tUcmFjZVxuICAgICAgICAgICAgaWYgKHN0LmdldEZ1bmN0aW9uTmFtZSgpID09PSBaT05FX0NBUFRVUkVTVEFDS1RSQUNFKSB7XG4gICAgICAgICAgICAgIHN0cnVjdHVyZWRTdGFja1RyYWNlLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZS5hcHBseSh0aGlzLCBbZXJyb3IsIHN0cnVjdHVyZWRTdGFja1RyYWNlXSk7XG4gICAgICB9O1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gTm93IHdlIG5lZWQgdG8gcG9wdWxhdGUgdGhlIGBibGFja2xpc3RlZFN0YWNrRnJhbWVzYCBhcyB3ZWxsIGFzIGZpbmQgdGhlXG4gIC8vIHJ1bi9ydW5HdWFyZGVkL3J1blRhc2sgZnJhbWVzLiBUaGlzIGlzIGRvbmUgYnkgY3JlYXRpbmcgYSBkZXRlY3Qgem9uZSBhbmQgdGhlbiB0aHJlYWRpbmdcbiAgLy8gdGhlIGV4ZWN1dGlvbiB0aHJvdWdoIGFsbCBvZiB0aGUgYWJvdmUgbWV0aG9kcyBzbyB0aGF0IHdlIGNhbiBsb29rIGF0IHRoZSBzdGFjayB0cmFjZSBhbmRcbiAgLy8gZmluZCB0aGUgZnJhbWVzIG9mIGludGVyZXN0LlxuICBjb25zdCBaT05FX0FXQVJFX0VSUk9SID0gJ1pvbmVBd2FyZUVycm9yJztcbiAgY29uc3QgRVJST1JfRE9UID0gJ0Vycm9yLic7XG4gIGNvbnN0IEVNUFRZID0gJyc7XG4gIGNvbnN0IFJVTl9HVUFSREVEID0gJ3J1bkd1YXJkZWQnO1xuICBjb25zdCBSVU5fVEFTSyA9ICdydW5UYXNrJztcbiAgY29uc3QgUlVOID0gJ3J1bic7XG4gIGNvbnN0IEJSQUNLRVRTID0gJygnO1xuICBjb25zdCBBVCA9ICdAJztcblxuICBsZXQgZGV0ZWN0Wm9uZTogWm9uZSA9IFpvbmUuY3VycmVudC5mb3JrKHtcbiAgICBuYW1lOiAnZGV0ZWN0JyxcbiAgICBvbkhhbmRsZUVycm9yOiBmdW5jdGlvbihwYXJlbnRaRDogWm9uZURlbGVnYXRlLCBjdXJyZW50OiBab25lLCB0YXJnZXQ6IFpvbmUsIGVycm9yOiBhbnkpOlxuICAgICAgICBib29sZWFuIHtcbiAgICAgICAgICBpZiAoZXJyb3Iub3JpZ2luYWxTdGFjayAmJiBFcnJvciA9PT0gWm9uZUF3YXJlRXJyb3IpIHtcbiAgICAgICAgICAgIGxldCBmcmFtZXMgPSBlcnJvci5vcmlnaW5hbFN0YWNrLnNwbGl0KC9cXG4vKTtcbiAgICAgICAgICAgIGxldCBydW5GcmFtZSA9IGZhbHNlLCBydW5HdWFyZGVkRnJhbWUgPSBmYWxzZSwgcnVuVGFza0ZyYW1lID0gZmFsc2U7XG4gICAgICAgICAgICB3aGlsZSAoZnJhbWVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICBsZXQgZnJhbWUgPSBmcmFtZXMuc2hpZnQoKTtcbiAgICAgICAgICAgICAgLy8gT24gc2FmYXJpIGl0IGlzIHBvc3NpYmxlIHRvIGhhdmUgc3RhY2sgZnJhbWUgd2l0aCBubyBsaW5lIG51bWJlci5cbiAgICAgICAgICAgICAgLy8gVGhpcyBjaGVjayBtYWtlcyBzdXJlIHRoYXQgd2UgZG9uJ3QgZmlsdGVyIGZyYW1lcyBvbiBuYW1lIG9ubHkgKG11c3QgaGF2ZVxuICAgICAgICAgICAgICAvLyBsaW5lbnVtYmVyKVxuICAgICAgICAgICAgICBpZiAoLzpcXGQrOlxcZCsvLnRlc3QoZnJhbWUpKSB7XG4gICAgICAgICAgICAgICAgLy8gR2V0IHJpZCBvZiB0aGUgcGF0aCBzbyB0aGF0IHdlIGRvbid0IGFjY2lkZW50YWxseSBmaW5kIGZ1bmN0aW9uIG5hbWUgaW4gcGF0aC5cbiAgICAgICAgICAgICAgICAvLyBJbiBjaHJvbWUgdGhlIHNlcGFyYXRvciBpcyBgKGAgYW5kIGBAYCBpbiBGRiBhbmQgc2FmYXJpXG4gICAgICAgICAgICAgICAgLy8gQ2hyb21lOiBhdCBab25lLnJ1biAoem9uZS5qczoxMDApXG4gICAgICAgICAgICAgICAgLy8gQ2hyb21lOiBhdCBab25lLnJ1biAoaHR0cDovL2xvY2FsaG9zdDo5ODc2L2Jhc2UvYnVpbGQvbGliL3pvbmUuanM6MTAwOjI0KVxuICAgICAgICAgICAgICAgIC8vIEZpcmVGb3g6IFpvbmUucHJvdG90eXBlLnJ1bkBodHRwOi8vbG9jYWxob3N0Ojk4NzYvYmFzZS9idWlsZC9saWIvem9uZS5qczoxMDE6MjRcbiAgICAgICAgICAgICAgICAvLyBTYWZhcmk6IHJ1bkBodHRwOi8vbG9jYWxob3N0Ojk4NzYvYmFzZS9idWlsZC9saWIvem9uZS5qczoxMDE6MjRcbiAgICAgICAgICAgICAgICBsZXQgZm5OYW1lOiBzdHJpbmcgPSBmcmFtZS5zcGxpdChCUkFDS0VUUylbMF0uc3BsaXQoQVQpWzBdO1xuICAgICAgICAgICAgICAgIGxldCBmcmFtZVR5cGUgPSBGcmFtZVR5cGUudHJhbnNpdGlvbjtcbiAgICAgICAgICAgICAgICBpZiAoZm5OYW1lLmluZGV4T2YoWk9ORV9BV0FSRV9FUlJPUikgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICB6b25lQXdhcmVGcmFtZTEgPSBmcmFtZTtcbiAgICAgICAgICAgICAgICAgIHpvbmVBd2FyZUZyYW1lMiA9IGZyYW1lLnJlcGxhY2UoRVJST1JfRE9ULCBFTVBUWSk7XG4gICAgICAgICAgICAgICAgICBibGFja0xpc3RlZFN0YWNrRnJhbWVzW3pvbmVBd2FyZUZyYW1lMl0gPSBGcmFtZVR5cGUuYmxhY2tMaXN0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZm5OYW1lLmluZGV4T2YoUlVOX0dVQVJERUQpICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgcnVuR3VhcmRlZEZyYW1lID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZuTmFtZS5pbmRleE9mKFJVTl9UQVNLKSAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgIHJ1blRhc2tGcmFtZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmbk5hbWUuaW5kZXhPZihSVU4pICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgcnVuRnJhbWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBmcmFtZVR5cGUgPSBGcmFtZVR5cGUuYmxhY2tMaXN0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBibGFja0xpc3RlZFN0YWNrRnJhbWVzW2ZyYW1lXSA9IGZyYW1lVHlwZTtcbiAgICAgICAgICAgICAgICAvLyBPbmNlIHdlIGZpbmQgYWxsIG9mIHRoZSBmcmFtZXMgd2UgY2FuIHN0b3AgbG9va2luZy5cbiAgICAgICAgICAgICAgICBpZiAocnVuRnJhbWUgJiYgcnVuR3VhcmRlZEZyYW1lICYmIHJ1blRhc2tGcmFtZSkge1xuICAgICAgICAgICAgICAgICAgKFpvbmVBd2FyZUVycm9yIGFzIGFueSlbc3RhY2tSZXdyaXRlXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gIH0pIGFzIFpvbmU7XG4gIC8vIGNhcmVmdWxseSBjb25zdHJ1Y3RvciBhIHN0YWNrIGZyYW1lIHdoaWNoIGNvbnRhaW5zIGFsbCBvZiB0aGUgZnJhbWVzIG9mIGludGVyZXN0IHdoaWNoXG4gIC8vIG5lZWQgdG8gYmUgZGV0ZWN0ZWQgYW5kIGJsYWNrbGlzdGVkLlxuXG4gIGNvbnN0IGNoaWxkRGV0ZWN0Wm9uZSA9IGRldGVjdFpvbmUuZm9yayh7XG4gICAgbmFtZTogJ2NoaWxkJyxcbiAgICBvblNjaGVkdWxlVGFzazogZnVuY3Rpb24oZGVsZWdhdGUsIGN1cnIsIHRhcmdldCwgdGFzaykge1xuICAgICAgcmV0dXJuIGRlbGVnYXRlLnNjaGVkdWxlVGFzayh0YXJnZXQsIHRhc2spO1xuICAgIH0sXG4gICAgb25JbnZva2VUYXNrOiBmdW5jdGlvbihkZWxlZ2F0ZSwgY3VyciwgdGFyZ2V0LCB0YXNrLCBhcHBseVRoaXMsIGFwcGx5QXJncykge1xuICAgICAgcmV0dXJuIGRlbGVnYXRlLmludm9rZVRhc2sodGFyZ2V0LCB0YXNrLCBhcHBseVRoaXMsIGFwcGx5QXJncyk7XG4gICAgfSxcbiAgICBvbkNhbmNlbFRhc2s6IGZ1bmN0aW9uKGRlbGVnYXRlLCBjdXJyLCB0YXJnZXQsIHRhc2spIHtcbiAgICAgIHJldHVybiBkZWxlZ2F0ZS5jYW5jZWxUYXNrKHRhcmdldCwgdGFzayk7XG4gICAgfSxcbiAgICBvbkludm9rZTogZnVuY3Rpb24oZGVsZWdhdGUsIGN1cnIsIHRhcmdldCwgY2FsbGJhY2ssIGFwcGx5VGhpcywgYXBwbHlBcmdzLCBzb3VyY2UpIHtcbiAgICAgIHJldHVybiBkZWxlZ2F0ZS5pbnZva2UodGFyZ2V0LCBjYWxsYmFjaywgYXBwbHlUaGlzLCBhcHBseUFyZ3MsIHNvdXJjZSk7XG4gICAgfVxuICB9KTtcblxuICAvLyB3ZSBuZWVkIHRvIGRldGVjdCBhbGwgem9uZSByZWxhdGVkIGZyYW1lcywgaXQgd2lsbFxuICAvLyBleGNlZWQgZGVmYXVsdCBzdGFja1RyYWNlTGltaXQsIHNvIHdlIHNldCBpdCB0b1xuICAvLyBsYXJnZXIgbnVtYmVyIGhlcmUsIGFuZCByZXN0b3JlIGl0IGFmdGVyIGRldGVjdCBmaW5pc2guXG4gIGNvbnN0IG9yaWdpbmFsU3RhY2tUcmFjZUxpbWl0ID0gRXJyb3Iuc3RhY2tUcmFjZUxpbWl0O1xuICBFcnJvci5zdGFja1RyYWNlTGltaXQgPSAxMDA7XG4gIC8vIHdlIHNjaGVkdWxlIGV2ZW50L21pY3JvL21hY3JvIHRhc2ssIGFuZCBpbnZva2UgdGhlbVxuICAvLyB3aGVuIG9uU2NoZWR1bGUsIHNvIHdlIGNhbiBnZXQgYWxsIHN0YWNrIHRyYWNlcyBmb3JcbiAgLy8gYWxsIGtpbmRzIG9mIHRhc2tzIHdpdGggb25lIGVycm9yIHRocm93bi5cbiAgY2hpbGREZXRlY3Rab25lLnJ1bigoKSA9PiB7XG4gICAgY2hpbGREZXRlY3Rab25lLnJ1bkd1YXJkZWQoKCkgPT4ge1xuICAgICAgY29uc3QgZmFrZVRyYW5zaXRpb25UbyA9XG4gICAgICAgICAgKHRvU3RhdGU6IFRhc2tTdGF0ZSwgZnJvbVN0YXRlMTogVGFza1N0YXRlLCBmcm9tU3RhdGUyOiBUYXNrU3RhdGUpID0+IHt9O1xuICAgICAgY2hpbGREZXRlY3Rab25lLnNjaGVkdWxlRXZlbnRUYXNrKFxuICAgICAgICAgIGJsYWNrbGlzdGVkU3RhY2tGcmFtZXNTeW1ib2wsXG4gICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgY2hpbGREZXRlY3Rab25lLnNjaGVkdWxlTWFjcm9UYXNrKFxuICAgICAgICAgICAgICAgIGJsYWNrbGlzdGVkU3RhY2tGcmFtZXNTeW1ib2wsXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgY2hpbGREZXRlY3Rab25lLnNjaGVkdWxlTWljcm9UYXNrKFxuICAgICAgICAgICAgICAgICAgICAgIGJsYWNrbGlzdGVkU3RhY2tGcmFtZXNTeW1ib2wsXG4gICAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IChab25lQXdhcmVFcnJvciBhcyBhbnkpKFpvbmVBd2FyZUVycm9yLCBOYXRpdmVFcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICh0OiBUYXNrKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAodCBhcyBhbnkpLl90cmFuc2l0aW9uVG8gPSBmYWtlVHJhbnNpdGlvblRvO1xuICAgICAgICAgICAgICAgICAgICAgICAgdC5pbnZva2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgKHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICh0IGFzIGFueSkuX3RyYW5zaXRpb25UbyA9IGZha2VUcmFuc2l0aW9uVG87XG4gICAgICAgICAgICAgICAgICB0Lmludm9rZSgpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKCkgPT4ge30pO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICAodCkgPT4ge1xuICAgICAgICAgICAgKHQgYXMgYW55KS5fdHJhbnNpdGlvblRvID0gZmFrZVRyYW5zaXRpb25UbztcbiAgICAgICAgICAgIHQuaW52b2tlKCk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAoKSA9PiB7fSk7XG4gICAgfSk7XG4gIH0pO1xuICBFcnJvci5zdGFja1RyYWNlTGltaXQgPSBvcmlnaW5hbFN0YWNrVHJhY2VMaW1pdDtcbn0pO1xuIl19