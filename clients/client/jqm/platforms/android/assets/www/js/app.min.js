function chatFocus(){console.log("chatfocus"),isPhone&&($("#page_chat #chattext").show(),$("#page_chat #chataudio2").hide(),$("#page_chat #chatfoto2").hide())}function chatBlurTimerHide(){isPhone&&($("#page_chat #chattext").hide(),$("#page_chat #chataudio2").show(),$("#page_chat #chatfoto2").show()),clearChatBlurTimer()}function clearChatBlurTimer(){window.clearTimeout(chatblurtimer)}function chatBlur(){console.log("chatblur"),chatblurtimer=window.setTimeout(chatBlurTimerHide,2e3)}function editUserProfile(){alert("non ancora implementato")}function tabbize(e){return}function setBadge(){var e=chatunreadcount;colog("chat non letti totali: "+e),0==e?isPhone&&cordova.plugins.notification.badge.clear():isPhone&&cordova.plugins.notification.badge.set(e)}function getChatNonLetti(e){for(var t=0,a=0;a<chatnonletti.length;a++){var o=chatnonletti[a];o.garaid&&o.garaid==e&&(t=o.count,!0)}return t}function setChatNonLetti(e,t){for(var a=!1,o=0;o<chatnonletti.length;o++){var r=chatnonletti[o];r.garaid&&r.garaid==e&&(r.count=t,a=!0)}if(0==a){var i={garaid:e,count:t};t>0&&chatnonletti.push(i)}setCookie("chat_unread",chatunreadcount)}function addChatNonLetti(e){return}function deleteFromRealtimeArray(e){for(var t=0;t<realtimeArray.length;t++){var a=realtimeArray[t],o=a.garaid+"_"+a.matchid;e==o&&(found=!0,colog("found key to delete "+o),realtimeArray.splice(t,1),colog("deleting from realtime array "+e))}}function getFromRealtimeArray(e){for(var t=null,a=0;a<realtimeArray.length;a++){var o=realtimeArray[a];e==o.garaid+"_"+o.matchid&&(found=!0,realtimeArray[a]=data,t=data)}return t}function syncRealtimeArray(e){return}function addLastRealtimeData(e){conslog("addLastRealtimeData"),conslog(e);for(var t=e.garaid+"_"+e.matchid,a=!1,o=0;o<realtimeArray.length;o++){var r=realtimeArray[o];r.garaid+"_"+r.id==t&&(conslog("found realtimeArray element to update"),r.lastrealtimedata=e,a=!0)}a||conslog("match "+t+" not found in realtimeArray")}function checkRealtimeArray(e,t){conslog("checkrealtimearray",e,t),null==t&&(t=!0),console.log("checkrealtimearray - changedata: "+t),console.log(e);for(var a=e.garaid+"_"+e.matchid,o=!1,r=0;r<realtimeArray.length;r++){var i=realtimeArray[r];a==i.garaid+"_"+i.matchid&&(o=!0,console.log("match "+a+" found in realtimearray"))}o||(console.log("match "+a+" not found in realtimearray, pushing it"),realtimeArray.push(e),checkConsoles(e.matchid,e))}function resizeImage(e){var t=$(e);t.removeAttr("width").removeAttr("height");var a=jQuery(e).parent();conslog("cw: "+a.css("width")+" - ch: "+a.css("height"));var o=parseInt(t.css("width").replace("px",""),10),r=parseInt(t.css("height").replace("px",""),10);o=$(e).get(0).naturalWidth,r=$(e).get(0).naturalHeight;var i=a.css("width")/o,n=a.css("height")/r;Math.max(i,n);conslog("w: "+o+" - height: "+r);var s=parseInt(a.css("width").replace("px",""),10),c=s/o;conslog("ratio2: "+c);var l=Math.ceil(c*r);conslog("newwidth: "+s+" - newheight: "+l),t.css({width:s,height:l})}function colog_old(e){debugActive&&console.log(e)}function toggleLeftMenu(){var e=$.mobile.activePage.attr("id");$("#"+e+" #menuPanel").length>0&&$("#"+e+" #menuPanel").remove();var t={loggedin:loggedin},a=new EJS({url:"tpl/menupanel.ejs"}).render(t);$("#"+e).append(a),$("#"+e+" #menuPanel").panel(),$("#"+e+" #menuPanel").panel("toggle")}function toggleRightMenu(e){var t=$.mobile.activePage.attr("id");$("#"+t+" #"+e).length>0&&$("#"+t+" #"+e).remove();var a={loggedin:loggedin,role:role},o=new EJS({url:"tpl/"+e+".ejs"}).render(a);$("#"+t).append(o),$("#"+t+" #"+e).panel(),$("#"+t+" #"+e).panel("toggle")}function setMatchesRefresh(){autorefresh&&(autorefreshcount++,console.log("running "),1==autorefreshcount&&setInterval(function(){refreshMatches()},timerMatches))}function toggleCheckbox(e,t){var a=$(e).prop("checked"),o=$("#"+t);conslog(a),a?o.show():o.hide()}function openPopup(e,t){if(1!=page_popup){t||(t="");var a=$.mobile.activePage.attr("id");conslog("current pageid: "+a),$("#"+a+" div[data-role=content] #temppopup").remove();var o=new EJS({url:"tpl/genericpop.ejs"}).render(e);$("#"+a+" div[data-role=content]").append(o),$("#"+a+" #temppopup h5").html(t),$("#"+a+" #temppopup").popup(),$("#"+a).page("destroy").page(),$("#"+a+" #temppopup").popup("open",{transition:"flip"})}else openPopupPage(e,t)}function openPopupPage(e,t){t||(t="");var a=$.mobile.activePage.attr("id");a="page_popup",$.mobile.changePage("#page_popup"),conslog("current pageid: "+a),$("#page_popup div[data-role=content] #temppopup").remove();var o=new EJS({url:"tpl/genericpop.ejs"}).render(e);$("#page_popup div[data-role=content]").append(o),$("#page_popup #temppopup h5").html(t),$("#"+a).trigger("pagecreate")}function popCloseRemove(){var e=$.mobile.activePage.attr("id");colog("current pageid: "+e),0==page_popup?$("#"+e+" #temppopup").popup("close").remove():$.mobile.back()}function openTabulato(e){progressStart("Caricamento.."),$.ajax({url:e,type:"GET",dataType:"html"}).done(function(e){colog(e);var t=$(e).find("img[alt=drawing_load_error]").attr("src").replace("./","");colog(t),openPopup("<img style='width: 400px; height: 500px;' src='http://demo.tkdtechnology.it/"+t+"' />"),progressStop()})}function openTabulatoPageNew(e){var t=rooturl+"/crossd";$.ajax({type:"POST",url:t,data:{url:e,format:""},dataType:"html"}).done(function(e){var t=$(e).find("#banner").find("img");console.log(t.attr("src"));var a="<a href='"+t.attr("src")+"' target='_blank' >Apri nel browser</a><br><br>";$("#page_tabulato #cont").empty().append(a).append(t),$.mobile.changePage("#page_tabulato")})}function openTabulatoPage(e,t){var a=$(e).html(),o=rooturl+"/gettkdtabulato";progressStart("Caricamento.."),$.ajax({url:o,type:"POST",dataType:"html",data:{url:t}}).done(function(e){colog(e);var o=$(e).find("img[alt=drawing_load_error]").attr("src").replace("./","");colog(o);var r="<img style='width: 600px; height: 600px;' src='http://demo.tkdtechnology.it/"+o+"' />";$("#page_tabulato #cat").html(a),$("#page_tabulato #cont").html(r),progressStop(),$("#page_tabulato #url").val(t),$.mobile.changePage("#page_tabulato"),$("#page_tabulato #cont img").get(0).addEventListener("gesturechange",function(e){console.log(e.scale),e.scale>1||e.scale})})}function openTabulatoImage(){var e=$("#page_tabulato #url").val();window.open(e,"_blank","location=no&toolbar=yes")}function getTabulatoImg(e,t){progressStart("Caricamento.."),$.ajax({url:e,type:"GET",dataType:"html"}).done(function(e){colog(e);var a=$(e).find("img[alt=drawing_load_error]").attr("src").replace("./","");colog(a),t("<img style='width: 500px; height: 600px;' src='http://demo.tkdtechnology.it/"+a+"' />"),progressStop()})}function greenifyMe(e,t){if("tkdradmin"==role){var a=$(e).closest("td").parent(),o="white";t&&"true"==String(t)&&(o="lightgreen"),a.css("background",o)}}function getCrossd(e){var t=rooturl+"/crossd";$.ajax({type:"POST",url:t,data:{url:e,format:""}}).done(function(e){}).error(function(e){console.log("error",e)})}function getTkdTechnologyGiornata(e,t,a){colog("getTkdTechnologyGiornata",e,t.trim()),e||(e=$("#page_tkdtnew_giorno").find("input:hidden#idgiornata").val());var o="https://www.tkdtechnology.it/index.php/welcome/dettaglio_tabulati?id_giornata="+e;t||(t="Giornata");var r=getDataGiornata(unescape(t.trim())),i={id:e,titolo:t,datagiornata:r,tabulati:{html:"",rows:[]},medagliere:{rows:[],html:""},elenco_societa:{rows:[],html:""}};$.mobile.changePage("#page_tkdtnew_giorno");var n=imgtext+"Caricamento in corso....";$("#page_tkdtnew_giorno #cat").html(n);var s=rooturl+"/crossd";$.ajax({type:"POST",url:s,data:{url:o,format:""}}).done(function(e){var t=$("#page_tkdtnew_giorno");colog("searching div "+r);$(e).find("#"+r);for(var a=["tabulati","medagliere","elenco_societa"],o="",n=0;n<a.length;n++){var s=a[n],c=$(e).find("#"+a[n]);"medagliere"==s&&(c=$(e).find("#"+r)),c.find("table").attr("table-layout","fixed"),c.find("table").attr("width","100%").attr("border","1"),c.find("table").find("th").css("font-size","10px"),c.find("table").find("td").css("font-size","10px");var l="";if("medagliere"==s){var d="40px";(p=c.find("table").find("thead").find("tr").find("th:eq(1)")).attr("width",d);g=c.find("table").find("tbody").find("tr");console.log("tr",g.length),g.each(function(){var e=$(this).find("td:eq(1)"),t=e.text().substring(0,30)+"...";e.text(t),e.attr("width",d).css("word-wrap","break-word").css("max-width","20%"),g.attr("height","25px")})}if("tabulati"==s){var g=c.find("table").find("tbody").find("tr"),p=c.find("table").find("thead").find("tr").find("th:eq(3)");p.remove(),g.each(function(){var e=$(this).find("td:eq(5)");$(this).find("td:eq(0)").attr("onclick","greenifyMe(this,false)"),e.html(e.html().replace("Vedi","")),e.find("a").addClass("ui-btn"),e.find("a").attr("onclick","greenifyMe(this,true)");var t=$(this).find("td:eq(0)").text(),a=$(this).find("td:eq(1)").text(),o=$(this).find("td:eq(2)").text(),r=$(this).find("td:eq(3)").text(),n=$(this).find("td:eq(4)").text();$(this).find("td:eq(2)").html(o+"<br>"+r);var s=e.find("a");s.removeAttr("target");var c=s.attr("href"),l="javascript:openTabulatoPageNew('"+c+"')";s.attr("href",l);var d={href:l,oldhref:c,sesso:t,categoria_eta:a,cintura_da:o,cintura_a:r,categoria_peso:n};$(this).find("td:eq(3)").remove(),i.tabulati.rows.push(d),g.attr("height","45px")})}"elenco_societa"==s&&(c.find("div").each(function(){$(this).attr("style","width: 100%; font-size: 12px;")}),l=" style='display: none;' "),o+="<div style='padding: 4px;text-align: left; font-weight: bold; border: 1px solid black; background: cyan; width: 100%; height: 30px;' onclick='toggleMe(this,"+n+")'>"+a[n].toUpperCase()+"</div><div class='xxx' "+l+">"+c.html()+"</div><br>";var u="<div class='xxx'>"+c.html()+"</div>";i[s].html=u}o="<div>"+o+"</div>";var h=new EJS({url:"tpl/tkdtnew_giorno.ejs"}).render(i);(t=$("#page_tkdtnew_giorno")).find("#cont").html(h),t.find("h5").html("Giornata di gara"),t.trigger("create"),t.find("div.ui-collapsible-content").css("padding","0px");var m=new Date,f=m.toLocaleDateString()+" "+m.toLocaleTimeString();$("#page_tkdtnew_giorno #cat").html("Ultimo agg.: "+f),progressStop()})}function toggleMe(e,t){$(e).closest("#cont").find("div.xxx:eq("+t+")").toggle()}function getTkdTechnologyNew(e,t){var a=null;if(jGara&&jGara.gara&&(a=jGara.gara.rows[0].doc),a){if(a.tkdt_id)console.log("found tkdt_id for this gara",a.tkdt_id),e=a.tkdt_id;else if(e=prompt("Inserisci id gara TKDT","44"),console.log("tkdt_garaid",e),!e)return}else if(e=prompt("Inserisci id gara TKDT","44"),console.log("tkdt_garaid",e),!e)return;console.log("tkdt_garaid",e);var o=!1;"page_tkdtnew"==$.mobile.activePage.attr("id")&&(o=!0),o||$.mobile.changePage("#page_tkdtnew");var r="https://www.tkdtechnology.it/index.php/welcome/",i=r+"tabulati_giorni?id="+e,n={giorni:[]},s=imgtext+"Caricamento in corso....";$("#page_tkdtnew #cat").html(s);var c=rooturl+"/crossd";$.ajax({type:"POST",url:c,data:{url:i,format:""}}).done(function(e){var t=$(e).find("#banner").find(".bs-component");$(t).each(function(e){var t={titolo:"",tabulati:[],medagliere:[],enabled:!0,hasContent:!1},a=$(this).find("a"),o=a.attr("href");if("disabled"==a.attr("disabled"))o=(o=a.text()).replace("I tabulati per questa giornata non sono ancora stati pubblicati",""),t.enabled=!1,t.titolo=o,t.hasContent=!1;else{var r=getQsFromUrl(o,"id_giornata");console.log("giornatagara",r),t.id_giornata=r,t.enabled=!0,t.titolo=a.text(),t.datagiorno=getDataGiornata(t.titolo),t.hasContent=!0}n.giorni.push(t)});var a=new EJS({url:"tpl/tkdtnew.ejs"}).render(n);$("#page_tkdtnew").find("#cont").html(a),colog("tkdtnew",n),$("#page_tkdtnew").find("h5").html("Giornate di gara"),$("#page_tkdtnew").trigger("create"),progressStop();var o=new Date,r=o.toLocaleDateString()+" "+o.toLocaleTimeString();$("#page_tkdtnew #cat").html("Ultimo agg.: "+r)})}function getTkdTechnology(e){silenttkdt||$("#page_tdkt").is(":visible")||(colog("page_tkdt not visible, showing it"),$.mobile.changePage("#page_tkdt")),enableprogress&&progressStart("Caricamento.."),$("#page_tkdt .update").html("Aggiornamento...");var t=rooturl+"/gettkdtech";$.ajax({url:t,type:"GET"}).done(function(t){tkdt_iscritti={rows:[],avversari:[],tabulati:[]};var a=$(t).find("div#tab-63-atl-cls"),o=($(t).find("div#tab-63"),$(t).find("div.tabs:first ul:first li"));colog("navtabs: "+o.length);var r="";colog(t),$(o).each(function(e){var a=$(this).find("a").attr("href"),o=$(this).find("a").html();colog(o);var i=$(t).find("div"+a+"-atl-int"),n=$(t).find("div"+a+"-atl-cls"),s=$(t).find("div"+a+"-atl-tab"),c=$(t).find("div"+a+"-atl-cat"),l=n.find("table");getTkdtInteractive(i.find("table")),l.css("border","2px solid black"),l.css("width","100%"),l.find("thead tr").prepend("<th width=8>&nbsp;</th>"),l.find("th").css("background","#f6f6f6"),l.find("tr").each(function(e){var t=$(this);e>0&&$(this).prepend("<td width=10>"+e+"</td>");var a=$(this).find("td:first");colog(a.length),t.html().toLowerCase().indexOf("rozzano")>-1&&(t.find("td").css("font-weight","bold"),t.css("background","lightgreen"))});var d="";s.find("a").each(function(e){var t=$(this).html(),o=($(this),$(this).attr("href")),r={href:o,descr:t,tabn:a};tkdt_iscritti.tabulati.push(r),d+="<a style='font-size: 10px; white-space: normal;' class=tabbutton href='#' onclick=openTabulatoPage(this,'"+o+"') >"+t+"</a>"}),l.find("td").css("text-align","center"),l.find("td,th").css("font-size","12px"),l.find("td").css("border-top","1px solid gray"),r+='<div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">'+o+'</h5><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Classifica</h5>'+n.html()+'</div><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Tabulati</h5>'+d+'</div><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Atleti per categoria</h5>'+c.html()+"</div></div>"});o.html(),a.html();$("#page_tkdt").find("#cont").html(r),$("#temppopup").find("div[data-role=collapsible]").collapsible({theme:"c",refresh:!0}),$("#page_tkdt").find("div[data-role=collapsible]").collapsible({theme:"c",refresh:!0}),$("#page_tkdt").find("a.tabbutton").button(),progressStop(),colog(tkdt_iscritti);var i=new Date,n=i.toLocaleDateString()+" "+i.toLocaleTimeString();$("#page_tkdt .update").html("Ultimo agg.: "+n);var s=$.mobile.activePage.attr("id");$("#"+s+" #menuPanel").panel("close"),e&&e(r)})}function showTabulatoAtleta(){if(tkdt_iscritti.rows.length>0){colog(tkdt_iscritti.rows);var e=$("#matchesatleta #atletaid").val();colog("atletaid: "+e);var t=getAtletaById(e);console.log(t);var a=t.cognome+t.nome,o=!1;colog("cerco chiave "+a),$(tkdt_iscritti.rows).each(function(e){var r=tkdt_iscritti.rows[e],i=r.cognome+r.nome,n=r.nome+r.cognome;if(i.trim().toLowerCase()==a.trim().toLowerCase()||n.trim().toLowerCase()==a.trim().toLowerCase()){o=!0;var s="";colog(tkdt_iscritti.tabulati);var c={nome:t.cognome+" "+t.nome,categoria_peso:r.categoria_peso,categoria_cintura:r.categoria_cintura,tabulati:[]};$(tkdt_iscritti.tabulati).each(function(e){var t=tkdt_iscritti.tabulati[e].descr.toLowerCase();colog(t),t.indexOf(r.categoria_peso.toLowerCase())>-1&&t.indexOf(r.categoria_cintura.toLowerCase())>-1&&t.indexOf(r.sesso.toLowerCase()+" - ")>-1&&(s+=t+"\n",c.tabulati.push(tkdt_iscritti.tabulati[e]))}),openPopup(new EJS({url:"tpl/mytabulati.ejs"}).render(c),"Tabulati")}}),o||alert("Categoria peso non trovata per "+t.cognome+" "+t.nome)}else silenttkdt=!0,getTkdTechnology(function(){silenttkdt=!1,showTabulatoAtleta()})}function gareFilterKeypress(e){conslog("garefilterkeypress",e),clearTimeout(garefiltertimer),garefiltertimer=setTimeout(function(){conslog("garefiltertimer passed"),refreshGareServer({allfields:$("#gare #myGareFilter").val()}),clearTimeout(garefiltertimer)},1e3)}function getTkdtInteractive(e){colog("getTkdInteractive"),e.find("tbody").find("tr").each(function(){var e=$(this),t=e.find("td:eq(0)").remove("span").html(),a=e.find("td:eq(1)").remove("span").html(),o=e.find("td:eq(2)").remove("span").html(),r=e.find("td:eq(3)").remove("span").html(),i=e.find("td:eq(4)").remove("span").html(),n=e.find("td:eq(5)").remove("span").html(),s=e.find("td:eq(6)").remove("span").html();if(o.toLowerCase().trim().indexOf("rozzano")>-1){var c={cognome:t,nome:a,categoria:r,categoria_cintura:i,categoria_peso:n,sesso:s};colog("interactive: "+t+" "+a+" - "+r+" - "+n+" - "+i),tkdt_iscritti.rows.push(c)}else{var l={cognome:t,nome:a,categoria:r,categoria_cintura:i,categoria_peso:n,sesso:s};tkdt_iscritti.avversari.push(l)}}),console.log("tkdt_iscritti structure:"),console.log(tkdt_iscritti)}function cancelDelMatch(){$("#matchesatleta #popDelMatch").popup("close")}function showCarousel(){var e=$("#page_carousel"),t=new EJS({url:"tpl/carousel.ejs"}).render({});e.find("#content").html(t),e.trigger("create"),$.mobile.changePage("#page_carousel")}function readFromFile(e,t){e.file(function(e){var a=new FileReader;a.onloadend=function(e){console.log("letto !!"),t(this.result)},a.readAsText(e)},errorHandler.bind(null,e))}function isCordovaApp(){var e=!1;return colog("isCordovaApp URLAAA:"+window.document.URL),-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")&&-1===document.URL.indexOf("localhost:8100")&&(e=!0),1!=e||navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)||(e=!1),console.log("iscordovaapp",e),e}function initApp(){console.log("initApp"),app.initialize(),colog("Navigator user agent from docready "+navigator.userAgent);var e=isCordovaApp();colog("aaaa"),colog("isCordovaApp: "+e),colog("Running on phone: "+(isPhone=!!e)),isPhone||docready()}function playSound(e){clearTimeout(soundTimer),settings&&settings.sound&&"true"==String(settings.sound)&&(soundTimer=setTimeout(function(){document.getElementById("sound").innerHTML='<audio autoplay="autoplay"><source src="'+e+'.mp3" type="audio/mpeg" /><source src="'+e+'.ogg" type="audio/ogg" /><embed hidden="true" autostart="true" loop="false" src="'+e+'.mp3" /></audio>',clearTimeout(soundTimer)},soundTime))}function myToast(e){var t=$.mobile.activePage.attr("id");colog("current pageid: "+t),$("#"+t+" div[data-role=content]").append(html),$("#"+t+" #popNotification").popup(),$("#"+t+" #popNotification").popup("open"),playSound("img/chimes"),setTimeout(function(){$("#"+t+" #popNotification").popup("close").remove()},1800)}function snotify(e){if(colog("Snotify:"),colog(e),0!=settings.notifiche){var t={body:e.text.replaceAll("<b>","").replaceAll("</b>",""),icon:"img/logotkdrozzano.png"};if(isPhone)e.text=e.text.replaceAll("<br>","\n"),notify(e);else{var a=new EJS({url:"tpl/popnotification.ejs"}).render(t),o=$.mobile.activePage.attr("id");if(colog("current pageid: "+o),$("#"+o+" div[data-role=content]").append(a),$("#"+o+" #popNotification").popup(),$("#"+o+" #popNotification").popup("open"),playSound("img/chimes"),setTimeout(function(){$("#"+o+" #popNotification").popup("close").remove()},6e3),"Notification"in window)if("granted"===Notification.permission){conslog("notification are granted");var r=t;r.body=r.body.replaceAll("<br>","");new Notification("AppKwonDo",r)}else"denied"!==Notification.permission&&(colog("asking grant for notifications"),Notification.requestPermission(function(e){if("granted"===e){var a=t;a.body=a.body.replaceAll("<br>","");new Notification("AppKwonDo",a)}}));else colog("This browser does not support system notifications")}}else colog("notifiche non attive nei settings, esco senza notificare")}function closePanel(){conslog("panels found: "+$("[data-role=panel]:visible").length),$("[data-role=panel]:visible").panel("close")}function updateHomeInfos(){conslog("updateHomeInfos"),$(".serverspan").html("Connesso al server: "+rooturl.replace("http://","").replace("https://","")),$("#userName").html("<b><font style='color: blue'>"+chatuser.nickname+"</font></b><br><span class='small'>"+user.email+"</span>"),settings?$(".societaspan").html("Società: "+settings.mysocietaname):(conslog("no settings found, loading options"),loadOptions(function(){refreshAtletiServer(),refreshGareServer()}))}function recordAudio(){recorder=new Object,console.log("recordAudio "+recording),recording&&($("#cronacaelements a#recordaudio span").text("REGISTRA").css("color","black"),$("#cronacaelements a#recordaudio").css("background","silver"),recorder.stop()),recording||($("#cronacaelements  a#recordaudio span").text("FERMA REGISTRAZIONE").css("color","yellow"),$("#cronacaelements  a#recordaudio").css("background","red"),recorder.record()),recording=!recording}function recordChatAudio(){getPlatform(),console.log("recordAudio "+recording),"true"==String(recording)&&($("#page_chat #recording").hide(),$("#page_chat #chataudio2").attr("src","img/audio.png"),console.log("registrazione terminata"),isPhone&&(isIOS||recorder.stopcb(function(e){console.log(e),openPopup(new EJS({url:"tpl/recordaudiook.ejs"}).render({audio:e}),"Conferma invio")}))),"true"!=String(recording)&&($("#page_chat #recording").show(),$("#page_chat #chataudio2").attr("src","img/audiorecording.png"),console.log("registrazione in corso, premi il microfono per interrompere"),isPhone&&(isIOS?navigator.device.capture.captureAudio(function(e){console.log("mediaFiles",e);var t,a;for(t=0;t<e.length;t++)a=e[t].fullPath,console.log("path",a);recording=!1,$("#page_chat #recording").hide(),$("#page_chat #chataudio2").attr("src","img/audio.png"),console.log("registrazione terminata");var o=new Media(e[0].localURL,function(e){o.release()},function(e){console.log("media err",e)});o.play()},function(e){alert("Error code: "+e.code),console.log("error recording on ios",e),recording=!1,$("#page_chat #recording").hide(),$("#page_chat #chataudio2").attr("src","img/audio.png"),console.log("registrazione terminata")},{limit:1}):recorder.record())),recording=!recording}function cancelChatAudio(){popCloseRemove()}function sendChatAudio(e){postChat({garaid:"",nickname:chatuser.nickname,sockid:chatuser.sockid,audio:e,text:""}),popCloseRemove()}function shareText(e){isPhone&&(console.log("shareText "+e),window.plugins.socialsharing.share(e))}function shareAudio(e){if(isPhone){var t=(new Date).juliandate(),a=rooturl+"/data/chatmedia/"+e;if(e.indexOf("data:audio")>-1)window.plugins.socialsharing.share(null,t,e,null);else{var o=new XMLHttpRequest;o.open("GET",a,!0),o.overrideMimeType("text/plain; charset=x-user-defined"),o.onreadystatechange=function(){if(4==o.readyState&&200==o.status){var e="data:audio/mp3;base64,"+stringToBase64(o.responseText);window.plugins.socialsharing.share(null,t,e,null)}},o.send()}}}function shareFoto(e){if(isPhone){var t=(new Date).juliandate(),a=e;if(e.indexOf("data:image")>-1)window.plugins.socialsharing.share(null,t,e,null);else{var o=new XMLHttpRequest;o.open("GET",a,!0),o.overrideMimeType("text/plain; charset=x-user-defined"),o.onreadystatechange=function(){if(4==o.readyState&&200==o.status){var e="data:image/jpeg;base64,"+stringToBase64(o.responseText);window.plugins.socialsharing.share(null,t,e,null)}},o.send()}}}function stringToBase64(e){for(var t,a,o,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="",n=0,s=e.length;n<s;){if(t=255&e.charCodeAt(n++),n==s){i+=r.charAt(t>>2),i+=r.charAt((3&t)<<4),i+="==";break}if(a=e.charCodeAt(n++),n==s){i+=r.charAt(t>>2),i+=r.charAt((3&t)<<4|(240&a)>>4),i+=r.charAt((15&a)<<2),i+="=";break}o=e.charCodeAt(n++),i+=r.charAt(t>>2),i+=r.charAt((3&t)<<4|(240&a)>>4),i+=r.charAt((15&a)<<2|(192&o)>>6),i+=r.charAt(63&o)}return i}function playAudio(){recorder.playback()}function sendAudio(){alert("non ancora implementato")}function readAudioFile(e){function t(e){alert("ERROR: "+e.code),console.log("ERROR: ",e)}var a=window.TEMPORARY;window.requestFileSystem(a,5242880,function(a){a.root.getFile(e,{},function(e){e.file(function(e){var t=new FileReader;t.onloadend=function(e){document.getElementById("textarea").value=this.result},t.readAsText(e)},t)},t)},t)}function bindFeedback(){$(document).on(tapevent,"a",function(){conslog("primordial tap event"),isPhone&&window.plugins.deviceFeedback.acoustic()})}function playFeedback(){isPhone&&window.plugins.deviceFeedback.acoustic()}function setWaitTkdt(e){(waitactive=e)?(colog("Timer activated"),waittkdttimer=setInterval(function(){colog("Wait Interval"),enableprogress=!1,silenttkdt=!0,getTkdTechnology(function(e){""!=tkdtcontent.trim()?e!=tkdtcontent&&(colog("tkdtcontent has changed !"),snotify({text:"Contenuto Tkdt variato"}),tkdtcontent=e):tkdtcontent=e,enableprogress=!0,silenttkdt=!1})},waitinterval)):(colog("Timer deactivated"),clearInterval(waittkdttimer),silenttkdt=!1,enableprogress=!0)}function toggleWaitTkdt(){var e=!1;$("#page_tkdt #ckwait:checked").length>0&&(e=!0),setWaitTkdt(e)}function tapholdBubble(){$("#page_chat .bubble").off("taphold"),$("#page_chat .bubble").on("taphold",function(e){var t=$(this);console.log("bubble taphold");var a=t.find("span.chattext").text();if(""!=a.trim())return console.log("share text"),void shareText(a);if(t.find(".shareaudio").length>0){var o=t.find(".shareaudio").val();return console.log("share audio "),void shareAudio(o)}if(t.find("img").length>0){return(o=t.find("img").attr("src")).indexOf("data:image")>-1&&!1,console.log("share foto "),void shareFoto(o)}})}function showTkdt2(){var e=jGara.gara.rows[0].doc.tkdt_id,t=rooturl+"/tkdt/get/"+e;progressStart("Recupero dati ufficiali di gara "+e+" ...."),$.ajax({type:"GET",url:t}).done(function(e){colog(e),progressStop(),showTkdt(e)})}function showTkdtSocieta(){var e=$.mobile.activePage.attr("id"),t=tkdt_atleti_iscritti,a=[];t.sort(function(e,t){var a=e.societa.replaceAll(".",""),o=t.societa.replaceAll(".","");return a>o?1:a<o?-1:0});for(var o="",r=0;r<t.length;r++){var i=t[r];i.sesso,i.cateta,i.catcintura,i.catpeso;if("A.S.D. TAEKWONDO ROZZANO"==i.societa&&"color: blue; font-weight: bold;",i.societa!=o){var n=filterArray(t,{societa:o=i.societa});n.length;n.sort(function(e,t){var a=e.nome,o=t.nome;return a>o?1:a<o?-1:0});var s={societa:o,atleti:n};a.push(s)}}var c=getCategorieCoperte(),l="<ul>";l="<h3>"+a.length+" società iscritte</h3><br>";var d=[];$.each(a,function(e,t){l+='<div data-role="collapsible" class="collaps" data-theme="a"><h5 class="h5collaps" style="font-size: 12px;">'+t.societa+" ("+t.atleti.length+')</h5><ul data-role="listview">';var a=getCategorieCoperte(t.societa),o=0;a.cats.forEach(function(e,t){var a=e.catcintura+e.cateta+e.catpeso+e.sesso;c.cats.forEach(function(e,t){var r=e.catcintura+e.cateta+e.catpeso+e.sesso;a==r&&o++})});var r={societa:t.societa,catcoperte:a,catcondivise:o,atleti:t.atleti};d.push(r),l+="<li>Categorie coperte: <b>"+a.cats.length+"</b></li>",$.each(t.atleti,function(e,t){l+="<li><b>"+t.nome+"</b><br><span style='font-size: 14px;'>"+t.sesso+" "+t.catpeso+" "+t.catcintura+"</span></li>"}),l+="</ul></div>"}),d.sort(function(e,t){var a=e.catcoperte.cats.length,o=t.catcoperte.cats.length;return a>o?-1:a<o?1:0}),l+="<br><br><table id=catcoperte align=center border=1 width='95%'><thead><th>&nbsp;</th><th>Societa</th><th>Cat coperte</th><th>Condivise</th></thead><tbody>",d.forEach(function(e,t){var a=parseInt(t,10)+1;l+="<tr><td width=5%>"+a+"</td><td width=70%>"+e.societa+"</td><td align=center>"+e.catcoperte.cats.length+" su "+e.atleti.length+"</td><td align=center>"+e.catcondivise+"</td></tr>"}),l+="</tbody></table>",$("#"+e+" #societa").empty().append(l),$("#"+e+" #societa #catcoperte td,#catcoperte th").css("font-size","12px"),$("#"+e).trigger("create")}function showTkdtMedagliereGlobale(e){e||jGara.gara.rows[0].doc.tkdt&&jGara.gara.rows[0].doc.tkdt.giorni&&jGara.gara.rows[0].doc.tkdt.giorni.length>0&&(e=jGara.gara.rows[0].doc.tkdt.giorni[0].id,colog("using giornataid from tkdt structure"));var t=rooturl+"/tkdt/medagliereglobale/"+e;progressStart("Caricamento medagliere globale"),$.ajax({type:"GET",url:t}).done(function(t){colog("got medagliereglobale for giornata "+e),progressStop();var a=$("#page_tkdtmedagliereglobale");a.find("#cont").html(t),a.find("#cont .table-striped").attr("border","1"),a.find("#cont .table-striped").attr("width","95%"),a.find("#cont a.link_w_tooltip_gold,#page_popup a.link_w_tooltip_silver,#page_popup a.link_w_tooltip_bronze").attr("onclick","viewMedagliati(this)");var o=$.mobile.activePage.attr("id");conslog("pageid",o),"page_tkdtmedagliereglobale"!=o&&(conslog("changing page"),$.mobile.changePage("#page_tkdtmedagliereglobale"))})}function viewMedagliati(e){var t=$(e).attr("title");t=(t=(t=t.replaceAll("<br>","\n")).replaceAll("<b>","")).replaceAll("</b>",""),alert(t)}function showTkdt(e){if(jGara.gara.rows[0].doc.tkdt){colog("showtkdt"),$("#page_tkdtnew #societa").empty(),progressStart();var t=jGara.gara.rows[0].doc.tkdt;e&&(t=e),t.giorni||(t.giorni=[]);var a=new EJS({url:"tpl/tkdtnew.ejs"}).render(t);$("#page_tkdtnew").find("#cont").empty().append(a),colog("tkdtnew",t),$("#page_tkdtnew").find("h5").html("Giornate di gara");var o=new Date,r=o.toLocaleDateString()+" "+o.toLocaleTimeString();$("#page_tkdtnew #cat").html("Ultimo agg.: "+r),$.mobile.changePage("#page_tkdtnew"),$("#page_tkdtnew").trigger("create"),progressStop()}else alert("Dati ufficiali non disponibili")}function tapMedals(){getPlatform(),isIOS&&showTkdtMedagliereGlobale()}function docready(){console.log("docready"),isPhone&&cordova.plugins.notification.local.on("click",notificationClick),tabbize("#popResult #matchestabsdiv"),$("#page_broadcast #videoSource").selectmenu(),$("#page_broadcast #audioSource").selectmenu(),$.event.special.swipe.horizontalDistanceThreshold=120,$("span.medals").off(tapevent),$("span.medals").on(tapevent,function(){showTkdtMedagliereGlobale()}),$("#popResult #risult").on("taphold",function(){console.log("taphold on result"),gConfirm("Confermi il reset del punteggio ?","Conferma reset",function(){$("#popResult #risult").val("0-0")},function(){})}),"no"==getQueryString("head")&&$(document).find("[data-role=header]").remove(),isPhone?($("#page_chat #chataudio2").show(),$("#page_chat #chatfoto2").show(),$("#page_chat #chattext").hide()):($("#page_chat #tdaudio").html("&nbsp"),$("#page_chat #tdfoto").html("&nbsp"),$("#page_chat #chataudio2").hide(),$("#page_chat #chatfoto2").hide(),$("#page_chat #chattext").show()),$(window).on("navigate",function(e,t){if(colog("navigateevent",t),"popResult"==t.state.pageUrl&&"back"==t.state.direction){colog("navigated back to console");var a=$("#popResult #matchid").val();$("#popResult #consolenavb li a").removeClass("ui-btn-active");for(o=0;o<consoles.length;o++)consoles[o].match.id==a&&$("#popResult #consolenavb li a:eq("+o+")").addClass("ui-btn-active")}if("matchesatleta"==t.state.pageUrl&&"back"==t.state.direction)for(var o=0;o<consoles.length;o++){var r=!1;consoles[o].match.realtime&&"true"==String(consoles[o].match.realtime)&&(r=!0),r||consoles.splice(o,1)}t.state.direction}),$("#page_chat #chatmsg").keyup(function(e){13==e.keyCode||socket.emit("typing",{nickname:chatuser.nickname})}),console.log("Using server on "+rooturl),console.log("navigator"),console.log(navigator);var e=navigator.platform.toLowerCase();e.indexOf("ipad")>-1&&(isIOS=!0),e.indexOf("mac")>-1&&(isIOS=!0),e.indexOf("ipod")>-1&&(isIOS=!0),e.indexOf("iphone")>-1&&(isIOS=!0);var t=getCookie("cronaca_read"),a=getCookie("chat_unread");console.log("chat_unread cookie",a),null!=a&&(console.log("trovato cookie chat_unread, popolo chatnonletti"),chatunreadcount=a),console.log("cronaca_read cookie: ",t),isPhone&&(recorder.stop=function(){window.plugins.audioRecorderAPI.stop(function(e){var t=e.substring(1);e.split("/");conslog("STOP, fname: "+(t="file://"+e)),conslog("msg: "+e),myToast({body:t+"<br>"+e}),window.resolveLocalFileSystemURL(t,function(e){conslog("fileEntry: ",e),e.file(function(e){conslog("file: ",e);var t=new FileReader;conslog("reader",t),t.onload=function(){conslog("onload readystate: "+t.readyState);var e=t.result;conslog(e),sounddata=e},t.onloadend=function(e){conslog("onloadend",e)},t.onloadstart=printEventType,t.onprogress=printEventType,t.readAsDataURL(e)})},function(e){console.log("error reading file",e)}),conslog("stopaudio ok: "+e)},function(e){conslog("stopaudio ko!!: "+e)})},recorder.stopcb=function(e){window.plugins.audioRecorderAPI.stop(function(t){var a=t.substring(1);t.split("/");a="file://"+t,console.log("STOP, fname: "+a),conslog("msg: "+t),window.resolveLocalFileSystemURL(a,function(t){conslog("fileEntry: ",t),t.file(function(t){conslog("file: ",t);var a=new FileReader;conslog("reader",a),a.onload=function(){conslog("onload readystate: "+a.readyState);var t=a.result;conslog(t),sounddata=t,e(t)},a.onloadend=function(e){conslog("onloadend",e)},a.onloadstart=printEventType,a.onprogress=printEventType,a.readAsDataURL(t)})},function(e){console.log("error reading file",e)}),conslog("stopaudio ok: "+t)},function(e){conslog("stopaudio ko!!: "+e)})},recorder.record=function(){window.plugins.audioRecorderAPI.record(function(e){console.log("recordaudio ok: "+e);var t=e.split("/");t[t.length-1]},function(e){console.log("recordaudio ko!!!: "+e)},30)},recorder.playback=function(){window.plugins.audioRecorderAPI.playback(function(e){conslog("playbackaudio ok: "+e)},function(e){conslog("playbackaudio ko!!: "+e)})}),$("#page_chat #chataudio").on(tapevent,function(e){recordChatAudio()}),$("a.sgradient").removeClass("sgradient"),$("a").addClass("fastClick"),bindFeedback(),$("a.ui-btn-left,a.ui-btn-right").addClass("transparentborderbutton").addClass("ui-nodisc-icon"),$.mobile.defaultPageTransition="none",$.mobile.defaultDialogTransition="none",$.mobile.page.prototype.options.addBackBtn=!0,$.mobile.useFastClick=!0,$("#popResult #roundfieldset").find(".roundnumber").off(tapevent),$("#popResult #roundfieldset").find(".foundnumber").on(tapevent,function(){}),$("#popResult .incbutton").off("tap"),$("#popResult .incbutton").on("tap",function(){conslog("tapped an inc button");var e=$("#popResult #risult").val(),t=$("#popResult #ammoniz1").val(),a=$("#popResult #ammoniz1").val();""==e.trim()&&(e="0-0"),""==t.trim()&&(t="0"),""==a.trim()&&(a="0");var o=$(this).attr("id"),r=parseInt(e.split("-")[0].trim(),10),i=parseInt(e.split("-")[1].trim(),10),n=parseInt(t,10),s=parseInt(a,10),c=$("#popResult #matchid").val(),l=$("#popResult #matchnumber").val();conslog("r1: "+r),conslog("r2: "+i),conslog("ammon1: "+n),conslog("ammon2: "+s);var d=o.substring(o.length-1),g=o.substring(0,o.length-1);conslog(d+" - "+g),"plus"==g&&(1==d&&r++,2==d&&i++),"minus"==g&&(1==d&&r--,2==d&&i--,r<0&&(r=0),i<0&&(i=0)),"ammplus"==g&&(1==d&&n++,2==d&&s++,n<0&&(n=0),s<0&&(s=0)),"ammminus"==g&&(1==d&&n--,2==d&&s--,n<0&&(n=0),s<0&&(s=0));var p=r+"-"+i;conslog("r1: "+r+" - r2: "+i+" - ammon1: "+n),r>i&&($("#popResult #radio_vinto").prop("checked",!0).checkboxradio("refresh"),$("#popResult #radio_perso").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_nondisputato").prop("checked",!1).checkboxradio("refresh")),r<i&&($("#popResult #radio_vinto").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_perso").prop("checked",!0).checkboxradio("refresh"),$("#popResult #radio_nondisputato").prop("checked",!1).checkboxradio("refresh")),r==i&&($("#popResult #radio_vinto").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_perso").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_nondisputato").prop("checked",!1).checkboxradio("refresh")),$("#popResult #risult").val(p),$("#popResult #ammoniz1").val(n);var u=$("#popResult #ck_realtime:checked"),h=consoles[getConsolesIndex(c)];if(h.result=p,u.length>0){conslog("notify realtime result for "+l+" - "+p+" - "),realtime.active=!0,realtime.running=!0,realtime.result=p,conslog("realtimeindex:",realtimeindex);realtimeArray[realtimeindex];h.active=!0,h.running=!0,sendRealtime();chatuser.sockid,chatuser.nickname,realtime.result}}),$("#popResult #ck_realtime").off(tapevent),$("#popResult #ck_realtime").on(tapevent,function(){$("#popResult #ck_realtime:checked").length>0?(realtime.active=!0,sendRealtime(),socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,matchid:selectedid,matchnumber:selectedmatchid,result:rf,ammoniz1:ammon1,ammoniz2:ammon2,event:"startmatch",text:rf})):realtime.active=!1});var o=window.location.href;if(openFB.init({appId:"924594024295731",tokenStore:window.localStorage}),conslog("docready !"),conslog("url: "+o),o.indexOf("#")>-1)return colog("back to index"),void(window.location.href="index.html");jQuery.support.cors=!0,storage=window.localStorage,socket=io.connect(rooturl),conslog("socket connected to socket server",socket),$.ajaxSetup({cache:!1,beforeSend:function(e){colog("beforesend",user.token),e.setRequestHeader("x-auth-token",user.token)}}),$.event.special.tap.emitTapOnTaphold=!1,FastClick.attach(document.body),socket.on("refreshchat",function(e){consolog("SOCKET received refreshchat "),refreshChat(),chatunreadcount=0,setCookie("chat_unread","0"),setChatBubbles()}),socket.on("realtimematches",function(e){consolog("SOCKET received realtimematches event !",e),updateTempoReale(e.matches)}),socket.on("updategara",function(e){consolog("SOCKET received updategara",e);var t=e.garaid;$.mobile.activePage.attr("id");if(jcurrentgara&&jcurrentgara.id==t){if(e.text){var a=e.text.replace("(n.","(numero ");playVoice(a=a.replace("-"," a "))}refreshCurrentGara(function(){refreshMatchesForAtleta()})}}),socket.on("realtime",function(e){consolog("SOCKET received realtime",e);var t,a=e;if(e.event&&(t=e.event),"refreshcronaca"==t){if(garanotifyid=a.garaid,!jcurrentgara.stato)return console.log("nessuna gara, carico la "+garanotifyid),void openGara(garanotifyid,function(e){console.log("refreshcronaca");var t=jGara.cronaca.rows.length-cronaca_read.length;t<0&&(t=0),$.ajax({url:rooturl+"/matches/getcronaca/"+jcurrentgara.id,type:"GET"}).done(function(e){jGara.cronaca=e,renderCronaca(jGara.cronaca);var o=jGara.cronaca.rows.length-cronaca_read.length;if(o<0&&(o=0),t!=o){var r=o-t,i=a.cron,n=r+" nuovi messaggi di cronaca ";1==r&&(n=r+" nuovo messaggio di cronaca");var s="";i.audio&&(""!=s.trim()&&(s+=","),s+=" audio"),i.foto&&(""!=s.trim()&&(s+=","),s+=" foto"),n+=s,i.text&&(n+=" - "+i.textmsg),snotify({text:n})}})});console.log("refreshcronaca");var o=jGara.cronaca.rows.length-cronaca_read.length;o<0&&(o=0),$.ajax({url:rooturl+"/matches/getcronaca/"+jcurrentgara.id,type:"GET"}).done(function(e){jGara.cronaca=e,renderCronaca(jGara.cronaca);var t=jGara.cronaca.rows.length-cronaca_read.length;if(t<0&&(t=0),o!=t){var r=t-o,i=a.cron,n=r+" nuovi messaggi di cronaca ";1==r&&(n=r+" nuovo messaggio di cronaca");var s="";i.audio&&(""!=s.trim()&&(s+=","),s+=" audio"),i.foto&&(""!=s.trim()&&(s+=","),s+=" foto"),n+=s,i.text&&(n+=" - "+i.textmsg),snotify({text:n})}})}if("resetcronaca"==t)return conslog("realtime resetcronaca, letti "+cronaca_read.length),void deleteCronacaReadForGara(e.garaid);updRealtimeResult(e)}),socket.on("typing",function(e){e.nickname;$("#page_chat .chattyping").html(e.nickname+" sta scrivendo...."),typingtimeout&&clearTimeout(typingtimeout),typingtimeout=setTimeout(typingTimeoutFunction,3e3)}),socket.on("sysmsg",function(e){consolog("SOCKET received sysmsg",e),snotify(e)}),socket.on("refreshsockets",function(e){consolog("SOCKET received refreshsockets"),showSockets()}),socket.on("chatmsg",function(e){consolog("SOCKET received chatmsg",e),e.color&&"yellow"==e.color&&e.text;var t=$("#page_chat"),a=new EJS({url:"tpl/chatsingle.ejs"}).render(e),o=$.mobile.activePage.attr("id"),r=!0;e.nickname==chatuser.nickname&&e.foto&&(r=!1),r&&t.find(".container").append(a),tapholdBubble(),"page_chat"==o&&chatScrollBottom();var i=e.nickname+" - "+e.text;if(""==e.text){var n="Immagine";e.audio&&(n="Messaggio vocale"),i=e.nickname+" - "+n}e.time.substring(8,10),e.time.substring(10,12);e.nickname!=chatuser.nickname&&(playSound("img/chat"),"page_chat"!=o&&(garanotifyid=e.garaid,snotify({text:i,garaid:e.garaid}),setCookie("chat_unread",++chatunreadcount))),setChatBubbles()}),socket.on("getnickname",function(e){consolog("SOCKET received getnickname: "+e.sockid),setCookie("socketid",e.sockid),chatuser.sockid=e.sockid;var t={device:"browser",type:"clientspecs",nickname:chatuser.nickname,appversion:appversion,email:user.email};isPhone&&(t.device="mobile"),socket.send(t)}),socket.on("notification",function(e){if(consolog("SOCKET received notification",e),e.text){if("newevent"==e.text)return void notifyNextEvents(!0);""!=e.text.trim()&&snotify(e)}if(e.updategara&&"yes"==e.updategara){$.mobile.activePage.attr("id");if(jcurrentgara&&jcurrentgara.id==e.garaid){var t=e.text.replace("(n.","(numero ");playVoice(t=t.replace("-"," a ")),refreshCurrentGara(function(){})}}}),socket.on("refreshgara",function(e){if(consolog("SOCKET received refreshgara",e),e.updategara&&"yes"==e.updategara){$.mobile.activePage.attr("id");jcurrentgara&&jcurrentgara.id==e.garaid&&refreshCurrentGara()}}),socket.on("connect",function(){consolog("SOCKET this client has connected to the server!")}),socket.on("message",function(e){consolog("SOCKET received message ",e)}),socket.on("disconnect",function(){consolog("SOCKET this client has disconnected!")}),$("#optionsPage #server").val(rooturl),$("#matchesatleta #dialogForAtleta").popup(),$("#gara #popResult").popup(),$("#gara  #popDelMatch").popup(),$("#gara  #popAddMatch").popup(),$("#page_atleti #atleti_categorie").panel(),conslog("binding gara page"),bindGaraPage(),$("#menuExit").off(tapevent),$("#menuExit").on(tapevent,function(e){exitapp()}),conslog("sono qui"),loadOptions(function(e){conslog("options",settings),refreshAtletiServer(function(){refreshGareServer()})}),$(document).on("pagebeforeshow",function(e){colog("pagebeforeshow"),colog("fbloggedin "+fbloggedin),fbloggedin||(window.location.href="index.html")}),$(document).on("pageshow",function(e){return colog("pageshow"),colog("fbloggedin "+fbloggedin),void(fbloggedin||(window.location.href="index.html"))}),$("#index_fb").on("pageshow",function(e){jumpToLogin()});var r=getQueryString("mode");jumpToLogin(),$("#gara #hgara a").css("width","100%"),"open"==r&&$.mobile.changePage("#index"),window.addEventListener("offline",function(){console.log("You have gone OFFLINE");myToast({body:"Connessione di rete persa, sei OFFLINE"})}),window.addEventListener("online",function(){console.log("You have gone ONLINE");myToast({body:"Sei ONLINE"});$.mobile.activePage.attr("id")})}function jumpToLogin(){var e=getCookie("autologin");if(console.log("autologin",e),e&&"true"==String(e))setTimeout(function(){$("#index_fb #accedi").trigger("click"),console.log("timeout passed")},500);console.log()}function typingTimeoutFunction(){clearTimeout(typingtimeout),typingtimeout=null,$("#page_chat .chattyping").html("")}function getMatchById(e){var t={};return $(jGara.matchesbyprog.rows).each(function(a){var o=jGara.matchesbyprog.rows[a].doc,r=o.id;if(e==r)return t=o}),t}function clickVPND(e){$("#popResult .vpnd").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_"+e.toLowerCase()).prop("checked",!0).checkboxradio("refresh")}function displayRtMatches(){conslog(rtmatches)}function addMatchToRealtime(e){conslog("adding match "+e+" to realtime");var t=!1;if($(rtmatches).each(function(a){rtmatches[a].id==e&&(t=!0)}),t)conslog("match already in realtime list");else{var a=getMatchById(e);rtmatches.push(a),conslog("added match to realtime list")}}function delMatchFromRealtime(e){$(rtmatches).each(function(t){rtmatches[t].id==e&&(rtmatches.splice(t,1),conslog("match "+e+" removed from relatime list"))})}function sendRealtime(e){var t=!1,a=$("#popResult #matchid").val(),o=$("#popResult #matchnumber").val(),r=getConsolesIndex(a);colog("consolesindex "+r),colog("realtimeindex "+realtimeindex);var i="0-0",n=realtime,s="1",c=!1,l=!1,d=!1,g=!1;if(n=consoles[r],conslog("rta",n),n||console.log("no rta found"),n&&(n.result&&(i=n.result),n.round&&(s=n.round),n.running&&(l=n.running),n.paused&&(d=n.paused),n.fineround&&(c=n.fineround),n.active&&(g=n.active)),g&&(t=!0),e&&1==e&&(t=!0),t){var p="TEMPO REALE !<br> ",u="black",h="in pausa";l&&(h="IN CORSO",u="blue"),c&&(h="FINE ROUND "+s,u="black");var m="<font color='"+u+"'>Round "+s;"GP"==s&&(m="<font color='"+u+"'>GoldenPoint"),p+=" "+m,p+=", "+h,p+=", "+i+"</font>",conslog("rta2",n),n&&n.foto&&(p+="<br><img style='float: left' src='"+n.foto+"' width='60px' height='60px' />");u="black";g&&(u="blue");var f={type:"realtime",to:"all",garaid:jcurrentgara.id,matchid:a,matchnumber:o,result:i,round:s,fineround:c,running:l,paused:d,ammoniz1:0,ammoniz2:0,event:"realtime",text:p,match:getMatchById(a),active:g};conslog("sendrealtime",f),socketNotify(f),updRealtimeResult(f)}}function clickRound(e){var t=$(e).val();currentround=t;console.log("clicked round "+t),$("#popResult #ckfineround").prop("checked",!1).checkboxradio("refresh");if($("#popResult label[for=ckpausematch]").html("<span style='color: orange;'>IN CORSO</span>".replace("MATCH ","")),$("#popResult #ckpausematch").prop("checked",!0).checkboxradio("refresh"),$("#popResult .roundnumber").css("background","silver").css("font-weight","normal"),$(e).css("background","green").css("font-weight","bold"),$("#popResult #ck_realtime:checked").length>0){var a=$("#popResult #matchid").val(),o=($("#popResult #matchnumber").val(),getConsolesIndex(a)),r=consoles[o];r.round=t,r.running=!0,r.paused=!1,r.fineround=!1,sendRealtime()}}function viewCronacaElements(){var e="http://tkdr.herokuapp.com/matches/viewcronacaelements/"+jcurrentgara.id;$.get(e,function(e){$("#viewCelem [data-role=content]").html(e),$("#viewCelem [data-role=content] ul").listview(),$.mobile.changePage("#viewCelem")})}function sendCronacaElements(){var e="#cronacaelements",t=!1,a={foto:!1,audio:!1,text:!1},o={text:"",image:"",sound:""},r=$(e+" #ckFotoCelem:checked").length;if(r>0?(t=t||!0,console.log("sending foto"),""!=fotodata.trim()&&(o.image=fotodata,a.foto=!0)):delete o.image,(r=$(e+" #ckTestoCelem:checked").length)>0&&(t=t||!0,console.log("sending text"),text=$(e+" textarea#testo").val(),o.text=text,a.text=!0,a.textmsg=text),r=$(e+" #ckAudioCelem:checked").length,r>0?(t=t||!0,console.log("sending audio"),console.log(sounddata),""!=sounddata.trim()&&(o.sound=sounddata,a.audio=!0)):delete o.sound,t){console.log(o),progressStart("Caricamento");var i="/matches/addcronacaelement/"+jcurrentgara.id;$.ajax({type:"POST",url:rooturl+i,async:!0,data:o,success:function(e){console.log("send elements result:",e),progressStop(),$.mobile.back(),socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,event:"refreshcronaca",cron:a}),$.ajax({url:rooturl+"/matches/getcronaca/"+jcurrentgara.id,type:"GET"}).done(function(e){jGara.cronaca=e,renderCronaca(jGara.cronaca),setActiveTab(activeTab=2)})},error:function(e){alert("errore nell'invio"),progressStop(),console.log("errore nell'invio",e)}})}else alert("Per aggiornare la cronaca selezionare almeno un elemento testo, audio o immagine")}function toDataUrl(e,t){var a=new XMLHttpRequest;a.responseType="blob",a.onload=function(){var e=new FileReader;e.onloadend=function(){t(e.result)},e.readAsDataURL(a.response)},a.open("GET",e),a.send()}function getChatAudio(){}function getChatFoto(){if(console.log("getChatFoto"),!navigator.camera)return conslog("Camera API not supported in getFoto"),void toDataUrl(defaultimage,function(e){fotodata=e});var e=1;navigator.notification.confirm("Scegli la sorgente per l'immagine",function(t){if(2!=(e=parseInt(t,10)-1)){var a={quality:100,destinationType:Camera.DestinationType.DATA_URL,sourceType:e,encodingType:0,targetWidth:800,targetHeight:800,correctOrientation:!0};navigator.camera.getPicture(function(e){conslog("photo length: "+e.length);var t="data:image/jpeg;base64,"+e,a={garaid:"",nickname:chatuser.nickname,sockid:chatuser.sockid,foto:t,text:""};console.log(a);var o=new EJS({url:"tpl/chatsingle.ejs"}).render(a);$("#page_chat").find(".container").append(o),chatScrollBottom(),postChat(a)},function(e){console.log("Error taking picture",e)},a)}},"Posta immagine",["Galleria","Fotocamera","Annulla"])}function getFoto(){if(!navigator.camera)return conslog("Camera API not supported in getFoto"),$(".fotoview").css("background-image","url("+defaultimage+")").css("width","100%").css("height","300px"),toDataUrl(defaultimage,function(e){fotodata=e}),void $(".fotoview").show();var e={quality:25,destinationType:Camera.DestinationType.DATA_URL,sourceType:1,encodingType:0,targetWidth:500,targetHeight:500,correctOrientation:!0};navigator.camera.getPicture(function(e){$(".fotoview img").attr("src","url(data:image/jpeg;base64,"+e+")"),$(".fotoview").css("background-image","url(data:image/jpeg;base64,"+e+")").css("width","100%").css("height","250px"),$(".fotoview").show(),conslog("photo length: "+e.length),fotodata="data:image/jpeg;base64,"+e},function(){alert("Error taking picture","Error")},e)}function sendFoto(){realtime.foto=fotodata,sendRealtime(),delete realtime.foto,$.mobile.back()}function createCronacaElement(){return conslog("createCronacaElement"),$("#cronacaelements .fotoview").css("width","100%"),void $.mobile.changePage("#cronacaelements")}function clickRealtime(){conslog("clickRealtime");var e=$("#popResult #ck_realtime:checked"),t=$("#popResult #realtimediv"),a=$("#popResult #risult").val(),o=$("#popResult #matchid").val(),r=($("#popResult #matchnumber").val(),"Tempo reale"),i="black",n=!1;if(e.length>0){t.show(),i="lightgreen",r="TEMPO REALE ATTIVO",n=!0,a;getMatchById(o);$("#popResult .roundnumber").css("background","silver")}else t.hide(),i="black",r="Tempo reale",n=!1;var s="<span style='color: "+i+";'>"+r+"</span>";$("#popResult label[for=ck_realtime]").html(s.replace("MATCH ",""));var c="/matches/update/"+jcurrentgara.id+"/"+o,l={realtime:n},d="realtime_off";n&&(d="realtime_on"),console.log("sending admin_action",d);l.admin_action=d,colog("realtimeindex before call: "+realtimeindex),$.post(rooturl+c,l,function(){colog("realtime setted to "+n+" for matchid "+o),refreshCurrentGara(function(){refreshChat(!0),renderRealtimeTabs(),""!=lastDisplayedAtletaId.trim()&&showMatchesForAtleta(lastDisplayedAtletaId),renderRealtimeTabs(),renderConsoleTabs()})})}function getConsolesIndex(e){for(var t=0;t<consoles.length;t++)if(consoles[t].match.id==e)return t}function clickPausa(){conslog("clicked fine round");var e=$("#popResult #ckfineround:checked").length,t=realtimeArray[realtimeindex],a=$("#popResult #matchid").val(),o=$("#popResult #matchnumber").val(),r=getConsolesIndex(a);t=consoles[r];var i=!1,n="black",s="MATCH IN PAUSA";if(e>0?(conslog("checked"),i=!0,t.fineround=!0,t.running=!1,t.paused=!0,n="black",s="MATCH IN PAUSA"):(t.fineround=!1,t.running=!0,t.paused=!1),0==e&&conslog("unchecked"),t.fineround){$("#popResult #ckpausematch").prop("checked",!1).checkboxradio("refresh");var c="<span style='color: "+n+";'>"+s+"</span>";$("#popResult label[for=ckpausematch]").html(c.replace("MATCH ",""))}var l=$("#popResult #ck_realtime:checked");currentround.toLowerCase(),l.length>0&&(console.log("notify realtime result for "+o),t.active=!0,realtime.active=!0,realtime.running=!i,realtime.fineround=i,sendRealtime())}function clickPauseMatch(){console.log("clicked pausa match");var e=$("#popResult #ckpausematch:checked").length,t="MATCH IN PAUSA",a="black",o=$("#popResult #matchid").val(),r=$("#popResult #matchnumber").val(),i=getConsolesIndex(o),n=consoles[i];console.log(n),e>0?(console.log("checked, match in corso"),t="MATCH IN CORSO",a="orange",n.paused=!1,n.running=!0,n.fineround=!1):(console.log("unchecked, match in pausa"),t="MATCH IN PAUSA",a="black",n.running=!1,n.fineround=!1,n.paused=!0),$("#popResult #ckfineround").prop("checked",n.fineround).checkboxradio("refresh");var s="<span style='color: "+a+";'>"+t+"</span>";$("#popResult label[for=ckpausematch]").html(s.replace("MATCH ",""));var c=$("#popResult #ck_realtime:checked");currentround.toLowerCase(),c.length>0&&(console.log("notify realtime result for "+r),n.active=!0,sendRealtime())}function refreshRealtime(e){conslog("refreshrealtime, current realtimeArray",realtimeArray);for(d=0;d<e.rows.length;d++){var t=e.rows[d].doc,a=!1;t.realtime&&"true"==String(t.realtime)&&(a=!0);var o={active:a,garaid:t.garaid,matchid:t.id,match:t};if(a){for(var r=!1,i=0;i<realtimeArray.length;i++)conslog(t.id,realtimeArray[i].match.id),t.id==realtimeArray[i].match.id&&(r=!0,conslog("!!! match "+t.id+" already in realtimearray, will not touch it"));r||(conslog("match "+t.id+" not found in realtimearray, pushing it"),realtimeArray.push(o));for(var n=!1,s=0;s<consoles.length;s++)consoles[s].match.id==t.id&&(n=!0);n||(consoles.push(o),conslog("realtime match "+t.id+" not found in consoles, adding it"))}else deleteFromRealtimeArray(t.garaid+"_"+t.id)}conslog("realtime matches",realtimeArray.length);for(var c=notifiche_temporeale,l=jGara.gara.rows[0].doc.id,d=0;d<realtimeArray.length;d++){var g=realtimeArray[d];conslog("rtax",g);for(var p=l+"_"+g.match.atletaid,u=g.match.atletaname,h=g.match.matchid,i=0;i<c.length;i++)c[i]==p&&snotify({text:"TEMPO REALE: "+h+" "+u})}var m=new EJS({url:"tpl/matchesrealtime2.ejs"}).render(realtimeArray);$("#page_chat .chatrealtime .rtul").empty().append(m)}function clickRtMatch(e,t,a){if(conslog("clicked match garaid "+t+" matchid "+e,"role "+role),"tkdradmin"==role){var o=!1,r=0;consoles.forEach(function(a,i){conslog("console item",a),a.matchid==e&&a.garaid==t&&(o=!0,r=i)}),conslog("this match was found in console index "+r),setResult(a)}}function updRealtimeResult(e){var t=e.matchid,a=(e.result,e.ammoniz1,e.match,e.event);conslog("updateRealtimeResult "+t,e);for(var o=0;o<realtimeArray.length;o++)realtimeArray[o].match.id==t&&(realtimeArray[o]=e,conslog("found this match in realtimearray, setting its data to "),conslog(realtimeArray[o]));var r=e.text;"true"==String(e.active)&&(r="<font style='color: blue'>"+e.text+"</font>"),realtimeArray.length>0?($("#index #lichat a table tr td:eq(1)").css("color","lightgreen").html("Chatkwondo - Tempo reale"),$("#gara #lichat a").css("color","lightgreen").html("Chatkwondo - Tempo reale").css("font-weight","bold")):($("#index #lichat a table tr td:eq(1)").css("color","black").html("Chatkwondo"),$("#gara #lichat a").css("color","white").html("Chatkwondo").css("font-weight","normal")),$("#page_chat .chatrealtime .rtul li").each(function(){var o=$(this).attr("id").replace("match_",""),i=$(this).find("a");if(o==t)if($(this).css(""),conslog("found match to update in realtime !!","ev",e),"matchupdate"==a)i.find("span.soft").html(r),i.find("img.imgicon").attr("src","images/greenblink.gif");else if("matchstart"==a)i.find("img.imgicon").attr("src","images/greenblink.gif"),playSound("img/roundstart");else if(e.active){if(conslog("realtime active !"),0==i.find("span.realtime").length&&(i.find("div").append("<span class='realtime'></span>"),conslog("creating realtime div "+i.find("span.realtime").length),conslog(r)),i.find("span.vinto").hide(),i.find("span.realtime").html(r),e.result.split("-").length>0){n=e.match.atletaname+" "+e.result.replace("-"," a ");if(e.fineround&&"true"==String(e.fineround)){colog("fine round !!!");e.result.split("-");var n=e.match.atletaname+". Fine round "+e.round+". Punteggio: "+e.result.replace("-"," a ")}playVoice(n)}0==i.find("img.blinkicon").length&&i.prepend("<img src='images/greenblink.gif' class='imgicon blinkicon' />"),i.find("img.imgicon:eq(1)").hide(),i.find("span.vinto").hide()}})}function updRealtimeResult_old(e){var t=e.matchid,a=e.result,o=(e.ammoniz1,e.match,e.event);conslog("updateRealtimeResult "+t+" - "+a),conslog("updrealtimeresult "),conslog(e),conslog("rtarray: ",realtimeArray);var r=e.text;e.active&&(r="<font style='color: blue'>"+e.text+"</font>"),$("#page_chat .chatrealtime .rtul li").each(function(){var a=$(this).attr("id").replace("match_",""),i=$(this).find("a");a==t&&($(this).css(""),colog("found match to update in realtime"),"matchupdate"==o?(i.find("span.soft").html(r),i.find("img.imgicon").attr("src","images/greenblink.gif")):"matchstart"==o?i.find("img.imgicon").attr("src","images/greenblink.gif"):e.active?(conslog("realtime active !"),0==i.find("span.realtime").length&&(i.find("div").append("<span class='realtime'></span>"),console.log("creating realtime div "+i.find("span.realtime").length),console.log(r)),i.find("span.vinto").hide(),i.find("span.realtime").html(r),0==i.find("img.blinkicon").length&&i.prepend("<img src='images/greenblink.gif' class='imgicon blinkicon' />"),i.find("img.imgicon:eq(1)").hide(),i.find("span.vinto").hide()):(conslog("realtime not active !"),i.find("span.realtime").remove(),i.find("span.vinto").show(),i.find("img.blinkicon").remove(),i.find("img.imgicon:first").show(),i.find("span.vinto").show()))})}function exitapp(){app.exit()}function setChatBubbles(){var e=chatunreadcount;e>0?($("#gara #chatgarabubble").html(e).show(),$("#index #chatcountbubble").html(e).show()):($("#gara #chatgarabubble").html("0").hide(),$("#index #chatcountbubble").html("0").hide()),setBadge()}function notifyNextGare(e){conslog("notify next gare",e);var t=[],a=new Date;e.rows.forEach(function(e,o){var r=e.doc,i=!1;if(r.stato&&"nondisputata"==r.stato&&(i=!0),i){var n=r.data.split("/"),s=new Date(n[2],parseInt(n[1],10)-1,n[0]),c=Math.round((a-s)/864e5);c<0&&t.push({gara:r,diff:c})}}),conslog("nextGare",t);var o=getCookie("garenotify"),r=!1;if(o){var i=new Date(o),n=Math.round((a-i)/864e5);colog("notifydiff",n),n>notifyeventdays&&(r=!0)}else r=!0,conslog("no garenotify cookie found");if(conslog(o),r){setCookie("garenotify",a);var s="Prossimi Eventi: <br><br>",c=0;t.forEach(function(e,t){s+="- "+e.gara.title+" - "+e.gara.location+" - "+e.gara.data+"<br>",c++}),console.log("Prossimi eventi da notificare",c),c>0&&snotify({text:s})}}function showTempoRealePage(){fetchTempoRealePage(),$.mobile.changePage("#page_temporeale")}function updateTempoReale(e){var t=new EJS({url:"tpl/temporeale.ejs"}).render(e);$("#page_temporeale").find("#content").html(t),$("#page_temporeale").trigger("create");var a=$.mobile.activePage.attr("id");"page_temporeale"==a&&conslog("pageid",a)}function fetchTempoRealePage(e){return void socket.emit("getrealtimematches")}function showNextEvents(){progressStart("Caricamento prossimi eventi"),getNextEvents(function(e){var t=new EJS({url:"tpl/nextevents.ejs"}).render(e);$("#page_nextevents #content").html(t),$("#page_nextevents #navbar #recnum").html("Prossimi eventi: "+e.length),$("#page_nextevents #ulnextevents").listview(),$("#page_nextevents #ulnextevents").listview("refresh"),$.mobile.changePage("#page_nextevents"),progressStop(),notifyNextEvents()})}function notifyNextEvents(e){var t=new Date;getNextEvents(function(a){var o=a;conslog("nextGare",o);var r=getCookie("garenotify"),i=getCookie("numevents"),n=!1;if(r){var s=new Date(r),c=Math.round((t-s)/864e5);colog("notifydiff",c),c>notifyeventdays&&(n=!0)}else n=!0,conslog("no garenotify cookie found");if(i&&o.length!=parseInt(i,10)&&(n=!0),conslog(r),e&&"true"==String(e)&&(n=!0),n){setCookie("garenotify",t),setCookie("numevents",o.length);var l="Prossimi Eventi: <br><br>",d=0;o.forEach(function(e,t){l+="- "+e.gara.data+"<br>   "+e.gara.title+" - "+e.gara.location+"<br>",d++}),console.log("prossimi eventi da notificare",d),d>0&&snotify({text:l,action:"nextevents"})}})}function openEvent(e,t){conslog("openevent",t),"Gara"==e&&($.mobile.changePage("#gara"),openGara(t)),"Evento"==e&&viewEvento(t)}function getNextEvents(e){var t=new Date;app.loadAllGare(function(a){refreshEventiServer(function(o){var r={rows:[]};a.rows.forEach(function(e,t){r.rows.push(e)}),o.rows.forEach(function(e,t){r.rows.push(e)});var i=[];r.rows.forEach(function(e,a){var o=e.doc,r=!1;if(o.stato&&"nondisputata"==o.stato&&(r=!0),r){var n=o.data.split("/"),s=new Date(n[2],parseInt(n[1],10)-1,n[0]),c=Math.round((t-s)/864e5)-1;c<0&&i.push({gara:o,diff:c})}}),conslog("nextevents",i),i.sort(function(e,t){var a=e.gara.data,o=t.gara.data,r=a.substring(6,10)+a.substring(3,5)+a.substring(0,2),i=o.substring(6,10)+o.substring(3,5)+o.substring(0,2);return r>i?1:r<i?-1:0}),conslog(i),nexteventscount=i.length,$("#index #nexteventsbubble").html(nexteventscount),nexteventscount>0?$("#index #nexteventsbubble").show():$("#index #lista #nexteventsbubble").hide(),e&&e(i)})})}function refreshGareServer(e){var t=!0,a={};e&&(e instanceof String||"string"==typeof e?(a={stato:e},t=!0):(a=e,t=!1));$.mobile.activePage.attr("id");var o=imgtext+"Caricamento....";$("#gare #recnum span").html(o),app.loadAllGare(function(o){if(o.error)myToast({body:"errore"});else{conslog("Gare caricate da "+rooturl),$gare=o;var r=$("#listagare");r.html("");var i='<li data-role="list-divider" role="heading" data-theme="b">'+o.rows.length+" gare</li>";if(r.append(i),o.rows.sort(function(e,t){if(e.doc.data&&t.doc.data){var a=getNormalD(e.doc.data),o=getNormalD(t.doc.data);if(a>o)return-1;if(a<o)return 1}return 0}),e)if(a.allfields){var n=a.allfields,s={rows:[]},c=["data","title","location","tipo"];o.rows.forEach(function(e,t){for(var a in e.doc)c.indexOf(a)>-1&&String(e.doc[a]).toLowerCase().trim().indexOf(n.trim().toLowerCase())>-1&&s.rows.push(e)}),o=s,conslog("newarr",s)}else o=filterRows(o,a,t);var l={oro:0,arg:0,bro:0};o.rows.forEach(function(e,t){var a=e.doc;a.ori&&(l.oro+=parseInt(a.ori)),a.argenti&&(l.arg+=parseInt(a.argenti)),a.bronzi&&(l.bro+=parseInt(a.bronzi))});var d=new EJS({url:"tpl/gare.ejs"}).render(o.rows);r.empty().append(d),progressStop(),$("#gare #recnum span").html(o.rows.length+" gare   &nbsp;&nbsp;&nbsp;&nbsp; <span style='color: gray'>(ORO: "+l.oro+" - ARG: "+l.arg+" - BRO: "+l.bro+")</span>"),r.find("li").off("tap"),r.find("li").on("tap",function(){playFeedback();var e=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+e),$("#gara #listabyprog").empty(),setCookie("lastcronaca",""),realtimeArray=[],consoles=[],$.mobile.changePage("#gara"),openGara(e,function(){garaid=e,$gara=o}),!1}),r.find("li").off("taphold"),r.find("li").on("taphold",function(){if("tkdradmin"==role){var e=$(this).find("a").attr("id").split("_")[0],t=$(this).find("a").attr("id").split("_")[1],a=getGaraById(e);colog(a);var o={id:e,rev:t,doc:a.doc},r=new EJS({url:"tpl/popgare.ejs"}).render(o);$("#gare div[data-role=content] #popGare").remove(),$("#gare div[data-role=content]").append(r),$("#gare #popGare #ulpopgare").listview(),$("#gare #popGare").popup(),$("#gare #popGare").popup("open")}}),r.listview(),r.listview("refresh")}})}function markGara(e,t){var a={id:e,stato:t};$.ajax({url:rooturl+"/gare/update",type:"POST",data:a}).done(function(e){popGareCancel(),refreshGareServer()})}function editEvento(e){if("tkdradmin"==role){var t=$("#page_editevento");$.ajax({url:rooturl+"/eventi/findbyid/"+e,type:"GET"}).done(function(a){conslog("read event "+e,a);var o=a.rows[0].doc;t.find(".jform").each(function(){var e=$(this).attr("id");o[e]&&$(this).val(o[e])}),$.mobile.changePage("#page_editevento")})}}function viewEvento(e){$("#page_viewevento");$.ajax({url:rooturl+"/eventi/findbyid/"+e,type:"GET"}).done(function(t){conslog("read event "+e,t);t.rows[0].doc;var a=new EJS({url:"tpl/viewevento.ejs"}).render(t);$("#page_viewevento .content").html(a),$.mobile.changePage("#page_viewevento"),$("#page_viewevento").trigger("create")})}function editEventoOk(){var e={id:$("#page_editevento #id").val()};$("#page_editevento").find(".jform").each(function(){var t=$(this).attr("id");e[t]=$(this).val()}),console.log(e),$.ajax({url:rooturl+"/eventi/update",type:"POST",data:e}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.goBack,showNextEvents())}).fail(function(e){myToast({body:"Error posting"}),console.log("error",e)})}function sendEventsNotify(){socketNotify({type:"notification",to:"all",text:"newevent"})}function editGara(e){editgaratkdt={},console.log("editgara");var t=getGaraById(e);$("#page_editgara").find(".jform").each(function(){var e=$(this).attr("id");t.doc[e]&&$(this).val(t.doc[e]);var a="combattimento";"tipo"==e&&(t.doc.tipo&&(a=t.doc.tipo),$(this).val(a))}),t.doc.tkdt_id?""!=t.doc.tkdt_id.trim()&&(progressStart("lettura dati di gara ufficiale "+t.doc.tkdt_id),$.ajax({url:rooturl+"/tkdt/getfromfile/"+t.doc.tkdt_id+"?societaid="+settings.mysocieta,dataType:"json",type:"GET"}).done(function(e){progressStop();var a=e;t.doc.tkdt=a,editgaratkdt=a,colog("retrieved tkdt id "+t.doc.tkdt_id,a),t.doc.tkdt.atleti||(t.doc.tkdt.atleti=[]),t.doc.tkdt.atleti_iscritti||(t.doc.tkdt.atleti_iscritti=[]),t.doc.tkdt.tabulati||(t.doc.tkdt.tabulati=[]),console.log("gara.doc.tkdt",t.doc.tkdt);var o=$("#page_editgara").find("div[data-role=content]").find("#tkdt");o.empty(),o.append("Atleti iscritti: "+t.doc.tkdt.atleti_iscritti.length+"<br>"),o.append("Atleti effettivi in gara: "+t.doc.tkdt.atleti.length+"<br>"),o.append("Tabulati trovati: "+t.doc.tkdt.tabulati.length+"<br>"),o.append('<br><label><input type="checkbox" name="ck_tkdt" id="ck_tkdt">&nbsp;Salva TKDT</label><br>'),$.mobile.changePage("#page_editgara"),popGareCancel()})):($.mobile.changePage("#page_editgara"),popGareCancel())}function editGaraOk(){var e=!1,t={id:$("#page_editgara #id").val()},a=$("#page_editgara"),o=checkValidGaraForm(a);if(1!=o.error){a.find(".jform").each(function(){var e=$(this).attr("id");t[e]=$(this).val()});var r=a.find("#ck_tkdt");if(console.log("cklength",r.length),r.length>0){var i=r.is(":checked");console.log("checked",i),i&&(e=!0)}console.log(t),$.ajax({url:rooturl+"/gare/update",type:"POST",data:t}).done(function(t){if(t.error)console.log("error");else if(console.log("posted"),e){if(t.tkdt_id&&""!=t.tkdt_id.trim()){console.log("saving tkdt");var a=rooturl+"/tkdt/retrieve/"+t.tkdt_id;$.ajax({type:"GET",url:a}).done(function(e){console.log("retrieved and saved tkdt "+e.tkdt_id+" to file"),$.mobile.changePage("#gare"),refreshGareServer()})}}else $.mobile.changePage("#gare"),refreshGareServer()}).fail(function(e){myToast({body:"Error posting"}),console.log("error",e)})}else alert("Errore di inserimento:\n\n"+o.errors)}function refreshCurrentGara(e){autorefreshcount=0;var t=imgtext+"Refresh in corso...";$("#gara .medals").html(t);var a=jcurrentgara.id;conslog("refreshCurrentGara - id= "+a),openGara(a,e)}function popGareCloseRemove(){$("#gare #popGare").popup("close").remove()}function loadFullGaraById(e,t){$.ajax({url:rooturl+"/gare/fullgarabyid/"+e+"?societaid="+settings.mysocieta,dataType:"json",type:"GET"}).done(function(e){t&&t(e)})}function renderFormeByAtleta(e){conslog("iscrs",e),e.rows.sort(function(e,t){var a=e.atleta.cognome+" "+e.atleta.nome,o=t.atleta.cognome+" "+t.atleta.nome;return a>o?1:a<o?-1:0});var t=new EJS({url:"tpl/formebyatleta.ejs"}).render(e),a="listabyatleta",o=$("ul#"+a);o.empty(),o.append(t),o.listview(),o.listview("refresh"),a="listabyprog",(o=$("ul#"+a)).empty(),o.append(t),o.listview(),o.listview("refresh"),e.rows.length>0&&$("#gara #nomatches").hide()}function renderGaraInfo(e){$("#gara #litipogara").html("Tipo gara: <b>"+tipogara.toUpperCase()+"</b>");var t="";isFiltered&&(t=" (filtri applicati) ");var a=filterRows(e,{dadisputare:"yes"}),o=filterRows(a,{disputato:"yes"}),r=filterRows(o,{vinto:"yes"}),i=filterRows(o,{vinto:"no"}),n=o.rows.length-r.rows.length,s=getMaschiFemmine(a.rows),c=a.rows.length+" match da disputare ( M: "+s.maschi+", F: "+s.femmine+" )";s=getMaschiFemmine(r.rows);var l=getMaschiFemmine(o.rows),d=getMaschiFemmine(i.rows);c+="<br>"+o.rows.length+" match disputati ( M: "+l.maschi+", F: "+l.femmine+" ) <br>"+r.rows.length+" vinti ( M: "+s.maschi+", F: "+s.femmine+" ) <br>"+n+" persi ( M: "+d.maschi+", F: "+d.femmine+" )"+t,$("#limatches").html(c);var g=filterRows(o,{medagliamatch:"oro"}),p=filterRows(o,{medagliamatch:"argento"}),u=filterRows(o,{medagliamatch:"bronzo"}),h=getMaschiFemmine(g.rows),m=getMaschiFemmine(p.rows),f=getMaschiFemmine(u.rows);c="ORI: "+g.rows.length+" ( M: "+h.maschi+", F: "+h.femmine+" ) - punti: "+getPunti(g.rows.length,0,0)+"<br>ARGENTI: "+p.rows.length+" ( M: "+m.maschi+", F: "+m.femmine+" ) - punti: "+getPunti(0,p.rows.length,0)+"<br>BRONZI: "+u.rows.length+" ( M: "+f.maschi+", F: "+f.femmine+" ) - punti: "+getPunti(0,0,u.rows.length)+"<br><br>Punteggio totale medaglie: "+getPunti(g.rows.length,p.rows.length,u.rows.length)+" "+t,$("#limedaglie").html(c);var v=new Date,b=v.toLocaleDateString()+" "+v.toLocaleTimeString();$("#lilastupdate").html("<span color=gray><i>Ultimo aggiornamento: "+b+"</i></span>"),$("#gara #ulinfogara span").html(getMedaglieGara(e)),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){$(this).index();var e=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+e).removeClass("ui-screen-hidden"),prevSelection=e,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var t=$(this).find("a").attr("data-tab-class");$("#gara .ul"+t).show()})}function getTkdtCategoria(e){var t=getTkdtAtleta(e);colog("getTkdtCategoria",t);var a=e.sesso.toUpperCase()+"  "+t.catpeso+"kg - "+t.catcintura;return"atleta non trovato"==t.nome&&(a="Dati ufficiali categoria non disponibili"),a}function openGara(e,t){var a=$("#gara #floatrt");a.hide(),colog("opengara "+e),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var e=$(this).index(),t=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+t).removeClass("ui-screen-hidden"),prevSelection=t,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var a=$(this).find("a").attr("data-tab-class");$("#gara .ul"+a).show(),activeTab=e,cacheViews()});var o=imgtext+"Caricamento...";$("#gara .medals").html(o),loadFullGaraById(e,function(o){if(conslog("loaded gara",e),jGara=o,jcurrentgara=o.gara.rows[0].doc,jcurrentgara.tipogara="Combattimento",jcurrentgara.tipo&&"forme"==jcurrentgara.tipo.toLowerCase()&&(jcurrentgara.tipogara="Forme"),tipogara=jcurrentgara.tipogara.toLowerCase(),conslog("tipogara",tipogara),jcurrentgara.tkdt?(jcurrentgara.tkdt.atleti||(jcurrentgara.tkdt.atleti=[]),jcurrentgara.tkdt.atleti_iscritti||(jcurrentgara.tkdt.atleti_iscritti=[]),jcurrentgara.tkdt.tabulati||(jcurrentgara.tkdt.tabulati=[]),tkdt_atleti=jcurrentgara.tkdt.atleti,tkdt_tabulati=jcurrentgara.tkdt.tabulati,tkdt_atleti_iscritti=jcurrentgara.tkdt.atleti_iscritti):(tkdt_atleti=[],tkdt_tabulati=[],tkdt_atleti_iscritti=[]),colog("tkdt_atleti",tkdt_atleti.length),colog("tkdt_tabulati",tkdt_tabulati.length),colog("tkdt_atleti_iscritti",tkdt_atleti_iscritti.length),jmatchesbyprog={rows:[]},jmatchesbyatleta={rows:[]},"combattimento"==tipogara)$("#gara #navbar").show(),jmatchesbyprog=o.matchesbyprog,jmatchesbyprog=filterMatches(o.matchesbyprog.rows,!0),jmatchesbyatleta=filterMatchesByAtleta(o.matchesbyatleta.rows),jmatchesbyprog.rows.forEach(function(e,t){var a=getTkdtCategoria(getAtletaById(e.doc.atletaid));e.doc.tkdtcategoria=a}),jmatchesbyatleta.rows.forEach(function(e,t){var a=getTkdtCategoria(getAtletaById(e.id));e.tkdtcategoria=a}),renderMatchesByProg(jmatchesbyprog),renderMatchesByAtleta(jmatchesbyatleta),setTimeout(function(){conslog("setting active tab in opengara"),setActiveTab(0),conslog("done")},300);else{jmatchesbyprog=o.matchesbyprog,o.formebyatleta.rows.forEach(function(e,t){var a=e.atleta.id,r=filterRows(o.matchesbyprog,{atletaid:a});colog("esecuzioni per "+e.atleta.nome+" "+e.atleta.cognome,r.rows.length),e.esecuzioni=r.rows}),console.log("data.formebyatleta",o.formebyatleta),renderFormeByAtleta(o.formebyatleta);var r=$(this).find("a").attr("data-tab-class");$("#gara .ul"+r).show(),setActiveTab(1)}if(renderCronaca(o.cronaca),renderGaraInfo(jmatchesbyprog),refreshRealtime(jmatchesbyprog),colog("floatrt",a),o.realtime){colog("realtime",o.realtime.rows.length);var i="img/chaticon03.png";if(o.realtime.rows.length>0){console.log("ci sono "+o.realtime.rows.length+" incontri in realtime",o.realtime);var n="";o.realtime.rows.forEach(function(e,t){var a=e.doc,o=a.id;-1==lastrtmatches.indexOf(o)&&(""!=n.trim()&&(n+=", "),n+=a.matchid+"-"+a.atletaname,lastrtmatches.push(o))}),""!=n&&(n="TEMPO REALE: "+n),a.find(".floatrttext").html("TEMPO<br>REALE ("+o.realtime.rows.length+")"),playSound("img/realtime"),i="images/greenblink.gif"}else a.hide(),lastrtmatches=[];$("#gara #chaticon").attr("src",i)}var s={doc:jcurrentgara};$("#gara #hdr").find("#hgara a").html(s.doc.location+" -     "+s.doc.data),$("#gara #hdriscritti").find("h1").html(s.doc.title+" "+s.doc.location+" -     "+s.doc.data);var c=[];s.doc.myiscritti&&(c=s.doc.myiscritti.split(","));var l=c.length;iscrittiincat=[],l=(iscrittiincat=filterIscritti(c)).length,mf=getMaschiFemmine(iscrittiincat,"iscritti"),$("#gara #lisocieta").html("<b>"+settings.mysocietaname+"</b>"),$("#gara #ligaratitle").html("Gara: <b>"+s.doc.title+"</b>");var d="";s.doc.tkdt_id&&(d=s.doc.tkdt_id),$("#gara #ligaraid").html("id: <b>"+s.doc.id+"</b> tkdt_id: "+d);var g="";s.doc.maplocation&&""!=s.doc.maplocation.trim()&&(g="&nbsp;&nbsp;<a sclass='ui-btn ui-mini' href='#' onclick='garaMaps()' class='pulsante' style='width:40px;'>Mappa</a>"),$("#gara #ligaralocation").html("Location: "+s.doc.location+g),$("#liiscritti").text(l+" atleti iscritti --  F: "+mf.femmine+" M: "+mf.maschi);var p=getCategorieCoperte();$("#gara #licategorie").text(p.text),setChatBubbles(),$("#gara #hgara a").css("width","100%"),conslog("console.length",consoles.length);for(var u=0;u<consoles.length;u++){var h=consoles[u],m=getMatchById(h.match.id);h.match=m;var f=m.realtime;conslog("rt",f),h.active=f}t&&t(),colog("stato gara: "+jcurrentgara.stato),"disputata"==jcurrentgara.stato?$("#iscrittiPage #btnAddIscritto").hide():"tkdradmin"==role&&$("#iscrittiPage #btnAddIscritto").show()})}function approveUser(e){var t=rooturl+"/users/approve/"+e;$.get(t,function(e){showPendingRegs()})}function changeUserView(){var e=$("#page_regpendings #userview").val(),t=rooturl+"/users/regpending";"all"==e&&(t=rooturl+"/users/list"),$.get(t,function(e){var t=new EJS({url:"tpl/users.ejs"}).render(e.rows);$("#page_regpendings #table").html(t)})}function showPendingRegs(){return $.mobile.changePage("#page_regpendings"),void changeUserView()}function showRegisterPage(){$.mobile.changePage("#registeruser")}function deleteUser(e){if(confirm("Sicuro di voler cancellare questo utente ?")){var t=rooturl+"/users/delete",a={email:e};$.post(t,a,function(e){console.log(e),changeUserView()})}}function doRegisterUser(){var e=$("#registeruser"),t=e.find("#reg-email").val(),a=e.find("#reg-nickname").val(),o=e.find("#reg-password").val(),r=rooturl+"/users/register",i=[];""==t.trim()&&i.push("Fornisci una email"),""!=t.trim()&&(isValidEmail(t)||i.push("Fornisci una email valida")),""==a.trim()&&i.push("Fornisci un nickname"),""==o.trim()&&i.push("Fornisci una password");var n="";if(i.length>0)return i.forEach(function(e,t){n+=e+"\n"}),n="Sono stati riscontrati i seguenti errori: \n\n\n"+n,void alert(n);var s={email:t,nickname:a,psw:o};$.post(r,s,function(e){console.log(e);var t=!1;if(e.hasOwnProperty("error")&&"true"==String(e.error)&&(t=!0),t){a=e.msg;alert(a)}else{var a="Grazie ! Registrazione completata ! Riceverai a breve una email all'indirizzo "+s.email+" con i dettagli per l'attivazione della tua userid su AppKwonDo";alert(a),$.mobile.back()}})}function isValidEmail2(e){return"string"==typeof e&&/^[\w+\d+._]+\@[\w+\d+_+]+\.[\w+\d+._]{2,8}$/.test(e)}function isValidEmail(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)}function doLogin(e){conslog("socket",socket),socket||(socket=io.connect(rooturl)),conslog("socket",socket);var t=$("#login"),a=t.find("#txt-email").val(),o=t.find("#txt-password").val(),r=t.find("#chck-rememberme").prop("checked"),i=t.find("#chck-autologin").prop("checked"),n=[];""==a.trim()&&n.push("Fornisci una email"),""!=a.trim()&&(isValidEmail(a)||n.push("Fornisci una email valida")),""==o.trim()&&n.push("Fornisci una password");var s="";if(n.length>0)return n.forEach(function(e,t){s+=e+"\n"}),s="Sono stati riscontrati i seguenti errori: \n\n\n"+s,alert(s),void(e&&$.mobile.changePage("#login"));var c=rooturl+"/users/login";conslog("Accessing url "+c);var l=imgtext+"Accesso in corso...";$("#login #loginbutton").html(l);var d="Basic "+window.btoa(a+":"+o),g=window.btoa(a+":"+o);$.ajax({url:c,data:{email:a,password:o,authorization:d},type:"POST"}).done(function(e){if(progressStop(),colog("login result",e),"true"!=String(e.loggedin))return console.log("login unsuccessfull"),alert("Login fallito"),void $("#login #loginbutton").html("Accedi");colog("server returns user",user=e),role=user.role,loggedin=!0,myToast({body:"login eseguito con successo"});var t=e.token;chatuser.nickname=user.nickname;var o={device:"browser",type:"clientspecs",nickname:chatuser.nickname,appversion:appversion,email:user.email};isPhone&&(o.device="mobile"),socket.send(o),"tkdradmin"==role?($("#index .loginspan").html("Accesso amministratore eseguito"),$("#index #lilogout").show(),$("#index #lilogin").hide(),$("#index #liatleti").show(),$("#index #lisockets").show(),$("#gara #liresetcronaca").show(),$("#gara #lisysmsg").show(),$("#gare #liaggiungigara").show(),$("#page_atleti #liaggiungiatleta").show(),$("#iscrittiPage #btnAddIscritto").show(),$("#gare #test").show(),$(".showadmin").show()):$(".showadmin").hide(),console.log("ckal: "+i);var n=!1;if(i&&(console.log("setting autologin true"),setCookie("autologin","true",cookieDays),n=!0),r){var s={email:a,nickname:user.nickname,encuser:g,token:t,autologin:n,socketid:chatuser.sockid};setCookie("appkwondo_user",JSON.stringify(s)),colog("setted user cookies")}else deleteCookie("email"),deleteCookie("psw"),deleteCookie("token"),deleteCookie("nickname"),colog("deleted rememberme cookies");$.mobile.changePage("#index"),refreshNews(),setChatBubbles(),refreshChat(),conslog("sono qui qui"),updateHomeInfos(),conslog("updated home infos"),getPlatform(),conslog("isIOS",isIOS),isIOS&&(conslog("removing Indietro for iOS"),$(".lista a").css("height","20px"),$("a:contains('Indietro')").each(function(){$(this).text($(this).text().replace("Indietro","").trim()),$(this).addClass("ui-btn-icon-notext"),$(this).css("height","16px")})),notifyNextEvents(),$("#login #loginbutton").html("Login")}).fail(function(e){progressStop(),$("#login #loginbutton").html("Login"),conslog("error:"),conslog(e),myToast({body:"Error"})})}function getPlatform(){var e=navigator.platform.toLowerCase();isIOS=!1,e.indexOf("ipad")>-1&&(isIOS=!0),e.indexOf("mac")>-1&&(isIOS=!0),e.indexOf("ipod")>-1&&(isIOS=!0),e.indexOf("iphone")>-1&&(isIOS=!0)}function toggleVoice(){var e=!1;settings.voice&&"true"==String(settings.voice)&&(e=!0),e=!e,settings.voice=e,conslog("Vocal output setted to ",settings.voice)}function playVoice(e){clearTimeout(voiceTimer),conslog("playVoice settings.voice",settings.voice),settings.voice&&"true"==String(settings.voice)&&(voiceTimer=setTimeout(function(){if(isPhone)TTS.speak({text:e,locale:"it-IT",rate:1.2},function(){colog("success speaking")},function(e){console.log("error speaking, reason",e)});else if(window.speechSynthesis){var t=new SpeechSynthesisUtterance;t.lang="it-IT",t.text=e,window.speechSynthesis.speak(t)}else console.log("speec synthesis not found on this browser");clearTimeout(voiceTimer)},voiceTime))}function refreshNews(e){$.ajax({url:rooturl+"/news",dataType:"json",type:"GET"}).done(function(t){var a=new EJS({url:"tpl/news.ejs"}).render(t.rows);$("#page_news #content").html(a),e&&e(t)})}function initTabs(){$("#gara a[data-role=tab]").each(function(e){$(this).unbind(tapevent),$(this).bind(tapevent,function(){sdebug($(this).attr("id")),setActiveTab(activeTab=e)})})}function setActiveTab(e){return conslog("setActiveTab "+e),void $("#gara #navbar ul li:eq("+e+")").trigger("tap")}function loadCronaca(e,t){colog("loadcronaca for gara "+e),$.ajax({url:rooturl+"/matches/getcronaca/"+e,type:"GET"}).done(function(a){if($("#gara #listacronaca").empty(),a.error)console.log("error reading cronaca for this gara id="+e);else{console.log("cronaca: "+a.rows.length),colog(a);a.rows;cronaca=a,jGara.cronaca=cronaca,renderCronaca(cronaca)}t&&t()})}function setCronacaRead(e){var t=jcurrentgara.id+"_"+e;"disputata"!=jcurrentgara.stato.toLowerCase()&&(-1==cronaca_read.indexOf(t)&&(cronaca_read.push(t),crnonletti++),renderCronaca(jGara.cronaca))}function findCronacaRead(e){var t=!1,a=(jcurrentgara.stato,jcurrentgara.id+"_"+e.time);return cronaca_read.indexOf(a)>-1&&(t=!0),t}function findCronacaUnread(e){var t=!1;return $(cronaca_unread).each(function(a){var o=cronaca_unread[a];conslog("crow",o),o.time==e.time&&o.garaid==jcurrentgara.id&&(t=!0,conslog("questo non è stato letto"))}),t}function renderCronaca(e){var t=cronaca_read.length,a=e.rows.length-t;colog("non letti prima del <0: "+a),"disputata"==jcurrentgara.stato.toLowerCase()&&(a=0,deleteCronacaReadForGara(jcurrentgara.id)),a<0&&(a=0,deleteCronacaReadForGara(jcurrentgara.id)),setCookie("cronaca_read",JSON.stringify(cronaca_read)),colog("cronaca non letti per questa gara: "+a),colog("cronaca letti per questa gara",t),colog("cronaca non letti globale: "+crnonletti);var o=new EJS({url:"tpl/cronaca2.ejs"}).render(e);$("#gara #listacronaca").empty(),$("#gara #listacronaca").append(o),$("#gara #listacronaca").listview(),$("#gara #listacronaca").listview("refresh")}function getPunti(e,t,a){return 7*e+3*t+1*a}function resetFilters(){$("#temppopup #sex").val("_"),$("#temppopup #categ").val("_"),$("#temppopup #medag").val("_"),$("#temppopup #quadrato").val("_")}function setFilters(){var e="";$("#temppopup #sex").val()&&(e=$("#temppopup #sex").val()),"_"==e&&(e="");var t="";$("#temppopup #categ").val()&&(t=$("#temppopup #categ").val()),"_"==t&&(t="");var a="";$("#temppopup #medag").val()&&(a=$("#temppopup #medag").val()),"_"==a&&(a="");var o="";$("#temppopup #quadrato").val()&&(o=$("#temppopup #quadrato").val()),"_"==o&&(o="");var r="<font color='yellow'><b>Filtri applicati</b></font>",i="2px solid yellow";""==(garaFilters={categoria:t.toLowerCase().trim(),sesso:e,medaglia:a,quadrato:o}).categoria&&""==garaFilters.sesso&&""==garaFilters.medaglia&&""==garaFilters.quadrato&&(r="Nessun filtro",i="0px solid white"),$("#gara .spanfilt").html(r).css("border",i),popCloseRemove(),refreshCurrentGara()}function loadMatchesByProgOld(e,t){var a={matches:$allmatches,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(a,t),colog("loadmatchesbyprog "+e),$.ajax({url:rooturl+"/matches/findbygaraid/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){$allmatches=e,colog("total matches: "+($matches=e).rows.length);t=[];if(""!=cat){var t={rows:[]};$(e.rows).each(function(a){getCategoria(e.rows[a].doc.datanascita).toLowerCase()==cat.toLowerCase()&&t.rows.push(e.rows[a])}),colog("matches after categoria "+cat+": "+($matches=t).rows.length)}var o=new EJS({url:"tpl/matchesbyprog2.ejs"}).render($matches.rows),r=$("#gara ul#listabyprog");r.empty(),r.append(o),r.listview(),r.listview("refresh");var i="";""!=$.trim(viewcat)&&(i=" in cat. "+viewcat.toUpperCase()),colog("$allmatches for cat "+viewcat+"--------\x3e"+JSON.stringify($allmatches));var n=filterRows($matches,{dadisputare:"yes"}),s=filterRows(n,{disputato:"yes"});colog("$C---\x3e"+JSON.stringify(s));var c=filterRows(s,{vinto:"yes"}),l=filterRows(s,{vinto:"no"}),d=s.rows.length-c.rows.length,g=getMaschiFemmine(n.rows),p=n.rows.length+" match da disputare ( M: "+g.maschi+", F: "+g.femmine+" )";g=getMaschiFemmine(c.rows);var u=getMaschiFemmine(s.rows),h=getMaschiFemmine(l.rows);p+="<br>"+s.rows.length+" match disputati ( M: "+u.maschi+", F: "+u.femmine+" ) <br>"+c.rows.length+" vinti ( M: "+g.maschi+", F: "+g.femmine+" ) <br>"+d+" persi ( M: "+h.maschi+", F: "+h.femmine+" )"+i,$("#limatches").html(p);var m=filterRows(s,{medagliamatch:"oro"}),f=filterRows(s,{medagliamatch:"argento"}),v=filterRows(s,{medagliamatch:"bronzo"}),b=getMaschiFemmine(m.rows),w=getMaschiFemmine(f.rows),y=getMaschiFemmine(v.rows);p="ORI: "+m.rows.length+" ( M: "+b.maschi+", F: "+b.femmine+" ) - punti: "+getPunti(m.rows.length,0,0)+"<br>ARGENTI: "+f.rows.length+" ( M: "+w.maschi+", F: "+w.femmine+" ) - punti: "+getPunti(0,f.rows.length,0)+"<br>BRONZI: "+v.rows.length+" ( M: "+y.maschi+", F: "+y.femmine+" ) - punti: "+getPunti(0,0,v.rows.length)+"<br><br>Punteggio totale medaglie: "+getPunti(m.rows.length,f.rows.length,v.rows.length)+" "+i,$("#limedaglie").html(p),$("#gara #ulinfogara span").html(getMedaglieGara($matches)),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var e=$(this).index(),t=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+t).removeClass("ui-screen-hidden"),prevSelection=t,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var o=$(this).find("a").attr("data-tab-class");$("#gara .ul"+o).show(),activeTab=e,cacheViews(),a.callback&&a.callback()}),setActiveTab(activeTab)})}function cacheViews(){}function filterMatches(e,t){t||(t=!1);var a={rows:[]},o=!1;return $(e).each(function(r){var i="",n="",s="",c="",l="";t?(i=e[r].doc.datanascita,n=e[r].doc.medagliamatch,c=(s=e[r].doc.matchid).substring(0,s.length-2),l=e[r].doc.atletaid):(i=e[r].datanascita,n=e[r].medagliamatch,c=(s=e[r].matchid).substring(0,s.length-2),l=e[r].atletaid);var d=!0;for(f in garaFilters)if(""!=garaFilters[f]){if(o=!0,"categoria"==f){var g=getCategoria(i).toLowerCase().trim()!=garaFilters.categoria.toLowerCase().trim();garaFilters.categoria.toLowerCase().trim().indexOf("senior")>-1&&(g=-1==getCategoria(i).toLowerCase().trim().indexOf("senior")),g&&(d=d&&!1)}"medaglia"==f&&n.toLowerCase().trim()!=garaFilters.medaglia.toLowerCase().trim()&&(d=d&&!1),"quadrato"==f&&c.toLowerCase().trim()!=garaFilters.quadrato.toLowerCase().trim()&&(d=d&&!1),"sesso"==f&&($a=getAtletaById(l),$a.sesso.toLowerCase().trim()!=garaFilters.sesso.toLowerCase().trim()&&(d=d&&!1))}o?d&&a.rows.push(e[r]):a.rows.push(e[r])}),isFiltered=o,a}function filterMatchesByAtleta(e,t){t||(t=!1);var a={rows:[]},o=!1;return $(e).each(function(r){var i="",n="";t?(i=e[r].doc.datanascita,n=e[r].doc.id):(i=e[r].datanascita,n=e[r].id);var s=!0;for(f in garaFilters)if(""!=garaFilters[f]){if(o=!0,"categoria"==f){var c=getCategoria(i).toLowerCase().trim()!=garaFilters.categoria.toLowerCase().trim();garaFilters.categoria.toLowerCase().trim().indexOf("senior")>-1&&(c=-1==getCategoria(i).toLowerCase().trim().indexOf("senior")),c&&(s=s&&!1)}"sesso"==f&&($a=getAtletaById(n),$a.sesso.toLowerCase().trim()!=garaFilters.sesso.toLowerCase().trim()&&(s=s&&!1))}o?s&&a.rows.push(e[r]):a.rows.push(e[r])}),isFiltered=o,a}function loadMatchesByProg(e,t){var a={matches:$allmatches,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(a,t),colog("loadmatchesbyprog "+e),$.ajax({url:rooturl+"/matches/findbygaraid/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){$allmatches=e,colog("total matches: "+($matches=e).rows.length);var t={rows:[]};t=filterMatches(e.rows,!0),colog("matches after categoria "+cat+": "+($matches=t).rows.length),jmatchesbyprog=$matches,renderMatchesByProg();var o="";isFiltered&&(o=" (filtri applicati) "),colog("$allmatches --------\x3e"+JSON.stringify($allmatches));var r=filterRows($matches,{dadisputare:"yes"}),i=filterRows(r,{disputato:"yes"});colog("$C---\x3e"+JSON.stringify(i));var n=filterRows(i,{vinto:"yes"}),s=filterRows(i,{vinto:"no"}),c=i.rows.length-n.rows.length,l=getMaschiFemmine(r.rows),d=r.rows.length+" match da disputare ( M: "+l.maschi+", F: "+l.femmine+" )";l=getMaschiFemmine(n.rows);var g=getMaschiFemmine(i.rows),p=getMaschiFemmine(s.rows);d+="<br>"+i.rows.length+" match disputati ( M: "+g.maschi+", F: "+g.femmine+" ) <br>"+n.rows.length+" vinti ( M: "+l.maschi+", F: "+l.femmine+" ) <br>"+c+" persi ( M: "+p.maschi+", F: "+p.femmine+" )"+o,$("#limatches").html(d);var u=filterRows(i,{medagliamatch:"oro"}),h=filterRows(i,{medagliamatch:"argento"}),m=filterRows(i,{medagliamatch:"bronzo"}),f=getMaschiFemmine(u.rows),v=getMaschiFemmine(h.rows),b=getMaschiFemmine(m.rows);d="ORI: "+u.rows.length+" ( M: "+f.maschi+", F: "+f.femmine+" ) - punti: "+getPunti(u.rows.length,0,0)+"<br>ARGENTI: "+h.rows.length+" ( M: "+v.maschi+", F: "+v.femmine+" ) - punti: "+getPunti(0,h.rows.length,0)+"<br>BRONZI: "+m.rows.length+" ( M: "+b.maschi+", F: "+b.femmine+" ) - punti: "+getPunti(0,0,m.rows.length)+"<br><br>Punteggio totale medaglie: "+getPunti(u.rows.length,h.rows.length,m.rows.length)+" "+o,$("#limedaglie").html(d),$("#gara #ulinfogara span").html(getMedaglieGara($matches)),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var e=$(this).index(),t=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+t).removeClass("ui-screen-hidden"),prevSelection=t,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var o=$(this).find("a").attr("data-tab-class");$("#gara .ul"+o).show(),activeTab=e,cacheViews(),a.callback&&a.callback()}),setActiveTab(activeTab)})}function setRealtimeNotification(e){var t=notifiche_temporeale,a="Attivare";t.indexOf(e)>-1&&(a="Disattivare"),gConfirm("Vuoi "+a+" la notifica di tempo reale per questo atleta ?","Attivazione notifica atleta",function(){if("Attivare"==a)t.push(e);else for(var o=0;o<t.length;o++)t[o]==e&&t.splice(o,1);renderMatchesByProg(jmatchesbyprog),renderMatchesByAtleta(jmatchesbyatleta),console.log("ntr",t)},function(){})}function renderMatchesByProg(e){var t=new EJS({url:"tpl/matchesbyprog2.ejs"}).render(e.rows),a=$("#gara ul#listabyprog");if(a.empty(),a.append(t),a.listview(),a.listview("refresh"),$("#gara #nomatches").hide(),"tkdradmin"!=role&&(a.find("li").off("taphold"),a.find("li").on("taphold",function(){var t=$(this).index(),a=jGara.gara.rows[0].doc.id;if("disputata"!=jGara.gara.rows[0].doc.stato.toLowerCase()){var o=e.rows[t].doc;o.id;setRealtimeNotification(a+"_"+o.atletaid)}})),"tkdradmin"==role&&(a.find("li").off("taphold"),a.find("li").on("taphold",function(){var t=$(this).index(),a=e.rows[t].doc;conslog(a.doc);var o="Attivazione",r=!0,i="realtime_on";a.realtime&&"true"==String(a.realtime)&&(r=!1,o="Disattivazione",i="realtime_off"),gConfirm(o+" TempoReale per il match "+a.matchid+" ?",o+" TempoReale",function(){selectedid=a.id,selectedmatchid=a.matchid,realtime.active=r;var e="/matches/update/"+a.garaid+"/"+a.id,t={realtime:r,admin_action:i};$.post(rooturl+e,t,function(){console.log("realtime setted to "+realtime.active+" for matchid "+selectedid),refreshCurrentGara(function(){refreshChat(!0);var e=-1;if("true"==String(realtime.active)){for(var t=0;t<realtimeArray.length;t++)realtimeArray[t].match.id==selectedid&&(e=t);conslog("realtimeindex: ",e),realtimeindex=e}sendRealtime(!0)})})},function(){})})),0==e.rows.length){var o=refreshIscritti(!0);t=new EJS({url:"tpl/iscritti.ejs"}).render(o);var r=$("#gara #nomatches ul.iscritti_nomatches");r.empty(),r.append(t),r.listview(),r.listview("refresh"),$("#gara p.iscrittilength").html(o.length+" iscritti a questa gara"),isFiltered||$("#gara #nomatches").show()}}function loadMatchesByAtletaOld(e){colog("loadmatchesbyatleta "+e),$.ajax({url:rooturl+"/matches/findbygaraid/byatleta/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){var t=e;if(colog("total matches: "+t.length),""!=cat){var a=[];$(e).each(function(t){getCategoria(e[t].datanascita).toLowerCase()==cat.toLowerCase()&&a.push(e[t])}),colog("matches after categoria "+cat+": "+(t=a).length)}var o=new EJS({url:"tpl/matchesbyatleta4.ejs"}).render(t),r=$("ul#listabyatleta");r.empty(),r.append(o),r.listview(),r.listview("refresh"),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var e=$(this).index(),t=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+t).removeClass("ui-screen-hidden"),prevSelection=t,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var a=$(this).find("a").attr("data-tab-class");$("#gara .ul"+a).show(),activeTab=e,cacheViews()}),setActiveTab(activeTab)})}function loadMatchesByAtleta(e){colog("loadmatchesbyatleta "+e),$.ajax({url:rooturl+"/matches/findbygaraid/byatleta/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){var t=e;colog("total matches: "+t.length);var a=[],o=!1;$(e).each(function(t){var r=e[t].datanascita,i=e[t].id,n=!0;for(var s in garaFilters)""!=garaFilters[s]&&(o=!0,"categoria"==s&&(garaFilters[s].toLowerCase().trim().indexOf("senior")>-1?-1==getCategoria(r).toLowerCase().trim().indexOf("senior")&&(n=n&&!1):getCategoria(r).toLowerCase().trim()!=garaFilters.categoria.toLowerCase().trim()&&(n=n&&!1)),"sesso"==s&&getAtletaById(i).sesso.toLowerCase().trim()!=garaFilters.sesso.toLowerCase().trim()&&(n=n&&!1));o?n&&a.push(e[t]):a.push(e[t])}),isFiltered=o,colog("matches after categoria "+cat+": "+(t=a).length),renderMatchesByAtleta(t)})}function renderMatchesByAtleta(e){conslog(e);var t=new EJS({url:"tpl/matchesbyatleta4.ejs"}).render(e),a=$("ul#listabyatleta");a.empty(),a.append(t),a.listview(),a.listview("refresh"),a.find("li").off("taphold"),a.find("li").on("taphold",function(){var t=$(this).index(),a=jGara.gara.rows[0].doc.id;"disputata"!=jGara.gara.rows[0].doc.stato.toLowerCase()&&setRealtimeNotification(a+"_"+e.rows[t].id)}),$("#gara #navbar ul li").unbind(tapevent).bind(tapevent,function(){var e=$(this).index(),t=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+t).removeClass("ui-screen-hidden"),prevSelection=t,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var a=$(this).find("a").attr("data-tab-class");$("#gara .ul"+a).show(),activeTab=e,cacheViews(),setActiveTab(activeTab)})}function refreshMeByProg(e){var t=$matches;sdebug("$mm.lenght: "+t.find("match").length);var a={matches:t,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(a,e);var o=a.matches;sdebug("refreshMeByProg matches: "+o.find("match").length+" - shownullmatches: "+a.showNullMatches+" - ulSelector: "+a.ulSelector),refreshMode="byprog";var r=$.parseXML("<matches></matches>"),i=$(r);sdebug("matches: "+$matches.find("match").length);var n=garaid,s="";o.find("match").each(function(){var e=$(this),t=$(this).find("garaid").text();if(sdebug("match: "+t),t==n){var a=$(this).find("progid").text(),o=$(this).find("atletaid").text(),r=$.trim($(this).find("datanascita").text());sdebug(a+" - "+o+" datanasc: "+r);var s=e.clone();if(""!=$.trim(viewcat)){var c=getCategoria(r);sdebug("categoria for "+o+": "+c),$.trim(viewcat)==$.trim(c)&&i.find("matches").append(s)}else i.find("matches").append(s)}}),matches=i.find("match"),matches.sort(function(e,t){var a=$(e).find("progid").text(),o=$(t).find("progid").text();return a<o?-1:a>o?1:0}),matches.each(function(){var e=$(this).clone(),t=$(this).find("id").text(),o=($(this).find("progid").text(),$(this).find("matchid").text()),r=$(this).find("vinto").text(),i=$(this).find("disputato").text(),n=$(this).find("dadisputare").text(),c=$(this).find("medagliamatch").text(),l=$(this).find("risultato").text(),d=$(this).find("datanascita").text(),g=getCategoria(d).toUpperCase(),p=$(this).find("atletaid").text(),u=$(this).find("atletaname").text();e.append("<atletaname></atletaname>"),e.find("atletaname").text(u),$msav.find("matches").append(e);var h="",m=!1,f="";if("yes"==$.trim(n)&&(m=!0),"no"==$.trim(n)&&(m=!1,f="black",a.showNullMatches&&(m=!0)),"yes"==$.trim(i)&&("yes"==$.trim(r)&&(h=" style='background-color: green' ",f="green"),"no"==$.trim(r)&&(h=" style='background-color: #C00000 ' ",f="red")),m){var v="matchtoplay.png";"oro"==c&&(v="medaglia_oro.png"),"argento"==c&&(v="medaglia_argento.png"),"bronzo"==c&&(v="medaglia_bronzo.png"),"yes"==$.trim(i)&&"none"==c&&("yes"==$.trim(r)&&(v="matchok.png"),"yes"!=$.trim(r)&&(v="matchko.png"));var b="",w="Non disputato",y="nondisputato";"yes"==$.trim(i)&&(y="vinto",w="Vinto, ",b="risultato: "+l,"yes"!=$.trim(r)&&(w="Perso, ",y="perso")),b=w+b,h="";var k="onclick='setResult(this)'";a.clickAtletaMatches&&(k="onclick=\"matchesPerAtleta('"+p+"','"+u+"','"+d+"')\""),s+="<li "+h+" tkdr-matchid='"+o+"' data-icon='false' id='match_"+t+"' ><a  shref=javascript:matchAtletaDetail('"+p+"') id='prog"+t+"' data-ajax='false'  href='#' "+k+" shref='gareatleta.html?atletaid="+p+"&garaid="+garaid+"'><img swidth='50' sheight='50' src='images/"+v+"' class='imgicon sui-li-icon ui-corner-none' ><div><span class='match "+f+"'>"+o+"</span><br><span class='categoria'>"+g+"</span><br><span class='atleta'>"+u+"</span><br><span class='soft "+y+"'>"+b+"</span></div></a><input type='hidden' class='datanascita' value='"+d+"' /><input type='hidden' class='atletaid' value='"+p+"' /><input type='hidden' class='atletaname' value='"+u+"'/></li>"}});var c=a.ulSelector,l=$("ul#"+c);if(l.empty(),l.append(s),l.listview(),l.listview("refresh"),a.showUpdated){$("#ulinfogara li span.left").html(sgetMedaglieGara(garaid));var d="";""!=$.trim(viewcat)&&(d=" in cat. "+viewcat.toUpperCase());var g=filterRows($allMatches,{dadisputare:"yes"}),p=(filterRows(g,{disputato:"yes"}),filterRows(g,{vinto:"yes"})),u=filterRows(g,{vinto:"no"}),h=g.rows.length+" incontri da disputare";h+="<br>"+g.rows.length+" incontri disputati, "+p.length+" vinti, "+u.length+" persi",$("#limatches").html(h+d),$("#gara #ulinfogara span").html(getMedaglieGara($a));var m=new Date,f=formatDateTime(m);sdebug("data "+f),$("li.liprog").find("span").html("Aggiornato: "+f)}null!=a.callback&&a.callback()}function refreshSocietaServer(){var e=imgtext+"Caricamento...";$("#page_societa #recnum span").html(e),debugga("refreshSocietaServer"),$.ajax({url:rooturl+"/societa/findall",type:"GET"}).done(function(e){if(e.error)toast("errore","long");else{toast("Societa caricate da "+rooturl);var t=$("#lista_societa");t.html("");var a='<li data-role="list-divider" role="heading" data-theme="b">'+e.rows.length+" atleti</li>";t.append(a);var o=new EJS({url:"tpl/societa.ejs"}).render(e.rows);t.empty().append(o),progressStop(),$("#page_societa #recnum span").html(e.rows.length+" societa"),t.find("li").off(tapevent),t.find("li").on(tapevent,function(){var e=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+e),progressStart("Lettura dati"),$.ajax({url:rooturl+"/societa/findall",type:"GET"}).done(function(t){progressStop();var a=t.data.rows[0].doc,o=(createHtmGrid(a),createHtmListview(a));$("#page_societa  #listax_societa").empty().append(o),$("#page_societa #societa").val(e),$.mobile.changePage("#page_societa"),$("#page_societa  #listax_societa").listview()}),!1}),t.find("li").off("taphold"),t.find("li").on("taphold",function(){if(loggedin&&"tkdradmin"==role){var e=$(this).find("a").attr("id").split("_")[0],t=$(this).find("a").attr("id").split("_")[1];gConfirm("Confermi l'eliminazione della societa ?","Conferma eliminazione",function(){var a={};a.id=e,a.rev=t,$.ajax({url:rooturl+"/societa/delete",type:"POST",data:a}).done(function(e){e.error?console.log("error"):(console.log("posted"),refreshSocietaServer())}).fail(function(){toast("Error posting","long")})},function(){})}}),t.listview(),t.listview("refresh")}})}function refreshEventiServer(e){var t=imgtext+"Caricamento...";$("#page_eventi #recnum span").html(t),debugga("refreshEventiServer"),$.ajax({url:rooturl+"/eventi/findall",type:"GET"}).done(function(t){if(t.error)toast("errore","long");else{conslog("Eventi caricati da "+rooturl);var a=$("#lista_eventi");a.html("");var o='<li data-role="list-divider" role="heading" data-theme="b">'+t.rows.length+" eventi</li>";a.append(o),t.rows.sort(function(e,t){var a=e.doc.data,o=t.doc.data,r=a.substring(6,10)+a.substring(3,5)+a.substring(0,2),i=o.substring(6,10)+o.substring(3,5)+o.substring(0,2);return r>i?1:r<i?-1:0});var r=new EJS({url:"tpl/eventi.ejs"}).render(t.rows);a.empty().append(r),progressStop(),$("#page_eventi #recnum span").html(t.rows.length+" eventi"),a.find("li").off("taphold"),a.find("li").on("taphold",function(){if(loggedin&&"tkdradmin"==role){var e=$(this).find("a").attr("id").split("_")[0],t=$(this).find("a").attr("id").split("_")[1];gConfirm("Confermi l'eliminazione dell'evento' ?","Conferma eliminazione",function(){var a={};a.id=e,a.rev=t,$.ajax({url:rooturl+"/eventi/delete",type:"POST",data:a}).done(function(e){e.error?console.log("error"):(console.log("posted"),refreshEventiServer())}).fail(function(){toast("Error posting","long")})},function(){})}}),a.listview(),a.listview("refresh")}e&&e(t)})}function getHistoryForAtleta(e){var t=$("#page_atleta").find("input#atletaid").val();console.log(t);var a=rooturl+"/gare/history/"+t;progressStart("Calcolo storico in corso"),$.get(a,function(e){console.log(e),console.log(e.rows.length);var t=new EJS({url:"tpl/historyatleta.ejs"}).render(e);$("#page_atleta .historyatleta").html(t),progressStop()})}function getMpaHistoryAtleta(){var e=$("#matchesatleta #atletaid").val(),t=rooturl+"/gare/history/"+e;$.get(t,function(t){var a=getAtletaById(e);t.tkdtatleta=getTkdtAtleta(a),colog("tkdtatleta",t.tkdtatleta),t.avversari=getTkdtAtletiCategoria(t.tkdtatleta.cateta,t.tkdtatleta.catcintura,t.tkdtatleta.catpeso,t.tkdtatleta.sesso),colog("avversari",t.avversari),t.tabulato=getTkdtTabulatiCategoria(t.tkdtatleta.cateta,t.tkdtatleta.catcintura,t.tkdtatleta.catpeso,t.tkdtatleta.sesso),colog("tabulato",t.tabulato);var o=new EJS({url:"tpl/mpahistoryatleta2.ejs"}).render(t);$("#matchesatleta #historyatleta").html(o),progressStop(),$("#matchesatleta").trigger("create")})}function getMpaHistoryAtletaForme(){var e=$("#matchesatleta #atletaid").val(),t=rooturl+"/gare/history/"+e;$.get(t,function(t){var a=getAtletaById(e);t.tkdtatleta=getTkdtAtleta(a),conslog("tkdtatleta",t.tkdtatleta),t.avversari=getTkdtAtletiCategoriaForme(t.tkdtatleta.cateta,t.tkdtatleta.catcintura,t.tkdtatleta.cattipo,t.tkdtatleta.sesso),conslog("avversari",t.avversari);var o=new EJS({url:"tpl/mpahistoryatleta.ejs"}).render(t);$("#matchesatleta #historyatleta").html(o),progressStop(),$("#matchesatleta").trigger("create")})}function getHistoryForAtletaId(e){console.log(e);var t=rooturl+"/gare/history/"+e;progressStart("Calcolo storico in corso"),$.get(t,function(e){conslog(e),conslog(e.rows.length);var t=new EJS({url:"tpl/historyatleta.ejs"}).render(e);$("#page_atleta .historyatleta").html(t),progressStop()})}function refreshAtletiServer(e){debugga("refreshAtletiServer");var t=imgtext+"Caricamento...";$("#page_atleti #recnum span").html(t),app.loadAllSchede(function(t){if(colog("atleti:",t),displayedAtleti=Object.assign({},t),t.error)toast("errore","long");else{conslog("Atleti caricati da "+rooturl);var a=$("#lista_atleti");a.html("");var o='<li data-role="list-divider" role="heading" data-theme="b">'+t.rows.length+" atleti</li>";a.append(o);var r=new EJS({url:"tpl/atleti.ejs"}).render(t.rows);a.empty().append(r),progressStop(),$("#page_atleti #recnum span").html(t.rows.length+" atleti in "+settings.mysocietaname),a.find("li").off(tapevent),a.find("li").on(tapevent,function(){playFeedback();var e=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+e),progressStart("Lettura dati"),atleta.loadById(e,function(t){progressStop();var a=t.data.rows[0].doc,o=(createHtmGrid(a),createHtmListview(a));$("#page_atleta  #listax_atleta").empty().append(o),$("#page_atleta #atletaid").val(e),$("#page_atleta .historyatleta").empty(),getHistoryForAtleta(),$.mobile.changePage("#page_atleta"),$("#page_atleta  #listax_atleta").listview()}),!1}),a.find("li").off("taphold"),a.find("li").on("taphold",function(){if(loggedin&&"tkdradmin"==role){var e=$(this).find("a").attr("id").split("_")[0],t=$(this).find("a").attr("id").split("_")[1];gConfirm("Confermi l'eliminazione dell'atleta ?","Conferma eliminazione",function(){var a={};a.id=e,a.rev=t,$.ajax({url:rooturl+"/atleti/delete",type:"POST",data:a}).done(function(e){e.error?console.log("error"):(console.log("posted"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")})},function(){})}}),a.listview(),a.listview("refresh")}e&&e()})}function progressStart(e){$.mobile.loading("show",{text:e,textVisible:!0,theme:"b",html:""})}function progressStop(){$.mobile.loading("hide")}function refreshSchede(){var e=$("#liElencoSchede");e.html("");var t='<li data-role="list-divider" role="heading" data-theme="b">'+app.storage.length+" schede</li>";e.append(t);for(var a=0;a<app.storage.length;a++){var o=$("<li data-theme='c'><a href='#' data-transition='slide'>"+app.storage.key(a)+"</a></li>");o.off(tapevent),o.on(tapevent,function(){scheda.load($(this).text()),$("#txtNome").val(scheda.data.nome),$("#txtIndirizzo").val(scheda.data.indirizzo),$("#txtDescrizione").val(scheda.data.descrizione),$("#txtPrezzo").val(scheda.data.prezzo),$("#scanDiv").html(scheda.data.barcode),""!=$.trim(scheda.data.photoURI)?($("#fotoAnteprima").attr("src",scheda.data.photoURI).css({width:"128px",height:"128px"}),$("#fotoAnteprima").on(tapevent,function(){$("#fullPhoto").attr("src",scheda.data.photoURI).css({width:"400px",height:"700px"}),$.mobile.changePage("#viewPhoto",{role:"dialog"})})):$("#fotoAnteprima").attr("src","img/nophoto.jpg").css({width:"128px",height:"128px"}),$("#scheda h3").html("Modifica "+boname),$.mobile.changePage("#scheda")}),o.off("taphold"),o.on("taphold",function(){var e=$(this).text();navigator.notification.confirm("Confermi l'eliminazione della scheda?",function(t){1==t&&(scheda.remove(e),$.mobile.changePage("#elencoSchede"))},"Conferma eliminazione","Sì,No")}),e.append(o)}e.listview("refresh")}function alerta(e){isPhone?navigator.notification.alert(e,function(){},"Avviso"):debugga(e)}function debugga(e){colog(e)}function newScheda(){delete scheda.data._id,delete scheda.data._rev,scheda.data.nome="",scheda.data.indirizzo="",scheda.data.descrizione="",scheda.data.prezzo="",scheda.data.coordinate="",scheda.data.photoURI="",scheda.data.barcode="",$("#txtNome").val(""),$("#txtIndirizzo").val(""),$("#txtDescrizione").val(""),$("#txtPrezzo").val(""),$("#scanDiv").html("No code"),$("#fotoAnteprima").attr("src","img/nophoto.jpg").css({width:"128px",height:"128px"}),$("#scheda h3").html("Nuova "+boname),$.mobile.changePage("#scheda")}function toast(e,t){myToast({body:e})}function gConfirm(e,t,a,o){isPhone?navigator.notification.confirm(e,function(e){1==e?a():o()},t,"Sì,No"):confirm(e)?a():o()}function importAtleti(){$.ajax({url:rooturl+"/atleti/findall",type:"GET"}).done(function(e){alert(e.length)})}function getNormalD(e){return e.substring(6)+e.substring(3,5)+e.substring(0,2)}function createPopup(e){var t=$('<a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-right">Close</a>').button(),a=$("<div/>",{"data-role":"popup"}).css({width:$(window).width()/1.5+"px"}).append(t).append(e);$(".ui-page-active").append(a),$("[data-role=popup]").on("popupafterclose",function(){$(this).remove()}).on("popupafteropen",function(){$(this).popup("reposition",{positionTo:"window"})}).popup({dismissible:!1,history:!1,theme:"b",overlayTheme:"b"}).popup("open")}function tapFilters(){if(getPlatform(),isIOS){conslog("clicked on filters");var e=$("#gara ul#ulcategorie");e.listview(),e.listview("refresh"),openPopup(new EJS({url:"tpl/popfilters.ejs"}).render({}),"Filtri"),$("#temppopup #setfilt").button(),$("#temppopup #resetfilt").button(),$("#temppopup td").css("padding","5px"),$("#temppopup").css("padding","5px").css("top","10px !important"),""!=garaFilters.categoria?$("#temppopup #categ").val(garaFilters.categoria):$("#temppopup #categ").val("_"),""!=garaFilters.sesso?$("#temppopup #sex").val(garaFilters.sesso):$("#temppopup #sex").val("_"),""!=garaFilters.medaglia?$("#temppopup #medag").val(garaFilters.medaglia):$("#temppopup #medag").val("_"),""!=garaFilters.quadrato?$("#temppopup #quadrato").val(garaFilters.quadrato):$("#temppopup #quadrato").val("_")}}function createHtmGrid(e){var t="<table border=1 width='300'>";for(var a in e)colog(" name="+a+" value="+e[a]),t+="<tr><td>"+a+"</td><td>"+e[a]+"</td></tr>";return t+="</table>"}function createHtmListview(e){var t='<ul data-role="listview">',t="";for(var a in e){colog(" name="+a+" value="+e[a]);var o=e[a];"categoria"==a.toLowerCase()&&(o=getCategoria(e.datanascita,!0).toUpperCase()),t+='<li class="gradient ui-li-static ui-body-inherit"><span class="small">'+a+'</span><br><span class="medium">'+o+"</li>"}return t}function bindGaraPage(){colog("bindaGaraPage"),$(document).on("pageshow","#gara",function(){debug("durl: "+$(this).data("url")),garaid=parm_garaid,setActiveTab(activeTab),$("#gara #dialogCategorie").popup(),$("#gara #dialogForAtleta").popup(),$("#gara #refresh").off(tapevent),$("#gara #refresh").on(tapevent,function(){debug("activetab: "+activeTab)}),$(".tb").remove(),$("#av_toolbar_regdiv").remove(),$("#av_toolbar_iframe").remove(),$("#gara .spancat").off(tapevent),$("#gara .spancat").on(tapevent,function(e){sdebug("clicked on categorie");var t=$("#gara ul#ulcategorie");t.listview(),t.listview("refresh"),e.preventDefault(),openPopup(new EJS({url:"tpl/popcategorie.ejs"}).render({}),"Categorie")}),$("#gara .spanfilt").off(tapevent),$("#gara .spanfilt").on(tapevent,function(e){conslog("clicked on filters");var t=$("#gara ul#ulcategorie");t.listview(),t.listview("refresh"),e.preventDefault(),openPopup(new EJS({url:"tpl/popfilters.ejs"}).render({}),"Filtri"),$("#temppopup #setfilt").button(),$("#temppopup #resetfilt").button(),$("#temppopup td").css("padding","5px"),$("#temppopup").css("padding","5px").css("top","10px !important"),""!=garaFilters.categoria?$("#temppopup #categ").val(garaFilters.categoria):$("#temppopup #categ").val("_"),""!=garaFilters.sesso?$("#temppopup #sex").val(garaFilters.sesso):$("#temppopup #sex").val("_"),""!=garaFilters.medaglia?$("#temppopup #medag").val(garaFilters.medaglia):$("#temppopup #medag").val("_"),""!=garaFilters.quadrato?$("#temppopup #quadrato").val(garaFilters.quadrato):$("#temppopup #quadrato").val("_")}),$("#gara #ulcategorie li").off(tapevent),$("#gara #ulcategorie li").on(tapevent,function(){var e=$(this).text();viewcat=e.toLowerCase();var t=e.toLowerCase();"tutte"==viewcat.toLowerCase()&&(viewcat=""),cat=viewcat,document.cookie="cookiecat="+viewcat+"; expires=Thu, 18 Dec 2023 12:00:00 UTC",$("#dialogCategorie").popup("close"),t.indexOf("esordienti")>-1&&(t=t.replace("esordienti","eso")),t.indexOf("cadetti")>-1&&(t=t.replace("cadetti","cad")),t.indexOf("junior")>-1&&(t=t.replace("junior","jun")),t.indexOf("senior")>-1&&(t=t.replace("senior","sen")),$(".spancat").text(cattxt+t.toUpperCase()),refreshCurrentGara()}),$("#gara #listabyprog li").off(tapevent),$("#gara #listabyprog li").on(tapevent,function(){$(this).attr("id").replace("prog","")}),$("#gara #navbar ul li").on("vclick",function(){var e=$(this).index(),t=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+t).removeClass("ui-screen-hidden"),prevSelection=t,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var a=$(this).find("a").attr("data-tab-class");$("#gara .ul"+a).show(),activeTab=e,cacheViews()}),setActiveTab(activeTab),$("#gara #bubble").off(tapevent),$("#gara #bubble").on(tapevent,function(){if(setAllCronacaRead(jcurrentgara.id),notifyseen=!0,notifycount=0,nonletti=0,$("#gara .nonvisto").removeClass("nonvisto"),$("#gara #bubble").html("0").hide(),cronaca.rows.length>0){setCookie("lastcronaca",cronaca.rows[0].time);var e=getCookie("cronacaletti_"+jcurrentgara.id);e||(e=""),$(cronaca.rows).each(function(t){var a=cronaca.rows[t];""!=e.trim()&&(e+=","),e+=a.time}),setCookie("cronacaletti_"+jcurrentgara.id,e)}$("#gara a#tab_cronaca").trigger("click")}),$("#gara #panelright").off(tapevent),$("#gara #panelright").on(tapevent,function(){$(this).panel("close")}),anninascita="",cat="",searchgara="",""!=$.trim(cat)&&(debug("viewing category: "+cat),viewcat=cat);var e=getCookie("cookiecat");""!=$.trim(e)&&(viewcat=e);var t="";""==$.trim(t)&&(t="tutte"),t.indexOf("esordienti")>-1&&(t=t.replace("esordienti","eso")),t.indexOf("cadetti")>-1&&(t=t.replace("cadetti","cad")),t.indexOf("junior")>-1&&(t=t.replace("junior","jun")),t.indexOf("senior")>-1&&(t=t.replace("senior","sen")),t=t.toUpperCase(),$("#gara .spancat").text(cattxt+t),debug("cookiecat: "+e),""==$.trim(garaid)&&""==$.trim(searchgara)&&(searchgara="corna"),showMsg&&$("#msgBar").show()})}function setFilters(){console.log("clicked filters"),conslog("clicked on filters");var e=$("#gara ul#ulcategorie");e.listview(),e.listview("refresh"),openPopup(new EJS({url:"tpl/popfilters.ejs"}).render({}),"Filtri"),$("#temppopup #setfilt").button(),$("#temppopup #resetfilt").button(),$("#temppopup td").css("padding","5px"),$("#temppopup").css("padding","5px").css("top","10px !important"),""!=garaFilters.categoria?$("#temppopup #categ").val(garaFilters.categoria):$("#temppopup #categ").val("_"),""!=garaFilters.sesso?$("#temppopup #sex").val(garaFilters.sesso):$("#temppopup #sex").val("_"),""!=garaFilters.medaglia?$("#temppopup #medag").val(garaFilters.medaglia):$("#temppopup #medag").val("_"),""!=garaFilters.quadrato?$("#temppopup #quadrato").val(garaFilters.quadrato):$("#temppopup #quadrato").val("_")}function setAllCronacaRead(e){var t=jGara.cronaca;$(t.rows).each(function(a){var o=t.rows[a].time,r=e+"_"+o;"disputata"!=jcurrentgara.stato.toLowerCase()&&-1==cronaca_read.indexOf(r)&&(cronaca_read.push(r),--crnonletti<0&&(crnonletti=0))}),renderCronaca(t)}function setCategoria(e){var t=$(e).text();viewcat=t.toLowerCase();var a=t.toLowerCase();"tutte"==viewcat.toLowerCase()&&(viewcat=""),cat=viewcat,document.cookie="cookiecat="+viewcat+"; expires=Thu, 18 Dec 2023 12:00:00 UTC",$("#dialogCategorie").popup("close"),a.indexOf("esordienti")>-1&&(a=a.replace("esordienti","eso")),a.indexOf("cadetti")>-1&&(a=a.replace("cadetti","cad")),a.indexOf("junior")>-1&&(a=a.replace("junior","jun")),a.indexOf("senior")>-1&&(a=a.replace("senior","sen")),$(".spancat").text(cattxt+a.toUpperCase()),refreshCurrentGara(),popCloseRemove()}function sdebug(e){debugga(e)}function debug(e){debugga(e)}function captureAudio(){navigator.device.capture.captureAudio(function(e){var t,a=e[0],o=new FileReader;o.onload=function(e){e.target.result},t=new window.File(a.name,a.localURL,a.type,a.lastModifiedDate,a.size),o.readAsDataURL(t)})}function captureVideo(){navigator.device.capture.captureVideo(function(e){var t,a=e[0],o=new FileReader;o.onload=function(e){e.target.result},t=new window.File(a.name,a.localURL,a.type,a.lastModifiedDate,a.size),o.readAsDataURL(t)})}function openChatFoto(e){if(console.log("openchatfoto"),isPhone){if(e.toLowerCase().trim().indexOf("http:")>-1)return void window.cordova.plugins.FileOpener.openFile(e,function(t){conslog("file "+e+" successfully opened")},function(t){console.log("error opening file "+e),console.log(t)});var t=e.replace("data:image/jpeg;base64,","");window.Base64ImageSaverPlugin.saveImageDataToLibrary(function(e){console.log(e),e="file://"+e,window.cordova.plugins.FileOpener.openFile(e,function(t){conslog("file "+e+" successfully opened")},function(t){console.log("error opening file "+e),console.log(t)})},function(e){console.log(e)},t)}else window.open(e,"_system","width=310,height=30")}function openImage(e){var t=e.replace("thumb_","");if(isPhone)window.cordova.plugins.FileOpener.openFile(t,function(e){conslog("file "+t+" successfully opened")},function(e){console.log("error opening file "+t)});else{e.replace("thumb_","");$("#viewimage #img1").attr("src",e.replace("thumb_","")),$.mobile.changePage("#viewimage")}}function getCookie(e){for(var t=e+"=",a=document.cookie.split(";"),o=0;o<a.length;o++){for(var r=a[o];" "==r.charAt(0);)r=r.substring(1);if(0==r.indexOf(t))return r.substring(t.length,r.length)}return""}function filterIscritti(e){var t=[],a=!1;$(e).each(function(o){var r=getAtletaById(e[o]),i=getCategoria(r.datanascita),n=r.sesso,s=!0;""==e[o].trim()&&(s=s&&!1);for(f in garaFilters)""!=garaFilters[f]&&(a=!0,"sesso"==f&&n.toLowerCase().trim()!=garaFilters[f].toLowerCase().trim()&&(s=s&&!1),"categoria"==f&&(garaFilters[f].toLowerCase().trim().indexOf("senior")>-1?-1==i.toLowerCase().trim().indexOf("senior")&&(s=s&&!1):i.toLowerCase().trim()!=garaFilters[f].toLowerCase().trim()&&(s=s&&!1)));s&&t.push(e[o])});t.length;return t}function refreshGara(e,t){var a={callback:null};$.extend(a,t),refreshCronaca(),oldupdatetext=$("#gara #ulinfogara li span.left").html(),$("#gara #ulinfogara li span.left").html("Aggiornamento...");colog("gara: "+JSON.stringify($gara));var o=$gara;$("#gara #hdr").find("#hgara a").html(o.doc.location+" -     "+o.doc.data+" - "+settings.mysocietaname),$("#hdriscritti").find("h1").html(o.doc.title+" "+o.doc.location+" -     "+o.doc.data);var r=filterIscritti(o.doc.iscritti.split(",")).length;$("#ligaratitle").html("Gara: <b>"+o.doc.title+"</b>"),$("#ligaralocation").html("Location: "+o.doc.location),$("#liiscritti").text(r+" atleti iscritti "),datagara=o.doc.data;var i=datagara.split("/");annogara=i[2];new Date;$("#gara #hgara a").css("width","100%")}function getMaschiFemmine(e,t){jcurrentgara.iscritti.split(",");var a=0,o=0;return $(e).each(function(r){var i,n="M";(i=getAtletaById("iscritti"==t?e[r]:e[r].doc.atletaid)).sesso&&(n=i.sesso.toUpperCase()),"M"==n&&a++,"F"==n&&o++}),{maschi:a,femmine:o}}function refreshCronaca(){}function getMedaglieGara(e){var t=0,a=0,o=0;return $(e.rows).each(function(r){var i=e.rows[r].doc,n=(i.garaid,i.datanascita,$.trim(i.medagliamatch));"oro"==$.trim(n)&&t++,"argento"==$.trim(n)&&a++,"bronzo"==$.trim(n)&&o++}),"<span style='color: yellow;'>ORI: <b>"+t+"</b></span>&nbsp;&nbsp;&nbsp;<span style='color: silver;'>ARG: <b>"+a+"</b></span>&nbsp;&nbsp;&nbsp;<span style='color: orange;'>BRO: <b>"+o+"</b></span>"}function getCategoria(e,t){var a="senior a",o=(new Date).getFullYear();if(jcurrentgara.data||(t=!0),1!=t&&(o=jcurrentgara.data.split("/")[2]),""==$.trim(e))return"senior b";var r=e.split(".")[2],i=parseInt(o,10)-parseInt(r,10);return i>=18&&i<=35&&(a="senior a"),i>=15&&i<=17&&(a="junior"),i>=12&&i<=14&&(a="cadetti a"),i>=10&&i<=11&&(a="cadetti b"),i>35&&(a="senior b"),i<10&&(a="esordienti"),a}function showIscritti(){refreshIscritti(),$("#iscrittiPage #selectiscr").controlgroup(),$("#iscrittiPage #selectiscr").controlgroup("refresh",{shadow:!0}),$("#iscrittiPage input:checkbox").checkboxradio(),$("#iscrittiPage input:checkbox").checkboxradio("refresh"),$("#iscrittiPage input[type='checkbox']").attr("checked",!0).checkboxradio("refresh"),$("#iscrittiPage #selectiscr").trigger("create"),$.mobile.changePage("#iscrittiPage"),$("#iscrittiPage").page()}function getMatchesCountForAtleta(e){var t=jGara.matchesbyprog,a=0;return $(t.rows).each(function(o){t.rows[o].doc.atletaid==e&&a++}),a}function refreshIscritti(e){e||(e=!1);var t="",a=jGara.gara.rows[0].doc;conslog("refreshiscritti:"),conslog(a),a.myiscritti&&(t=a.myiscritti),colog("iscritti: "+t);var o=filterIscritti(t.split(",")),r="",i=[];if($(o).each(function(e){var t=getAtletaById(o[e]),a={};a.nome=t.cognome+" "+t.nome,a.id=t.id,a.sesso=t.sesso,a.categoria=getCategoria(t.datanascita);getTkdtAtleta(t);var r=getTkdtCategoria(t);a.tkdtcategoria=r,i.push(a)}),i.sort(function(e,t){var a=e.nome.trim(),o=t.nome.trim();return a>o?1:a<o?-1:0}),1==e)return i;conslog("atls",i);var r=new EJS({url:"tpl/iscritti.ejs"}).render(i),n=$("#iscrittiPage #uliscritti");n.empty(),n.append(r),n.listview(),n.listview("refresh"),$("#iscrittiPage #infogaraiscritti").html(i.length+" iscritti")}function getAtletaById(e,t){var a="";return $($atleti.rows).each(function(t){var o=$atleti.rows[t].doc,r=o.id;o.cognome,o.nome;if(r==e)return a=o}),a}function refreshMatchesForAtleta(){showMatchesForAtleta($("#matchesatleta #atletaid").val())}function showMatchesForAtleta(e){lastDisplayedAtletaId=e,$("#matchesatleta #atletaid").val(e);var t=[],a=getAtletaById(e);selectedAtl=a;var o=jGara.matchesbyprog;$(o.rows).each(function(r){var i=o.rows[r];i.doc.atletaid==e&&(i.doc.tkdtcategoria=getTkdtCategoria(a),t.push(i))}),t.sort(function(e,t){var a=e.doc.progid,o=t.doc.progid;return a>o?1:a<o?-1:0});var r=new EJS({url:"tpl/matchesforatleta2.ejs"}).render(t),i=$("#matchesatleta #listampa");i.empty(),i.append(r),$("#matchesatleta #historyatleta").empty(),getMpaHistoryAtleta(),$(document).off("taphold","#matchesatleta ul#listampa li"),$("#matchesatleta ul#listampa li").off("swipe"),$("#matchesatleta ul#listampa li").on("swipe",function(e){conslog("event",e);var t=$(e.currentTarget);conslog("li",t.attr("id")),conslog("swipe event");t.attr("id").replace("match_","")}),$("#matchesatleta ul#listampa li").off("taphold"),$("#matchesatleta ul#listampa li").on("taphold",function(e){if("tkdradmin"==role&&loggedin){$(this).addClass("tapped");var t=$(this).attr("id").replace("match_","");delmatchid=t,"disputata"!=jcurrentgara.stato&&$("#popDelMatch").popup("open")}}),$("#matchesatleta #mparecnum").html(t.length+" incontri per "+a.cognome+" "+a.nome)}function showMatchesForAtletaForme(e){lastDisplayedAtletaId=e,$("#matchesatleta #atletaid").val(e);var t=[],a=getAtletaById(e);selectedAtl=a;var o=jGara.matchesbyprog;$(o.rows).each(function(a){var r=o.rows[a];r.doc.atletaid==e&&t.push(r)}),t.sort(function(e,t){var a=e.progid,o=t.progid;return a>o?1:a<o?-1:0}),conslog("$matchesforatleta",t);var r=new EJS({url:"tpl/matchesforatletaforme.ejs"}).render(t),i=$("#matchesatleta #listampa");i.empty(),i.append(r),$("#matchesatleta #historyatleta").empty(),getMpaHistoryAtletaForme(),$(document).off("taphold","#matchesatleta ul#listampa li"),$("#matchesatleta ul#listampa li").off("swipe"),$("#matchesatleta ul#listampa li").on("swipe",function(e){conslog("event",e);var t=$(e.currentTarget);conslog("li",t.attr("id")),conslog("swipe event");t.attr("id").replace("match_","")}),$("#matchesatleta ul#listampa li").off("taphold"),$("#matchesatleta ul#listampa li").on("taphold",function(e){if("tkdradmin"==role&&loggedin){$(this).addClass("tapped");var t=$(this).attr("id").replace("match_","");delmatchid=t,"disputata"!=jcurrentgara.stato&&$("#popDelMatch").popup("open")}}),$("#matchesatleta #mparecnum").html(t.length+" incontri per "+a.cognome+" "+a.nome)}function sysMsg(e){var t=$.mobile.activePage.attr("id"),a="";if(e&&(a=e),loggedin&&"tkdradmin"==role){var o={destsocket:a},r=new EJS({url:"tpl/sysmsg.ejs"}).render(o);$("#"+t+" div[data-role=content]").append(r),$("#"+t+" #popSysMsg #dest").val(a),$("#"+t+" #popSysMsg").popup(),$("#"+t+" #popSysMsg").popup("open")}}function sysMsgOk(){var e=$.mobile.activePage.attr("id"),t=$("#"+e+" #popSysMsg #tamsg").val(),a=$("#"+e+" #popSysMsg #dest").val();if(""!=t.trim()){var o="all";""!=a.trim()&&(o=a),socketNotify({type:"notification",to:o,text:t}),$("#"+e+" #popSysMsg").popup("close").remove()}else $("#gara #popSysMsg").popup("close").remove()}function sysMsgCancel(){var e=$.mobile.activePage.attr("id");$("#"+e+" #popSysMsg").popup("close").remove()}function popGareOk(){$("#gare #popGare").popup("close").remove()}function popGareCancel(){$("#gare #popGare").popup("close").remove()}function sendRtCmd(e,t){var a=$("#matchConsole #rtidx").val(),o=realtimeArray[a],r=o.result;if("p1plus"==e){var i=c=r.split("-")[0],n=l=r.split("-")[1],s=(i=parseInt(c,10)+1)+"-"+n;realtimeArray[a].result=s}if("p1minus"==e){var i=c=r.split("-")[0],n=l=r.split("-")[1];(i=parseInt(c,10)-1)<0&&(i=0);s=i+"-"+n;realtimeArray[a].notifykey=getRtNotifyKey(i,n),realtimeArray[a].result=s}if("p2plus"==e){var c=r.split("-")[0],n=l=r.split("-")[1],s=(i=c)+"-"+(n=parseInt(l,10)+1);realtimeArray[a].notifykey=getRtNotifyKey(i,n),realtimeArray[a].result=s}if("p2minus"==e){var c=r.split("-")[0],l=r.split("-")[1],i=c,n=l;(n=parseInt(c,10)-1)<0&&(n=0);s=i+"-"+n;realtimeArray[a].notifykey=getRtNotifyKey(i,n),realtimeArray[a].result=s}if(e.indexOf("pause")>-1){var d=!1,d=!1;o.paused&&(d=o.paused),d=!d,realtimeArray[a].notifykey="paused_"+d}if(e.indexOf("round_")>-1){var g=e.split("_")[1];o.round=g,realtimeArray[a].notifykey="startround_"+g}if(e.indexOf("endround")>-1){var p=!1;p=$(t).find(":checked").length>0,realtimeArray[a].notifykey="endround_"+p,o.endround=p}console.log("rtcmd",o),mapConsole(a)}function getRtNotifyKey(e,t){var a=parseInt(e,10),o=parseInt(t,10);return a>o?"puntoafavore":a<o?"puntocontro":a==o?"puntipari":""}function updateConsole(e){var t=realtimeArray[e];$("div#popResult .ui-content").find("#risult").val(t.result)}function viewConsoleOld(e){return conslog("viewConsole",e,realtimeArray[e]),void $.mobile.changePage("#matchConsole")}function viewConsole(e){mapConsoles(e)}function mapConsoles(e){var t=$("#popResult #realtimediv");$("#popResult #consolenavb");colog("mapconsoles "+e);var a={},o=!1;if(e>-1){a=consoles[e],conslog(a),selectedid=a.match.id,selectedmatchid=a.match.matchid;a.match.id;var r=a.match.matchid;a.match.realtime&&"true"==String(a.match.realtime)&&(o=!0)}$("#popResult #matchid").val(a.match.id),$("#popResult #matchnumber").val(a.match.matchid),o?t.show():t.hide();var i=$("#popResult .ui-content");i.find("#ck_realtime").prop("checked",o).checkboxradio("refresh");var n=!0,s=!1,c=!1,l="1";a.paused&&(n=a.paused),a.fineround&&(s=a.fineround),a.running&&(c=a.running),a.result&&a.result,a.round&&(l=a.round),c?(n=!1,s=!1):n=!0,conslog("paused",n,"running",c,"round",l),$("#popResult #hdrpopresult h1").html(r+" - "+a.match.atletaname);var d=!1,g="black",p="IN PAUSA";"false"==String(n)&&(d=!0),i.find("#ckpausematch").prop("checked",d).checkboxradio("refresh"),d&&(g="orange",p="IN CORSO");var u="<span style='color: "+g+";'>"+p+"</span>";$("#popResult label[for=ckpausematch]").html(u),d=!1,s&&(d=!0),i.find("#ckfineround").prop("checked",d).checkboxradio("refresh"),i.find("#risult").val(a.result),$("#popResult .roundnumber").css("background","silver");var h=-1;h="gp"==l.toLowerCase()?3:parseInt(l,10)-1,$("#popResult .roundnumber:eq("+h+")").css("background","green")}function mapConsole(e){var t=$("#popResult #realtimediv"),a=$("#popResult #navb");conslog("mapconsole "+e);var o={};e>-1?(o=realtimeArray[e],conslog(o),selectedid=o.match.id,selectedmatchid=o.match.matchid,t.show(),lastrealtime=o,a.removeClass("translucid")):(console.log("lastenteredmatch",lastenteredmatch),selectedid=lastenteredmatch.id,selectedmatchid=lastenteredmatch.matchid,console.log("selectedid",selectedid,"selectedmatchid",selectedmatchid),(o=lastrealtime).match=lastenteredmatch,console.log("idx=-1, rta:",o),t.hide(),a.addClass("translucid")),realtimeindex=e;var r=!0,i=!1,n=!1,s="1";o.paused&&(r=o.paused),o.fineround&&(i=o.fineround),o.running&&(n=o.running),o.result&&o.result,o.round&&(s=o.round),n?(r=!1,i=!1):r=!0,conslog("paused",r,"running",n,"round",s);var c=$("#popResult .ui-content");$("#popResult #hdrpopresult h1").html(selectedmatchid+" - "+o.match.atletaname);var l=!1,d="black",g="IN PAUSA";"false"==String(r)&&(l=!0),c.find("#ckpausematch").prop("checked",l).checkboxradio("refresh"),l&&(d="orange",g="IN CORSO");var p="<span style='color: "+d+";'>"+g+"</span>";$("#popResult label[for=ckpausematch]").html(p),l=!1,i&&(l=!0),c.find("#ckfineround").prop("checked",l).checkboxradio("refresh"),c.find("#risult").val(o.result),$("#popResult .roundnumber").css("background","silver");var u=-1;u="gp"==s.toLowerCase()?3:parseInt(s,10)-1,$("#popResult .roundnumber:eq("+u+")").css("background","green")}function renderRealtimeTabs(e){return}function showMatchConsole(e){console.log("showMatchConsole",e),$.mobile.changePage("#popResult");var t=!1;e.realtime&&"true"==String(e.realtime)&&(t=!0),$("#popResult #ck_realtime").prop("checked",t).checkboxradio().checkboxradio("refresh")}function renderConsoleTabs(){if(colog("renderconsoletabs",consoles),0==consoles.length)return $("#popResult #consolenavb").remove(),void conslog("consoles array=0");for(var e="",t=!1,a=0;a<consoles.length;a++){selectedid==consoles[a].match.id&&(t=!0),conslog("selid",selectedid,"matchid",consoles[a].match.id);var o="gray",r="normal";consoles[a].match.realtime&&"true"==String(consoles[a].match.realtime)&&(o="lightgreen",r="normal");var i=consoles[a].match.atletaname.substring(0,10)+"...";e+='<li><a onclick="mapConsoles('+a+')"  style="font-size: 13px; font-weight: '+r+"; color: "+o+';" data-href="a">'+consoles[a].match.matchid+" "+i+"</a></li>"}conslog(selectedid,t),$("#popResult #consolenavb").remove();var n=$('<div data-role="navbar" id="consolenavb" style="border: 0px solid yellow"><ul>'+e+"</ul></div>");conslog(n.html()),$("#popResult #hdrpopresult #navcontainer").append(n).trigger("create");var s=$("#popResult #matchid").val();$("#popResult #consolenavb li a").removeClass("ui-btn-active");for(a=0;a<consoles.length;a++)consoles[a].match.id==s&&$("#popResult #consolenavb li a:eq("+a+")").addClass("ui-btn-active")}function deleteFromConsoles(e){for(var t=0;t<consoles.length;t++)consoles[t].match.id==selectedid&&(consoles.splice(t,1),console.log("match "+e+" deleted from consoles array"));$(consoles).each(function(e){var t=consoles[e].match;t.id==selectedid&&(found=!0,matchToAdd=t)})}function checkConsoles(e,t){colog("checking if match "+e+" already in consoles array");var a=!1;if($(consoles).each(function(e){consoles[e].match.id==selectedid&&(a=!0)}),a)colog("match "+e+" already in consoles array, doing nothing");else{colog("match is not into consoles array, adding it");var o={active:!1,match:getMatchById(e),result:"0-0",round:"1",paused:!0,running:!1};t&&(o=t),consoles.push(o),colog("match "+e+" added to consoles array")}}function setResult(e){if(loggedin&&"tkdradmin"==role){var t=!1;if("disputata"==jcurrentgara.stato&&(t=!0),!t){sdebug("setresult");var a=$(e).closest("li");a.addClass("liselected");var o=a.attr("id").replace("match_","");sdebug("clicked matchid: "+o),selectedid=o;var r=o,i=a.attr("tkdr-matchid");selectedmatchid=a.attr("tkdr-matchid");var n=getMatchById(o);lastenteredmatch=jQuery.extend(!0,{},n),colog("last entered match",lastenteredmatch),conslog(n);var s=!1;n.realtime&&"true"==String(n.realtime)&&(s=!0),$("#popResult #hdrpopresult #navb").remove(),$.mobile.changePage("#popResult"),$("#popResult #matchid").val(r),$("#popResult #matchnumber").val(i),$("#popResult #checkgp").prop("checked",!1),$("#popResult #hdrpopresult h1").html(i+" - "+n.atletaname),conslog("mtch",n),$("#popResult #risult").val("0-0"),checkConsoles(r);var c=getConsolesIndex(r);$("#popResult #risult").val(consoles[c].result),$("#popResult #ck_realtime").prop("checked",s).checkboxradio().checkboxradio("refresh");var l=$("#popResult #realtimediv");if(s){colog("you entered a realtime match");l.show(),$("#popResult #navb ul li:eq(0) a").addClass("ui-btn-active")}else conslog("This match is not realtime"),l.hide();renderConsoleTabs()}}}function selectRealtimeTab(e){for(var t=0;t<realtimeArray.length;t++)realtimeArray[t].match.id==selectedid&&(e=t);$("#popResult #navb ul li:eq("+e+") a").addClass("ui-btn-active")}function removeFromConsoles(){$("#popResult #ck_realtime:checked").length>0?alert("Disattivare il realtime prima di eliminare una console"):deleteFromConsoles($("#popResult #matchid").val())}function setResultOld(e){if(loggedin&&"tkdradmin"==role){var t=!1;if("disputata"==jcurrentgara.stato&&(t=!0),!t){sdebug("setresult");var a=$(e).closest("li");a.addClass("liselected");var o=a.attr("id").replace("match_","");sdebug("clicked matchid: "+o),selectedid=o,selectedmatchid=a.attr("tkdr-matchid"),renderRealtimeTabs();var r=getMatchById(selectedid);$("#popResult #hdrpopresult h1").html(selectedmatchid+" - "+r.atletaname),console.log("mtch",r),$("#popResult #risult").val("0-0"),console.log("usepopup",!1),$("#popResult #checkgp").prop("checked",!1).checkboxradio().checkboxradio("refresh"),$("#popResult #radio_round1").prop("checked",!0).checkboxradio().checkboxradio("refresh");var i=!1;r.realtime&&"true"==String(r.realtime)&&(i=!0),console.log("rt: "+i),$("#popResult #ck_realtime").prop("checked",i).checkboxradio().checkboxradio("refresh"),$.mobile.changePage("#popResult",{changeHash:!0}),$("#popResult").css("padding",".4em"),i?$("#popResult #realtimediv").show():$("#popResult #realtimediv").hide()}}}function setResultById(e,t){if(loggedin&&"tkdradmin"==role){var a=jcurrentgara.stato,o=filterRows($allmatches,{id:e}),r=!1;if(0==o.rows.length&&(r=!0),"disputata"==a&&(r=!0),!r){colog("setresultbyid "+e),colog(o),sdebug("setting result2 for matchid: "+e),selectedid=e,selectedmatchid=o.rows[0].doc.matchid,$("#popResult #risult").val(t.risultato);var i=!1;t.goldenpoint&&"yes"==t.glodenpoint&&(i=!0),$("#popResult #checkgp").prop("checked",i).checkboxradio("refresh")}}}function setResultCancel(){$("ul#listampa li").removeClass("liselected"),selectedid="",selectedmatchid="",$.mobile.changePage("#matchesatleta")}function sgetMatchesForAtleta(e,t){var a=e;console.log("input",e);filterRows(a,{atletaid:t},!0)}function setResultOK2(){var e="",t="",a=new Array("primo","secondo","terzo","quarto","quinto","sesto","settimo","ottavo","nono","decimo"),o=new Array("finale","semifinale","quarto di finale","ottavo di finale","sedicesimo di finale","trentaduesimo di finale"),r=$("#popResult #risult").val(),i=$("#popResult #checkgp").prop("checked");colog("goldenpoint: "+i);var n=selectedid;n=$("#popResult #matchid").val();var s=$("#popResult #matchnumber").val();conslog("setting result for match "+n),delMatchFromRealtime(n),deleteFromConsoles(n);var c=getAtletaById(getMatchById(n).atletaid);console.log("jgara",jGara.matchesbyprog);var l=filterRows(jGara.matchesbyprog,{atletaid:c.id});console.log("atleta: ",c),console.log("mfa",l),progressStart("Aggiornamento..","Aggiornamento");var d=c.cognome+" "+c.nome,g=getCategoria(c.datanascita),p=(c.cognome,c.nome,"nondisputato");$("#popResult #radio_vinto:checked").length>0&&(p="vinto"),$("#popResult #radio_perso:checked").length>0&&(p="perso"),$("#popResult #radio_nondisputato:checked").length>0&&(p="nondisputato");var u={},h="updagent.php?action=edit&tag=match",m="/matches/update/"+jcurrentgara.id+"/"+n,f=$("#matchesatleta ul#listampa li").length,v=0;$(l.rows).each(function(e){l.rows[e].doc.id==n&&(v=e)}),console.log("ord1",v);var b=$("#matchesatleta ul#listampa li#match_"+n).index();b=v;var w=(f=l.rows.length)-b-1,y=w-1,k="",x="",_="",C="none",S="vince";if("nondisputato"==p)C="none",!1,u={vinto:k="no",disputato:x="no",dadisputare:_="yes",realtime:!1};else{"vinto"==p&&(k="yes",S="vince"),"perso"==p&&(k="no",S="perde"),x="yes",_="yes";var A=s,T="";1==f&&(T=" e unico ");var j="";w<4&&(j=", "+o[w]),console.log("ordarr",a[b],b),e+=d+" "+S+" il suo "+a[b]+" "+T+"incontro (n."+A+j+") ",""!=$.trim(r)&&(e+=" per "+r),u={vinto:k,disputato:x,dadisputare:_,realtime:!1},console.log("docvintoperso",u),u.goldenpoint=i,i&&"true"==String(i)&&(e+=" al golden point ");var R="";y<2&&(R=" !!"),y>-1&&"yes"==k&&(e+=" e va in "+o[y]+R+". ")}h+="&id="+n,h+="&garaid="+garaid,h+="&vinto="+k,h+="&disputato="+x,h+="&dadisputare="+_,""!=$.trim(r)&&(h+="&risultato="+r,u.risultato=r),sdebug("ln: "+f),sdebug("ord: "+b),parseInt(b,10)==parseInt(f,10)-1&&("yes"==x?("no"==k&&(C="argento"),"yes"==k&&(C="oro")):C="none"),parseInt(b,10)==parseInt(f,10)-2&&("yes"==x?"no"==k&&(C="bronzo"):C="none"),"none"!=C&&(e+=". E' "+C.toUpperCase()+" !"),h+="&medagliamatch="+C,u.medagliamatch=C;var P=0;$(l.rows).each(function(e){var a=l.rows[e].doc.id,o="updagent.php?action=edit&tag=match&garaid="+garaid+"&id="+a,r={};if(e<b&&(sdebug("gara precedente "+e),"yes"==x&&(o+="&disputato=yes&vinto=yes&dadisputare=yes&medagliamatch=none",r.disputato="yes",r.vinto="yes",r.dadisputare="yes",r.medagliamatch="none"),sdebug(o),o="/matches/update/"+jcurrentgara.id+"/"+a,$.ajax({type:"POST",url:rooturl+o,data:r,async:!1})),e>b){if(sdebug("gara successiva "+e),1==++P){var i=getDerby(a,g);$(i.rows).each(function(e){colog("derby con "+i.rows[e].doc.atletaname),t=" .Sarà derby con "+i.rows[e].doc.atletaname+" al "+i.rows[e].doc.matchid+" ! ";var o=i.rows[e].doc.id,r="/matches/update/"+jcurrentgara.id+"/"+o;"yes"==k?($.ajax({type:"POST",url:rooturl+r,data:{derby:a},async:!1}),r="/matches/update/"+jcurrentgara.id+"/"+a,$.ajax({type:"POST",url:rooturl+r,data:{derby:o},async:!1})):(t="",$.ajax({type:"POST",url:rooturl+r,data:{derby:null},async:!1}),r="/matches/update/"+jcurrentgara.id+"/"+a,$.ajax({type:"POST",url:rooturl+r,data:{derby:null},async:!1}))}),P=0}"yes"==x&&("yes"==k&&(o+="&disputato=no&vinto=no&dadisputare=yes&medagliamatch=none",r.disputato="no",r.vinto="no",r.dadisputare="yes",r.medagliamatch="none"),"no"==k&&(o+="&disputato=no&vinto=no&dadisputare=no&medagliamatch=none",r.disputato="no",r.vinto="no",r.dadisputare="no",r.medagliamatch="none")),"no"==x&&(o+="&disputato=no&vinto=no&dadisputare=yes&medagliamatch=none",r.disputato="no",r.vinto="no",r.dadisputare="yes",r.medagliamatch="none"),o="/matches/update/"+jcurrentgara.id+"/"+a,r.savedmatch=!0,r.realtime=!1,sdebug(o),$.ajax({type:"POST",url:rooturl+o,data:r,async:!1})}}),e+=t;var E="savecronaca.php?garaid="+garaid+"&text="+encodeURI(e);E="/matches/addcronaca/"+jcurrentgara.id,console.log("posting doc",u),u.admin_action="setresult",$.post(rooturl+m,u,function(){delete u.admin_action,$.mobile.back();$("ul#listampa li.liselected").find("input:hidden.atletaid").val();c.id,$("#matchesatleta ul#listampa li").removeClass("liselected");var t=getCookie("notifiche_atleta");t&&""!=t.trim()&&t.indexOf(c.id.trim()),socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,matchid:n,matchnumber:s,result:"",ammoniz1:0,ammoniz2:0,event:"realtime",text:"",match:getMatchById(n),active:!1,deleterealtime:!0}),socketNotify({type:"notification",to:"all",text:e,garaid:jcurrentgara.id,updategara:"yes"}),postChat({garaid:jcurrentgara.id,nickname:chatuser.nickname,sockid:chatuser.sockid,color:"yellow",text:e}),$.ajax({type:"POST",url:rooturl+E,async:!1,data:{text:e}},function(){loadCronaca()}),openGara(jGara.gara.rows[0].doc.id,function(){showMatchesForAtleta(c.id),progressStop()})})}function setResultOK(e){var t=$("#popResult #matchid").val();$("#popResult #matchnumber").val();conslog("setting result for match "+t),delMatchFromRealtime(t),deleteFromConsoles(t);var a=$("#popResult #risult").val(),o=$("#popResult #checkgp").prop("checked"),r=getMatchById(t);r.goldenpoint=o,r.risultato=a;var i=getAtletaById(r.atletaid),n={match:r,atl:i,mfa:filterRows(jGara.matchesbyprog,{atletaid:i.id})},s=rooturl+"/matches/setresultok";console.log("posting result, match",r),progressStart(),postData(s,n,function(e){console.log("gara refreshed"),progressStop(),$.mobile.changePage("#matchesatleta")})}function postData(e,t,a){$.post(e,t,function(e){a&&a(e)})}function getDerby(e,t){colog("getDerby for matchid "+e+" in category "+t);var a={rows:[]},o={rows:[]};colog("allmatches");var r=jGara.matchesbyprog;colog(r);var i=filterRows(r,{id:e}),n=i.rows[0].doc.matchid,s=getCategoria(i.rows[0].doc.datanascita),c=filterRows(r,{matchid:n,dadisputare:"yes",disputato:"no"});return colog("incontri con matchid="+n+": "+c.rows.length+" in categoria "+s),$(c.rows).each(function(a){var r=c.rows[a];if(r.doc.id!=e){var i=getCategoria(r.doc.datanascita),s=!0;i.trim().toLowerCase()!=t.trim().toLowerCase()&&(s=!1,colog("match "+n+" in category "+i+" ignored, searching for category "+t)),s&&o.rows.push(r)}}),$(o.rows).each(function(e){var t=o.rows[e],i=t.doc.atletaname,s=t.doc.atletaid,c=filterRows(r,{atletaid:s});c.rows.sort(function(e,t){var a=e.doc.matchid,o=t.doc.matchid;return a>o?1:a<o?-1:0});var l=0;colog("analisi incontri di "+i),$(c.rows).each(function(e){var t=c.rows[e],o=t.doc.matchid,r=t.doc.disputato,i=t.doc.dadisputare,s=!1;"no"==r&&"yes"==i&&(l++,s=!0),colog("matchid "+o+" - eligible: "+s),o==n&&1==l&&(a.rows.push(t),colog("è il primo prossimo incontro, DERBY OK"))})}),colog("Derby trovati per match id "+e+": "+a.rows.length),a}function setCorazzaColor(e){$("#popAddMatch").find("#color").val(e),$("#popAddMatch").find("#blue").css("border","4px solid yellow"),$("#popAddMatch").find("#red").css("border","0px solid yellow"),"red"==e&&($("#popAddMatch").find("#red").css("border","4px solid yellow"),$("#popAddMatch").find("#blue").css("border","0px solid yellow"))}function addMatch(){var e=$("#popAddMatch");console.log(jGara),jGara.gara.rows[0].doc.tipogara&&"forme"==jGara.gara.rows[0].doc.tipogara.toLowerCase()&&(e=$("#popAddMatchForme")),e.popup("open")}function addMatchCancel(){var e=$("#popAddMatch");jGara.gara.rows[0].doc.tipogara&&"forme"==jGara.gara.rows[0].doc.tipogara.toLowerCase()&&(e=$("#popAddMatchForme")),e.popup("close")}function addMatchFormeCancel(){var e=$("#popAddMatch");jGara.gara.rows[0].doc.tipogara&&"forme"==jGara.gara.rows[0].doc.tipogara.toLowerCase()&&(e=$("#popAddMatchForme")),e.popup("close")}function refreshMatches(e){colog("RefreshMatches");var t=imgtext+"Aggiornamento match...";$("#gara .medals").html(t),mf={maschi:"0",femmine:"0"},loadMatchesByProg(jcurrentgara.id,{callback:function(){progressStop(),e&&e()}}),loadMatchesByAtleta(jcurrentgara.id),loadCronaca(jcurrentgara.id),autorefresh&&setMatchesRefresh()}function addMatchOK(){var e=$("#popAddMatch #matchid"),t=$("#popAddMatch #color").val(),a=Right(e.val(),2),o=selectedAtl.datanascita,r=selectedAtl.cognome+" "+selectedAtl.nome,i=selectedAtl.id,n={progid:a,societaid:settings.mysocieta,societaname:settings.mysocietaname,garaid:jcurrentgara.id,atletaid:i,atletaname:r,risultato:"",ordine:"1",vinto:"no",disputato:"no",dadisputare:"yes",matchid:e.val().toUpperCase().trim(),color:t,lastupdate:"never",datanascita:o};$.ajax({url:rooturl+"/matches/add/"+jcurrentgara.id,type:"POST",data:n}).done(function(e){e.error?console.log("error"):(console.log("posted"),$(e.addedmatches.rows).each(function(t){var a=e.addedmatches.rows[t],o=a.doc.id,r=getCategoria(a.doc.datanascita);colog("derbies"),colog("$allmatches");var i=jGara.matchesbyprog;colog(i),i.rows.push(a);var n=getDerby(o,r);if(colog(n),n.rows.length>0&&i.rows.length>0){var s=n.rows[0].doc.id,c="/matches/update/"+jcurrentgara.id+"/"+o;$.ajax({type:"POST",url:rooturl+c,data:{derby:s},async:!1}),c="/matches/update/"+jcurrentgara.id+"/"+s,$.ajax({type:"POST",url:rooturl+c,data:{derby:o},async:!1})}}),toast("Match "+n.matchid+" added for atleta "+selectedAtl.cognome+" "+selectedAtl.nome),openGara(jGara.gara.rows[0].doc.id,function(){refreshIscritti(),$("#popAddMatch").popup("close"),showMatchesForAtleta(selectedAtl.id)}))}).fail(function(){toast("Error posting","long")})}function addMatchFormeOK(){var e=$("#popAddMatchForme #matchid"),t=$("#popAddMatchForme #color").val(),a=(Right(e.val(),2),selectedAtl.datanascita),o=selectedAtl.cognome+" "+selectedAtl.nome,r=selectedAtl.id,i=$("#popAddMatchForme #selforma").val(),n=$("#popAddMatchForme #medforma").val(),s={societaid:settings.mysocieta,societaname:settings.mysocietaname,garaid:jcurrentgara.id,atletaid:r,atletaname:o,ordine:"1",vinto:"no",disputato:"yes",dadisputare:"yes",matchid:e.val().toUpperCase().trim(),voto:e.val().toUpperCase().trim(),color:t,lastupdate:"never",datanascita:a,forma:i,medagliamatch:n};$.ajax({url:rooturl+"/matches/addforme/"+jcurrentgara.id,type:"POST",data:s}).done(function(e){if(e.error)console.log("error");else{console.log("posted");var t=s.atletaname+" ha eseguito la forma "+i+", voto assegnato "+s.voto+".";"none"!=n.toLowerCase().trim()&&(t+=" E' "+n),postChat({garaid:jcurrentgara.id,nickname:chatuser.nickname,sockid:chatuser.sockid,color:"yellow",text:t}),toast("Match "+s.matchid+" added for atleta "+selectedAtl.cognome+" "+selectedAtl.nome),openGara(jGara.gara.rows[0].doc.id,function(){refreshIscritti(),$("#popAddMatchForme").popup("close"),showMatchesForAtletaForme(selectedAtl.id)})}}).fail(function(){toast("Error posting","long")})}function test(){return}function filterAndRender(e){colog("filterandrender "+JSON.stringify(e));var t=filterRows($allmatches,e),a=new EJS({url:"tpl/matchesbyprog2.ejs"}).render(t.rows),o=$("ul#listabyprog");o.empty(),o.append(a),o.listview(),o.listview("refresh");var r=filterRows(t,{dadisputare:"yes"}),i=(filterRows(r,{disputato:"yes"}),filterRows(r,{vinto:"yes"})),n=filterRows(r,{vinto:"no"}),s=r.rows.length+" incontri da disputare";s+="<br>"+r.rows.length+" incontri disputati, "+i.length+" vinti, "+n.length+" persi",$("#limatches").html(s),$("#gara #ulinfogara span").html(getMedaglieGara(t))}function filterRows(e,t,a){a||(a=!1);var o={rows:[]},r=e.rows;return $(r).each(function(e){var i=r[e],n=!0;for(var s in i.doc)for(var c in t)if(c==s){var l=t[c].toLowerCase();if(""!=l.trim()){var d=i.doc[s].toLowerCase();a?d.trim()==l.trim()||(n=n&&!1):d.indexOf(l)>-1||(n=n&&!1)}}n&&o.rows.push(i)}),o}function filterArray(e,t,a){a||(a=!1);var o=[],r=e;return $(r).each(function(e){var i=r[e],n=!0;for(var s in i)for(var c in t)if(c==s){var l=t[c].toLowerCase();if(""!=l.trim()){var d=i[s].toLowerCase();a?d.trim()==l.trim()||(n=n&&!1):d.indexOf(l)>-1||(n=n&&!1)}}n&&o.push(i)}),o}function searchMatches(){var e=[],t=0,a=0,o=0,r=0,i=0,n=0,s=0,c="M";c=$("#searchMatches #sex").val();var l=$("#searchMatches #categ").val(),d=$("#searchMatches #medag").val(),g="";$("#searchMatches #quadrato").val()&&(g=$("#searchMatches #quadrato").val().trim()),g||(g=""),"_"==g&&(g="");var p=[{name:"sesso",value:c},{name:"categoria",value:l},{name:"medagliamatch",value:d}],u={rows:[]};$($allmatches.rows).each(function(e){var t=$allmatches.rows[e].doc,a=getAtletaById(t.atletaid),o={};t.sesso=a.sesso,t.categoria=getCategoria(a.datanascita),o=t,u.rows.push(o)}),$(u.rows).each(function(t){var a=u.rows[t],o=!0;$(p).each(function(e){var t=p[e];if(a[t.name]){var r=a[t.name].toLowerCase(),i="";null!=t.value&&(i=t.value.toLowerCase());var n=!0;""==i.trim()&&(n=!1),"_"==i.trim()&&(n=!1),n&&-1==r.indexOf(i)&&(o=!1)}else o=!1});getAtletaById(a.atletaid);if(o)if(""!=g.trim()){var r=a.matchid.trim();r.substring(0,r.length-2).trim()==g&&e.push(a)}else e.push(a)});var h="";$(e).each(function(c){var l=e[c].disputato,d=e[c].dadisputare,g=e[c].vinto,p="",u="",m="blacknormal";"yes"==d.toLowerCase().trim()?(m="blacknormal","yes"==l.toLowerCase().trim()&&(p="<b>",u="</b>",m="yes"==g.toLowerCase().trim()?"green":"red")):m="black",h+="<li class='"+m+"'><span class='"+m+"'>"+p+e[c].atletaname+" - "+e[c].matchid+u+"</span></li>","yes"==e[c].disputato?("yes"==e[c].vinto?t++:a++,o++,"oro"==e[c].medagliamatch&&i++,"argento"==e[c].medagliamatch&&n++,"bronzo"==e[c].medagliamatch&&s++):r++});var m="";m+="<b>totale incontri trovati: "+e.length+"</b><br>",m+="disputati: "+o+"<br>",m+="vinti: "+t+"<br>",m+="persi: "+a+"<br>",m+="non disputati: "+r+"<br>",m+="ori: "+i+"<br>",m+="argenti: "+n+"<br>",m+="bronzi: "+s+"<br><br><br>",$("#searchMatches #searchResults").empty().html(m),$("#searchMatches #searchlist").empty(),$("#searchMatches #searchlist").append(h),$("#searchMatches #searchlist").listview(),$("#searchMatches #searchlist").listview("refresh")}function addGara(){conslog("addgara"),$.mobile.changePage("#page_addgara")}function addEvento(){conslog("addevento"),$.mobile.changePage("#page_addevento")}function addSocieta(){conslog("addsocieta"),$.mobile.changePage("#page_addsocieta")}function addAtleta(){conslog("addatleta"),$("#page_addatleta").find("#societaid").val(settings.mysocieta),getSocietaById(settings.mysocieta,function(e){e.rows.length>0&&$("#page_addatleta").find("#societa").html("Società: <b>"+e.rows[0].doc.nome.toUpperCase()+"</b>"),$.mobile.changePage("#page_addatleta")})}function addAtletaOk(e){var t=$(e).closest("div[data-role=page]"),a={},o=checkValidAtletaForm(t);1!=o.error?(t.find(".jform").each(function(){var e=$(this).attr("id");a[e]=$(this).val()}),$.ajax({url:rooturl+"/atleti/add",type:"POST",data:a}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_atleti"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")})):alert("Errore di inserimento:\n\n"+o.errors)}function addSocietaOk(e){var t={};$(e).closest("div[data-role=page]").find(".jform").each(function(){var e=$(this).attr("id");t[e]=$(this).val()}),$.ajax({url:rooturl+"/societa/add",type:"POST",data:t}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_societa"),refreshSocietaServer())}).fail(function(){toast("Error posting","long")})}function addGaraOk(e){var t=$(e).closest("div[data-role=page]"),a=checkValidGaraForm(t);if(1!=a.error){var o={};t.find(".jform").each(function(){var e=$(this).attr("id");o[e]=$(this).val()}),$.ajax({url:rooturl+"/gare/add",type:"POST",data:o}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#gare"),refreshGareServer())}).fail(function(){toast("Error posting","long")})}else alert("Errore di inserimento:\n\n"+a.errors)}function addEventoOk(e){var t=$(e).closest("div[data-role=page]"),a=checkValidGaraForm(t);if(1!=a.error){var o={};t.find(".jform").each(function(){var e=$(this).attr("id");o[e]=$(this).val()}),$.ajax({url:rooturl+"/eventi/add",type:"POST",data:o}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_eventi"),refreshEventiServer())}).fail(function(){toast("Error posting","long")})}else alert("Errore di inserimento:\n\n"+a.errors)}function editAtleta(e){console.log("editatleta");var t=$(e).closest("div[data-role=page]").find("#atletaid").val();colog("Editing atletaid "+t);var a=getAtletaById(t);$("#page_editatleta").find(".jform").each(function(){var e=$(this).attr("id");colog("campo "+e+" - "+a[e]),$(this).val(a[e])}),$("#page_editatleta").find("#atletaid").val(t),$("#page_editatleta").find("#societaid").val(settings.mysocieta),getSocietaById(settings.mysocieta,function(e){e.rows.length>0&&$("#page_editatleta").find("#societa").html("Società: "+e.rows[0].doc.nome.toUpperCase()),$.mobile.changePage("#page_editatleta")})}function checkValidGaraForm(e){var t="",a=!1,o="",r="location,title,data,stato".split(",");$(r).each(function(o){""==e.find("#"+r[o]).val().trim()&&(a=!0,t+="- il campo "+r[o]+" non può essere vuoto\n")}),o=e.find("#data").val(),3!=(r=o.split("/")).length&&(a=!0,t+="- la data deve essere nel formato gg/mm/aaaa\n"),o=e.find("#stato").val();var i=!1,n="nondisputata,disputata,incorso".split(",");return $(n).each(function(e){n[e]==o&&(i=!0)}),i||(a=!0,t+="- stato invalido, stati validi sono nondisputata,disputata,incorso\n"),{error:a,errors:t}}function checkValidAtletaForm(e){var t="",a=!1;return""==e.find("#nome").val().trim()&&(a=!0,t+="- il nome non può essere vuoto\n"),""==e.find("#cognome").val().trim()&&(a=!0,t+="- il cognome non può essere vuoto\n"),3!=e.find("#datanascita").val().split(".").length&&(a=!0,t+="- la data di nascita deve essere nel formato gg.mm.aaaa\n"),{error:a,errors:t}}function editAtletaOk(e){var t=$(e).closest("div[data-role=page]"),a=t.find("#atletaid").val(),o={},r=checkValidAtletaForm(t);1!=r.error?(t.find(".jform").each(function(){var e=$(this).attr("id");o[e]=$(this).val()}),$.ajax({url:rooturl+"/atleti/update/"+a,type:"POST",data:o}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_atleti"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")})):alert("Errore di inserimento:\n\n"+r.errors)}function getAllAtleti(e){$.ajax({type:"GET",url:rooturl+"/atleti/findall/",success:function(t){e(t)}})}function addIscritto(){var e=[];jcurrentgara.iscritti;progressStart(),getAllAtleti(function(t){$(t.rows).each(function(a){var o=t.rows[a];o.doc.id.trim();e.push(o)}),e.sort(function(e,t){var a=e.doc.cognome.trim(),o=t.doc.cognome.trim();return a>o?1:a<o?-1:0}),progressStop();var a=new EJS({url:"tpl/selectiscritti.ejs"}).render(e);$("#selectIscrittiPage #selectiscr").empty().append(a),$.mobile.changePage("#selectIscrittiPage"),$("#selectIscrittiPage").trigger("create")})}function addIscrittiOk(){var e="";$("#selectIscrittiPage :checkbox:checked").each(function(t){var a=$(this).val();""!=e.trim()&&(e+=","),e+=a}),jcurrentgara.iscritti=e;var t={};t.id=jcurrentgara.id,t.iscritti=e,$.ajax({url:rooturl+"/gare/update",type:"POST",data:t}).done(function(e){e.error?toast("error"):(console.log("posted"),refreshCurrentGara(function(){showIscritti(),refreshGareServer()}))}).fail(function(){toast("Error posting update","long")})}function saveOptions(){rooturl=$("#optionsPage #server").val();var e=$("#optionsPage #ckNotifiche").prop("checked"),t=$("#optionsPage #ckSound").prop("checked"),a=$("#optionsPage #ckVoice").prop("checked"),o=$("#optionsPage #societaid").val(),r=$("#optionsPage #societaid option:selected").text(),i={server:rooturl,notifiche:e,mysocieta:o,mysocietaname:r,voice:a,sound:t};setCookie("options",JSON.stringify(i)),settings=i,$(".serverspan").html("Server: "+rooturl),refreshAtletiServer(),refreshGareServer(),refreshNews(function(e){}),$.mobile.back(),updateHomeInfos()}function setServer(e){$("#optionsPage #server").val(e)}function getSocieta(e){$.ajax({type:"GET",url:rooturl+"/societa/findall/",success:function(t){e(t)}})}function getSocietaById(e,t){$.ajax({type:"GET",url:rooturl+"/societa/findbyid/"+e,success:function(e){t(e)}})}function loadOptions(e){conslog("loadOptions");var t={server:rooturl,notifiche:!0,mysocieta:"20160217220400",mysocietaname:"ASD TAEKWONDO ROZZANO",voice:!1,sound:!0};settings=t,getSocieta(function(a){var o=new EJS({url:"tpl/selectsocieta.ejs"}).render(a.rows);$("#optionsPage #societaid").empty().append(o);var r=getCookie("options");if(conslog("options cookie",r),null==r)setCookie("options",JSON.stringify(t)),settings=t,$("#optionsPage #server").val(settings.server),$("#optionsPage #ckNotifiche").prop("checked",settings.notifiche),$("#optionsPage #ckVoice").prop("checked",settings.voice),$("#optionsPage #ckSound").prop("checked",settings.sound),$("#optionsPage #societaid").val(settings.mysocieta);else{var i=JSON.parse(r);conslog("parsed cookie",i),i.hasOwnProperty("server")||(i.server=t.server),i.hasOwnProperty("notifiche")||(i.notifiche=t.notifiche),i.hasOwnProperty("mysocieta")||(i.mysocieta=t.mysocieta),i.hasOwnProperty("mysocietaname")||(i.mysocietaname=t.mysocietaname),i.hasOwnProperty("voice")||(i.voice=t.voice),$("#optionsPage #server").val(i.server),$("#optionsPage #ckNotifiche").prop("checked",i.notifiche),$("#optionsPage #societaid").val(i.mysocieta),$("#optionsPage #ckVoice").prop("checked",i.voice),$("#optionsPage #ckSound").prop("checked",i.sound),settings=i}e&&e(settings)})}function delMatch(){var e=delmatchid;gConfirm("Sei sicuro di voler cancellare l'incontro ?","Conferma",function(){colog("deleting matchid "+e);var t="updagent.php?action=delete&tag=match",a=jGara.matchesbyprog;$(a.rows).each(function(t){var o=a.rows[t].doc.id,r=a.rows[t].doc;if(o.trim()==e.trim()&&r.derby&&""!=r.derby.trim()){var i=r.derby,n="/matches/update/"+jcurrentgara.id+"/"+i;$.ajax({type:"POST",url:rooturl+n,data:{derby:null},async:!1}),colog("resetted derby flag on matchid "+i)}}),t+="&id="+e,t+="&garaid="+garaid,t="/matches/delete/"+jcurrentgara.id+"/"+e,$.post(rooturl+t,{a:"1"},function(){delmatchid="",openGara(jcurrentgara.id,function(){var e="combattimento";jcurrentgara.tipo&&"forme"==jcurrentgara.tipo&&(e="forme"),$("#matchesatleta #popDelMatch").popup("close"),"combattimento"==e?showMatchesForAtleta(selectedAtl.id):showMatchesForAtletaForme(selectedAtl.id)})})},function(){cancelDelMatch()})}function cancelDelMatch(){$("#matchesatleta #popDelMatch").popup("close")}function getCookie(e){var t;if(isPhone)t=window.localStorage.getItem(e);else{var a=(t=document.cookie).indexOf(" "+e+"=");if(-1==a&&(a=t.indexOf(e+"=")),-1==a)t=null;else{a=t.indexOf("=",a)+1;var o=t.indexOf(";",a);-1==o&&(o=t.length),t=unescape(t.substring(a,o))}}return t}function setCookie(e,t,a){if(isPhone)window.localStorage.setItem(e,t);else{var o=new Date;o.setDate(o.getDate()+a);var r=escape(t)+(null==a?"":"; expires="+o.toUTCString());document.cookie=e+"="+r}}function autoLogin(){var e=getCookie("appkwondo_user"),t=getCookie("email"),a=getCookie("psw"),o=getCookie("autologin");if(e){console.log("has appkwondo_user cookie !!");var r=JSON.parse(e),i=window.atob(r.encuser);t=i.split(":")[0],a=i.split(":")[1],o=r.autologin}fbloggedin=!0,colog("autologin cookie: "+o),o&&"true"==String(o)&&(t&&a?(console.log("doing autologin"),$("#login #txt-email").val(t),$("#login #txt-password").val(a),doLogin(!0)):(toast("Login automatico fallito"),deleteCookie("email"),deleteCookie("psw"),deleteCookie("autologin"),showLoginPage()))}function showLoginPage(){var e=getCookie("appkwondo_user"),t=getCookie("email"),a=getCookie("psw"),o=getCookie("autologin");if(e){console.log("has appkwondo_user cookie !!");var r=JSON.parse(e),i=window.atob(r.encuser);colog("user !!",r),t=i.split(":")[0],a=i.split(":")[1],o=r.autologin}if(console.log(o),t&&a?($("#login #txt-email").val(t),$("#login #txt-password").val(a)):($("#login #txt-email").val(""),$("#login #txt-password").val("")),o&&"true"==String(o))return console.log("autologin is true, autologgin in"),void autoLogin();$.mobile.changePage("#login")}function enableAudioJS(){}function loadChatFile(e){var t=$("#page_chat"),a=rooturl+"/chat/getfile/"+e;$.ajax({type:"GET",url:a,success:function(e){var a=e.rows,o=new EJS({url:"tpl/chat.ejs"}).render(a);t.find(".container").empty().append(o),enableAudioJS(),tapholdBubble(),self;var r=new EJS({url:"tpl/matchesrealtime2.ejs"}).render(realtimeArray);t.find(".chatrealtime .rtul").empty().append(r),$.mobile.changePage("#page_chat")},error:function(e){}})}function listChats(){$.mobile.changePage("#page_chatlist"),progressStart();var e=rooturl+"/chat/list";$.ajax({url:e,type:"GET",data:{}}).done(function(e){conslog("chat listate"),progressStop();var t=new EJS({url:"tpl/chatlist.ejs"}).render(e.rows);$("#page_chatlist").find(".content ul").empty().append(t),$("#page_chatlist").find(".content ul").listview().listview("refresh"),$("#page_chatlist").find(".content ul li").off("taphold"),$("#page_chatlist").find(".content ul li").on("taphold",function(){var e=$(this).find(".medium").text();e.indexOf("_")>-1&&gConfirm("Sei sicuro di voler cancellare la chat "+e+" ?","Cancella chat",function(){var t=rooturl+"/chat/delete/"+e.split("_")[1].replace(".json","");$.ajax({url:t,type:"GET",data:{}}).done(function(e){console.log("data"),listChats()})},function(){})}),refreshChat()})}function resetChat(){var e=rooturl+"/chat/archive/"+jcurrentgara.id;chatmultiroom||(e=rooturl+"/chat/archive"),gConfirm("Sei sicuro di voler resettare la chat per questa gara ? ?","Reset chat",function(){$.ajax({url:e,type:"GET",data:{}}).done(function(e){conslog("chat resettata"),refreshChat(),socketNotify({type:"refreshchat",to:"all",nickname:chatuser.nickname}),gotoChat(!0)})},function(){})}function gotoRanking(){$.mobile.changePage("#page_ranking"),updateRankingTkdr()}function postChat(e){colog("postchat",e);var t={sockid:chatuser.sockid,nickname:chatuser.nickname,garaid:jcurrentgara.id,text:$("#page_chat #chatmsg").val()};e||(e=t);var a=!1,o=!1,r=!1;e.foto&&""!=e.foto.trim()&&(o=!0),e.audio&&""!=e.audio.trim()&&(r=!0);var i=o||r;if(""!=e.text.trim()||i||(a=!0),!a){var n=rooturl+"/chat/put/"+jcurrentgara.id;chatmultiroom||(n=rooturl+"/chat/put"),playSound("img/chatsend"),$("#page_chat #chatmsg").val(""),$.ajax({url:n,type:"POST",data:e}).done(function(e){console.log("chat posted !!",e),$("#page_chat #chatmsg").val("")}).error(function(e){console.log("error",e)})}}function gotoEventi(){refreshEventiServer(function(){$.mobile.changePage("#page_eventi")})}function gotoChat(e){$("#page_chat");$.mobile.changePage("#page_chat"),chatScrollBottom(),setCookie("chat_unread",chatunreadcount=0),setChatBubbles()}function refreshChat(e){var t=$("#page_chat"),a=rooturl+"/chat/getno64/"+jcurrentgara.id;chatmultiroom||(a=rooturl+"/chat/getno64"),$.ajax({type:"GET",url:a,success:function(e){var a=e.rows;a.forEach(function(e,t){e.audiourl});var o=new EJS({url:"tpl/chat.ejs"}).render(a);t.find(".container").empty().append(o);var r=new EJS({url:"tpl/matchesrealtime2.ejs"}).render(realtimeArray);t.find(".chatrealtime .rtul").empty().append(r),tapholdBubble()},error:function(e){}})}function gotoSocieta(){$.mobile.changePage("#page_societa"),refreshSocietaServer()}function doLogout(){gConfirm("Sei sicuro di volerti scollegare ?","Log out",function(){loggedin=!1,$("#index #lilogin").show(),$("#index #liatleti").hide(),$("#index #lisockets").hide(),$("#gare #liaggiungigara").hide(),$("#gara #liresetcronaca").hide(),$("#gara #lisysmsg").hide(),$("#page_atleti #liaggiungiatleta").hide(),$("#iscrittiPage #btnAddIscritto").hide(),$("#gare #test").hide(),$("#index .loginspan").html(""),$(".showadmin").hide(),deleteCookie("autologin"),$.mobile.changePage("#index_fb")},function(){})}function showNotifications(){var e=jcurrentgara.iscritti;colog("iscritti: "+e);var t=e.split(",");""==e.trim()&&(t=[]);var a=[];$(t).each(function(e){var o=getAtletaById(t[e]),r={};r.nome=o.cognome+" "+o.nome,r.id=o.id,a.push(r)}),a.sort(function(e,t){var a=e.nome.trim(),o=t.nome.trim();return a>o?1:a<o?-1:0}),html=new EJS({url:"tpl/selectnotifiche.ejs"}).render(a),$("#page_notifiche #ulatleti").empty().append(html),$.mobile.changePage("#page_notifiche")}function setNotificheOk(){var e="";$("#page_notifiche :checkbox:checked").each(function(t){var a=$(this).val();colog(a),""!=e.trim()&&(e+=","),e+=a}),setCookie("notifiche_atleta",e),$.mobile.changePage("#gara")}function none(){}function notify(e){conslog("msg",e);var t=e.text,a=1;if(e.action&&"nextevents"==e.action&&(a=2),isPhone){++notcount>3&&(notcount=1);cordova.plugins.notification.local.schedule({id:a,text:t,title:"AppKwonDo",icon:"file://img/logotkdrozzano_icon.png"})}else console.log("Notification: "+t)}function notificationClick(e){var t=e.id;1==t&&(conslog("notificationclick",e),$.mobile.changePage("#page_chat"),chatScrollBottom(),setCookie("chat_unread",chatunreadcount=0),setChatBubbles()),2==t&&showNextEvents()}function clickNotification(){console.log("clicked notifichation"),$.mobile.changePage("#gara"),openGara(garanotifyid,function(){garaid=id,$gara=data,gotoChat()})}function pushSuccessHandler(e){var t="Push Callback Success! Result = "+e;console.log(t)}function pushErrorHandler(e){console.log("pushError: "+e)}function onNotificationGCM(e){switch(console.log("onNotificationGCM"),e.event){case"registered":e.regid.length>0&&(console.log("Regid "+e.regid),toast("Registered on GCM"),cordova.plugins.notification.local.on("click",function(e){toast("clicked notification"),$("#dialogNotifiche #content").empty.html(e.text),$.mobile.changePage("#dialogNotifiche",{role:"dialog"})}));break;case"message":notify(e.message);break;case"error":console.log("GCM error "+e.msg);break;default:console.log("An unknown GCM event has occurred")}}function sendGCM(e){console.log("sendGCM: "+e);var t={};t.message=e,t.title="AppKwonDo",t.msgcnt="3",t.soundname="beep.wav",$.ajax({url:rooturl+"/matches/notify",type:"POST",data:t}).done(function(e){e.error?(colog("error posting notification"),toast("error")):colog("posted GCM notification")}).fail(function(){toast("Error posting GCM push","long")})}function deleteCronacaReadForGara(e){conslog("deleteCronacaRead for gara "+e),conslog("parto con cronaca_read: "+cronaca_read.length),conslog(cronaca_read);for(var t=0;t<cronaca_read.length;t++){var a=cronaca_read[t];conslog("row: ",a);var o=a.split("_"),r=o[0],i=o[1];r==e&&(conslog("elimino "+i),cronaca_read.splice(t,1))}conslog("cronaca_read restante: "+cronaca_read.length),conslog(cronaca_read)}function resetCronaca(){var e=jcurrentgara.id;gConfirm("Vuoi veramente resettare la cronaca per questa gara ?","conferma",function(){socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,event:"resetcronaca"}),deleteCronacaReadForGara(e),$.ajax({type:"GET",url:rooturl+"/gare/resetcronaca/"+e,success:function(e){toast("Cronaca resettata"),socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,event:"refreshcronaca"}),refreshCurrentGara()}})},function(){})}function socketNotify(e){sendSocketMessage(e)}function sendSocketMessage(e){var t={to:"all",text:"sample message",type:"notification"};e&&(t=e),socket.send(t),colog("socket message sent to socket.io server")}function getGaraById(e){t=null;sdebug("getGaraById "+e);var t={};return $($gare.rows).each(function(a){var o=$gare.rows[a],r=o.doc.id;$.trim(r)==$.trim(e)&&(sdebug("trovata gara"),t=o)}),t}function mapOpened(){console.log("mapOpened")}function garaMaps(e){var t=jcurrentgara,a="";t.maplocation&&(a=t.maplocation);var o=new EJS({url:"tpl/garamap.ejs"}).render(a);$("#garamaps #content").html(o),$.mobile.changePage("#garamaps")}function viewMap(e){window.open(e,"_system")}function eventMaps(e){var t=jcurrentgara,a="";t.maplocation&&(a=t.maplocation);var o=new EJS({url:"tpl/eventmap.ejs"}).render(a);$("#eventmaps #content").html(o),$.mobile.changePage("#eventmaps")}function deleteGara(e){var t=e;gConfirm("Confermi l'eliminazione della gara ?","Conferma eliminazione",function(){var a={};a.id=e,a.rev=t,$.ajax({url:rooturl+"/gare/delete",type:"POST",data:a}).done(function(e){e.error?console.log("error"):(console.log("posted"),refreshGareServer())}).fail(function(){toast("Error posting","long")})},function(){}),popGareCancel()}function showSocketsPage(){showSockets(function(){$.mobile.changePage("#page_sockets")})}function showSockets(e){var t={};$("#page_sockets #pconn").html("Aggiornamento..."),$.ajax({url:rooturl+"/socketusers",type:"GET",data:t}).done(function(t){var a=new EJS({url:"tpl/sockets.ejs"}).render(t);$("#page_sockets #content").html(a),$("#page_sockets #ulsockets").listview(),$("#page_sockets #pconn").html(t.length+" utenti connessi ad AppKwonDo"),e&&e()})}function resetLog(){var e=rooturl+"/clearlog";progressStart(),$.ajax({url:e,type:"GET"}).done(function(e){console.log(e),e=e.replace(/(?:\r\n|\r|\n)/g,"<br />"),progressStop(),gotoLog()})}function gotoLog(){var e=rooturl+"/log.txt";progressStart(),$.ajax({url:e,type:"GET"}).done(function(e){e=e.replace(/(?:\r\n|\r|\n)/g,"<br />"),$("#page_log #content").html(e),progressStop(),$.mobile.changePage("#page_log")})}function clickSocket(e){var t=$.mobile.activePage.attr("id"),a={destsocket:e},o=new EJS({url:"tpl/sysmsg.ejs"}).render(a);return $("#"+t+" div[data-role=content]").append(o),$("#"+t+" #popSysMsg #dest").val(e),$("#"+t+" #popSysMsg").popup(),void $("#"+t+" #popSysMsg").popup("open")}function fb_login(){facebookcheck?openFB.login(function(e){"connected"===e.status?(conslog("Facebook login succeeded, got access token: "+e.authResponse.token),$("#index_fb #errormsg").html(""),fb_getInfo(function(){fbCheckGroup("116270558490682",fb_user,function(e){var t="holly ozoora".toLowerCase().split(",");if($(t).each(function(a){var o=t[a].trim();fb_user.name.toLowerCase().indexOf(o)>-1&&(e=!0)}),e){conslog("bravo, fai parte del gruppo facebook asd taekwondorozzano"),$("#index_fb #errormsg").html(""),fbloggedin=!0,refreshNews(),$.mobile.changePage("#index");var a={device:"browser",type:"clientspecs",nickname:socketnickname,appversion:appversion};isPhone&&(a.device="mobile"),socket.send(a)}else{$("#index_fb #errormsg").html("Non fai attualmente parte del gruppo Facebook ASD Taekwondo Rozzano.")}})})):(conslog("Login Facebook fallito: "+e.error),$("#index_fb #errormsg").html("Accesso a Facebook fallito"))},{scope:"email,publish_actions,user_managed_groups"}):(fbloggedin=!0,refreshNews(),$.mobile.changePage("#index"))}function fb_live(){openFB.api({path:"/me/live_videos",success:function(e){conslog("success",e)},error:fb_errorHandler})}function fb_getInfo(e){openFB.api({path:"/me",success:function(t){conslog(JSON.stringify(t)),fb_userid=t.id,fb_user.id=t.id,fb_user.name=t.name,socketnickname=fb_user.name,conslog("fb_userid: "+fb_userid),conslog("fb_name: "+t.name),conslog("socketnickname: "+socketnickname),$("#index #fbuser #userName").html(chatuser.nickname),$("#index #fbuser #eMail").html(user.email),$("#index #fbuser #userPic").attr("src","http://graph.facebook.com/"+t.id+"/picture?type=small"),$("#index #fbuser").show(),e&&e()},error:fb_errorHandler})}function fb_share(){openFB.api({method:"POST",path:"/me/feed",params:{message:document.getElementById("Message").value||"Testing Facebook APIs"},success:function(){alert("the item was posted on Facebook")},error:fb_errorHandler})}function fb_revoke(){openFB.revokePermissions(function(){alert("Permissions revoked")},fb_errorHandler)}function fb_logout(e){openFB.logout(function(){colog("Logout successful"),fbloggedin=!1,e&&e()},fb_errorHandler)}function fb_errorHandler(e){alert(e.message)}function fb_checkgroup(){fbCheckGroup("116270558490682",fb_user,function(e){e&&alert("bravo, fai parte del gruppo")})}function getQueryString(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var o=t[a].split("=");if(o[0]==e)return o[1]}}function Right(e,t){if(t<=0)return"";if(t>String(e).length)return e;var a=String(e).length;return String(e).substring(a,a-t)}function addCronaca(){$.mobile.changePage("#page_editcronaca")}function addCronacaOk(){var e="/matches/addcronaca/"+jcurrentgara.id,t=$("#page_editcronaca #testo").val();progressStart(),$.ajax({type:"POST",url:rooturl+e,async:!0,data:{text:t},success:function(){progressStop();$("#page_editcronaca input:checkbox[name=ckNotifica]").is(":checked")&&socketNotify({type:"notification",to:"all",text:t,garaid:jcurrentgara.id,updategara:"yes"}),loadCronaca(jcurrentgara.id,function(){$.mobile.changePage("#gara")})},error:function(){progressStop(),alert("errore")}})}function delCronaca(e){confirm("Sicuro di voler cancellare questa riga di cronaca da questa gara ?","Conferma")&&$.ajax({type:"POST",url:rooturl+"/matches/delcronaca/"+jcurrentgara.id+"/"+e,success:function(e){toast("Cronaca aggiornata"),loadCronaca(jcurrentgara.id)}})}function toggleConsole(e){$(e).find("div.console").toggle()}function gotoTempoReale(){var e=$("#realtimeconsole"),t=new EJS({url:"tpl/realtimeconsole.ejs"}).render(realtimeArray);e.find("#content").html(t),e.trigger("create"),e.trigger("pagecreate"),$.mobile.changePage("#realtimeconsole")}function updateRankingTkdr(){var e="";""!="".trim()&&(e=" per l'anno ");var t="Calcolo ranking TKDR "+e+" in corso....";$("#page_ranking #ranking").html(t);var a=imgtext+"Caricamento in corso...",o=$("#page_ranking #updranking").html();$("#page_ranking #updranking").html(a),$.ajax({type:"GET",url:rooturl+"/atleti/ranking/save",async:!0,success:function(e){statrows=e.rows;var t=$("#page_ranking #selstat").val();console.log("tipostat",t);for(var a=0;a<statrows.length;a++){var r=statrows[a].doc;if(r.garedisputate=parseInt(r.garedisputate,10),r.matchdisputati=parseInt(r.matchdisputati,10),r.garedisputate>0){r.percentgare=parseInt(r.ranking_tkdr,10)/parseInt(r.garedisputate,10),r.percentmatch=parseInt(r.ranking_tkdr,10)/parseInt(r.matchdisputati,10);var i=r.ori+r.argenti+r.bronzi;r.percentmedaglie=parseInt(i,10)/parseInt(r.garedisputate,10)*100,r.percentgare=r.percentgare.toFixed(2),r.percentmatch=r.percentmatch.toFixed(2),r.percentmedaglie=r.percentmedaglie.toFixed(2)}else r.percentgare=0,r.percentmatch=0,r.percentmedaglie=0}console.log("sorting by "+ranking_sortcampo),e.rows.sort(function(e,t){var a=e.doc[ranking_sortcampo],o=t.doc[ranking_sortcampo];return a>o?-1:a<o?1:0}),console.log(e.rows);var n=new EJS({url:"tpl/ranking2.ejs"}).render(e.rows);$("#page_ranking #ranking").html(n),$("#page_ranking #updranking").html(o),$("#page_ranking #ulranking").listview(),$("#page_ranking #ulranking").listview("refresh"),$("#page_ranking").trigger("pagecreate")}})}function sortStats(e){ranking_sortcampo=e,updateRankingTkdr()}function changeStats(e){"match"==e&&(col=10),"gare"==e&&(col=9),"percentmedaglia"==e&&(col=8),"percentmatch"==e&&(col=7),"percentgare"==e&&(col=6),"absolute"==e&&(col=5),$("#page_ranking #ranking tr").each(function(){$(this).find("td:gt(4)").hide(),$(this).find("th:gt(4)").hide(),$(this).find("td:eq("+col+")").show(),$(this).find("th:eq("+col+")").show()}),$("#page_ranking #ranking thead").find("th:eq("+col+")").trigger("click")}function updateRankingTkdr_old(){var e,t,a=$("#page_ranking #selanno").val(),o="";""!=a.trim()&&(o=" per l'anno "+a);var r="Calcolo ranking TKDR "+o+" in corso....";$("#page_ranking #ranking").html(r),progressStart(r),$.ajax({type:"GET",url:rooturl+"/atleti/findall?societaid="+settings.mysocieta,async:!0,success:function(o){e=o,$.ajax({type:"GET",async:!0,url:rooturl+"/gare/findall?societa="+settings.mysocieta,success:function(o){t=o,$(t.rows).each(function(e){var a=t.rows[e].doc.id;$.ajax({type:"GET",async:!1,url:rooturl+"/matches/findbygaraid/"+a+"?societa="+settings.mysocieta,success:function(a){t.rows[e].doc.matches=a}})}),$(e.rows).each(function(o){var r=e.rows[o].doc;getCategoria(r.datanascita,!0);e.rows[o].doc.ranking_tkdr=0,e.rows[o].doc.ori=0,e.rows[o].doc.argenti=0,e.rows[o].doc.bronzi=0,e.rows[o].doc.garedisputate=0,colog("calcolo ranking per "+r.cognome+" "+r.nome),$(t.rows).each(function(i){var n=t.rows[i].doc,s=(n.id,n.data),c=!1;if(""==a?c=!0:s.indexOf("/"+a)>-1&&(c=!0),c){var l=t.rows[i].doc.matches,d=!1;$(l.rows).each(function(t){var a=l.rows[t].doc;if(a.atletaid==r.id&&(d=!0,a.medagliamatch)){var i=a.medagliamatch.toLowerCase();"oro"==i&&(e.rows[o].doc.ranking_tkdr+=7,e.rows[o].doc.ori++),"argento"==i&&(e.rows[o].doc.ranking_tkdr+=3,e.rows[o].doc.argenti++),"bronzo"==i&&(e.rows[o].doc.ranking_tkdr+=1,e.rows[o].doc.bronzi++)}}),1==d&&e.rows[o].doc.garedisputate++}})}),e.rows.sort(function(e,t){var a=e.doc.ranking_tkdr,o=t.doc.ranking_tkdr;return a>o?-1:a<o?1:0});var r=new EJS({url:"tpl/ranking2.ejs"}).render(e.rows);$("#page_ranking #ranking").html(r),progressStop()}})}})}function padZeros(e,t){for(var a=String(e);a.length<t;)a="0"+a;return a}function formatBytes(e){return e<1024?e+" Bytes":e<1048576?(e/1024).toFixed(3)+" KB":e<1073741824?(e/1048576).toFixed(3)+" MB":(e/1073741824).toFixed(3)+" GB"}function chatScrollTop(){$.mobile.silentScroll(0)}function chatScrollBottom(){var e=$("#page_chat #chatscroll");e.attr("data-icon","arrow-u"),e.addClass("ui-icon-arrow-u").removeClass("ui-icon-arrow-d");$.mobile.silentScroll(99999)}function chatScroll(){var e=$("#page_chat #chatscroll"),t=e.attr("data-icon");console.log(t);var a=0;"arrow-d"==t?(console.log("giu"),e.attr("data-icon","arrow-u"),e.addClass("ui-icon-arrow-u").removeClass("ui-icon-arrow-d"),a=99999):(console.log("su"),a=0,e.attr("data-icon","arrow-d"),e.addClass("ui-icon-arrow-d").removeClass("ui-icon-arrow-u")),console.log(a),$.mobile.silentScroll(a)}function getQsFromUrl(e,t){e||(e=window.location.href),t=t.replace(/[\[\]]/g,"\\$&");var a=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return a?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null}function getUniqueArray(e){var t=[];return $(e).each(function(a){-1==t.indexOf(e[a])&&t.push(e[a])}),t}function displayTkdtIscr(e){"peratleta"==e&&($("#page_tkdtnew #peratleta").show(),$("#page_tkdtnew #percategoria").hide()),"percategoria"==e&&($("#page_tkdtnew #peratleta").hide(),$("#page_tkdtnew #percategoria").show())}function gotoBroadcast(){}function goBack(){$.mobile.back()}function clickAtletaRanking(e){var t=getAtletaById(e);console.log("clicked atletaid "+e,t)}var pictureSource,destinationType,scheda={},loggedin=!1,role="tkdruser",fbloggedin=!1,chatrefreshcount=0,tipogara="combattimento",ranking_sortcampo="ranking_tkdr",lastrtmatches=[],lastenteredmatch={},consoles=[],page_popup=!0,appversion="1.4.5",crnonletti=0,garanotifyid="",facebookcheck=!0,debugActive=!1,notifyeventdays=2,nexteventscount=0,defaultimage="img/logotkdrozzano.jpg",tapevent="tap",cronaca_unread=[],cronaca_read=[],chatnonletti=[],chatunreadcount=0,fotodata="",sounddata="",currentround="1",currentresult="0-0",currentammon=0,chatmultiroom=!1,notifiche_temporeale=[],tkdt_iscritti={tabulati:[],avversari:[],rows:[]},user={token:"eyJhbGciOiJIUzI1NiJ9.ZGVteW1AeWFob28uaXQ.oTBSwtNyFE4OLWby0ATY4g-WUBd7OUPp-EaIv_r_2vQ"},realtime={round:"1",result:"0-0",ammoniz:0,running:!1,active:!1,fineround:!1},realtimeArray=[],realtimeindex=-1,chatuser={sockid:"",nickname:""},rtmatches=[],rooturl="http://tkdr.herokuapp.com";console.log("rooturl",rooturl);var typingtimeout=null,caricamentotext="<img style='position: relative; top: 4px;' src='images/ajax-loader2.gif' />&nbsp;&nbsp;&nbsp;Caricamento...",imgtext="<img style='position: relative; top: 4px;' src='images/ajax-loader2.gif' />&nbsp;&nbsp;&nbsp;",settings=null,garaFilters={categoria:"",sesso:"",medaglia:"",quadrato:""},isFiltered=!1,socketnickname="",socket,isPhone=!1,boname="scheda",bonames="Schede",parm_garaid="",cattxt="Categoria: ",showMsg=null,garaid="",jGara={cronaca:{rows:[]}},$gara={},$gare={},jcurrentgara={},activeTab=0,jmatchesbyatleta=[],jmatchesbyprog=[],$atleti={},displayedAtleti={},$allatleti={},delmatchid="",prevSelection="tab1",$matches,$allmatches={},cat="",selectedAtl={},selectedid="",cookieDays=3,storage,cronaca={rows:[]},autorefresh=!1,timerMatches=2e4,mf={},iscrittiincat=[],viewcat="",fb_userid="",fb_user={};console.log("e allora");var colog=function(){debugActive&&console.log.apply(console,arguments)},conslog=function(){debugActive&&console.log.apply(console,arguments)},consolog=function(){console.log.apply(console,arguments)};$(window).resize(function(){resizeImage("#viewimage #img1")});var chatblurtimer,autorefreshcount=0,garefiltertimer,app={initialize:function(){conslog("app.initialize"),this.bind()},onCameraSuccess:function(e){toast("Photo acquired","long");var t,a,o;for(t=0,o=e.length;t<o;t+=1)a=e[t].fullPath,$("#fotoAnteprima").attr("src",a).css({width:"128px",height:"128px"})},onCameraError:function(e){toast("Error acquiring photo: "+e,"long")},onMenuButton:function(){return console.log("menubutton pressed"),void toggleLeftMenu()},onBackButton:function(){var e=$.mobile.activePage.attr("id");playFeedback(),$("#"+e+" #btnBack").trigger("click")},online:function(){$("#btnInviaSchede").removeClass("ui-disabled")},offline:function(){$("#btnInviaSchede").addClass("ui-disabled")},isOnline:function(){var e=navigator.connection.type;return toast(e,"short"),e!=Connection.NONE&&e!=Connection.UNKNOWN},bind:function(){colog("app.bind"),document.addEventListener("deviceready",this.deviceready,!1)},deviceready:function(){colog("deviceready !"),document.addEventListener("online",app.online,!1),document.addEventListener("offline",app.offline,!1),document.addEventListener("menubutton",app.onMenuButton,!1),document.addEventListener("backbutton",app.onBackButton,!1),storage=window.localStorage,pictureSource=navigator.camera.PictureSourceType,destinationType=navigator.camera.DestinationType,colog("Navigator user agent from deviceready: "+navigator.userAgent),-1!=navigator.userAgent.indexOf("Android")&&($.mobile.defaultPageTransition="none",$.mobile.defaultDialogTransition="none",$.mobile.buttonMarkup.hoverDelay=0),isPhone=!!navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/),cordova.plugins.backgroundMode.setEnabled(!0),cordova.plugins.backgroundMode.setDefaults({title:"Appkwondo",text:"Tocca per passare ad Appkwondo",color:"#555555",resume:!0,hidden:!0,bigText:!0}),window.plugins.intent.setNewIntentHandler(function(e){if(console.log("intent "+JSON.stringify(e)),e.type&&"image/*"==e.type){toast("intent! "+JSON.stringify(e),5e3);var t=e.clipItems[0].uri;window.FilePath.resolveNativePath(t,function(e){readFromFile(t=e,function(e){console.log("readfromfile callback",e)})})}}),docready(),app.start()},start:function(){},exit:function(){navigator.notification.confirm("Vuoi veramente chiudere AppKwonDo ?",function(e){1==e&&navigator.app.exitApp()},"Informazione","Sì,No")},storage:window.localStorage,initialize:function(){this.bind()},loadAllSchede:function(e){$.ajax({url:rooturl+"/atleti/findall?societaid="+settings.mysocieta,type:"GET"}).done(function(t){$atleti=t,e(t)})},loadAllGare:function(e){$.ajax({url:rooturl+"/gare/findall?societa="+settings.mysocieta,type:"GET"}).done(function(t){e(t)})}};window.onunload=function(){return!0},$(document).ready(function(){console.log("jquery docready"),initApp()});var soundTime=1500,soundTimer,recorder=new Object,recording=!1,errorHandler=function(e,t){var a="";switch(t.code){case FileError.QUOTA_EXCEEDED_ERR:a="Storage quota exceeded";break;case FileError.NOT_FOUND_ERR:a="File not found";break;case FileError.SECURITY_ERR:a="Security error";break;case FileError.INVALID_MODIFICATION_ERR:a="Invalid modification";break;case FileError.INVALID_STATE_ERR:a="Invalid state";break;default:a="Unknown error"}console.log("Error ("+e+"): "+a)},printEventType=function(e){console.log("got event: "+e.type)},waittkdttimer,waitactive=!1,waitinterval=6e4,tkdtcontent="",silenttkdt=!1,enableprogress=!0,isIOS=!1,isDraggin=!1,lastrealtime={},scheda={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","Sì,No")},save:function(e,t,a){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var o="addScheda";scheda.data._id&&(o="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+o,type:"POST",data:scheda.data}).done(function(e){e.error?a():(app.storage.clear(),colog("save result: "+JSON.stringify(e)),t())}).fail(function(){myToast({body:"Error posting"})})}},onPositionSuccess:function(e){scheda.data.coordinate=e.coords,myToast({body:JSON.stringify(scheda.data)}),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(e){var t="";switch(e.code){case PositionError.PERMISSION_DENIED:t="L'applicazione non è autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:t="Non è disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:t="Non è stato possibile rilevare la posizione corrente"}myToast({body:t})},load:function(e){if(""!=e){var t=app.storage.getItem($.trim(e));scheda.data=JSON.parse(t)}},loadById:function(e,t){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/schede/findById/"+e,type:"GET"}).done(function(a){colog("loadbyid "+e+": "+JSON.stringify(a)),scheda.data=a,t(scheda)})},remove:function(e,t){debugga(e+" "+t),""!=e&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:e,rev:t}}).done(function(e){app.storage.clear(),refreshSchedeServer()}).fail(function(){myToast({body:"Error posting"})})},send:function(e,t,a){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:e}).done(function(e){app.storage.clear(),t()}).fail(a)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},gara={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","Sì,No")},save:function(e,t,a){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var o="addScheda";scheda.data._id&&(o="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+o,type:"POST",data:scheda.data}).done(function(e){e.error?a():(app.storage.clear(),colog("save result: "+JSON.stringify(e)),t())}).fail(function(){myToast({body:"Error posting"})})}},onPositionSuccess:function(e){scheda.data.coordinate=e.coords,myToast({body:JSON.stringify(scheda.data)}),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(e){var t="";switch(e.code){case PositionError.PERMISSION_DENIED:t="L'applicazione non è autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:t="Non è disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:t="Non è stato possibile rilevare la posizione corrente"}myToast({body:t})},load:function(e){if(""!=e){var t=app.storage.getItem($.trim(e));scheda.data=JSON.parse(t)}},loadById:function(e,t){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/gare/findById/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(a){$gara=a.rows[0],jcurrentgara=$gara.doc,colog("jcurrentgara: "+JSON.stringify(jcurrentgara));colog("loadbyid "+e+": "+JSON.stringify(a)),scheda.data=a,t(scheda)})},remove:function(e,t){debugga(e+" "+t),""!=e&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:e,rev:t}}).done(function(e){app.storage.clear(),refreshSchedeServer()}).fail(function(){myToast({body:"Error posting"})})},send:function(e,t,a){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:e}).done(function(e){app.storage.clear(),t()}).fail(a)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},atleta={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","Sì,No")},save:function(e,t,a){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var o="addScheda";scheda.data._id&&(o="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+o,type:"POST",data:scheda.data}).done(function(e){e.error?a():(app.storage.clear(),colog("save result: "+JSON.stringify(e)),t())}).fail(function(){myToast({body:"Error posting"})})}},onPositionSuccess:function(e){scheda.data.coordinate=e.coords,myToast({body:JSON.stringify(scheda.data)}),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(e){var t="";switch(e.code){case PositionError.PERMISSION_DENIED:t="L'applicazione non è autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:t="Non è disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:t="Non è stato possibile rilevare la posizione corrente"}myToast({body:t})},load:function(e){if(""!=e){var t=app.storage.getItem($.trim(e));scheda.data=JSON.parse(t)}},loadById:function(e,t){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/atleti/findById/"+e,type:"GET"}).done(function(a){colog("loadbyid "+e+": "+JSON.stringify(a)),scheda.data=a,t(scheda)})},remove:function(e,t){debugga(e+" "+t),""!=e&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:e,rev:t}}).done(function(e){app.storage.clear(),refreshSchedeServer()}).fail(function(){myToast({body:"Error posting"})})},send:function(e,t,a){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:e}).done(function(e){app.storage.clear(),t()}).fail(a)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},voiceTime=1500,voiceTimer,lastDisplayedAtletaId="",mf={maschi:"0",femmine:"0"},deleteCookie=function(e){isPhone?window.localStorage.removeItem(e):document.cookie=e+"=;expires=Thu, 01 Jan 1970 00:00:01 GMT;"},notcount=0,fbCheckGroup=function(e,t,a){var o=t.id;openFB.api({path:"/"+e+"/members",params:{limit:400},success:function(e){colog(JSON.stringify(e)),colog(e.data.length+" users nel gruppo");for(var t=!1,r=0;r<e.data.length;r++)e.data[r].id==o&&(t=!0);a&&a(t)},error:fb_errorHandler})},statrows=[];Date.prototype.juliandate=function(){var e=this.getFullYear().toString(),t=(this.getMonth()+1).toString(),a=this.getDate().toString(),o=this.getHours(),r=this.getMinutes(),i=this.getSeconds(),n=this.getMilliseconds();console.log("milliseconds: "+n);var s=e+padZeros(t,2)+padZeros(a,2)+padZeros(o,2)+padZeros(r,2)+padZeros(i,2)+padZeros(n,3);return console.log("jdate: "+s),s},Date.prototype.juliandateshort=function(){var e=this.getFullYear().toString(),t=(this.getMonth()+1).toString(),a=this.getDate().toString(),o=this.getHours(),r=this.getMinutes(),i=this.getSeconds(),n=e+padZeros(t,2)+padZeros(a,2)+padZeros(o,2)+padZeros(r,2)+padZeros(i,2);return console.log("jdate: "+n),n},String.prototype.replaceAll=function(e,t){return this.split(e).join(t)};