(function (global) {
    var wtfTrace = null;
    var wtfEvents = null;
    var wtfEnabled = (function () {
        var wtf = global['wtf'];
        if (wtf) {
            wtfTrace = wtf.trace;
            if (wtfTrace) {
                wtfEvents = wtfTrace.events;
                return true;
            }
        }
        return false;
    })();
    var WtfZoneSpec = (function () {
        function WtfZoneSpec() {
            this.name = 'WTF';
        }
        WtfZoneSpec.prototype.onFork = function (parentZoneDelegate, currentZone, targetZone, zoneSpec) {
            var retValue = parentZoneDelegate.fork(targetZone, zoneSpec);
            WtfZoneSpec.forkInstance(zonePathName(targetZone), retValue.name);
            return retValue;
        };
        WtfZoneSpec.prototype.onInvoke = function (parentZoneDelegate, currentZone, targetZone, delegate, applyThis, applyArgs, source) {
            var scope = WtfZoneSpec.invokeScope[source];
            if (!scope) {
                scope = WtfZoneSpec.invokeScope[source] =
                    wtfEvents.createScope("Zone:invoke:" + source + "(ascii zone)");
            }
            return wtfTrace.leaveScope(scope(zonePathName(targetZone)), parentZoneDelegate.invoke(targetZone, delegate, applyThis, applyArgs, source));
        };
        WtfZoneSpec.prototype.onHandleError = function (parentZoneDelegate, currentZone, targetZone, error) {
            return parentZoneDelegate.handleError(targetZone, error);
        };
        WtfZoneSpec.prototype.onScheduleTask = function (parentZoneDelegate, currentZone, targetZone, task) {
            var key = task.type + ':' + task.source;
            var instance = WtfZoneSpec.scheduleInstance[key];
            if (!instance) {
                instance = WtfZoneSpec.scheduleInstance[key] =
                    wtfEvents.createInstance("Zone:schedule:" + key + "(ascii zone, any data)");
            }
            var retValue = parentZoneDelegate.scheduleTask(targetZone, task);
            instance(zonePathName(targetZone), shallowObj(task.data, 2));
            return retValue;
        };
        WtfZoneSpec.prototype.onInvokeTask = function (parentZoneDelegate, currentZone, targetZone, task, applyThis, applyArgs) {
            var source = task.source;
            var scope = WtfZoneSpec.invokeTaskScope[source];
            if (!scope) {
                scope = WtfZoneSpec.invokeTaskScope[source] =
                    wtfEvents.createScope("Zone:invokeTask:" + source + "(ascii zone)");
            }
            return wtfTrace.leaveScope(scope(zonePathName(targetZone)), parentZoneDelegate.invokeTask(targetZone, task, applyThis, applyArgs));
        };
        WtfZoneSpec.prototype.onCancelTask = function (parentZoneDelegate, currentZone, targetZone, task) {
            var key = task.source;
            var instance = WtfZoneSpec.cancelInstance[key];
            if (!instance) {
                instance = WtfZoneSpec.cancelInstance[key] =
                    wtfEvents.createInstance("Zone:cancel:" + key + "(ascii zone, any options)");
            }
            var retValue = parentZoneDelegate.cancelTask(targetZone, task);
            instance(zonePathName(targetZone), shallowObj(task.data, 2));
            return retValue;
        };
        ;
        WtfZoneSpec.forkInstance = wtfEnabled && wtfEvents.createInstance('Zone:fork(ascii zone, ascii newZone)');
        WtfZoneSpec.scheduleInstance = {};
        WtfZoneSpec.cancelInstance = {};
        WtfZoneSpec.invokeScope = {};
        WtfZoneSpec.invokeTaskScope = {};
        return WtfZoneSpec;
    }());
    function shallowObj(obj, depth) {
        if (!depth)
            return null;
        var out = {};
        for (var key in obj) {
            if (obj.hasOwnProperty(key)) {
                var value = obj[key];
                switch (typeof value) {
                    case 'object':
                        var name_1 = value && value.constructor && value.constructor.name;
                        value = name_1 == Object.name ? shallowObj(value, depth - 1) : name_1;
                        break;
                    case 'function':
                        value = value.name || undefined;
                        break;
                }
                out[key] = value;
            }
        }
        return out;
    }
    function zonePathName(zone) {
        var name = zone.name;
        zone = zone.parent;
        while (zone != null) {
            name = zone.name + '::' + name;
            zone = zone.parent;
        }
        return name;
    }
    Zone['wtfZoneSpec'] = !wtfEnabled ? null : new WtfZoneSpec();
})(typeof window === 'object' && window || typeof self === 'object' && self || global);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3RmLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsid3RmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVlBLENBQUMsVUFBUyxNQUFXO0lBcUJuQixJQUFJLFFBQVEsR0FBYSxJQUFJLENBQUM7SUFDOUIsSUFBSSxTQUFTLEdBQWMsSUFBSSxDQUFDO0lBQ2hDLElBQU0sVUFBVSxHQUFZLENBQUM7UUFDM0IsSUFBTSxHQUFHLEdBQVEsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9CLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDUixRQUFRLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQztZQUNyQixFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUNiLFNBQVMsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDO2dCQUM1QixNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ2QsQ0FBQztRQUNILENBQUM7UUFDRCxNQUFNLENBQUMsS0FBSyxDQUFDO0lBQ2YsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUVMO1FBQUE7WUFDRSxTQUFJLEdBQVcsS0FBSyxDQUFDO1FBNkV2QixDQUFDO1FBcEVDLDRCQUFNLEdBQU4sVUFDSSxrQkFBZ0MsRUFBRSxXQUFpQixFQUFFLFVBQWdCLEVBQ3JFLFFBQWtCO1lBQ3BCLElBQU0sUUFBUSxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDL0QsV0FBVyxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xFLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDbEIsQ0FBQztRQUVELDhCQUFRLEdBQVIsVUFDSSxrQkFBZ0MsRUFBRSxXQUFpQixFQUFFLFVBQWdCLEVBQUUsUUFBa0IsRUFDekYsU0FBYyxFQUFFLFNBQWdCLEVBQUUsTUFBYztZQUNsRCxJQUFJLEtBQUssR0FBRyxX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QkFDekUsS0FBSyxHQUFHLE1BQUksSUFBVSxNQUFPLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxLQUFLLEVBQUUsS0FBSyxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQUksQ0FBQzt3QkFDekUsS0FBSyxDQUFDO29CQUNSLEtBQUssVUFBVTt3QkFDYixLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksSUFBSSxTQUFTLENBQUM7d0JBQ2hDLEtBQUssQ0FBQztnQkFDVixDQUFDO2dCQUNELEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDbkIsQ0FBQztRQUNILENBQUM7UUFDRCxNQUFNLENBQUMsR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVELHNCQUFzQixJQUFVO1FBQzlCLElBQUksSUFBSSxHQUFXLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDN0IsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDbkIsT0FBTyxJQUFJLElBQUksSUFBSSxFQUFFLENBQUM7WUFDcEIsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztZQUMvQixJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUNyQixDQUFDO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNkLENBQUM7SUFFQSxJQUFZLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEdBQUcsSUFBSSxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFDeEUsQ0FBQyxDQUFDLENBQUMsT0FBTyxNQUFNLEtBQUssUUFBUSxJQUFJLE1BQU0sSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLElBQUksSUFBSSxJQUFJLE1BQU0sQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuLyoqXG4gKiBAZmlsZW92ZXJ2aWV3XG4gKiBAc3VwcHJlc3Mge21pc3NpbmdSZXF1aXJlfVxuICovXG5cbihmdW5jdGlvbihnbG9iYWw6IGFueSkge1xuICBpbnRlcmZhY2UgV3RmIHtcbiAgICB0cmFjZTogV3RmVHJhY2U7XG4gIH1cbiAgaW50ZXJmYWNlIFd0ZlNjb3BlIHt9XG4gIGludGVyZmFjZSBXdGZSYW5nZSB7fVxuICBpbnRlcmZhY2UgV3RmVHJhY2Uge1xuICAgIGV2ZW50czogV3RmRXZlbnRzO1xuICAgIGxlYXZlU2NvcGUoc2NvcGU6IFd0ZlNjb3BlLCByZXR1cm5WYWx1ZT86IGFueSk6IHZvaWQ7XG4gICAgYmVnaW5UaW1lUmFuZ2UocmFuZ2VUeXBlOiBzdHJpbmcsIGFjdGlvbjogc3RyaW5nKTogV3RmUmFuZ2U7XG4gICAgZW5kVGltZVJhbmdlKHJhbmdlOiBXdGZSYW5nZSk6IHZvaWQ7XG4gIH1cbiAgaW50ZXJmYWNlIFd0ZkV2ZW50cyB7XG4gICAgY3JlYXRlU2NvcGUoc2lnbmF0dXJlOiBzdHJpbmcsIGZsYWdzPzogYW55KTogV3RmU2NvcGVGbjtcbiAgICBjcmVhdGVJbnN0YW5jZShzaWduYXR1cmU6IHN0cmluZywgZmxhZ3M/OiBhbnkpOiBXdGZFdmVudEZuO1xuICB9XG5cbiAgdHlwZSBXdGZTY29wZUZuID0gKC4uLmFyZ3M6IGFueVtdKSA9PiBXdGZTY29wZTtcbiAgdHlwZSBXdGZFdmVudEZuID0gKC4uLmFyZ3M6IGFueVtdKSA9PiBhbnk7XG5cbiAgLy8gRGV0ZWN0IGFuZCBzZXR1cCBXVEYuXG4gIGxldCB3dGZUcmFjZTogV3RmVHJhY2UgPSBudWxsO1xuICBsZXQgd3RmRXZlbnRzOiBXdGZFdmVudHMgPSBudWxsO1xuICBjb25zdCB3dGZFbmFibGVkOiBib29sZWFuID0gKGZ1bmN0aW9uKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHd0ZjogV3RmID0gZ2xvYmFsWyd3dGYnXTtcbiAgICBpZiAod3RmKSB7XG4gICAgICB3dGZUcmFjZSA9IHd0Zi50cmFjZTtcbiAgICAgIGlmICh3dGZUcmFjZSkge1xuICAgICAgICB3dGZFdmVudHMgPSB3dGZUcmFjZS5ldmVudHM7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH0pKCk7XG5cbiAgY2xhc3MgV3RmWm9uZVNwZWMgaW1wbGVtZW50cyBab25lU3BlYyB7XG4gICAgbmFtZTogc3RyaW5nID0gJ1dURic7XG5cbiAgICBzdGF0aWMgZm9ya0luc3RhbmNlID1cbiAgICAgICAgd3RmRW5hYmxlZCAmJiB3dGZFdmVudHMuY3JlYXRlSW5zdGFuY2UoJ1pvbmU6Zm9yayhhc2NpaSB6b25lLCBhc2NpaSBuZXdab25lKScpO1xuICAgIHN0YXRpYyBzY2hlZHVsZUluc3RhbmNlOiB7W2tleTogc3RyaW5nXTogV3RmRXZlbnRGbn0gPSB7fTtcbiAgICBzdGF0aWMgY2FuY2VsSW5zdGFuY2U6IHtba2V5OiBzdHJpbmddOiBXdGZFdmVudEZufSA9IHt9O1xuICAgIHN0YXRpYyBpbnZva2VTY29wZToge1trZXk6IHN0cmluZ106IFd0ZkV2ZW50Rm59ID0ge307XG4gICAgc3RhdGljIGludm9rZVRhc2tTY29wZToge1trZXk6IHN0cmluZ106IFd0ZkV2ZW50Rm59ID0ge307XG5cbiAgICBvbkZvcmsoXG4gICAgICAgIHBhcmVudFpvbmVEZWxlZ2F0ZTogWm9uZURlbGVnYXRlLCBjdXJyZW50Wm9uZTogWm9uZSwgdGFyZ2V0Wm9uZTogWm9uZSxcbiAgICAgICAgem9uZVNwZWM6IFpvbmVTcGVjKTogWm9uZSB7XG4gICAgICBjb25zdCByZXRWYWx1ZSA9IHBhcmVudFpvbmVEZWxlZ2F0ZS5mb3JrKHRhcmdldFpvbmUsIHpvbmVTcGVjKTtcbiAgICAgIFd0ZlpvbmVTcGVjLmZvcmtJbnN0YW5jZSh6b25lUGF0aE5hbWUodGFyZ2V0Wm9uZSksIHJldFZhbHVlLm5hbWUpO1xuICAgICAgcmV0dXJuIHJldFZhbHVlO1xuICAgIH1cblxuICAgIG9uSW52b2tlKFxuICAgICAgICBwYXJlbnRab25lRGVsZWdhdGU6IFpvbmVEZWxlZ2F0ZSwgY3VycmVudFpvbmU6IFpvbmUsIHRhcmdldFpvbmU6IFpvbmUsIGRlbGVnYXRlOiBGdW5jdGlvbixcbiAgICAgICAgYXBwbHlUaGlzOiBhbnksIGFwcGx5QXJnczogYW55W10sIHNvdXJjZTogc3RyaW5nKTogYW55IHtcbiAgICAgIGxldCBzY29wZSA9IFd0ZlpvbmVTcGVjLmludm9rZVNjb3BlW3NvdXJjZV07XG4gICAgICBpZiAoIXNjb3BlKSB7XG4gICAgICAgIHNjb3BlID0gV3RmWm9uZVNwZWMuaW52b2tlU2NvcGVbc291cmNlXSA9XG4gICAgICAgICAgICB3dGZFdmVudHMuY3JlYXRlU2NvcGUoYFpvbmU6aW52b2tlOiR7c291cmNlfShhc2NpaSB6b25lKWApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHd0ZlRyYWNlLmxlYXZlU2NvcGUoXG4gICAgICAgICAgc2NvcGUoem9uZVBhdGhOYW1lKHRhcmdldFpvbmUpKSxcbiAgICAgICAgICBwYXJlbnRab25lRGVsZWdhdGUuaW52b2tlKHRhcmdldFpvbmUsIGRlbGVnYXRlLCBhcHBseVRoaXMsIGFwcGx5QXJncywgc291cmNlKSk7XG4gICAgfVxuXG5cbiAgICBvbkhhbmRsZUVycm9yKFxuICAgICAgICBwYXJlbnRab25lRGVsZWdhdGU6IFpvbmVEZWxlZ2F0ZSwgY3VycmVudFpvbmU6IFpvbmUsIHRhcmdldFpvbmU6IFpvbmUsXG4gICAgICAgIGVycm9yOiBhbnkpOiBib29sZWFuIHtcbiAgICAgIHJldHVybiBwYXJlbnRab25lRGVsZWdhdGUuaGFuZGxlRXJyb3IodGFyZ2V0Wm9uZSwgZXJyb3IpO1xuICAgIH1cblxuICAgIG9uU2NoZWR1bGVUYXNrKFxuICAgICAgICBwYXJlbnRab25lRGVsZWdhdGU6IFpvbmVEZWxlZ2F0ZSwgY3VycmVudFpvbmU6IFpvbmUsIHRhcmdldFpvbmU6IFpvbmUsIHRhc2s6IFRhc2spOiBhbnkge1xuICAgICAgY29uc3Qga2V5ID0gdGFzay50eXBlICsgJzonICsgdGFzay5zb3VyY2U7XG4gICAgICBsZXQgaW5zdGFuY2UgPSBXdGZab25lU3BlYy5zY2hlZHVsZUluc3RhbmNlW2tleV07XG4gICAgICBpZiAoIWluc3RhbmNlKSB7XG4gICAgICAgIGluc3RhbmNlID0gV3RmWm9uZVNwZWMuc2NoZWR1bGVJbnN0YW5jZVtrZXldID1cbiAgICAgICAgICAgIHd0ZkV2ZW50cy5jcmVhdGVJbnN0YW5jZShgWm9uZTpzY2hlZHVsZToke2tleX0oYXNjaWkgem9uZSwgYW55IGRhdGEpYCk7XG4gICAgICB9XG4gICAgICBjb25zdCByZXRWYWx1ZSA9IHBhcmVudFpvbmVEZWxlZ2F0ZS5zY2hlZHVsZVRhc2sodGFyZ2V0Wm9uZSwgdGFzayk7XG4gICAgICBpbnN0YW5jZSh6b25lUGF0aE5hbWUodGFyZ2V0Wm9uZSksIHNoYWxsb3dPYmoodGFzay5kYXRhLCAyKSk7XG4gICAgICByZXR1cm4gcmV0VmFsdWU7XG4gICAgfVxuXG5cbiAgICBvbkludm9rZVRhc2soXG4gICAgICAgIHBhcmVudFpvbmVEZWxlZ2F0ZTogWm9uZURlbGVnYXRlLCBjdXJyZW50Wm9uZTogWm9uZSwgdGFyZ2V0Wm9uZTogWm9uZSwgdGFzazogVGFzayxcbiAgICAgICAgYXBwbHlUaGlzOiBhbnksIGFwcGx5QXJnczogYW55W10pOiBhbnkge1xuICAgICAgY29uc3Qgc291cmNlID0gdGFzay5zb3VyY2U7XG4gICAgICBsZXQgc2NvcGUgPSBXdGZab25lU3BlYy5pbnZva2VUYXNrU2NvcGVbc291cmNlXTtcbiAgICAgIGlmICghc2NvcGUpIHtcbiAgICAgICAgc2NvcGUgPSBXdGZab25lU3BlYy5pbnZva2VUYXNrU2NvcGVbc291cmNlXSA9XG4gICAgICAgICAgICB3dGZFdmVudHMuY3JlYXRlU2NvcGUoYFpvbmU6aW52b2tlVGFzazoke3NvdXJjZX0oYXNjaWkgem9uZSlgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB3dGZUcmFjZS5sZWF2ZVNjb3BlKFxuICAgICAgICAgIHNjb3BlKHpvbmVQYXRoTmFtZSh0YXJnZXRab25lKSksXG4gICAgICAgICAgcGFyZW50Wm9uZURlbGVnYXRlLmludm9rZVRhc2sodGFyZ2V0Wm9uZSwgdGFzaywgYXBwbHlUaGlzLCBhcHBseUFyZ3MpKTtcbiAgICB9XG5cbiAgICBvbkNhbmNlbFRhc2socGFyZW50Wm9uZURlbGVnYXRlOiBab25lRGVsZWdhdGUsIGN1cnJlbnRab25lOiBab25lLCB0YXJnZXRab25lOiBab25lLCB0YXNrOiBUYXNrKTpcbiAgICAgICAgYW55IHtcbiAgICAgIGNvbnN0IGtleSA9IHRhc2suc291cmNlO1xuICAgICAgbGV0IGluc3RhbmNlID0gV3RmWm9uZVNwZWMuY2FuY2VsSW5zdGFuY2Vba2V5XTtcbiAgICAgIGlmICghaW5zdGFuY2UpIHtcbiAgICAgICAgaW5zdGFuY2UgPSBXdGZab25lU3BlYy5jYW5jZWxJbnN0YW5jZVtrZXldID1cbiAgICAgICAgICAgIHd0ZkV2ZW50cy5jcmVhdGVJbnN0YW5jZShgWm9uZTpjYW5jZWw6JHtrZXl9KGFzY2lpIHpvbmUsIGFueSBvcHRpb25zKWApO1xuICAgICAgfVxuICAgICAgY29uc3QgcmV0VmFsdWUgPSBwYXJlbnRab25lRGVsZWdhdGUuY2FuY2VsVGFzayh0YXJnZXRab25lLCB0YXNrKTtcbiAgICAgIGluc3RhbmNlKHpvbmVQYXRoTmFtZSh0YXJnZXRab25lKSwgc2hhbGxvd09iaih0YXNrLmRhdGEsIDIpKTtcbiAgICAgIHJldHVybiByZXRWYWx1ZTtcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gc2hhbGxvd09iaihvYmo6IHtbazogc3RyaW5nXTogYW55fSwgZGVwdGg6IG51bWJlcik6IGFueSB7XG4gICAgaWYgKCFkZXB0aCkgcmV0dXJuIG51bGw7XG4gICAgY29uc3Qgb3V0OiB7W2s6IHN0cmluZ106IGFueX0gPSB7fTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBvYmopIHtcbiAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBsZXQgdmFsdWUgPSBvYmpba2V5XTtcbiAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHtcbiAgICAgICAgICBjYXNlICdvYmplY3QnOlxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IHZhbHVlICYmIHZhbHVlLmNvbnN0cnVjdG9yICYmICg8YW55PnZhbHVlLmNvbnN0cnVjdG9yKS5uYW1lO1xuICAgICAgICAgICAgdmFsdWUgPSBuYW1lID09ICg8YW55Pk9iamVjdCkubmFtZSA/IHNoYWxsb3dPYmoodmFsdWUsIGRlcHRoIC0gMSkgOiBuYW1lO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnZnVuY3Rpb24nOlxuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5uYW1lIHx8IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIG91dFtrZXldID0gdmFsdWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICBmdW5jdGlvbiB6b25lUGF0aE5hbWUoem9uZTogWm9uZSkge1xuICAgIGxldCBuYW1lOiBzdHJpbmcgPSB6b25lLm5hbWU7XG4gICAgem9uZSA9IHpvbmUucGFyZW50O1xuICAgIHdoaWxlICh6b25lICE9IG51bGwpIHtcbiAgICAgIG5hbWUgPSB6b25lLm5hbWUgKyAnOjonICsgbmFtZTtcbiAgICAgIHpvbmUgPSB6b25lLnBhcmVudDtcbiAgICB9XG4gICAgcmV0dXJuIG5hbWU7XG4gIH1cblxuICAoWm9uZSBhcyBhbnkpWyd3dGZab25lU3BlYyddID0gIXd0ZkVuYWJsZWQgPyBudWxsIDogbmV3IFd0ZlpvbmVTcGVjKCk7XG59KSh0eXBlb2Ygd2luZG93ID09PSAnb2JqZWN0JyAmJiB3aW5kb3cgfHwgdHlwZW9mIHNlbGYgPT09ICdvYmplY3QnICYmIHNlbGYgfHwgZ2xvYmFsKTtcbiJdfQ==