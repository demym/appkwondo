function colog(e){debugActive&&console.log(e)}function toggleLeftMenu(){var e=$.mobile.activePage.attr("id"),a=$("#"+e+" #menuPanel").length;a>0&&$("#"+e+" #menuPanel").remove();var t={loggedin:loggedin},o=new EJS({url:"tpl/menupanel.ejs"}).render(t);$("#"+e).append(o),$("#"+e+" #menuPanel").panel(),$("#"+e+" #menuPanel").panel("toggle")}function toggleRightMenu(e){var a=$.mobile.activePage.attr("id"),t=$("#"+a+" #"+e).length;t>0&&$("#"+a+" #"+e).remove();var o={loggedin:loggedin,role:role},i=new EJS({url:"tpl/"+e+".ejs"}).render(o);$("#"+a).append(i),$("#"+a+" #"+e).panel(),$("#"+a+" #"+e).panel("toggle")}function setMatchesRefresh(){autorefresh&&(autorefreshcount++,console.log("running "),1==autorefreshcount&&setInterval(function(){refreshMatches()},timerMatches))}function openPopup(e,a){a||(a="");var t=$.mobile.activePage.attr("id");colog("current pageid: "+t),$("#"+t+" div[data-role=content] #temppopup").remove();var o=new EJS({url:"tpl/genericpop.ejs"}).render(e);$("#"+t+" div[data-role=content]").append(o),$("#"+t+" #temppopup h5").html(a),$("#"+t+" #temppopup").popup(),$("#"+t+" #temppopup").popup("open",{transition:"flip"})}function popCloseRemove(){var e=$.mobile.activePage.attr("id");colog("current pageid: "+e),$("#"+e+" #temppopup").popup("close").remove()}function openTabulato(e){progressStart("Caricamento.."),$.ajax({url:e,type:"GET",dataType:"html"}).done(function(e){colog(e);var a=$(e).find("img[alt=drawing_load_error]"),t=a.attr("src").replace("./","");colog(t);var o="<img style='width: 400px; height: 500px;' src='http://demo.tkdtechnology.it/"+t+"' />";openPopup(o),progressStop()})}function openTabulatoPage(e,a){var t=$(e).html(),o=rooturl+"/gettkdtabulato";progressStart("Caricamento.."),$.ajax({url:o,type:"POST",dataType:"html",data:{url:a}}).done(function(e){colog(e);var o=$(e).find("img[alt=drawing_load_error]"),i=o.attr("src").replace("./","");colog(i);var r="<img style='width: 600px; height: 600px;' src='http://demo.tkdtechnology.it/"+i+"' />";$("#page_tabulato #cat").html(t),$("#page_tabulato #cont").html(r),progressStop(),$("#page_tabulato #url").val(a),$.mobile.changePage("#page_tabulato");var n=$("#page_tabulato #cont img").get(0);n.addEventListener("gesturechange",function(e){console.log(e.scale),e.scale>1||e.scale<1})})}function openTabulatoImage(){var e=$("#page_tabulato #url").val();window.open(e,"_blank","location=no&toolbar=yes")}function getTabulatoImg(e,a){progressStart("Caricamento.."),$.ajax({url:e,type:"GET",dataType:"html"}).done(function(e){colog(e);var t=$(e).find("img[alt=drawing_load_error]"),o=t.attr("src").replace("./","");colog(o);var i="<img style='width: 500px; height: 600px;' src='http://demo.tkdtechnology.it/"+o+"' />";a(i),progressStop()})}function getTkdTechnology(){progressStart("Caricamento..");var e=rooturl+"/gettkdtech";$.ajax({url:e,type:"GET"}).done(function(e){var a=$(e).find("div#tab-63-atl-cls"),t=($(e).find("div#tab-63"),$(e).find("div.tabs:first ul:first li"));colog("navtabs: "+t.length);var o="";colog(e),$(t).each(function(a){var t=$(this).find("a").attr("href"),i=$(this).find("a").html();colog(i);var r=$(e).find("div"+t+"-atl-int"),n=$(e).find("div"+t+"-atl-cls"),s=$(e).find("div"+t+"-atl-tab"),c=$(e).find("div"+t+"-atl-cat"),l=n.find("table"),d=r.find("table");getTkdtInteractive(d),l.css("border","2px solid black"),l.css("width","100%"),l.find("thead tr").prepend("<th width=8>&nbsp;</th>"),l.find("th").css("background","#f6f6f6"),l.find("tr").each(function(e){var a=$(this);e>0&&$(this).prepend("<td width=10>"+e+"</td>");var t=$(this).find("td:first");colog(t.length),a.html().toLowerCase().indexOf("rozzano")>-1&&(a.find("td").css("font-weight","bold"),a.css("background","lightgreen"))});var g="";s.find("a").each(function(e){var a=$(this).html(),t=($(this),$(this).attr("href"));g+="<a style='font-size: 10px; white-space: normal;' class=tabbutton href='#' onclick=openTabulatoPage(this,'"+t+"') >"+a+"</a>"}),l.find("td").css("text-align","center"),l.find("td,th").css("font-size","12px"),l.find("td").css("border-top","1px solid gray"),o+='<div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">'+i+'</h5><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Classifica</h5>'+n.html()+'</div><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Tabulati</h5>'+g+'</div><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Atleti per categoria</h5>'+c.html()+"</div></div>"});t.html()+a.html();$("#page_tkdt").find("#cont").html(o),$("#page_tdkt").is(":visible")||(colog("page_tkdt not visible, showing it"),$.mobile.changePage("#page_tkdt")),$("#temppopup").find("div[data-role=collapsible]").collapsible({theme:"c",refresh:!0}),$("#page_tkdt").find("div[data-role=collapsible]").collapsible({theme:"c",refresh:!0}),$("#page_tkdt").find("a.tabbutton").button(),progressStop();var i=$.mobile.activePage.attr("id");$("#"+i+" #menuPanel").panel("close")})}function getTkdtInteractive(e){console.log("getTkdInteractive");var a=e.find("tbody"),t=a.find("tr");t.each(function(){var e=$(this),a=e.find("td:eq(0)").remove("span").html(),t=e.find("td:eq(1)").remove("span").html(),o=e.find("td:eq(2)").remove("span").html(),i=e.find("td:eq(3)").remove("span").html(),r=e.find("td:eq(4)").remove("span").html(),n=e.find("td:eq(5)").remove("span").html(),s=e.find("td:eq(6)").remove("span").html();if(o.toLowerCase().trim().indexOf("rozzano")>-1){var c={cognome:a,nome:t,categoria:i,categoria_cintura:r,categoria_peso:n,sesso:s};console.log("interactive: "+a+" "+t+" - "+i+" - "+n+" - "+r),tkdt_iscritti.rows.push(c)}})}function cancelDelMatch(){$("#matchesatleta #popDelMatch").popup("close")}function isCordovaApp(){var e=!1;return colog("isCordovaApp URL:"+document.URL),-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")&&(e=!0),1!=e||navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)||(e=!1),e}function initApp(){app.initialize(),colog("Navigator user agent from docready "+navigator.userAgent);var e=isCordovaApp();colog("isCordovaApp: "+e),isPhone=e?!0:!1,colog("Running on phone: "+isPhone),isPhone||docready()}function playSound(e){document.getElementById("sound").innerHTML='<audio autoplay="autoplay"><source src="'+e+'.mp3" type="audio/mpeg" /><source src="'+e+'.ogg" type="audio/ogg" /><embed hidden="true" autostart="true" loop="false" src="'+e+'.mp3" /></audio>'}function snotify(e){if(colog("Snotify:"),colog(e),0==settings.notifiche)return void colog("notifiche non attive nei settings, esco senza notificare");var a={body:e.text,icon:"img/logotkdrozzano.png"};if(isPhone){notify(e.text);var t=new EJS({url:"tpl/popnotification.ejs"}).render(a),o=$.mobile.activePage.attr("id");colog("current pageid: "+o),$("#"+o+" div[data-role=content]").append(t),$("#"+o+" #popNotification").popup(),$("#"+o+" #popNotification").popup("open"),playSound("img/chimes"),setTimeout(function(){$("#"+o+" #popNotification").popup("close").remove()},6e3)}else{var t=new EJS({url:"tpl/popnotification.ejs"}).render(a),o=$.mobile.activePage.attr("id");if(colog("current pageid: "+o),$("#"+o+" div[data-role=content]").append(t),$("#"+o+" #popNotification").popup(),$("#"+o+" #popNotification").popup("open"),playSound("img/chimes"),setTimeout(function(){$("#"+o+" #popNotification").popup("close").remove()},6e3),"Notification"in window)if("granted"===Notification.permission){colog("notification are granted");new Notification("AppKwonDo",a)}else"denied"!==Notification.permission&&(colog("asking grant for notifications"),Notification.requestPermission(function(e){if("granted"===e){new Notification("AppKwonDo",a)}}));else colog("This browser does not support system notifications")}}function conslog(e){console.log(e)}function closePanel(){conslog("panels found: "+$("[data-role=panel]:visible").length),$("[data-role=panel]:visible").panel("close")}function updateHomeInfos(){$(".serverspan").html("Connesso al server: "+rooturl.replace("http://","").replace("https://","")),$(".societaspan").html("Società: "+settings.mysocietaname)}function docready(){$("a").addClass("fastClick"),$("a.ui-btn-left,a.ui-btn-right").addClass("transparentborderbutton").addClass("ui-nodisc-icon"),$.mobile.defaultPageTransition="none",$("#popResult .incbutton").on("click",function(){var e=$("#popResult #risult").val();""==e.trim()&&(e="0-0");var a=$(this).attr("id"),t=parseInt(e.split("-")[0].trim(),10),o=parseInt(e.split("-")[1].trim(),10);colog("r1: "+t),colog("r2: "+o);var i=a.substring(a.length-1),r=a.substring(0,a.length-1);colog(i+" - "+r),"plus"==r&&(1==i&&t++,2==i&&o++),"minus"==r&&(1==i&&t--,2==i&&o--,0>t&&(t=0),0>o&&(o=0));var n=t+"-"+o;$("#popResult #risult").val(n)});var e=window.location.href;if(openFB.init({appId:"924594024295731",tokenStore:window.localStorage}),colog("docready !"),colog("url: "+e),e.indexOf("#")>-1)return colog("back to index"),void(window.location.href="index.html");jQuery.support.cors=!0,storage=window.localStorage,socket=io.connect(rooturl),colog("socket connected to socket server"),$.ajaxSetup({cache:!1}),$.event.special.tap.emitTapOnTaphold=!1,FastClick.attach(document.body),socket.on("sysmsg",function(e){snotify(e)}),socket.on("refreshsockets",function(e){console.log("refreshsockets"),showSockets()}),socket.on("getnickname",function(e){console.log("getnickname: "+e.sockid),setCookie("socketid",e.sockid)}),socket.on("notification",function(e){if(colog("received notification from socket.io server:"),colog(e),snotify(e),e.updategara&&"yes"==e.updategara){$.mobile.activePage.attr("id");jcurrentgara&&jcurrentgara.id==e.garaid&&refreshCurrentGara()}}),socket.on("refreshgara",function(e){if(colog("received refreshgara from socket.io server:"),colog(e),e.updategara&&"yes"==e.updategara){$.mobile.activePage.attr("id");jcurrentgara&&jcurrentgara.id==e.garaid&&refreshCurrentGara()}}),socket.on("connect",function(){colog("Client has connected to the server!")}),socket.on("message",function(e){colog("Received a message from the server!"),colog(e)}),socket.on("disconnect",function(){colog("The client has disconnected!")}),$("#optionsPage #server").val(rooturl),$("#matchesatleta #dialogForAtleta").popup(),$("#gara #popResult").popup(),$("#gara #popDelMatch").popup(),$("#gara #popAddMatch").popup(),$("#page_atleti #atleti_categorie").panel(),bindGaraPage(),$("#menuExit").on("tap",function(e){exitapp()}),loadOptions(function(){refreshAtletiServer(),refreshGareServer(),updateHomeInfos()}),autoLogin(),$(document).on("pagebeforeshow",function(e){colog("pagebeforeshow"),colog("fbloggedin "+fbloggedin),fbloggedin||(window.location.href="index.html")}),$(document).on("pageshow",function(e){return colog("pageshow"),colog("fbloggedin "+fbloggedin),void(fbloggedin||(window.location.href="index.html"))});var a=getQueryString("mode");"open"==a&&$.mobile.changePage("#index")}function exitapp(){app.exit()}function refreshGareServer(e){$.mobile.activePage.attr("id");app.loadAllGare(function(a){if(a.error)toast("errore","long");else{toast("Gare caricate da "+rooturl),$gare=a;var t=$("#listagare");t.html("");var o='<li data-role="list-divider" role="heading" data-theme="b">'+a.rows.length+" gare</li>";t.append(o),a.rows.sort(function(e,a){if(e.doc.data&&a.doc.data){var t=getNormalD(e.doc.data),o=getNormalD(a.doc.data);if(t>o)return-1;if(o>t)return 1}return 0}),e&&(a=filterRows(a,{stato:e},!0));var i=new EJS({url:"tpl/gare.ejs"}).render(a.rows);t.empty().append(i),progressStop(),$("#gare #recnum span").html(a.rows.length+" gare"),t.find("li").on("tap",function(){var e=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+e),$("#gara #listabyprog").empty(),setCookie("lastcronaca",""),$.mobile.changePage("#gara"),openGara(e,function(){garaid=e,$gara=a}),!1}),t.find("li").on("taphold",function(){if("tkdradmin"==role){var e=$(this).find("a").attr("id").split("_")[0],a=$(this).find("a").attr("id").split("_")[1],t=getGaraById(e);colog(t);var o={id:e,rev:a,doc:t.doc},i=new EJS({url:"tpl/popgare.ejs"}).render(o);$("#gare div[data-role=content] #popGare").remove(),$("#gare div[data-role=content]").append(i),$("#gare #popGare #ulpopgare").listview(),$("#gare #popGare").popup(),$("#gare #popGare").popup("open")}}),t.listview(),t.listview("refresh")}})}function markGara(e,a){var t={id:e,stato:a};$.ajax({url:rooturl+"/gare/update",type:"POST",data:t}).done(function(e){popGareCancel(),refreshGareServer()})}function editGara(e){console.log("editgara");var a=getGaraById(e),t=$("#page_editgara");t.find(".jform").each(function(){var e=$(this).attr("id");$(this).val(a.doc[e])}),$.mobile.changePage("#page_editgara"),popGareCancel()}function editGaraOk(){var e=$("#page_editgara #id").val(),a={id:e},t=$("#page_editgara"),o=checkValidGaraForm(t);return 1==o.error?void alert("Errore di inserimento:\n\n"+o.errors):(t.find(".jform").each(function(){var e=$(this).attr("id");a[e]=$(this).val()}),console.log(a),void $.ajax({url:rooturl+"/gare/update",type:"POST",data:a}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#gare"),refreshGareServer())}).fail(function(){toast("Error posting","long")}))}function refreshCurrentGara(){autorefreshcount=0,$("#gara .medals").html(caricamentotext);var e=jcurrentgara.id;colog("refreshCurrentGara - id= "+e),openGara(e)}function popGareCloseRemove(){$("#gare #popGare").popup("close").remove()}function openGara(e,a){colog("opengara "+e),$("#gara #navbar ul li").bind("tap",function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var t=$(this).find("a").attr("data-tab-class");$("#gara .ul"+t).show(),activeTab=e}),gara.loadById(e,function(e){refreshMatches(),$("#gara #hdr").find("#hgara a").html($gara.doc.location+" -     "+$gara.doc.data+" - "+settings.mysocietaname),$("#gara #hdriscritti").find("h1").html($gara.doc.title+" "+$gara.doc.location+" -     "+$gara.doc.data);var t=[];$gara.doc.myiscritti&&(t=$gara.doc.myiscritti.split(","));var o=t.length,i="";iscrittiincat=[],iscrittiincat=filterIscritti(t),o=iscrittiincat.length,mf=getMaschiFemmine(iscrittiincat,"iscritti"),$("#gara #lisocieta").html("<b>"+settings.mysocietaname+"</b>"),$("#gara #ligaratitle").html("Gara: <b>"+$gara.doc.title+"</b>");var r="";$gara.doc.maplocation&&""!=$gara.doc.maplocation.trim()&&(r="&nbsp;&nbsp;<a href='#' onclick='garaMaps()' class='pulsante' style='width:40px;'>Mappa</a>"),$("#gara #ligaralocation").html("Location: "+$gara.doc.location+r),$("#liiscritti").text(o+" atleti iscritti"+i+" --  F: "+mf.femmine+" M: "+mf.maschi),a&&a(),colog("stato gara: "+jcurrentgara.stato),"disputata"==jcurrentgara.stato&&($("#matchesatleta #actionpanela").hide(),$("#iscrittiPage #btnAddIscritto").hide())})}function doLogin(){var e=$("#login"),a=e.find("#txt-email").val(),t=e.find("#txt-password").val(),o=e.find("#chck-rememberme").prop("checked"),i=e.find("#chck-autologin").prop("checked");progressStart("Accesso in corso...","Log-in"),$.ajax({url:rooturl+"/atleti/login",data:{email:a,password:t},type:"POST"}).done(function(e){progressStop(),colog("login result: "+JSON.stringify(e)),role=e.role,loggedin=!0,"true"==e.loggedin?(toast("login eseguito con successo"),"tkdradmin"==role&&($("#index .loginspan").html("Accesso amministratore eseguito"),$("#index #lilogout").show(),$("#index #lilogin").hide(),$("#index #liatleti").show(),$("#index #lisockets").show(),$("#gara #liresetcronaca").show(),$("#gara #lisysmsg").show(),$("#gare #liaggiungigara").show(),$("#page_atleti #liaggiungiatleta").show(),$("#matchesatleta #actionpanela").show(),$("#iscrittiPage #btnAddIscritto").show(),$("#gare #test").show(),$(".showadmin").show()),colog("ckal: "+i),i?(colog("setting autologin true"),setCookie("autologin","true",cookieDays)):deleteCookie("autologin"),o?(setCookie("email",a,cookieDays),setCookie("psw",t,cookieDays),colog("setted rememberme cookies")):(deleteCookie("email"),deleteCookie("psw"),colog("deleted rememberme cookies")),$.mobile.changePage("#index"),refreshNews()):($("#login #dlg-invalid-credentials").popup("open"),$("#index .loginspan").html(""))}).fail(function(){progressStop(),toast("Error getting elibrary documents","long")})}function refreshNews(e){$.ajax({url:rooturl+"/news",dataType:"json",type:"GET"}).done(function(a){var t=new EJS({url:"tpl/news.ejs"}).render(a.rows);$("#page_news #content").html(t),e&&e(a)})}function initTabs(){$("#gara a[data-role=tab]").each(function(e){$(this).bind("vclick",function(){sdebug($(this).attr("id")),activeTab=e,setActiveTab(activeTab)})})}function setActiveTab(e){return void $("#gara #navbar ul li:eq("+e+")").trigger("vclick")}function loadCronaca(e,a){colog("loadcronaca for gara "+e),$.ajax({url:rooturl+"/matches/getcronaca/"+e,type:"GET"}).done(function(t){if($("#gara #listacronaca").empty(),t.error)console.log("error reading cronaca for this gara id="+e);else{console.log("cronaca: "+t.rows.length),colog(t);t.rows;cronaca=t;var o=new EJS({url:"tpl/cronaca.ejs"}).render(t.rows);$("#gara #listacronaca").append(o),$("#gara #listacronaca").listview(),$("#gara #listacronaca").listview("refresh")}a&&a()})}function getPunti(e,a,t){var o=0;return o=7*e+3*a+1*t}function resetFilters(){$("#temppopup #sex").val("_"),$("#temppopup #categ").val("_"),$("#temppopup #medag").val("_"),$("#temppopup #quadrato").val("_")}function setFilters(){var e="";$("#temppopup #sex").val()&&(e=$("#temppopup #sex").val()),"_"==e&&(e="");var a="";$("#temppopup #categ").val()&&(a=$("#temppopup #categ").val()),"_"==a&&(a="");var t="";$("#temppopup #medag").val()&&(t=$("#temppopup #medag").val()),"_"==t&&(t="");var o="";$("#temppopup #quadrato").val()&&(o=$("#temppopup #quadrato").val()),"_"==o&&(o=""),garaFilters={categoria:a.toLowerCase().trim(),sesso:e,medaglia:t,quadrato:o};var i="<font color='yellow'><b>Filtri applicati</b></font>",r="2px solid yellow";""==garaFilters.categoria&&""==garaFilters.sesso&&""==garaFilters.medaglia&&""==garaFilters.quadrato&&(i="Nessun filtro",r="0px solid white"),$("#gara .spanfilt").html(i).css("border",r),popCloseRemove(),refreshCurrentGara()}function loadMatchesByProgOld(e,a){var t={matches:$allmatches,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(t,a),colog("loadmatchesbyprog "+e),$.ajax({url:rooturl+"/matches/findbygaraid/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){$matches=e,$allmatches=e,colog("total matches: "+$matches.rows.length);var a=[];if(""!=cat){var a={rows:[]};$(e.rows).each(function(t){var o=e.rows[t].doc.datanascita;colog("datanascita: "+o),getCategoria(o).toLowerCase()==cat.toLowerCase()&&a.rows.push(e.rows[t])}),$matches=a,colog("matches after categoria "+cat+": "+$matches.rows.length)}var o=new EJS({url:"tpl/matchesbyprog.ejs"}).render($matches.rows),i="listabyprog",r=$("#gara ul#"+i);r.empty(),r.append(o),r.listview(),r.listview("refresh");var n="";""!=$.trim(viewcat)&&(n=" in cat. "+viewcat.toUpperCase()),colog("$allmatches for cat "+viewcat+"-------->"+JSON.stringify($allmatches));var s=filterRows($matches,{dadisputare:"yes"}),c=filterRows(s,{disputato:"yes"});colog("$C--->"+JSON.stringify(c));var l=filterRows(c,{vinto:"yes"}),d=filterRows(c,{vinto:"no"}),g=c.rows.length-l.rows.length,p=getMaschiFemmine(s.rows),u=s.rows.length+" match da disputare ( M: "+p.maschi+", F: "+p.femmine+" )";p=getMaschiFemmine(l.rows);var h=getMaschiFemmine(c.rows),m=getMaschiFemmine(d.rows);u+="<br>"+c.rows.length+" match disputati ( M: "+h.maschi+", F: "+h.femmine+" ) <br>"+l.rows.length+" vinti ( M: "+p.maschi+", F: "+p.femmine+" ) <br>"+g+" persi ( M: "+m.maschi+", F: "+m.femmine+" )"+n,$("#limatches").html(u);var f=filterRows(c,{medagliamatch:"oro"}),v=filterRows(c,{medagliamatch:"argento"}),b=filterRows(c,{medagliamatch:"bronzo"}),w=getMaschiFemmine(f.rows),y=getMaschiFemmine(v.rows),k=getMaschiFemmine(b.rows);u="ORI: "+f.rows.length+" ( M: "+w.maschi+", F: "+w.femmine+" ) - punti: "+getPunti(f.rows.length,0,0)+"<br>ARGENTI: "+v.rows.length+" ( M: "+y.maschi+", F: "+y.femmine+" ) - punti: "+getPunti(0,v.rows.length,0)+"<br>BRONZI: "+b.rows.length+" ( M: "+k.maschi+", F: "+k.femmine+" ) - punti: "+getPunti(0,0,b.rows.length)+"<br><br>Punteggio totale medaglie: "+getPunti(f.rows.length,v.rows.length,b.rows.length)+" "+n,$("#limedaglie").html(u),$("#gara #ulinfogara span").html(getMedaglieGara($matches)),$("#gara #navbar ul li").bind("vclick",function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var o=$(this).find("a").attr("data-tab-class");$("#gara .ul"+o).show(),activeTab=e,t.callback&&t.callback()}),setActiveTab(activeTab)})}function filterMatches(e,a){a||(a=!1);var t={rows:[]},o=!1;return $(e).each(function(i){var r="",n="",s="",c="",l="";a?(r=e[i].doc.datanascita,n=e[i].doc.medagliamatch,s=e[i].doc.matchid,c=s.substring(0,s.length-2),l=e[i].doc.atletaid):(r=e[i].datanascita,n=e[i].medagliamatch,s=e[i].matchid,c=s.substring(0,s.length-2),l=e[i].atletaid),colog("datanascita: "+r);var d=!0;for(f in garaFilters)if(""!=garaFilters[f]){if(o=!0,"categoria"==f){var g=getCategoria(r).toLowerCase().trim()!=garaFilters.categoria.toLowerCase().trim();garaFilters.categoria.toLowerCase().trim().indexOf("senior")>-1&&(g=-1==getCategoria(r).toLowerCase().trim().indexOf("senior")),g&&(d=d&&!1)}if("medaglia"==f&&n.toLowerCase().trim()!=garaFilters.medaglia.toLowerCase().trim()&&(d=d&&!1),"quadrato"==f&&c.toLowerCase().trim()!=garaFilters.quadrato.toLowerCase().trim()&&(d=d&&!1),"sesso"==f){$a=getAtletaById(l);var p=$a.sesso;p.toLowerCase().trim()!=garaFilters.sesso.toLowerCase().trim()&&(d=d&&!1)}}o?d&&t.rows.push(e[i]):t.rows.push(e[i])}),isFiltered=o,t}function loadMatchesByProg(e,a){var t={matches:$allmatches,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(t,a),colog("loadmatchesbyprog "+e),$.ajax({url:rooturl+"/matches/findbygaraid/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){$matches=e,$allmatches=e,colog("total matches: "+$matches.rows.length);var a={rows:[]};a=filterMatches(e.rows,!0),$matches=a,colog("matches after categoria "+cat+": "+$matches.rows.length);var o=new EJS({url:"tpl/matchesbyprog.ejs"}).render($matches.rows),i="listabyprog",r=$("#gara ul#"+i);if(r.empty(),r.append(o),r.listview(),r.listview("refresh"),$("#gara #nomatches").hide(),0==$matches.rows.length){var n=refreshIscritti(!0);o=new EJS({url:"tpl/iscritti.ejs"}).render(n);var s=$("#gara #nomatches ul.iscritti_nomatches");s.empty(),s.append(o),s.listview(),s.listview("refresh");var c=$("#gara p.iscrittilength");c.html(n.length+" iscritti a questa gara"),$("#gara #nomatches").show()}var l="";isFiltered&&(l=" (filtri applicati) "),colog("$allmatches -------->"+JSON.stringify($allmatches));var d=filterRows($matches,{dadisputare:"yes"}),g=filterRows(d,{disputato:"yes"});colog("$C--->"+JSON.stringify(g));var p=filterRows(g,{vinto:"yes"}),u=filterRows(g,{vinto:"no"}),c=g.rows.length-p.rows.length,h=getMaschiFemmine(d.rows),m=d.rows.length+" match da disputare ( M: "+h.maschi+", F: "+h.femmine+" )";h=getMaschiFemmine(p.rows);var f=getMaschiFemmine(g.rows),v=getMaschiFemmine(u.rows);m+="<br>"+g.rows.length+" match disputati ( M: "+f.maschi+", F: "+f.femmine+" ) <br>"+p.rows.length+" vinti ( M: "+h.maschi+", F: "+h.femmine+" ) <br>"+c+" persi ( M: "+v.maschi+", F: "+v.femmine+" )"+l,$("#limatches").html(m);var b=filterRows(g,{medagliamatch:"oro"}),w=filterRows(g,{medagliamatch:"argento"}),y=filterRows(g,{medagliamatch:"bronzo"}),k=getMaschiFemmine(b.rows),S=getMaschiFemmine(w.rows),C=getMaschiFemmine(y.rows);m="ORI: "+b.rows.length+" ( M: "+k.maschi+", F: "+k.femmine+" ) - punti: "+getPunti(b.rows.length,0,0)+"<br>ARGENTI: "+w.rows.length+" ( M: "+S.maschi+", F: "+S.femmine+" ) - punti: "+getPunti(0,w.rows.length,0)+"<br>BRONZI: "+y.rows.length+" ( M: "+C.maschi+", F: "+C.femmine+" ) - punti: "+getPunti(0,0,y.rows.length)+"<br><br>Punteggio totale medaglie: "+getPunti(b.rows.length,w.rows.length,y.rows.length)+" "+l,$("#limedaglie").html(m),$("#gara #ulinfogara span").html(getMedaglieGara($matches)),$("#gara #navbar ul li").bind("vclick",function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var o=$(this).find("a").attr("data-tab-class");$("#gara .ul"+o).show(),activeTab=e,t.callback&&t.callback()}),setActiveTab(activeTab)})}function loadMatchesByAtletaOld(e){colog("loadmatchesbyatleta "+e),$.ajax({url:rooturl+"/matches/findbygaraid/byatleta/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){var a=e;if(colog("total matches: "+a.length),""!=cat){var t=[];$(e).each(function(a){var o=e[a].datanascita;colog("datanascita: "+o),getCategoria(o).toLowerCase()==cat.toLowerCase()&&t.push(e[a])}),a=t,colog("matches after categoria "+cat+": "+a.length)}var o=new EJS({url:"tpl/matchesbyatleta.ejs"}).render(a),i="listabyatleta",r=$("ul#"+i);r.empty(),r.append(o),r.listview(),r.listview("refresh"),$("#gara #navbar ul li").bind("vclick",function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var t=$(this).find("a").attr("data-tab-class");$("#gara .ul"+t).show(),activeTab=e}),setActiveTab(activeTab)})}function loadMatchesByAtleta(e){colog("loadmatchesbyatleta "+e),$.ajax({url:rooturl+"/matches/findbygaraid/byatleta/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){var a=e;colog("total matches: "+a.length);var t=[],o=!1;$(e).each(function(a){var i=e[a].datanascita,r=e[a].id;colog("datanascita: "+i);var n=!0;for(var s in garaFilters)if(""!=garaFilters[s]&&(o=!0,"categoria"==s&&(garaFilters[s].toLowerCase().trim().indexOf("senior")>-1?-1==getCategoria(i).toLowerCase().trim().indexOf("senior")&&(n=n&&!1):getCategoria(i).toLowerCase().trim()!=garaFilters.categoria.toLowerCase().trim()&&(n=n&&!1)),"sesso"==s)){var c=getAtletaById(r),l=c.sesso;l.toLowerCase().trim()!=garaFilters.sesso.toLowerCase().trim()&&(n=n&&!1)}o?n&&t.push(e[a]):t.push(e[a])}),isFiltered=o,a=t,colog("matches after categoria "+cat+": "+a.length);var i=new EJS({url:"tpl/matchesbyatleta.ejs"}).render(a),r="listabyatleta",n=$("ul#"+r);n.empty(),n.append(i),n.listview(),n.listview("refresh"),$("#gara #navbar ul li").bind("vclick",function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var t=$(this).find("a").attr("data-tab-class");$("#gara .ul"+t).show(),activeTab=e}),setActiveTab(activeTab)})}function refreshMeByProg(e){var a=$matches;sdebug("$mm.lenght: "+a.find("match").length);var t={matches:a,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(t,e);var o=t.matches;sdebug("refreshMeByProg matches: "+o.find("match").length+" - shownullmatches: "+t.showNullMatches+" - ulSelector: "+t.ulSelector),refreshMode="byprog";var i=$.parseXML("<matches></matches>"),r=$(i);sdebug("matches: "+$matches.find("match").length);var n=garaid,s="";o.find("match").each(function(){var e=$(this),a=$(this).find("garaid").text();if(sdebug("match: "+a),a==n){var t=$(this).find("progid").text(),o=$(this).find("atletaid").text(),i=$.trim($(this).find("datanascita").text());sdebug(t+" - "+o+" datanasc: "+i);var s=e.clone();if(""!=$.trim(viewcat)){var c=getCategoria(i);sdebug("categoria for "+o+": "+c),$.trim(viewcat)==$.trim(c)&&r.find("matches").append(s)}else r.find("matches").append(s)}}),matches=r.find("match"),matches.sort(function(e,a){var t=$(e).find("progid").text(),o=$(a).find("progid").text();return o>t?-1:t>o?1:0}),matches.each(function(){var e=$(this).clone(),a=$(this).find("id").text(),o=($(this).find("progid").text(),$(this).find("matchid").text()),i=$(this).find("vinto").text(),r=$(this).find("disputato").text(),n=$(this).find("dadisputare").text(),c=$(this).find("medagliamatch").text(),l=$(this).find("risultato").text(),d=$(this).find("datanascita").text(),g=getCategoria(d).toUpperCase(),p=$(this).find("atletaid").text(),u=$(this).find("atletaname").text();e.append("<atletaname></atletaname>"),e.find("atletaname").text(u),$msav.find("matches").append(e);var h="",m=!1,f="";if("yes"==$.trim(n)&&(m=!0),"no"==$.trim(n)&&(m=!1,f="black",t.showNullMatches&&(m=!0)),"yes"==$.trim(r)&&("yes"==$.trim(i)&&(h=" style='background-color: green' ",f="green"),"no"==$.trim(i)&&(h=" style='background-color: #C00000 ' ",f="red")),m){var v="matchtoplay.png";"oro"==c&&(v="medaglia_oro.png"),"argento"==c&&(v="medaglia_argento.png"),"bronzo"==c&&(v="medaglia_bronzo.png"),"yes"==$.trim(r)&&"none"==c&&("yes"==$.trim(i)&&(v="matchok.png"),"yes"!=$.trim(i)&&(v="matchko.png"));var b="",w="Non disputato",y="nondisputato";"yes"==$.trim(r)&&(y="vinto",w="Vinto, ",b="risultato: "+l,"yes"!=$.trim(i)&&(w="Perso, ",y="perso")),b=w+b,h="";var k="onclick='setResult(this)'";t.clickAtletaMatches&&(k="onclick=\"matchesPerAtleta('"+p+"','"+u+"','"+d+"')\""),s+="<li "+h+" tkdr-matchid='"+o+"' data-icon='false' id='match_"+a+"' ><a  shref=javascript:matchAtletaDetail('"+p+"') id='prog"+a+"' data-ajax='false'  href='#' "+k+" shref='gareatleta.html?atletaid="+p+"&garaid="+garaid+"'><img swidth='50' sheight='50' src='images/"+v+"' class='imgicon sui-li-icon ui-corner-none' ><div><span class='match "+f+"'>"+o+"</span><br><span class='categoria'>"+g+"</span><br><span class='atleta'>"+u+"</span><br><span class='soft "+y+"'>"+b+"</span></div></a><input type='hidden' class='datanascita' value='"+d+"' /><input type='hidden' class='atletaid' value='"+p+"' /><input type='hidden' class='atletaname' value='"+u+"'/></li>"}});var c=t.ulSelector,l=$("ul#"+c);if(l.empty(),l.append(s),l.listview(),l.listview("refresh"),t.showUpdated){$("#ulinfogara li span.left").html(sgetMedaglieGara(garaid));var d="";""!=$.trim(viewcat)&&(d=" in cat. "+viewcat.toUpperCase());var g=filterRows($allMatches,{dadisputare:"yes"}),p=(filterRows(g,{disputato:"yes"}),filterRows(g,{vinto:"yes"})),u=filterRows(g,{vinto:"no"}),h=g.rows.length+" incontri da disputare";h+="<br>"+g.rows.length+" incontri disputati, "+p.length+" vinti, "+u.length+" persi",$("#limatches").html(h+d),
$("#gara #ulinfogara span").html(getMedaglieGara($a));var m=new Date,f=formatDateTime(m);sdebug("data "+f),$("li.liprog").find("span").html("Aggiornato: "+f)}null!=t.callback&&t.callback()}function refreshSocietaServer(){$("#page_societa #recnum span").html("Caricamento in corso..."),debugga("refreshSocietaServer"),$.ajax({url:rooturl+"/societa/findall",type:"GET"}).done(function(e){if(e.error)toast("errore","long");else{toast("Societa caricate da "+rooturl);var a=$("#lista_societa");a.html("");var t='<li data-role="list-divider" role="heading" data-theme="b">'+e.rows.length+" atleti</li>";a.append(t);var o=new EJS({url:"tpl/societa.ejs"}).render(e.rows);a.empty().append(o),progressStop(),$("#page_societa #recnum span").html(e.rows.length+" societa"),a.find("li").on("tap",function(){var e=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+e),progressStart("Lettura dati"),$.ajax({url:rooturl+"/societa/findall",type:"GET"}).done(function(a){progressStop();var t=a.data.rows[0].doc,o=(createHtmGrid(t),createHtmListview(t));$("#page_societa  #listax_societa").empty().append(o),$("#page_societa #societa").val(e),$.mobile.changePage("#page_societa"),$("#page_societa  #listax_societa").listview()}),!1}),a.find("li").on("taphold",function(){if(loggedin&&"tkdradmin"==role){var e=$(this).find("a").attr("id").split("_")[0],a=$(this).find("a").attr("id").split("_")[1];gConfirm("Confermi l'eliminazione della societa ?","Conferma eliminazione",function(){var t={};t.id=e,t.rev=a,$.ajax({url:rooturl+"/societa/delete",type:"POST",data:t}).done(function(e){e.error?console.log("error"):(console.log("posted"),refreshSocietaServer())}).fail(function(){toast("Error posting","long")})},function(){})}}),a.listview(),a.listview("refresh")}})}function refreshAtletiServer(){debugga("refreshAtletiServer"),app.loadAllSchede(function(e){if(e.error)toast("errore","long");else{toast("Atleti caricati da "+rooturl);var a=$("#lista_atleti");a.html("");var t='<li data-role="list-divider" role="heading" data-theme="b">'+e.rows.length+" atleti</li>";a.append(t);var o=new EJS({url:"tpl/atleti.ejs"}).render(e.rows);a.empty().append(o),progressStop(),$("#page_atleti #recnum span").html(e.rows.length+" atleti in "+settings.mysocietaname),a.find("li").on("tap",function(){var e=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+e),progressStart("Lettura dati"),atleta.loadById(e,function(a){progressStop();var t=a.data.rows[0].doc,o=(createHtmGrid(t),createHtmListview(t));$("#page_atleta  #listax_atleta").empty().append(o),$("#page_atleta #atletaid").val(e),$.mobile.changePage("#page_atleta"),$("#page_atleta  #listax_atleta").listview()}),!1}),a.find("li").on("taphold",function(){if(loggedin&&"tkdradmin"==role){var e=$(this).find("a").attr("id").split("_")[0],a=$(this).find("a").attr("id").split("_")[1];gConfirm("Confermi l'eliminazione dell'atleta ?","Conferma eliminazione",function(){var t={};t.id=e,t.rev=a,$.ajax({url:rooturl+"/atleti/delete",type:"POST",data:t}).done(function(e){e.error?console.log("error"):(console.log("posted"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")})},function(){})}}),a.listview(),a.listview("refresh")}})}function progressStart(e){$.mobile.loading("show",{text:e,textVisible:!0,theme:"b",html:""})}function progressStop(){$.mobile.loading("hide")}function refreshSchede(){var e=$("#liElencoSchede");e.html("");var a='<li data-role="list-divider" role="heading" data-theme="b">'+app.storage.length+" schede</li>";e.append(a);for(var t=0;t<app.storage.length;t++){var o=$("<li data-theme='c'><a href='#' data-transition='slide'>"+app.storage.key(t)+"</a></li>");o.on("tap",function(){scheda.load($(this).text()),$("#txtNome").val(scheda.data.nome),$("#txtIndirizzo").val(scheda.data.indirizzo),$("#txtDescrizione").val(scheda.data.descrizione),$("#txtPrezzo").val(scheda.data.prezzo),$("#scanDiv").html(scheda.data.barcode),""!=$.trim(scheda.data.photoURI)?($("#fotoAnteprima").attr("src",scheda.data.photoURI).css({width:"128px",height:"128px"}),$("#fotoAnteprima").on("tap",function(){$("#fullPhoto").attr("src",scheda.data.photoURI).css({width:"400px",height:"700px"}),$.mobile.changePage("#viewPhoto",{role:"dialog"})})):$("#fotoAnteprima").attr("src","img/nophoto.jpg").css({width:"128px",height:"128px"}),$("#scheda h3").html("Modifica "+boname),$.mobile.changePage("#scheda")}),o.on("taphold",function(){var e=$(this).text();navigator.notification.confirm("Confermi l'eliminazione della scheda?",function(a){1==a&&(scheda.remove(e),$.mobile.changePage("#elencoSchede"))},"Conferma eliminazione","Sì,No")}),e.append(o)}e.listview("refresh")}function alerta(e){isPhone?navigator.notification.alert(e,function(){},"Avviso"):debugga(e)}function debugga(e){colog(e)}function newScheda(){delete scheda.data._id,delete scheda.data._rev,scheda.data.nome="",scheda.data.indirizzo="",scheda.data.descrizione="",scheda.data.prezzo="",scheda.data.coordinate="",scheda.data.photoURI="",scheda.data.barcode="",$("#txtNome").val(""),$("#txtIndirizzo").val(""),$("#txtDescrizione").val(""),$("#txtPrezzo").val(""),$("#scanDiv").html("No code"),$("#fotoAnteprima").attr("src","img/nophoto.jpg").css({width:"128px",height:"128px"}),$("#scheda h3").html("Nuova "+boname),$.mobile.changePage("#scheda")}function toast(e,a){isPhone?window.plugins.toast.show(e,a,"center",function(e){},function(e){}):console.log(e)}function gConfirm(e,a,t,o){isPhone?navigator.notification.confirm(e,function(e){1==e?t():o()},a,"Sì,No"):confirm(e)?t():o()}function importAtleti(){$.ajax({url:rooturl+"/atleti/findall",type:"GET"}).done(function(e){alert(e.length)})}function getNormalD(e){var a=e.substring(6)+e.substring(3,5)+e.substring(0,2);return a}function createPopup(e){var a=$('<a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-right">Close</a>').button(),t=$("<div/>",{"data-role":"popup"}).css({width:$(window).width()/1.5+"px"}).append(a).append(e);$(".ui-page-active").append(t),$("[data-role=popup]").on("popupafterclose",function(){$(this).remove()}).on("popupafteropen",function(){$(this).popup("reposition",{positionTo:"window"})}).popup({dismissible:!1,history:!1,theme:"b",overlayTheme:"b"}).popup("open")}function createHtmGrid(e){var a="<table border=1 width='300'>";for(var t in e)colog(" name="+t+" value="+e[t]),a+="<tr><td>"+t+"</td><td>"+e[t]+"</td></tr>";return a+="</table>"}function createHtmListview(e){var a='<ul data-role="listview">',a="";for(var t in e){colog(" name="+t+" value="+e[t]);var o=e[t];"categoria"==t.toLowerCase()&&(o=getCategoria(e.datanascita,!0).toUpperCase()),a+='<li class="gradient ui-li-static ui-body-inherit"><span class="small">'+t+'</span><br><span class="medium">'+o+"</li>"}return a}function bindGaraPage(){colog("bindaGaraPage"),$(document).on("pageshow","#gara",function(){var e=$(this).data("url");debug("durl: "+e),garaid=parm_garaid,setActiveTab(activeTab),$("#gara #dialogCategorie").popup(),$("#gara #dialogForAtleta").popup(),$("#gara #refresh").on("tap",function(){debug("activetab: "+activeTab)}),$(".tb").remove(),$("#av_toolbar_regdiv").remove(),$("#av_toolbar_iframe").remove(),$("#gara .spancat").on("tap",function(e){sdebug("clicked on categorie");var a=$("#gara ul#ulcategorie");a.listview(),a.listview("refresh"),e.preventDefault();var t=new EJS({url:"tpl/popcategorie.ejs"}).render({});openPopup(t,"Categorie")}),$("#gara .spanfilt").on("tap",function(e){sdebug("clicked on filters");var a=$("#gara ul#ulcategorie");a.listview(),a.listview("refresh"),e.preventDefault();var t=new EJS({url:"tpl/popfilters.ejs"}).render({});openPopup(t,"Filtri"),$("#temppopup #setfilt").button(),$("#temppopup #resetfilt").button(),$("#temppopup td").css("padding","5px"),$("#temppopup").css("padding","5px").css("top","10px !important"),""!=garaFilters.categoria?$("#temppopup #categ").val(garaFilters.categoria):$("#temppopup #categ").val("_"),""!=garaFilters.sesso?$("#temppopup #sex").val(garaFilters.sesso):$("#temppopup #sex").val("_"),""!=garaFilters.medaglia?$("#temppopup #medag").val(garaFilters.medaglia):$("#temppopup #medag").val("_"),""!=garaFilters.quadrato?$("#temppopup #quadrato").val(garaFilters.quadrato):$("#temppopup #quadrato").val("_")}),$("#gara #ulcategorie li").on("vclick",function(){var e=$(this).text();viewcat=e.toLowerCase();var a=e.toLowerCase();"tutte"==viewcat.toLowerCase()&&(viewcat=""),cat=viewcat,document.cookie="cookiecat="+viewcat+"; expires=Thu, 18 Dec 2023 12:00:00 UTC",$("#dialogCategorie").popup("close"),a.indexOf("esordienti")>-1&&(a=a.replace("esordienti","eso")),a.indexOf("cadetti")>-1&&(a=a.replace("cadetti","cad")),a.indexOf("junior")>-1&&(a=a.replace("junior","jun")),a.indexOf("senior")>-1&&(a=a.replace("senior","sen")),$(".spancat").text(cattxt+a.toUpperCase()),refreshCurrentGara()}),$("#gara #listabyprog li").on("vclick",function(){var e=$(this).attr("id"),e=e.replace("prog","")}),$("#gara #navbar ul li").on("vclick",function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var t=$(this).find("a").attr("data-tab-class");$("#gara .ul"+t).show(),activeTab=e}),$("#gara #bubble").on("vclick",function(){if(notifyseen=!0,notifycount=0,nonletti=0,$("#gara .nonvisto").removeClass("nonvisto"),$("#gara #bubble").html("0").hide(),cronaca.rows.length>0){setCookie("lastcronaca",cronaca.rows[0].time);var e=getCookie("cronacaletti_"+jcurrentgara.id);e||(e=""),$(cronaca.rows).each(function(a){var t=cronaca.rows[a];""!=e.trim()&&(e+=","),e+=t.time}),setCookie("cronacaletti_"+jcurrentgara.id,e)}$("#gara a#tab_cronaca").trigger("click")}),$("#gara #panelright").on("tap",function(){$(this).panel("close")}),anninascita="",cat="",searchgara="",""!=$.trim(cat)&&(debug("viewing category: "+cat),viewcat=cat);var a=getCookie("cookiecat");""!=$.trim(a)&&(viewcat=a);var t="";""==$.trim(t)&&(t="tutte"),t.indexOf("esordienti")>-1&&(t=t.replace("esordienti","eso")),t.indexOf("cadetti")>-1&&(t=t.replace("cadetti","cad")),t.indexOf("junior")>-1&&(t=t.replace("junior","jun")),t.indexOf("senior")>-1&&(t=t.replace("senior","sen")),t=t.toUpperCase(),$("#gara .spancat").text(cattxt+t),debug("cookiecat: "+a),""==$.trim(garaid)&&""==$.trim(searchgara)&&(searchgara="corna"),showMsg&&$("#msgBar").show()})}function setCategoria(e){var a=$(e).text();viewcat=a.toLowerCase();var t=a.toLowerCase();"tutte"==viewcat.toLowerCase()&&(viewcat=""),cat=viewcat,document.cookie="cookiecat="+viewcat+"; expires=Thu, 18 Dec 2023 12:00:00 UTC",$("#dialogCategorie").popup("close"),t.indexOf("esordienti")>-1&&(t=t.replace("esordienti","eso")),t.indexOf("cadetti")>-1&&(t=t.replace("cadetti","cad")),t.indexOf("junior")>-1&&(t=t.replace("junior","jun")),t.indexOf("senior")>-1&&(t=t.replace("senior","sen")),$(".spancat").text(cattxt+t.toUpperCase()),refreshCurrentGara(),popCloseRemove()}function sdebug(e){debugga(e)}function debug(e){debugga(e)}function getCookie(e){for(var a=e+"=",t=document.cookie.split(";"),o=0;o<t.length;o++){for(var i=t[o];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(a))return i.substring(a.length,i.length)}return""}function filterIscritti(e){var a=[],t=!1;$(e).each(function(o){var i=getAtletaById(e[o]),r=i.datanascita,n=getCategoria(r),s=i.sesso,c=!0;""==e[o].trim()&&(c=c&&!1);for(f in garaFilters)""!=garaFilters[f]&&(t=!0,"sesso"==f&&s.toLowerCase().trim()!=garaFilters[f].toLowerCase().trim()&&(c=c&&!1),"categoria"==f&&(garaFilters[f].toLowerCase().trim().indexOf("senior")>-1?-1==n.toLowerCase().trim().indexOf("senior")&&(c=c&&!1):n.toLowerCase().trim()!=garaFilters[f].toLowerCase().trim()&&(c=c&&!1)));t?c&&a.push(e[o]):c&&a.push(e[o])});a.length;return a}function refreshGara(e,a){var t={callback:null};$.extend(t,a),refreshCronaca(),oldupdatetext=$("#gara #ulinfogara li span.left").html(),$("#gara #ulinfogara li span.left").html("Aggiornamento...");colog("gara: "+JSON.stringify($gara));var o=$gara;$("#gara #hdr").find("#hgara a").html(o.doc.location+" -     "+o.doc.data+" - "+settings.mysocietaname),$("#hdriscritti").find("h1").html(o.doc.title+" "+o.doc.location+" -     "+o.doc.data);var i=o.doc.iscritti.split(","),r=filterIscritti(i),n=r.length;$("#ligaratitle").html("Gara: <b>"+o.doc.title+"</b>"),$("#ligaralocation").html("Location: "+o.doc.location),$("#liiscritti").text(n+" atleti iscritti "),datagara=o.doc.data;var s=datagara.split("/");annogara=s[2];new Date}function getMaschiFemmine(e,a){colog("getmaschifemmine"),colog(jcurrentgara.iscritti);var t=(jcurrentgara.iscritti.split(","),0),o=0;$(e).each(function(i){var r;r=getAtletaById("iscritti"==a?e[i]:e[i].doc.atletaid);var n="M";r.sesso&&(n=r.sesso.toUpperCase()),"M"==n&&t++,"F"==n&&o++});var i={maschi:t,femmine:o};return i}function refreshCronaca(){}function getMedaglieGara(e){var a=0,t=0,o=0;$(e.rows).each(function(i){var r=e.rows[i].doc,n=(r.garaid,r.datanascita,$.trim(r.medagliamatch)),s=!0;s&&("oro"==$.trim(n)&&a++,"argento"==$.trim(n)&&t++,"bronzo"==$.trim(n)&&o++)});var i="<span style='color: yellow;'>ORI: <b>"+a+"</b></span>&nbsp;&nbsp;&nbsp;<span style='color: silver;'>ARG: <b>"+t+"</b></span>&nbsp;&nbsp;&nbsp;<span style='color: orange;'>BRO: <b>"+o+"</b></span>";return i}function getCategoria(e,a){var t="senior a",o=(new Date).getFullYear();if(1!=a){var i=jcurrentgara.data.split("/"),r=i[2];o=r}if(""==$.trim(e))return"senior b";var n=e.split("."),s=n[2],c=parseInt(o,10)-parseInt(s,10);return c>=18&&35>=c&&(t="senior a"),c>=15&&17>=c&&(t="junior"),c>=12&&14>=c&&(t="cadetti a"),c>=10&&11>=c&&(t="cadetti b"),c>35&&(t="senior b"),10>c&&(t="esordienti"),t}function showIscritti(){refreshIscritti(),$.mobile.changePage("#iscrittiPage")}function getMatchesCountForAtleta(e){colog("getmatchescount for atleta "+e),colog($allmatches);var a=0;return $($allmatches.rows).each(function(t){var o=$allmatches.rows[t].doc.atletaid;o==e&&a++}),a}function refreshIscritti(e){e||(e=!1);var a="";jcurrentgara.myiscritti&&(a=jcurrentgara.myiscritti),colog("iscritti: "+a);var t=a.split(","),o=filterIscritti(t),i="",r=[];if($(o).each(function(e){var a=getAtletaById(o[e]),t={};t.nome=a.cognome+" "+a.nome,t.id=a.id,t.sesso=a.sesso,t.categoria=getCategoria(a.datanascita),r.push(t)}),r.sort(function(e,a){var t=e.nome.trim(),o=a.nome.trim();return t>o?1:o>t?-1:0}),1==e)return r;var i=new EJS({url:"tpl/iscritti.ejs"}).render(r),n=$("#iscrittiPage #uliscritti");n.empty(),n.append(i),n.listview(),n.listview("refresh"),$("#iscrittiPage #infogaraiscritti").html(r.length+" iscritti")}function getAtletaById(e,a){var t="";return $($atleti.rows).each(function(a){var o=$atleti.rows[a].doc,i=o.id;o.cognome,o.nome;return i==e?t=o:void 0}),t}function showMatchesForAtleta(e){var a=[],t=getAtletaById(e);selectedAtl=t,$($allmatches.rows).each(function(t){var o=$allmatches.rows[t],i=o.doc.atletaid;i==e&&a.push(o)}),a.sort(function(e,a){var t=e.doc.progid,o=a.doc.progid;return t>o?1:o>t?-1:0});var o=new EJS({url:"tpl/matchesforatleta.ejs"}).render(a),i=$("#matchesatleta #listampa");i.empty(),i.append(o),$(document).off("taphold","#matchesatleta ul#listampa li"),$(document).on("taphold","#matchesatleta ul#listampa li",function(e){if("tkdradmin"==role&&loggedin){$(this).addClass("tapped");var a=$(this).attr("id").replace("match_","");delmatchid=a,"disputata"!=jcurrentgara.stato&&$("#popDelMatch").popup("open")}}),$("#matchesatleta #mparecnum").html(a.length+" incontri per "+t.cognome+" "+t.nome)}function sysMsg(e){var a=$.mobile.activePage.attr("id"),t="";if(e&&(t=e),loggedin&&"tkdradmin"==role){var o={destsocket:t},i=new EJS({url:"tpl/sysmsg.ejs"}).render(o);$("#"+a+" div[data-role=content]").append(i),$("#"+a+" #popSysMsg #dest").val(t),$("#"+a+" #popSysMsg").popup(),$("#"+a+" #popSysMsg").popup("open")}}function sysMsgOk(){var e=$.mobile.activePage.attr("id"),a=$("#"+e+" #popSysMsg #tamsg").val(),t=$("#"+e+" #popSysMsg #dest").val();if(""==a.trim())return void $("#gara #popSysMsg").popup("close").remove();var o="all";""!=t.trim()&&(o=t),socketNotify({type:"notification",to:o,text:a}),$("#"+e+" #popSysMsg").popup("close").remove()}function sysMsgCancel(){var e=$.mobile.activePage.attr("id");$("#"+e+" #popSysMsg").popup("close").remove()}function popGareOk(){$("#gare #popGare").popup("close").remove()}function popGareCancel(){$("#gare #popGare").popup("close").remove()}function setResult(e){if(loggedin&&"tkdradmin"==role){var a=jcurrentgara.stato,t=!1;if("disputata"==a&&(t=!0),!t){sdebug("setresult");var o=$(e).closest("li");o.addClass("liselected");var i=o.attr("id").replace("match_","");sdebug("clicked matchid: "+i),selectedid=i,selectedmatchid=o.attr("tkdr-matchid"),$("#popResult #risult").val(""),$("#popResult #checkgp").prop("checked",!1).checkboxradio("refresh"),$("#popResult").popup("open")}}}function setResultById(e,a){if(loggedin&&"tkdradmin"==role){var t=jcurrentgara.stato,o=filterRows($allmatches,{id:e}),i=!1;if(0==o.rows.length&&(i=!0),"disputata"==t&&(i=!0),!i){colog("setresultbyid "+e),colog(o),sdebug("setting result2 for matchid: "+e),selectedid=e,selectedmatchid=o.rows[0].doc.matchid,$("#popResult #risult").val(a.risultato);var r=!1;a.goldenpoint&&"yes"==a.glodenpoint&&(r=!0),$("#popResult #checkgp").prop("checked",r).checkboxradio("refresh")}}}function setResultCancel(){$("ul#listampa li").removeClass("liselected"),$("#popResult").popup("close"),selectedid="",selectedmatchid=""}function setResultOK(){var e=!0;progressStart("Aggiornamento..","Aggiornamento");var a="",t="",o=new Array("primo","secondo","terzo","quarto","quinto","sesto","settimo","ottavo","nono","decimo"),i=new Array("finale","semifinale","quarto di finale","ottavo di finale","sedicesimo di finale","trentaduesimo di finale"),r=$("#popResult #risult").val(),n=$("#popResult #checkgp").prop("checked"),s=selectedid,c=selectedAtl.cognome+" "+selectedAtl.nome,l=getCategoria(selectedAtl.datanascita),d=(selectedAtl.cognome+" "+selectedAtl.nome,$("input:radio[name=radio-choice-0]:checked").val()),g="updagent.php?action=edit&tag=match",p="/matches/update/"+jcurrentgara.id+"/"+s,u=$("#matchesatleta ul#listampa li").length,h=$("#matchesatleta ul#listampa li#match_"+s).index(),m=u-h-1,f=m-1,v="",b="",w="",y="none",k="vince";if("nondisputato"==d)v="no",w="yes",b="no",y="none",e=!1;else{"vinto"==d&&(v="yes",k="vince"),"perso"==d&&(v="no",k="perde"),b="yes",w="yes";var S=selectedmatchid,C="";1==u&&(C=" e unico ");var x="";4>m&&(x=", "+i[m]),a+=c+" "+k+" il suo "+o[h]+" "+C+"incontro (n."+S+x+") ",""!=$.trim(r)&&(a+=" per "+r),n&&(a+=" al golden point ");var P="";2>f&&(P=" !!"),f>-1&&"yes"==v&&(a+=" e va in "+i[f]+P+". ")}var _={vinto:v,disputato:b,dadisputare:w};g+="&id="+s,g+="&garaid="+garaid,g+="&vinto="+v,g+="&disputato="+b,g+="&dadisputare="+w,""!=$.trim(r)&&(g+="&risultato="+r,_.risultato=r),sdebug("ln: "+u),sdebug("ord: "+h),parseInt(h,10)==parseInt(u,10)-1&&("yes"==b?("no"==v&&(y="argento"),"yes"==v&&(y="oro")):y="none"),parseInt(h,10)==parseInt(u,10)-2&&("yes"==b?"no"==v&&(y="bronzo"):y="none"),"none"!=y&&(a+=". E' "+y.toUpperCase()+" !"),g+="&medagliamatch="+y,_.medagliamatch=y;var j=0;$("#matchesatleta ul#listampa li").each(function(e){var a=$(this).attr("id").replace("match_",""),o="updagent.php?action=edit&tag=match&garaid="+garaid+"&id="+a,i={};if(h>e&&(sdebug("gara precedente "+e),"yes"==b&&(o+="&disputato=yes&vinto=yes&dadisputare=yes&medagliamatch=none",i.disputato="yes",i.vinto="yes",i.dadisputare="yes",i.medagliamatch="none"),sdebug(o),o="/matches/update/"+jcurrentgara.id+"/"+a,$.ajax({type:"POST",url:rooturl+o,data:i,async:!1})),e>h){if(sdebug("gara successiva "+e),j++,1==j){var r=getDerby(a,l);$(r.rows).each(function(e){colog("derby con "+r.rows[e].doc.atletaname),t=" .Sarà derby con "+r.rows[e].doc.atletaname+" al "+r.rows[e].doc.matchid+" ! ";var o=r.rows[e].doc.id,i="/matches/update/"+jcurrentgara.id+"/"+o;"yes"==v?($.ajax({type:"POST",url:rooturl+i,data:{derby:a},async:!1}),i="/matches/update/"+jcurrentgara.id+"/"+a,$.ajax({type:"POST",url:rooturl+i,data:{derby:o},async:!1})):(t="",$.ajax({type:"POST",url:rooturl+i,data:{derby:null},async:!1}),i="/matches/update/"+jcurrentgara.id+"/"+a,$.ajax({type:"POST",url:rooturl+i,data:{derby:null},async:!1}))}),j=0}"yes"==b&&("yes"==v&&(o+="&disputato=no&vinto=no&dadisputare=yes&medagliamatch=none",i.disputato="no",i.vinto="no",i.dadisputare="yes",i.medagliamatch="none"),"no"==v&&(o+="&disputato=no&vinto=no&dadisputare=no&medagliamatch=none",i.disputato="no",i.vinto="no",i.dadisputare="no",i.medagliamatch="none")),"no"==b&&(o+="&disputato=no&vinto=no&dadisputare=yes&medagliamatch=none",i.disputato="no",i.vinto="no",i.dadisputare="yes",i.medagliamatch="none"),o="/matches/update/"+jcurrentgara.id+"/"+a,sdebug(o),$.ajax({type:"POST",url:rooturl+o,data:i,async:!1})}}),a+=t;var M="savecronaca.php?garaid="+garaid+"&text="+encodeURI(a);M="/matches/addcronaca/"+jcurrentgara.id,$.post(rooturl+p,_,function(){$("#popResult").popup("close");$("ul#listampa li.liselected").find("input:hidden.atletaid").val();$("#matchesatleta ul#listampa li").removeClass("liselected");var t=getCookie("notifiche_atleta");t&&""!=t.trim()&&t.indexOf(selectedAtl.id.trim())>-1,e&&socketNotify({type:"notification",to:"all",text:a,garaid:jcurrentgara.id,updategara:"yes"}),$.ajax({type:"POST",url:rooturl+M,async:!1,data:{text:a}},function(){loadCronaca()}),refreshMatches(function(){showMatchesForAtleta(selectedAtl.id),progressStop()})})}function getDerby(e,a){colog("getDerby for matchid "+e+" in category "+a);var t={rows:[]},o={rows:[]};colog("allmatches"),colog($allmatches);var i=filterRows($allmatches,{id:e}),r=i.rows[0].doc.matchid,n=i.rows[0].doc.datanascita,s=getCategoria(n),c=filterRows($allmatches,{matchid:r,dadisputare:"yes",disputato:"no"});return colog("incontri con matchid="+r+": "+c.rows.length+" in categoria "+s),$(c.rows).each(function(t){var i=c.rows[t],n=i.doc.id;if(n!=e){var s=getCategoria(i.doc.datanascita),l=!0;s.trim().toLowerCase()!=a.trim().toLowerCase()&&(l=!1,colog("match "+r+" in category "+s+" ignored, searching for category "+a)),l&&o.rows.push(i)}}),$(o.rows).each(function(e){var a=o.rows[e],i=a.doc.atletaname,n=a.doc.atletaid,s=filterRows($allmatches,{atletaid:n});s.rows.sort(function(e,a){var t=e.doc.matchid,o=a.doc.matchid;return t>o?1:o>t?-1:0});var c=0;colog("analisi incontri di "+i),$(s.rows).each(function(e){var a=s.rows[e],o=a.doc.matchid,i=a.doc.disputato,n=a.doc.dadisputare,l=!1;"no"==i&&"yes"==n&&(c++,l=!0),colog("matchid "+o+" - eligible: "+l),o==r&&1==c&&(t.rows.push(a),colog("è il primo prossimo incontro, DERBY OK"))})}),colog("Derby trovati per match id "+e+": "+t.rows.length),t}function addMatch(){$("#popAddMatch").popup("open")}function addMatchCancel(){$("#popAddMatch").popup("close")}function refreshMatches(e){colog("RefreshMatches"),$("#gara .medals").html(caricamentotext),mf={maschi:"0",femmine:"0"},loadMatchesByProg(jcurrentgara.id,{callback:function(){progressStop(),e&&e()}}),loadMatchesByAtleta(jcurrentgara.id),loadCronaca(jcurrentgara.id),autorefresh&&setMatchesRefresh()}function addMatchOK(){var e=$("#matchid"),a=Right(e.val(),2),t=selectedAtl.datanascita,o=selectedAtl.cognome+" "+selectedAtl.nome,i=selectedAtl.id,r={progid:a,societaid:settings.mysocieta,societaname:settings.mysocietaname,garaid:jcurrentgara.id,atletaid:i,atletaname:o,risultato:"",ordine:"1",vinto:"no",disputato:"no",dadisputare:"yes",matchid:e.val().toUpperCase().trim(),lastupdate:"never",datanascita:t};$.ajax({url:rooturl+"/matches/add/"+jcurrentgara.id,type:"POST",data:r}).done(function(e){e.error?console.log("error"):(console.log("posted"),$(e.addedmatches.rows).each(function(a){var t=e.addedmatches.rows[a],o=t.doc.id,i=getCategoria(t.doc.datanascita);colog("derbies"),colog("$allmatches"),colog($allmatches),$allmatches.rows.push(t);var r=getDerby(o,i);if(colog(r),r.rows.length>0&&$allmatches.rows.length>0){var n=r.rows[0].doc.id,s="/matches/update/"+jcurrentgara.id+"/"+o;$.ajax({type:"POST",url:rooturl+s,data:{derby:n},async:!1}),s="/matches/update/"+jcurrentgara.id+"/"+n,$.ajax({type:"POST",url:rooturl+s,data:{derby:o},async:!1})}}),toast("Match "+r.matchid+" added for atleta "+selectedAtl.cognome+" "+selectedAtl.nome),refreshMatches(function(){$("#popAddMatch").popup("close"),showMatchesForAtleta(selectedAtl.id)}))}).fail(function(){toast("Error posting","long")})}function test(){var e=filterRows($allmatches,{vinto:"yes",datanascita:".2003"}),a=new EJS({url:"tpl/matchesbyprog.ejs"}).render(e.rows),t="listabyprog",o=$("ul#"+t);o.empty(),o.append(a),o.listview(),o.listview("refresh"),$("#limatches").html($matches.rows.length+" incontri"),$("#gara #ulinfogara span").html(getMedaglieGara($matches))}function filterAndRender(e){colog("filterandrender "+JSON.stringify(e));var a=filterRows($allmatches,e),t=new EJS({url:"tpl/matchesbyprog.ejs"}).render(a.rows),o="listabyprog",i=$("ul#"+o);i.empty(),i.append(t),i.listview(),i.listview("refresh");var r=filterRows(a,{dadisputare:"yes"}),n=(filterRows(r,{disputato:"yes"}),filterRows(r,{vinto:"yes"})),s=filterRows(r,{vinto:"no"}),c=r.rows.length+" incontri da disputare";c+="<br>"+r.rows.length+" incontri disputati, "+n.length+" vinti, "+s.length+" persi",$("#limatches").html(c),$("#gara #ulinfogara span").html(getMedaglieGara(a))}function filterRows(e,a,t){t||(t=!1),colog("filterrows: ");var o={rows:[]},i=e.rows;return $(i).each(function(e){var r=i[e],n=!0;for(var s in r.doc)for(var c in a)if(c==s){var l=a[c].toLowerCase();if(""!=l.trim()){var d=r.doc[s].toLowerCase();t?d.trim()==l.trim()||(n=n&&!1):d.indexOf(l)>-1||(n=n&&!1)}}n&&o.rows.push(r)}),o}function searchMatches(){var e=[],a=0,t=0,o=0,i=0,r=0,n=0,s=0,c="M";c=$("#searchMatches #sex").val();var l=$("#searchMatches #categ").val(),d=$("#searchMatches #medag").val(),g="";$("#searchMatches #quadrato").val()&&(g=$("#searchMatches #quadrato").val().trim()),g||(g=""),"_"==g&&(g="");var p=[{name:"sesso",value:c},{name:"categoria",value:l},{name:"medagliamatch",value:d}],u={rows:[]};$($allmatches.rows).each(function(e){var a=$allmatches.rows[e].doc,t=a.atletaid,o=getAtletaById(t),i={};a.sesso=o.sesso,a.categoria=getCategoria(o.datanascita),i=a,u.rows.push(i)}),$(u.rows).each(function(a){var t=u.rows[a],o=!0;$(p).each(function(e){var a=p[e];if(t[a.name]){var i=t[a.name].toLowerCase(),r="";null!=a.value&&(r=a.value.toLowerCase());var n=!0;""==r.trim()&&(n=!1),"_"==r.trim()&&(n=!1),n&&-1==i.indexOf(r)&&(o=!1)}else o=!1});getAtletaById(t.atletaid);if(o)if(""!=g.trim()){var i=t.matchid.trim(),r=i.substring(0,i.length-2).trim();r==g&&e.push(t)}else e.push(t)});var h="";$(e).each(function(c){var l=e[c].disputato,d=e[c].dadisputare,g=e[c].vinto,p="",u="",m="blacknormal";"yes"==d.toLowerCase().trim()?(m="blacknormal","yes"==l.toLowerCase().trim()&&(p="<b>",u="</b>",m="yes"==g.toLowerCase().trim()?"green":"red")):m="black",h+="<li class='"+m+"'><span class='"+m+"'>"+p+e[c].atletaname+" - "+e[c].matchid+u+"</span></li>","yes"==e[c].disputato?("yes"==e[c].vinto?a++:t++,o++,"oro"==e[c].medagliamatch&&r++,"argento"==e[c].medagliamatch&&n++,"bronzo"==e[c].medagliamatch&&s++):i++});var m="";m+="<b>totale incontri trovati: "+e.length+"</b><br>",m+="disputati: "+o+"<br>",m+="vinti: "+a+"<br>",m+="persi: "+t+"<br>",m+="non disputati: "+i+"<br>",m+="ori: "+r+"<br>",m+="argenti: "+n+"<br>",m+="bronzi: "+s+"<br><br><br>",$("#searchMatches #searchResults").empty().html(m),$("#searchMatches #searchlist").empty(),$("#searchMatches #searchlist").append(h),$("#searchMatches #searchlist").listview(),$("#searchMatches #searchlist").listview("refresh")}function addGara(){console.log("addgara"),$.mobile.changePage("#page_addgara")}function addSocieta(){console.log("addsocieta"),$.mobile.changePage("#page_addsocieta")}function addAtleta(){console.log("addatleta"),$("#page_addatleta").find("#societaid").val(settings.mysocieta),getSocietaById(settings.mysocieta,function(e){e.rows.length>0&&$("#page_addatleta").find("#societa").html("Società: <b>"+e.rows[0].doc.nome.toUpperCase()+"</b>"),$.mobile.changePage("#page_addatleta")})}function addAtletaOk(e){var a=$(e).closest("div[data-role=page]"),t={},o=checkValidAtletaForm(a);return 1==o.error?void alert("Errore di inserimento:\n\n"+o.errors):(a.find(".jform").each(function(){var e=$(this).attr("id");t[e]=$(this).val()}),void $.ajax({url:rooturl+"/atleti/add",type:"POST",data:t}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_atleti"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")}))}function addSocietaOk(e){var a=$(e).closest("div[data-role=page]"),t={};a.find(".jform").each(function(){var e=$(this).attr("id");t[e]=$(this).val()}),$.ajax({url:rooturl+"/societa/add",type:"POST",data:t}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_societa"),refreshSocietaServer())}).fail(function(){toast("Error posting","long")})}function addGaraOk(e){var a=$(e).closest("div[data-role=page]"),t=checkValidGaraForm(a);if(1==t.error)return void alert("Errore di inserimento:\n\n"+t.errors);var o={};a.find(".jform").each(function(){var e=$(this).attr("id");o[e]=$(this).val()}),$.ajax({url:rooturl+"/gare/add",type:"POST",data:o}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#gare"),refreshGareServer())}).fail(function(){toast("Error posting","long")})}function editAtleta(e){console.log("editatleta");var a=$(e).closest("div[data-role=page]"),t=a.find("#atletaid"),o=t.val();colog("Editing atletaid "+o);var i=getAtletaById(o);$("#page_editatleta").find(".jform").each(function(){var e=$(this).attr("id");colog("campo "+e+" - "+i[e]),$(this).val(i[e])}),$("#page_editatleta").find("#atletaid").val(o),$("#page_editatleta").find("#societaid").val(settings.mysocieta),getSocietaById(settings.mysocieta,function(e){e.rows.length>0&&$("#page_editatleta").find("#societa").html("Società: "+e.rows[0].doc.nome.toUpperCase()),$.mobile.changePage("#page_editatleta")})}function checkValidGaraForm(e){var a="",t=!1,o="",i="location,title,data,stato",r=i.split(",");$(r).each(function(o){var i=e.find("#"+r[o]).val();""==i.trim()&&(t=!0,a+="- il campo "+r[o]+" non può essere vuoto\n")}),o=e.find("#data").val();var r=o.split("/");3!=r.length&&(t=!0,a+="- la data deve essere nel formato gg/mm/aaaa\n"),o=e.find("#stato").val();var n="nondisputata,disputata,incorso",s=!1,c=n.split(",");$(c).each(function(e){c[e]==o&&(s=!0)}),s||(t=!0,a+="- stato invalido, stati validi sono nondisputata,disputata,incorso\n");var l={error:t,errors:a};return l}function checkValidAtletaForm(e){var a="",t=!1,o="";o=e.find("#nome").val(),""==o.trim()&&(t=!0,a+="- il nome non può essere vuoto\n"),o=e.find("#cognome").val(),""==o.trim()&&(t=!0,a+="- il cognome non può essere vuoto\n"),o=e.find("#datanascita").val();var i=o.split(".");3!=i.length&&(t=!0,a+="- la data di nascita deve essere nel formato gg.mm.aaaa\n");var r={error:t,errors:a};return r}function editAtletaOk(e){var a=$(e).closest("div[data-role=page]"),t=a.find("#atletaid").val(),o={},i=checkValidAtletaForm(a);return 1==i.error?void alert("Errore di inserimento:\n\n"+i.errors):(a.find(".jform").each(function(){var e=$(this).attr("id");o[e]=$(this).val()}),void $.ajax({url:rooturl+"/atleti/update/"+t,type:"POST",data:o}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_atleti"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")}))}function getAllAtleti(e){$.ajax({type:"GET",url:rooturl+"/atleti/findall/",success:function(a){e(a)}})}function addIscritto(){var e=[];jcurrentgara.iscritti;progressStart(),getAllAtleti(function(a){$(a.rows).each(function(t){var o=a.rows[t];o.doc.id.trim();e.push(o);
}),e.sort(function(e,a){var t=e.doc.cognome.trim(),o=a.doc.cognome.trim();return t>o?1:o>t?-1:0}),progressStop();var t=new EJS({url:"tpl/selectiscritti.ejs"}).render(e);$("#selectIscrittiPage #selectiscr").empty().append(t),$.mobile.changePage("#selectIscrittiPage")})}function addIscrittiOk(){var e="";$("#selectIscrittiPage :checkbox:checked").each(function(a){var t=$(this).val();""!=e.trim()&&(e+=","),e+=t}),jcurrentgara.iscritti=e;var a={};a.id=jcurrentgara.id,a.iscritti=e,$.ajax({url:rooturl+"/gare/update",type:"POST",data:a}).done(function(e){e.error?toast("error"):(console.log("posted"),showIscritti())}).fail(function(){toast("Error posting update","long")})}function saveOptions(){rooturl=$("#optionsPage #server").val();var e=$("#optionsPage #ckNotifiche").prop("checked"),a=$("#optionsPage #societaid").val(),t=$("#optionsPage #societaid option:selected").text(),o={server:rooturl,notifiche:e,mysocieta:a,mysocietaname:t};setCookie("options",JSON.stringify(o)),settings=o,$(".serverspan").html("Server: "+rooturl),refreshAtletiServer(),refreshGareServer(),refreshNews(function(e){}),$.mobile.changePage("#index"),updateHomeInfos()}function setServer(e){$("#optionsPage #server").val(e)}function getSocieta(e){$.ajax({type:"GET",url:rooturl+"/societa/findall/",success:function(a){e(a)}})}function getSocietaById(e,a){$.ajax({type:"GET",url:rooturl+"/societa/findbyid/"+e,success:function(e){a(e)}})}function loadOptions(e){var a={server:rooturl,notifiche:!0,mysocieta:"20160217220400",mysocietaname:"ASD TAEKWONDO ROZZANO"};settings=a,getSocieta(function(t){var o=new EJS({url:"tpl/selectsocieta.ejs"}).render(t.rows);$("#optionsPage #societaid").empty().append(o);var i=getCookie("options");if(null==i)setCookie("options",JSON.stringify(a)),settings=a;else{var r=JSON.parse(i);r.server||(r.server=a.server),r.notifiche||(r.notifiche=a.notifiche),r.mysocieta||(r.mysocieta=a.mysocieta),r.mysocietaname||(r.mysocietaname=a.mysocietaname),$("#optionsPage #server").val(r.server),$("#optionsPage #ckNotifiche").prop("checked",r.notifiche),$("#optionsPage #societaid").val(r.mysocieta),settings=r}e()})}function delMatch(){var e=delmatchid;gConfirm("Sei sicuro di voler cancellare l'incontro ?","Conferma",function(){colog("deleting matchid "+e);var a="updagent.php?action=delete&tag=match";$($allmatches.rows).each(function(a){var t=$allmatches.rows[a].doc.id,o=$allmatches.rows[a].doc;if(t.trim()==e.trim()&&o.derby&&""!=o.derby.trim()){var i=o.derby,r="/matches/update/"+jcurrentgara.id+"/"+i;$.ajax({type:"POST",url:rooturl+r,data:{derby:null},async:!1}),colog("resetted derby flag on matchid "+i)}}),a+="&id="+e,a+="&garaid="+garaid,a="/matches/delete/"+jcurrentgara.id+"/"+e,$.post(rooturl+a,{a:"1"},function(){delmatchid="",refreshMatches(function(){$("#matchesatleta #popDelMatch").popup("close"),showMatchesForAtleta(selectedAtl.id)})})},function(){cancelDelMatch()})}function cancelDelMatch(){$("#matchesatleta #popDelMatch").popup("close")}function getCookie(e){var a;if(colog("isPhone: "+isPhone),isPhone){var t=window.localStorage;colog("storage: "+t),a=t.getItem(e)}else{a=document.cookie;var o=a.indexOf(" "+e+"=");if(-1==o&&(o=a.indexOf(e+"=")),-1==o)a=null;else{o=a.indexOf("=",o)+1;var i=a.indexOf(";",o);-1==i&&(i=a.length),a=unescape(a.substring(o,i))}}return a}function setCookie(e,a,t){if(isPhone){var o=window.localStorage;o.setItem(e,a)}else{var i=new Date;i.setDate(i.getDate()+t);var r=escape(a)+(null==t?"":"; expires="+i.toUTCString());document.cookie=e+"="+r}}function autoLogin(){var e=getCookie("email"),a=getCookie("psw"),t=getCookie("autologin");colog("autologin cookie: "+t),t&&"true"==t&&(e&&a?($("#login #txt-email").val(e),$("#login #txt-password").val(a),doLogin()):toast("Login automatico fallito"))}function showLoginPage(){var e=getCookie("email"),a=getCookie("psw"),t=getCookie("autologin");e&&a?($("#login #txt-email").val(e),$("#login #txt-password").val(a)):($("#login #txt-email").val(""),$("#login #txt-password").val("")),t?$("#login #chck-autologin").attr("data-cacheval","false"):$("#login #chck-autologin").attr("data-cacheval","true"),$.mobile.changePage("#login")}function gotoSocieta(){$.mobile.changePage("#page_societa"),refreshSocietaServer()}function doLogout(){gConfirm("Sei sicuro di volerti scollegare ?","Log out",function(){loggedin=!1,$("#index #lilogin").show(),$("#index #liatleti").hide(),$("#index #lisockets").hide(),$("#gare #liaggiungigara").hide(),$("#gara #liresetcronaca").hide(),$("#gara #lisysmsg").hide(),$("#page_atleti #liaggiungiatleta").hide(),$("#matchesatleta #actionpanela").hide(),$("#iscrittiPage #btnAddIscritto").hide(),$("#gare #test").hide(),$("#index .loginspan").html(""),$(".showadmin").hide(),$.mobile.changePage("#index_fb")},function(){})}function showNotifications(){var e=jcurrentgara.iscritti;colog("iscritti: "+e);var a=e.split(",");""==e.trim()&&(a=[]);var t=[];$(a).each(function(e){var o=getAtletaById(a[e]),i={};i.nome=o.cognome+" "+o.nome,i.id=o.id,t.push(i)}),t.sort(function(e,a){var t=e.nome.trim(),o=a.nome.trim();return t>o?1:o>t?-1:0}),html=new EJS({url:"tpl/selectnotifiche.ejs"}).render(t),$("#page_notifiche #ulatleti").empty().append(html),$.mobile.changePage("#page_notifiche")}function setNotificheOk(){var e="";$("#page_notifiche :checkbox:checked").each(function(a){var t=$(this).val();colog(t),""!=e.trim()&&(e+=","),e+=t}),setCookie("notifiche_atleta",e),$.mobile.changePage("#gara")}function notify(e){if(isPhone){notcount++,notcount>3&&(notcount=1);cordova.plugins.notification.local.schedule({id:1,text:e,title:"AppKwonDo",icon:"file://img/logotkdrozzano_icon.png"})}else console.log("Notification: "+e)}function pushSuccessHandler(e){var a="Push Callback Success! Result = "+e;console.log(a)}function pushErrorHandler(e){console.log("pushError: "+e)}function onNotificationGCM(e){switch(console.log("onNotificationGCM"),e.event){case"registered":e.regid.length>0&&(console.log("Regid "+e.regid),toast("Registered on GCM"),cordova.plugins.notification.local.on("click",function(e){toast("clicked notification"),$("#dialogNotifiche #content").empty.html(e.text),$.mobile.changePage("#dialogNotifiche",{role:"dialog"})}));break;case"message":notify(e.message);break;case"error":console.log("GCM error "+e.msg);break;default:console.log("An unknown GCM event has occurred")}}function sendGCM(e){console.log("sendGCM: "+e);var a={};a.message=e,a.title="AppKwonDo",a.msgcnt="3",a.soundname="beep.wav",$.ajax({url:rooturl+"/matches/notify",type:"POST",data:a}).done(function(e){e.error?(colog("error posting notification"),toast("error")):colog("posted GCM notification")}).fail(function(){toast("Error posting GCM push","long")})}function resetCronaca(){var e=jcurrentgara.id;gConfirm("Vuoi veramente resettare la cronaca per questa gara ?","conferma",function(){$.ajax({type:"GET",url:rooturl+"/gare/resetcronaca/"+e,success:function(e){toast("Cronaca resettata"),refreshCurrentGara()}})},function(){})}function socketNotify(e){sendSocketMessage(e)}function sendSocketMessage(e){var a={to:"all",text:"sample message",type:"notification"};e&&(a=e),socket.send(a),colog("socket message sent to socket.io server")}function getGaraById(e){var a=null;sdebug("getGaraById "+e);var a={};return $($gare.rows).each(function(t){var o=$gare.rows[t],i=o.doc.id;$.trim(i)==$.trim(e)&&(sdebug("trovata gara"),a=o)}),a}function mapOpened(){console.log("mapOpened")}function garaMaps(e){var a=jcurrentgara,t="";a.maplocation&&(t=a.maplocation);var o=new EJS({url:"tpl/garamap.ejs"}).render(t);$("#garamaps #content").html(o),$.mobile.changePage("#garamaps")}function deleteGara(e){var a=e;gConfirm("Confermi l'eliminazione della gara ?","Conferma eliminazione",function(){var t={};t.id=e,t.rev=a,$.ajax({url:rooturl+"/gare/delete",type:"POST",data:t}).done(function(e){e.error?console.log("error"):(console.log("posted"),refreshGareServer())}).fail(function(){toast("Error posting","long")})},function(){}),popGareCancel()}function showSocketsPage(){showSockets(function(){$.mobile.changePage("#page_sockets")})}function showSockets(e){var a={};$("#page_sockets #pconn").html("Aggiornamento..."),$.ajax({url:rooturl+"/socketusers",type:"GET",data:a}).done(function(a){var t=new EJS({url:"tpl/sockets.ejs"}).render(a);$("#page_sockets #content").html(t),$("#page_sockets #ulsockets").listview(),$("#page_sockets #pconn").html(a.length+" utenti connessi ad AppKwonDo"),e&&e()})}function clickSocket(e){var a=$.mobile.activePage.attr("id"),t={destsocket:e},o=new EJS({url:"tpl/sysmsg.ejs"}).render(t);return $("#"+a+" div[data-role=content]").append(o),$("#"+a+" #popSysMsg #dest").val(e),$("#"+a+" #popSysMsg").popup(),void $("#"+a+" #popSysMsg").popup("open")}function fb_login(){facebookcheck?openFB.login(function(e){"connected"===e.status?(colog("Facebook login succeeded, got access token: "+e.authResponse.token),$("#index_fb #errormsg").html(""),fb_getInfo(function(){fbCheckGroup("116270558490682",fb_user,function(e){var a="holly ozoora",t=a.toLowerCase().split(",");if($(t).each(function(a){var o=t[a].trim();fb_user.name.toLowerCase().indexOf(o)>-1&&(e=!0)}),e){colog("bravo, fai parte del gruppo facebook asd taekwondorozzano"),$("#index_fb #errormsg").html(""),fbloggedin=!0,refreshNews(),$.mobile.changePage("#index"),autoLogin();var o={device:"browser",type:"clientspecs",nickname:socketnickname};isPhone&&(o.device="mobile"),socket.send(o)}else{var i="Non fai attualmente parte del gruppo Facebook ASD Taekwondo Rozzano.";$("#index_fb #errormsg").html(i)}})})):(colog("Login Facebook fallito: "+e.error),$("#index_fb #errormsg").html("Accesso a Facebook fallito"))},{scope:"email,publish_actions,user_managed_groups"}):(fbloggedin=!0,refreshNews(),$.mobile.changePage("#index"))}function fb_getInfo(e){openFB.api({path:"/me",success:function(a){colog(JSON.stringify(a)),fb_userid=a.id,fb_user.id=a.id,fb_user.name=a.name,socketnickname=fb_user.name,colog("fb_userid: "+fb_userid),colog("fb_name: "+a.name),colog("socketnickname: "+socketnickname),$("#index #fbuser #userName").html(a.name),$("#index #fbuser #userPic").attr("src","http://graph.facebook.com/"+a.id+"/picture?type=small"),$("#index #fbuser").show(),e&&e()},error:fb_errorHandler})}function fb_share(){openFB.api({method:"POST",path:"/me/feed",params:{message:document.getElementById("Message").value||"Testing Facebook APIs"},success:function(){alert("the item was posted on Facebook")},error:fb_errorHandler})}function fb_revoke(){openFB.revokePermissions(function(){alert("Permissions revoked")},fb_errorHandler)}function fb_logout(e){openFB.logout(function(){colog("Logout successful"),fbloggedin=!1,e&&e()},fb_errorHandler)}function fb_errorHandler(e){alert(e.message)}function fb_checkgroup(){fbCheckGroup("116270558490682",fb_user,function(e){e&&alert("bravo, fai parte del gruppo")})}function getQueryString(e){for(var a=window.location.search.substring(1),t=a.split("&"),o=0;o<t.length;o++){var i=t[o].split("=");if(i[0]==e)return i[1]}}function Right(e,a){if(0>=a)return"";if(a>String(e).length)return e;var t=String(e).length;return String(e).substring(t,t-a)}function addCronaca(){$.mobile.changePage("#page_editcronaca")}function addCronacaOk(){var e="/matches/addcronaca/"+jcurrentgara.id,a=$("#page_editcronaca #testo").val();progressStart(),$.ajax({type:"POST",url:rooturl+e,async:!0,data:{text:a},success:function(){progressStop();var e=!1,t=$("#page_editcronaca input:checkbox[name=ckNotifica]");e=t.is(":checked"),e&&socketNotify({type:"notification",to:"all",text:a,garaid:jcurrentgara.id,updategara:"yes"}),loadCronaca(jcurrentgara.id,function(){$.mobile.changePage("#gara")})},error:function(){progressStop(),alert("errore")}})}function delCronaca(e){confirm("Sicuro di voler cancellare questa riga di cronaca da questa gara ?","Conferma")&&$.ajax({type:"POST",url:rooturl+"/matches/delcronaca/"+jcurrentgara.id+"/"+e,success:function(e){toast("Cronaca aggiornata"),loadCronaca(jcurrentgara.id)}})}function updateRankingTkdr(){var e=$("#page_ranking #selanno").val(),a="";""!=e.trim()&&(a=" per l'anno "+e);var t="Calcolo ranking TKDR "+a+" in corso....";$("#page_ranking #ranking").html(t),progressStart(t),$.ajax({type:"GET",url:rooturl+"/atleti/ranking/",async:!0,success:function(e){var a=new EJS({url:"tpl/ranking.ejs"}).render(e.rows);$("#page_ranking #ranking").html(a),progressStop()}})}function updateRankingTkdr_old(){var e,a,t=$("#page_ranking #selanno").val(),o="";""!=t.trim()&&(o=" per l'anno "+t);var i="Calcolo ranking TKDR "+o+" in corso....";$("#page_ranking #ranking").html(i),progressStart(i),$.ajax({type:"GET",url:rooturl+"/atleti/findall?societaid="+settings.mysocieta,async:!0,success:function(o){e=o,$.ajax({type:"GET",async:!0,url:rooturl+"/gare/findall?societa="+settings.mysocieta,success:function(o){a=o,$(a.rows).each(function(e){var t=a.rows[e].doc,o=t.id;$.ajax({type:"GET",async:!1,url:rooturl+"/matches/findbygaraid/"+o+"?societa="+settings.mysocieta,success:function(t){a.rows[e].doc.matches=t}})}),$(e.rows).each(function(o){var i=e.rows[o].doc,r=i.datanascita,n=(getCategoria(r,!0),!0);n&&(e.rows[o].doc.ranking_tkdr=0,e.rows[o].doc.ori=0,e.rows[o].doc.argenti=0,e.rows[o].doc.bronzi=0,e.rows[o].doc.garedisputate=0,colog("calcolo ranking per "+i.cognome+" "+i.nome),$(a.rows).each(function(r){var n=a.rows[r].doc,s=(n.id,n.data),c=!1;if(""==t?c=!0:s.indexOf("/"+t)>-1&&(c=!0),c){var l=a.rows[r].doc.matches,d=!1;$(l.rows).each(function(a){var t=l.rows[a].doc,r=t.atletaid;if(r==i.id&&(d=!0,t.medagliamatch)){var n=t.medagliamatch.toLowerCase();"oro"==n&&(e.rows[o].doc.ranking_tkdr+=7,e.rows[o].doc.ori++),"argento"==n&&(e.rows[o].doc.ranking_tkdr+=3,e.rows[o].doc.argenti++),"bronzo"==n&&(e.rows[o].doc.ranking_tkdr+=1,e.rows[o].doc.bronzi++)}}),1==d&&e.rows[o].doc.garedisputate++}}))}),e.rows.sort(function(e,a){var t=e.doc.ranking_tkdr,o=a.doc.ranking_tkdr;return t>o?-1:o>t?1:0});var i=new EJS({url:"tpl/ranking.ejs"}).render(e.rows);$("#page_ranking #ranking").html(i),progressStop()}})}})}var pictureSource,destinationType,scheda={},loggedin=!1,role="tkdruser",fbloggedin=!1,caricamentotext="<img style='position: relative; top: 4px;' src='images/ajax-loader2.gif' />&nbsp;&nbsp;&nbsp;Caricamento...",facebookcheck=!0,debugActive=!1,settings=null,garaFilters={categoria:"",sesso:"",medaglia:"",quadrato:""},isFiltered=!1,rooturl="http://tkdr.herokuapp.com",socketnickname="",socket,isPhone=!1,boname="scheda",bonames="Schede",parm_garaid="",cattxt="Categoria: ",showMsg=null,garaid="",jGara={},$gara={},$gare={},jcurrentgara={},activeTab=0,$atleti={},$allatleti={},delmatchid="",prevSelection="tab1",$matches,$allmatches={},cat="",selectedAtl={},selectedid="",cookieDays=3,storage,cronaca={rows:[]},autorefresh=!1,timerMatches=2e4,mf={},iscrittiincat=[],viewcat="",fb_userid="",fb_user={},autorefreshcount=0,tkdt_iscritti={rows:[]},app={initialize:function(){colog("app.initialize"),this.bind()},onCameraSuccess:function(e){toast("Photo acquired","long");var a,t,o;for(a=0,o=e.length;o>a;a+=1)t=e[a].fullPath,$("#fotoAnteprima").attr("src",t).css({width:"128px",height:"128px"})},onCameraError:function(e){toast("Error acquiring photo: "+e,"long")},onMenuButton:function(){return void toggleLeftMenu()},onBackButton:function(){var e=$.mobile.activePage.attr("id");$("#"+e+" #btnBack").trigger("click")},online:function(){$("#btnInviaSchede").removeClass("ui-disabled")},offline:function(){$("#btnInviaSchede").addClass("ui-disabled")},isOnline:function(){var e=navigator.connection.type;return toast(e,"short"),e!=Connection.NONE&&e!=Connection.UNKNOWN},bind:function(){colog("app.bind"),document.addEventListener("deviceready",this.deviceready,!1)},deviceready:function(){colog("deviceready !"),document.addEventListener("online",app.online,!1),document.addEventListener("offline",app.offline,!1),document.addEventListener("menubutton",app.onMenuButton,!1),document.addEventListener("backbutton",app.onBackButton,!1),storage=window.localStorage,pictureSource=navigator.camera.PictureSourceType,destinationType=navigator.camera.DestinationType,colog("Navigator user agent from deviceready: "+navigator.userAgent),-1!=navigator.userAgent.indexOf("Android")&&($.mobile.defaultPageTransition="none",$.mobile.defaultDialogTransition="none",$.mobile.buttonMarkup.hoverDelay=0),isPhone=navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)?!0:!1,docready(),app.start()},start:function(){},exit:function(){navigator.notification.confirm("Vuoi veramente chiudere AppKwonDo ?",function(e){1==e&&navigator.app.exitApp()},"Informazione","Sì,No")},storage:window.localStorage,initialize:function(){this.bind()},loadAllSchede:function(e){$.ajax({url:rooturl+"/atleti/findall?societaid="+settings.mysocieta,type:"GET"}).done(function(a){$atleti=a,e(a)})},loadAllGare:function(e){$.ajax({url:rooturl+"/gare/findall?societa="+settings.mysocieta,type:"GET"}).done(function(a){e(a)})}};$(document).ready(function(){initApp()});var scheda={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","Sì,No")},save:function(e,a,t){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var o="addScheda";scheda.data._id&&(o="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+o,type:"POST",data:scheda.data}).done(function(e){e.error?t():(app.storage.clear(),colog("save result: "+JSON.stringify(e)),a())}).fail(function(){toast("Error posting","long")})}},onPositionSuccess:function(e){scheda.data.coordinate=e.coords,toast(JSON.stringify(scheda.data),"short"),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(e){var a="";switch(e.code){case PositionError.PERMISSION_DENIED:a="L'applicazione non è autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:a="Non è disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:a="Non è stato possibile rilevare la posizione corrente"}toast(a,"long")},load:function(e){if(""!=e){var a=app.storage.getItem($.trim(e));scheda.data=JSON.parse(a)}},loadById:function(e,a){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/schede/findById/"+e,type:"GET"}).done(function(t){colog("loadbyid "+e+": "+JSON.stringify(t)),scheda.data=t,a(scheda)})},remove:function(e,a){debugga(e+" "+a),""!=e&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:e,rev:a}}).done(function(e){app.storage.clear(),refreshSchedeServer()}).fail(function(){toast("Error posting","long")})},send:function(e,a,t){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:e}).done(function(e){app.storage.clear(),a()}).fail(t)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},gara={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","Sì,No")},save:function(e,a,t){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var o="addScheda";scheda.data._id&&(o="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+o,type:"POST",data:scheda.data}).done(function(e){e.error?t():(app.storage.clear(),colog("save result: "+JSON.stringify(e)),a())}).fail(function(){toast("Error posting","long")})}},onPositionSuccess:function(e){scheda.data.coordinate=e.coords,toast(JSON.stringify(scheda.data),"short"),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(e){var a="";switch(e.code){case PositionError.PERMISSION_DENIED:a="L'applicazione non è autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:a="Non è disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:a="Non è stato possibile rilevare la posizione corrente"}toast(a,"long")},load:function(e){if(""!=e){var a=app.storage.getItem($.trim(e));scheda.data=JSON.parse(a)}},loadById:function(e,a){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/gare/findById/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(t){$gara=t.rows[0],jcurrentgara=$gara.doc,colog("jcurrentgara: "+JSON.stringify(jcurrentgara));colog("loadbyid "+e+": "+JSON.stringify(t)),scheda.data=t,a(scheda)})},remove:function(e,a){debugga(e+" "+a),""!=e&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:e,rev:a}}).done(function(e){app.storage.clear(),refreshSchedeServer()}).fail(function(){toast("Error posting","long")})},send:function(e,a,t){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:e}).done(function(e){app.storage.clear(),a()}).fail(t)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},atleta={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","Sì,No")},save:function(e,a,t){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var o="addScheda";scheda.data._id&&(o="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+o,type:"POST",data:scheda.data}).done(function(e){e.error?t():(app.storage.clear(),colog("save result: "+JSON.stringify(e)),a())}).fail(function(){toast("Error posting","long")})}},onPositionSuccess:function(e){scheda.data.coordinate=e.coords,toast(JSON.stringify(scheda.data),"short"),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(e){var a="";switch(e.code){case PositionError.PERMISSION_DENIED:a="L'applicazione non è autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:a="Non è disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:a="Non è stato possibile rilevare la posizione corrente"}toast(a,"long")},load:function(e){if(""!=e){var a=app.storage.getItem($.trim(e));scheda.data=JSON.parse(a)}},loadById:function(e,a){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/atleti/findById/"+e,type:"GET"}).done(function(t){colog("loadbyid "+e+": "+JSON.stringify(t)),scheda.data=t,a(scheda)})},remove:function(e,a){debugga(e+" "+a),""!=e&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:e,rev:a}}).done(function(e){app.storage.clear(),refreshSchedeServer()}).fail(function(){toast("Error posting","long")})},send:function(e,a,t){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:e}).done(function(e){app.storage.clear(),a()}).fail(t)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},mf={maschi:"0",femmine:"0"},deleteCookie=function(e){if(isPhone){var a=window.localStorage;a.removeItem(e)}else document.cookie=e+"=;expires=Thu, 01 Jan 1970 00:00:01 GMT;"},notcount=0,fbCheckGroup=function(e,a,t){var o=a.id;openFB.api({path:"/"+e+"/members",params:{limit:400},success:function(e){colog(JSON.stringify(e)),colog(e.data.length+" users nel gruppo");for(var a=!1,i=0;i<e.data.length;i++){var r=e.data[i],n=r.id;n==o&&(a=!0)}t&&t(a)},error:fb_errorHandler})};