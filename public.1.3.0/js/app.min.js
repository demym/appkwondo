function editUserProfile(){alert("non ancora implementato")}function tabbize(a){return}function setBadge(){var a=chatunreadcount;console.log("chat non letti totali: "+a),0==a?isPhone&&cordova.plugins.notification.badge.clear():isPhone&&cordova.plugins.notification.badge.set(a)}function getChatNonLetti(a){for(var b=0,c=!1,d=0;d<chatnonletti.length;d++){var e=chatnonletti[d];e.garaid&&e.garaid==a&&(b=e.count,c=!0)}return b}function setChatNonLetti(a,b){for(var c=!1,d=0;d<chatnonletti.length;d++){var e=chatnonletti[d];e.garaid&&e.garaid==a&&(e.count=b,c=!0)}if(0==c){var f={garaid:a,count:b};b>0&&chatnonletti.push(f)}setCookie("chat_unread",chatunreadcount)}function addChatNonLetti(a){return}function deleteFromRealtimeArray(a){conslog("key "+a);for(var b=0;b<realtimeArray.length;b++){var c=realtimeArray[b],d=c.garaid+"_"+c.matchid;conslog("key "+a+" ---> rkey "+d),a==d&&(found=!0,conslog("found key to delete "+d),realtimeArray.splice(b,1),console.log("deleting from realtime array "+a))}}function getFromRealtimeArray(a){for(var b=null,c=0;c<realtimeArray.length;c++){var d=realtimeArray[c],e=d.garaid+"_"+d.matchid;a==e&&(found=!0,realtimeArray[c]=data,b=data)}return b}function syncRealtimeArray(a){return}function addLastRealtimeData(a){conslog("addLastRealtimeData"),conslog(a);for(var b=a.garaid+"_"+a.matchid,c=!1,d=0;d<realtimeArray.length;d++){var e=realtimeArray[d],f=e.garaid+"_"+e.id;f==b&&(conslog("found realtimeArray element to update"),e.lastrealtimedata=a,c=!0)}c||conslog("match "+b+" not found in realtimeArray")}function checkRealtimeArray(a,b){null==b&&(b=!0),console.log("checkrealtimearray - changedata: "+b),console.log(a);for(var c=a.garaid+"_"+a.matchid,d=!1,e=0;e<realtimeArray.length;e++){var f=realtimeArray[e],g=f.garaid+"_"+f.matchid;c==g&&(d=!0,console.log("match "+c+" found in realtimearray"))}d||(console.log("match "+c+" not found in realtimearray, pushing it"),realtimeArray.push(a),checkConsoles(a.matchid,a))}function resizeImage(a){var b=$(a);b.removeAttr("width").removeAttr("height");var c=jQuery(a).parent();conslog("cw: "+c.css("width")+" - ch: "+c.css("height"));var d=parseInt(b.css("width").replace("px",""),10),e=parseInt(b.css("height").replace("px",""),10);d=$(a).get(0).naturalWidth,e=$(a).get(0).naturalHeight;var f=c.css("width")/d,g=c.css("height")/e;Math.max(f,g);conslog("w: "+d+" - height: "+e);var i=parseInt(c.css("width").replace("px",""),10),j=i/d;conslog("ratio2: "+j);var k=Math.ceil(j*e);conslog("newwidth: "+i+" - newheight: "+k),b.css({width:i,height:k})}function colog(a){var b=debugActive;b&&console.log(a)}function toggleLeftMenu(){var a=$.mobile.activePage.attr("id"),b=$("#"+a+" #menuPanel").length;b>0&&$("#"+a+" #menuPanel").remove();var c={loggedin:loggedin},d=new EJS({url:"tpl/menupanel.ejs"}).render(c);$("#"+a).append(d),$("#"+a+" #menuPanel").panel(),$("#"+a+" #menuPanel").panel("toggle")}function toggleRightMenu(a){var b=$.mobile.activePage.attr("id"),c=$("#"+b+" #"+a).length;c>0&&$("#"+b+" #"+a).remove();var d={loggedin:loggedin,role:role},e=new EJS({url:"tpl/"+a+".ejs"}).render(d);$("#"+b).append(e),$("#"+b+" #"+a).panel(),$("#"+b+" #"+a).panel("toggle")}function setMatchesRefresh(){autorefresh&&(autorefreshcount++,console.log("running "),1==autorefreshcount&&setInterval(function(){refreshMatches()},timerMatches))}function toggleCheckbox(a,b){var c=$(a).prop("checked"),d=$("#"+b);conslog(c),c?d.show():d.hide()}function openPopup(a,b){if(1==page_popup)return void openPopupPage(a,b);b||(b="");var c=$.mobile.activePage.attr("id");conslog("current pageid: "+c),$("#"+c+" div[data-role=content] #temppopup").remove();var d=new EJS({url:"tpl/genericpop.ejs"}).render(a);$("#"+c+" div[data-role=content]").append(d),$("#"+c+" #temppopup h5").html(b),$("#"+c+" #temppopup").popup(),$("#"+c).page("destroy").page(),$("#"+c+" #temppopup").popup("open",{transition:"flip"})}function openPopupPage(a,b){b||(b="");var c=$.mobile.activePage.attr("id");c="page_popup",$.mobile.changePage("#page_popup"),conslog("current pageid: "+c),$("#"+c+" div[data-role=content] #temppopup").remove();var d=new EJS({url:"tpl/genericpop.ejs"}).render(a);$("#"+c+" div[data-role=content]").append(d),$("#"+c+" #temppopup h5").html(b),$("#"+c).trigger("pagecreate")}function popCloseRemove(){var a=$.mobile.activePage.attr("id");colog("current pageid: "+a),0==page_popup?$("#"+a+" #temppopup").popup("close").remove():$.mobile.back()}function openTabulato(a){progressStart("Caricamento.."),$.ajax({url:a,type:"GET",dataType:"html"}).done(function(a){colog(a);var b=$(a).find("img[alt=drawing_load_error]"),c=b.attr("src").replace("./","");colog(c);var d="<img style='width: 400px; height: 500px;' src='http://demo.tkdtechnology.it/"+c+"' />";openPopup(d),progressStop()})}function openTabulatoPage(a,b){var c=$(a).html(),d=rooturl+"/gettkdtabulato";progressStart("Caricamento.."),$.ajax({url:d,type:"POST",dataType:"html",data:{url:b}}).done(function(a){colog(a);var d=$(a).find("img[alt=drawing_load_error]"),e=d.attr("src").replace("./","");colog(e);var f="<img style='width: 600px; height: 600px;' src='http://demo.tkdtechnology.it/"+e+"' />";$("#page_tabulato #cat").html(c),$("#page_tabulato #cont").html(f),progressStop(),$("#page_tabulato #url").val(b),$.mobile.changePage("#page_tabulato");var g=$("#page_tabulato #cont img").get(0);g.addEventListener("gesturechange",function(a){console.log(a.scale),a.scale>1||a.scale<1})})}function openTabulatoImage(){var a=$("#page_tabulato #url").val();window.open(a,"_blank","location=no&toolbar=yes")}function getTabulatoImg(a,b){progressStart("Caricamento.."),$.ajax({url:a,type:"GET",dataType:"html"}).done(function(a){colog(a);var c=$(a).find("img[alt=drawing_load_error]"),d=c.attr("src").replace("./","");colog(d);var e="<img style='width: 500px; height: 600px;' src='http://demo.tkdtechnology.it/"+d+"' />";b(e),progressStop()})}function getTkdTechnology(a){silenttkdt||$("#page_tdkt").is(":visible")||(colog("page_tkdt not visible, showing it"),$.mobile.changePage("#page_tkdt")),enableprogress&&progressStart("Caricamento.."),$("#page_tkdt .update").html("Aggiornamento...");var b=rooturl+"/gettkdtech";$.ajax({url:b,type:"GET"}).done(function(b){tkdt_iscritti={rows:[],avversari:[],tabulati:[]};var c=$(b).find("div#tab-63-atl-cls"),e=($(b).find("div#tab-63"),$(b).find("div.tabs:first ul:first li"));colog("navtabs: "+e.length);var f="";colog(b),$(e).each(function(a){var c=$(this).find("a").attr("href"),d=$(this).find("a").html();colog(d);var e=$(b).find("div"+c+"-atl-int"),g=$(b).find("div"+c+"-atl-cls"),h=$(b).find("div"+c+"-atl-tab"),i=$(b).find("div"+c+"-atl-cat"),j=g.find("table"),k=e.find("table");getTkdtInteractive(k),j.css("border","2px solid black"),j.css("width","100%"),j.find("thead tr").prepend("<th width=8>&nbsp;</th>"),j.find("th").css("background","#f6f6f6"),j.find("tr").each(function(a){var b=$(this);a>0&&$(this).prepend("<td width=10>"+a+"</td>");var c=$(this).find("td:first");colog(c.length),b.html().toLowerCase().indexOf("rozzano")>-1&&(b.find("td").css("font-weight","bold"),b.css("background","lightgreen"))});var l="";h.find("a").each(function(a){var b=$(this).html(),e=($(this),$(this).attr("href")),g={href:e,descr:b,tabn:c};tkdt_iscritti.tabulati.push(g),l+="<a style='font-size: 10px; white-space: normal;' class=tabbutton href='#' onclick=openTabulatoPage(this,'"+e+"') >"+b+"</a>"}),j.find("td").css("text-align","center"),j.find("td,th").css("font-size","12px"),j.find("td").css("border-top","1px solid gray"),f+='<div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">'+d+'</h5><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Classifica</h5>'+g.html()+'</div><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Tabulati</h5>'+l+'</div><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Atleti per categoria</h5>'+i.html()+"</div></div>"});e.html()+c.html();$("#page_tkdt").find("#cont").html(f),$("#temppopup").find("div[data-role=collapsible]").collapsible({theme:"c",refresh:!0}),$("#page_tkdt").find("div[data-role=collapsible]").collapsible({theme:"c",refresh:!0}),$("#page_tkdt").find("a.tabbutton").button(),progressStop(),colog(tkdt_iscritti);var h=new Date,i=h.toLocaleDateString()+" "+h.toLocaleTimeString();$("#page_tkdt .update").html("Ultimo agg.: "+i);var j=$.mobile.activePage.attr("id");$("#"+j+" #menuPanel").panel("close"),a&&a(f)})}function showTabulatoAtleta(){if(tkdt_iscritti.rows.length>0){colog(tkdt_iscritti.rows);var a=$("#matchesatleta #atletaid").val();colog("atletaid: "+a);var b=getAtletaById(a);console.log(b);var c=b.cognome+b.nome,d=!1;colog("cerco chiave "+c),$(tkdt_iscritti.rows).each(function(a){var e=tkdt_iscritti.rows[a],f=e.cognome+e.nome,g=e.nome+e.cognome;if(f.trim().toLowerCase()==c.trim().toLowerCase()||g.trim().toLowerCase()==c.trim().toLowerCase()){d=!0;var h="";colog(tkdt_iscritti.tabulati);var i={nome:b.cognome+" "+b.nome,categoria_peso:e.categoria_peso,categoria_cintura:e.categoria_cintura,tabulati:[]};$(tkdt_iscritti.tabulati).each(function(a){var b=tkdt_iscritti.tabulati[a].descr.toLowerCase();colog(b),b.indexOf(e.categoria_peso.toLowerCase())>-1&&b.indexOf(e.categoria_cintura.toLowerCase())>-1&&b.indexOf(e.sesso.toLowerCase()+" - ")>-1&&(h+=b+"\n",i.tabulati.push(tkdt_iscritti.tabulati[a]))});var j=new EJS({url:"tpl/mytabulati.ejs"}).render(i);openPopup(j,"Tabulati")}}),d||alert("Categoria peso non trovata per "+b.cognome+" "+b.nome)}else silenttkdt=!0,getTkdTechnology(function(){silenttkdt=!1,showTabulatoAtleta()})}function getTkdtInteractive(a){colog("getTkdInteractive");var b=a.find("tbody"),c=b.find("tr");c.each(function(){var a=$(this),b=a.find("td:eq(0)").remove("span").html(),c=a.find("td:eq(1)").remove("span").html(),d=a.find("td:eq(2)").remove("span").html(),e=a.find("td:eq(3)").remove("span").html(),f=a.find("td:eq(4)").remove("span").html(),g=a.find("td:eq(5)").remove("span").html(),h=a.find("td:eq(6)").remove("span").html();if(d.toLowerCase().trim().indexOf("rozzano")>-1){var i={cognome:b,nome:c,categoria:e,categoria_cintura:f,categoria_peso:g,sesso:h};colog("interactive: "+b+" "+c+" - "+e+" - "+g+" - "+f),tkdt_iscritti.rows.push(i)}else{var j={cognome:b,nome:c,categoria:e,categoria_cintura:f,categoria_peso:g,sesso:h};tkdt_iscritti.avversari.push(j)}}),console.log("tkdt_iscritti structure:"),console.log(tkdt_iscritti)}function cancelDelMatch(){$("#matchesatleta #popDelMatch").popup("close")}function isCordovaApp(){var a=!1;return colog("isCordovaApp URL:"+document.URL),document.URL.indexOf("http://")===-1&&document.URL.indexOf("https://")===-1&&(a=!0),1!=a||navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)||(a=!1),a}function initApp(){app.initialize(),colog("Navigator user agent from docready "+navigator.userAgent);var a=isCordovaApp();colog("isCordovaApp: "+a),isPhone=!!a,colog("Running on phone: "+isPhone),isPhone||docready()}function playSound(a){document.getElementById("sound").innerHTML='<audio autoplay="autoplay"><source src="'+a+'.mp3" type="audio/mpeg" /><source src="'+a+'.ogg" type="audio/ogg" /><embed hidden="true" autostart="true" loop="false" src="'+a+'.mp3" /></audio>'}function myToast(a){var b=new EJS({url:"tpl/popnotification.ejs"}).render(a),c=$.mobile.activePage.attr("id");colog("current pageid: "+c),$("#"+c+" div[data-role=content]").append(b),$("#"+c+" #popNotification").popup(),$("#"+c+" #popNotification").popup("open"),playSound("img/chimes"),setTimeout(function(){$("#"+c+" #popNotification").popup("close").remove()},1800)}function snotify(a){if(colog("Snotify:"),colog(a),0==settings.notifiche)return void colog("notifiche non attive nei settings, esco senza notificare");var b={body:a.text.replace("<b>","").replace("</b>",""),icon:"img/logotkdrozzano.png"};if(isPhone)notify(a.text);else{var c=new EJS({url:"tpl/popnotification.ejs"}).render(b),d=$.mobile.activePage.attr("id");if(colog("current pageid: "+d),$("#"+d+" div[data-role=content]").append(c),$("#"+d+" #popNotification").popup(),$("#"+d+" #popNotification").popup("open"),playSound("img/chimes"),setTimeout(function(){$("#"+d+" #popNotification").popup("close").remove()},6e3),"Notification"in window)if("granted"===Notification.permission){colog("notification are granted");new Notification("AppKwonDo",b)}else"denied"!==Notification.permission&&(colog("asking grant for notifications"),Notification.requestPermission(function(a){if("granted"===a){new Notification("AppKwonDo",b)}}));else colog("This browser does not support system notifications")}}function conslog(a){var b=debugActive;b&&console.log(a)}function closePanel(){conslog("panels found: "+$("[data-role=panel]:visible").length),$("[data-role=panel]:visible").panel("close")}function updateHomeInfos(){conslog("updateHomeInfos"),$(".serverspan").html("Connesso al server: "+rooturl.replace("http://","").replace("https://","")),$("#userName").html("<b><font style='color: blue'>"+chatuser.nickname.toUpperCase()+"</font></b>"),settings?$(".societaspan").html("Società: "+settings.mysocietaname):loadOptions()}function recordAudio(){console.log("recordAudio "+recording),recording&&($("#cronacaelements a#recordaudio span").text("REGISTRA").css("color","black"),$("#cronacaelements a#recordaudio").css("background","silver"),recorder.stop()),recording||($("#cronacaelements  a#recordaudio span").text("FERMA REGISTRAZIONE").css("color","yellow"),$("#cronacaelements  a#recordaudio").css("background","red"),recorder.record()),recording=!recording}function recordChatAudio(){console.log("recordAudio "+recording),recording&&($("#page_chat #recording").hide(),$("#page_chat #chataudio").attr("src","img/audio.png"),console.log("registrazione terminata"),isPhone&&recorder.stopcb(function(a){console.log(a);var b=new EJS({url:"tpl/recordaudiook.ejs"}).render({audio:a});openPopup(b,"Conferma invio")})),recording||($("#page_chat #recording").show(),$("#page_chat #chataudio").attr("src","img/audiorecording.png"),console.log("registrazione in corso, premi il microfono per interrompere"),isPhone&&recorder.record()),recording=!recording}function cancelChatAudio(){popCloseRemove()}function sendChatAudio(a){postChat({garaid:"",nickname:chatuser.nickname,sockid:chatuser.sockid,audio:a,text:""}),popCloseRemove()}function shareText(a){isPhone&&(console.log("shareText "+a),window.plugins.socialsharing.share(a))}function shareAudio(a){if(isPhone){var b=new Date,c=b.juliandate(),d=c,e=rooturl+"/data/chatmedia/"+a;if(a.indexOf("data:audio")>-1)window.plugins.socialsharing.share(null,d,a,null);else{var f=new XMLHttpRequest;f.open("GET",e,!0),f.overrideMimeType("text/plain; charset=x-user-defined"),f.onreadystatechange=function(){if(4==f.readyState&&200==f.status){var a="data:audio/mp3;base64,"+stringToBase64(f.responseText);window.plugins.socialsharing.share(null,d,a,null)}},f.send()}}}function shareFoto(a){if(isPhone){var b=new Date,c=b.juliandate(),d=c,e=a;if(a.indexOf("data:image")>-1)window.plugins.socialsharing.share(null,d,a,null);else{var f=new XMLHttpRequest;f.open("GET",e,!0),f.overrideMimeType("text/plain; charset=x-user-defined"),f.onreadystatechange=function(){if(4==f.readyState&&200==f.status){var a="data:image/jpeg;base64,"+stringToBase64(f.responseText);window.plugins.socialsharing.share(null,d,a,null)}},f.send()}}}function stringToBase64(a){for(var f,g,h,b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c="",d=0,e=a.length;d<e;){if(f=255&a.charCodeAt(d++),d==e){c+=b.charAt(f>>2),c+=b.charAt((3&f)<<4),c+="==";break}if(g=a.charCodeAt(d++),d==e){c+=b.charAt(f>>2),c+=b.charAt((3&f)<<4|(240&g)>>4),c+=b.charAt((15&g)<<2),c+="=";break}h=a.charCodeAt(d++),c+=b.charAt(f>>2),c+=b.charAt((3&f)<<4|(240&g)>>4),c+=b.charAt((15&g)<<2|(192&h)>>6),c+=b.charAt(63&h)}return c}function playAudio(){recorder.playback()}function sendAudio(){alert("non ancora implementato")}function readAudioFile(a){function d(b){b.root.getFile(a,{},function(a){a.file(function(a){var b=new FileReader;b.onloadend=function(a){var b=document.getElementById("textarea");b.value=this.result},b.readAsText(a)},e)},e)}function e(a){alert("ERROR: "+a.code),console.log("ERROR: ",a)}var b=window.TEMPORARY,c=5242880;window.requestFileSystem(b,c,d,e)}function bindFeedback(){$(document).on(tapevent,"a",function(){conslog("primordial tap event"),isPhone&&window.plugins.deviceFeedback.acoustic()})}function playFeedback(){isPhone&&window.plugins.deviceFeedback.acoustic()}function setWaitTkdt(a){waitactive=a,waitactive?(colog("Timer activated"),waittkdttimer=setInterval(function(){colog("Wait Interval"),enableprogress=!1,silenttkdt=!0,getTkdTechnology(function(a){""!=tkdtcontent.trim()?a!=tkdtcontent&&(colog("tkdtcontent has changed !"),snotify({text:"Contenuto Tkdt variato"}),tkdtcontent=a):tkdtcontent=a,enableprogress=!0,silenttkdt=!1})},waitinterval)):(colog("Timer deactivated"),clearInterval(waittkdttimer),silenttkdt=!1,enableprogress=!0)}function toggleWaitTkdt(){var a=$("#page_tkdt #ckwait:checked"),b=!1;a.length>0&&(b=!0),setWaitTkdt(b)}function tapholdBubble(){$("#page_chat .bubble").off("taphold"),$("#page_chat .bubble").on("taphold",function(a){var b=$(this);console.log("bubble taphold");var c=b.find("span.chattext").text();if(""!=c.trim())return console.log("share text"),void shareText(c);if(b.find(".shareaudio").length>0){var d=b.find(".shareaudio").val();return console.log("share audio "),void shareAudio(d)}if(b.find("img").length>0){var d=b.find("img").attr("src"),e=!0;return d.indexOf("data:image")>-1&&(e=!1),console.log("share foto "),void shareFoto(d)}})}function docready(){console.log("docready"),tabbize("#popResult #matchestabsdiv"),$("#popResult #risult").on("taphold",function(){console.log("taphold on result"),gConfirm("Confermi il reset del punteggio ?","Conferma reset",function(){$("#popResult #risult").val("0-0")},function(){})});var a=getQueryString("head");"no"==a&&$(document).find("[data-role=header]").remove(),isPhone||($("#page_chat #tdaudio").html("&nbsp"),$("#page_chat #tdfoto").html("&nbsp")),$(window).on("navigate",function(a,b){if(console.log("navigateevent",b),"popResult"==b.state.pageUrl&&"back"==b.state.direction){console.log("navigated back to console");var c=$("#popResult #matchid").val();$("#popResult #consolenavb li a").removeClass("ui-btn-active");for(var d=0;d<consoles.length;d++)consoles[d].match.id==c&&$("#popResult #consolenavb li a:eq("+d+")").addClass("ui-btn-active")}if("matchesatleta"==b.state.pageUrl&&"back"==b.state.direction)for(var d=0;d<consoles.length;d++){var e=!1;consoles[d].match.realtime&&"true"==String(consoles[d].match.realtime)&&(e=!0),e||consoles.splice(d,1)}"back"==b.state.direction}),$("#page_chat #chatmsg").focus(function(a){console.log("focus event")}),$("#page_chat #chatmsg").blur(function(a){console.log("blur event")}),$("#page_chat #chatmsg").keyup(function(a){13==a.keyCode||socket.emit("typing",{nickname:chatuser.nickname})}),console.log("Using server on "+rooturl),console.log("navigator"),console.log(navigator);var b=navigator.platform.toLowerCase();b.indexOf("ipad")>-1&&(isIOS=!0),b.indexOf("mac")>-1&&(isIOS=!0),b.indexOf("ipod")>-1&&(isIOS=!0),b.indexOf("iphone")>-1&&(isIOS=!0);var c=getCookie("cronaca_read"),d=getCookie("chat_unread");console.log("chat_unread cookie",d),null!=d&&(console.log("trovato cookie chat_unread, popolo chatnonletti"),chatunreadcount=d),setChatBubbles(),refreshChat(),console.log("cronaca_read cookie: ",c),isPhone&&(recorder.stop=function(){window.plugins.audioRecorderAPI.stop(function(a){var b=a.substring(1);a.split("/");b="file://"+a,conslog("STOP, fname: "+b),conslog("msg: "+a),myToast({body:b+"<br>"+a}),window.resolveLocalFileSystemURL(b,function(a){conslog("fileEntry: ",a),a.file(function(a){conslog("file: ",a);var b=new FileReader;conslog("reader",b),b.onload=function(){conslog("onload readystate: "+b.readyState);var a=b.result;conslog(a),sounddata=a},b.onloadend=function(a){conslog("onloadend",a)},b.onloadstart=printEventType,b.onprogress=printEventType,b.readAsDataURL(a)})},function(a){console.log("error reading file",a)}),conslog("stopaudio ok: "+a)},function(a){conslog("stopaudio ko!!: "+a)})},recorder.stopcb=function(a){window.plugins.audioRecorderAPI.stop(function(b){var c=b.substring(1);b.split("/");c="file://"+b,console.log("STOP, fname: "+c),conslog("msg: "+b),window.resolveLocalFileSystemURL(c,function(b){conslog("fileEntry: ",b),b.file(function(b){conslog("file: ",b);var c=new FileReader;conslog("reader",c),c.onload=function(){conslog("onload readystate: "+c.readyState);var b=c.result;conslog(b),sounddata=b,a(b)},c.onloadend=function(a){conslog("onloadend",a)},c.onloadstart=printEventType,c.onprogress=printEventType,c.readAsDataURL(b)})},function(a){console.log("error reading file",a)}),conslog("stopaudio ok: "+b)},function(a){conslog("stopaudio ko!!: "+a)})},recorder.record=function(){window.plugins.audioRecorderAPI.record(function(a){console.log("recordaudio ok: "+a);var b=a.split("/");b[b.length-1]},function(a){console.log("recordaudio ko!!!: "+a)},30)},recorder.playback=function(){window.plugins.audioRecorderAPI.playback(function(a){conslog("playbackaudio ok: "+a)},function(a){conslog("playbackaudio ko!!: "+a)})}),$("#page_chat #chataudio").on(tapevent,function(a){recordChatAudio()}),$("a.sgradient").removeClass("sgradient"),$("a").addClass("fastClick"),bindFeedback(),$("a.ui-btn-left,a.ui-btn-right").addClass("transparentborderbutton").addClass("ui-nodisc-icon"),$.mobile.defaultPageTransition="none",$.mobile.defaultDialogTransition="none",$.mobile.page.prototype.options.addBackBtn=!0,$.mobile.useFastClick=!0,$("#popResult #roundfieldset").find(".roundnumber").off(tapevent),$("#popResult #roundfieldset").find(".foundnumber").on(tapevent,function(){}),$("#popResult .incbutton").off(tapevent),$("#popResult .incbutton").on(tapevent,function(){conslog("tapped an inc button");var a=$("#popResult #risult").val(),b=$("#popResult #ammoniz1").val(),c=$("#popResult #ammoniz1").val();""==a.trim()&&(a="0-0"),""==b.trim()&&(b="0"),""==c.trim()&&(c="0");var d=$(this).attr("id"),e=parseInt(a.split("-")[0].trim(),10),f=parseInt(a.split("-")[1].trim(),10),g=parseInt(b,10),h=parseInt(c,10),i=$("#popResult #matchid").val(),j=$("#popResult #matchnumber").val();conslog("r1: "+e),conslog("r2: "+f),conslog("ammon1: "+g),conslog("ammon2: "+h);var k=d.substring(d.length-1),l=d.substring(0,d.length-1);conslog(k+" - "+l),"plus"==l&&(1==k&&e++,2==k&&f++),"minus"==l&&(1==k&&e--,2==k&&f--,e<0&&(e=0),f<0&&(f=0)),"ammplus"==l&&(1==k&&g++,2==k&&h++,g<0&&(g=0),h<0&&(h=0)),"ammminus"==l&&(1==k&&g--,2==k&&h--,g<0&&(g=0),h<0&&(h=0));var m=e+"-"+f;conslog("r1: "+e+" - r2: "+f+" - ammon1: "+g),e>f&&($("#popResult #radio_vinto").prop("checked",!0).checkboxradio("refresh"),$("#popResult #radio_perso").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_nondisputato").prop("checked",!1).checkboxradio("refresh")),e<f&&($("#popResult #radio_vinto").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_perso").prop("checked",!0).checkboxradio("refresh"),$("#popResult #radio_nondisputato").prop("checked",!1).checkboxradio("refresh")),e==f&&($("#popResult #radio_vinto").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_perso").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_nondisputato").prop("checked",!1).checkboxradio("refresh")),$("#popResult #risult").val(m),$("#popResult #ammoniz1").val(g);var n=$("#popResult #ck_realtime:checked"),o=consoles[getConsolesIndex(i)];if(o.result=m,n.length>0){conslog("notify realtime result for "+j+" - "+m+" - "),realtime.active=!0,realtime.running=!0,realtime.result=m,conslog("realtimeindex:",realtimeindex);realtimeArray[realtimeindex];o.active=!0,o.running=!0,sendRealtime();({sockid:chatuser.sockid,nickname:chatuser.nickname,text:"<b>"+realtime.result+"</b>"})}}),$("#popResult #ck_realtime").off(tapevent),$("#popResult #ck_realtime").on(tapevent,function(){var a=$("#popResult #ck_realtime:checked");a.length>0?(realtime.active=!0,sendRealtime(),socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,matchid:selectedid,matchnumber:selectedmatchid,result:rf,ammoniz1:ammon1,ammoniz2:ammon2,event:"startmatch",text:rf})):realtime.active=!1});var e=window.location.href;if(openFB.init({appId:"924594024295731",tokenStore:window.localStorage}),colog("docready !"),colog("url: "+e),e.indexOf("#")>-1)return colog("back to index"),void(window.location.href="index.html");jQuery.support.cors=!0,storage=window.localStorage,socket=io.connect(rooturl),console.log("socket connected to socket server",socket),$.ajaxSetup({cache:!1}),$.event.special.tap.emitTapOnTaphold=!1,FastClick.attach(document.body),socket.on("refreshchat",function(a){console.log("received socket refreshchat "),refreshChat(),chatunreadcount=0,setCookie("chat_unread","0"),setChatBubbles()}),socket.on("realtime",function(a){console.log("realtime update:",a);var b,c=a;if(a.event&&(b=a.event),"refreshcronaca"==b){if(garanotifyid=c.garaid,!jcurrentgara.stato)return console.log("nessuna gara, carico la "+garanotifyid),void openGara(garanotifyid,function(a){console.log("refreshcronaca");var b=jGara.cronaca.rows.length-cronaca_read.length;b<0&&(b=0),$.ajax({url:rooturl+"/matches/getcronaca/"+jcurrentgara.id,type:"GET"}).done(function(a){jGara.cronaca=a,renderCronaca(jGara.cronaca);var d=jGara.cronaca.rows.length-cronaca_read.length;if(d<0&&(d=0),b!=d){var e=d-b,f=c.cron,g=e+" nuovi messaggi di cronaca ";1==e&&(g=e+" nuovo messaggio di cronaca");var h="";f.audio&&(""!=h.trim()&&(h+=","),h+=" audio"),f.foto&&(""!=h.trim()&&(h+=","),h+=" foto"),g+=h,f.text&&(g+=" - "+f.textmsg),snotify({text:g})}})});console.log("refreshcronaca");var d=jGara.cronaca.rows.length-cronaca_read.length;d<0&&(d=0),$.ajax({url:rooturl+"/matches/getcronaca/"+jcurrentgara.id,type:"GET"}).done(function(a){jGara.cronaca=a,renderCronaca(jGara.cronaca);var b=jGara.cronaca.rows.length-cronaca_read.length;if(b<0&&(b=0),d!=b){var e=b-d,f=c.cron,g=e+" nuovi messaggi di cronaca ";1==e&&(g=e+" nuovo messaggio di cronaca");var h="";f.audio&&(""!=h.trim()&&(h+=","),h+=" audio"),f.foto&&(""!=h.trim()&&(h+=","),h+=" foto"),g+=h,f.text&&(g+=" - "+f.textmsg),snotify({text:g})}})}if("resetcronaca"==b){console.log("realtime resetcronaca, letti "+cronaca_read.length);var e=a.garaid;return void deleteCronacaReadForGara(e)}updRealtimeResult(a)}),socket.on("typing",function(a){a.nickname;$("#page_chat .chattyping").html(a.nickname+" sta scrivendo...."),typingtimeout&&clearTimeout(typingtimeout),typingtimeout=setTimeout(typingTimeoutFunction,3e3)}),socket.on("sysmsg",function(a){snotify(a)}),socket.on("refreshsockets",function(a){console.log("refreshsockets"),showSockets()}),socket.on("chatmsg",function(a){console.log("chatmsg",a);var b=$("#page_chat"),c=new EJS({url:"tpl/chatsingle.ejs"}).render(a),d=$.mobile.activePage.attr("id"),e=!0;a.nickname==chatuser.nickname&&a.foto&&(e=!1),e&&b.find(".container").append(c),tapholdBubble(),"page_chat"==d&&chatScrollBottom();var f=a.nickname+" - "+a.text;if(""==a.text){var g="Immagine";a.audio&&(g="Messaggio vocale"),f=a.nickname+" - "+g}a.time.substring(8,10)+":"+a.time.substring(10,12);a.nickname!=chatuser.nickname&&(playSound("img/chat"),"page_chat"!=d&&(garanotifyid=a.garaid,snotify({text:f,garaid:a.garaid}),chatunreadcount++,setCookie("chat_unread",chatunreadcount))),setChatBubbles()}),socket.on("getnickname",function(a){console.log("getnickname: "+a.sockid),setCookie("socketid",a.sockid),chatuser.sockid=a.sockid;var b={device:"browser",type:"clientspecs",nickname:chatuser.nickname,appversion:appversion};isPhone&&(b.device="mobile"),socket.send(b)}),socket.on("notification",function(a){if(colog("received notification from socket.io server:"),colog(a),a.text&&""!=a.text.trim()&&snotify(a),a.updategara&&"yes"==a.updategara){$.mobile.activePage.attr("id");jcurrentgara&&jcurrentgara.id==a.garaid&&refreshCurrentGara(function(){})}}),socket.on("refreshgara",function(a){if(colog("received refreshgara from socket.io server:"),colog(a),a.updategara&&"yes"==a.updategara){$.mobile.activePage.attr("id");jcurrentgara&&jcurrentgara.id==a.garaid&&refreshCurrentGara()}}),socket.on("connect",function(){colog("Client has connected to the server!")}),socket.on("message",function(a){colog("Received a message from the server!"),colog(a)}),socket.on("disconnect",function(){colog("The client has disconnected!")}),$("#optionsPage #server").val(rooturl),$("#matchesatleta #dialogForAtleta").popup(),$("#gara #popResult").popup(),$("#gara  #popDelMatch").popup(),$("#gara  #popAddMatch").popup(),$("#page_atleti #atleti_categorie").panel(),bindGaraPage(),$("#menuExit").off(tapevent),$("#menuExit").on(tapevent,function(a){exitapp()}),conslog("sono qui"),loadOptions(function(){refreshAtletiServer(),refreshGareServer()}),$(document).on("pagebeforeshow",function(a){colog("pagebeforeshow"),colog("fbloggedin "+fbloggedin),fbloggedin||(window.location.href="index.html")}),$(document).on("pageshow",function(a){return colog("pageshow"),colog("fbloggedin "+fbloggedin),void(fbloggedin||(window.location.href="index.html"))}),$("#index_fb").on("pageshow",function(a){jumpToLogin()});var f=getQueryString("mode");jumpToLogin(),$("#gara #hgara a").css("width","100%"),"open"==f&&$.mobile.changePage("#index")}function jumpToLogin(){var a=getCookie("autologin");if(console.log("autologin",a),a&&"true"==String(a)){setTimeout(function(){$("#index_fb #accedi").trigger("click"),console.log("timeout passed")},500)}console.log()}function typingTimeoutFunction(){clearTimeout(typingtimeout),typingtimeout=null,$("#page_chat .chattyping").html("")}function getMatchById(a){var b={};return $(jGara.matchesbyprog.rows).each(function(c){var d=jGara.matchesbyprog.rows[c],e=d.doc,f=e.id;if(a==f)return b=e}),b}function clickVPND(a){$("#popResult .vpnd").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_"+a.toLowerCase()).prop("checked",!0).checkboxradio("refresh")}function displayRtMatches(){conslog(rtmatches)}function addMatchToRealtime(a){conslog("adding match "+a+" to realtime");var b=!1;if($(rtmatches).each(function(c){var d=rtmatches[c].id;d==a&&(b=!0)}),b)conslog("match already in realtime list");else{var c=getMatchById(a);rtmatches.push(c),conslog("added match to realtime list")}}function delMatchFromRealtime(a){$(rtmatches).each(function(b){var c=rtmatches[b].id;c==a&&(rtmatches.splice(b,1),conslog("match "+a+" removed from relatime list"))})}function sendRealtime(a){var b=!1,c=$("#popResult #matchid").val(),d=$("#popResult #matchnumber").val(),e=getConsolesIndex(c);console.log("consolesindex "+e),console.log("realtimeindex "+realtimeindex);var f="0-0",g=realtime,h="1",i=!1,j=!1,k=!1,l=!1;if(g=consoles[e],conslog("rta",g),g||console.log("no rta found"),g&&(g.result&&(f=g.result),g.round&&(h=g.round),g.running&&(j=g.running),g.paused&&(k=g.paused),g.fineround&&(i=g.fineround),g.active&&(l=g.active)),l&&(b=!0),a&&1==a&&(b=!0),b){var m="TEMPO REALE !<br> ",n="black",o="in pausa";j&&(o="IN CORSO",n="blue"),i&&(o="FINE ROUND "+h,n="black");var p="<font color='"+n+"'>Round "+h;"GP"==h&&(p="<font color='"+n+"'>GoldenPoint"),m+=" "+p,m+=", "+o,m+=", "+f+"</font>",conslog(g),g&&g.foto&&(m+="<br><img style='float: left' src='"+g.foto+"' width='60px' height='60px' />");var n="black";l&&(n="blue");var r={type:"realtime",to:"all",garaid:jcurrentgara.id,matchid:c,matchnumber:d,result:f,round:h,fineround:i,running:j,paused:k,ammoniz1:0,ammoniz2:0,event:"realtime",text:m,match:getMatchById(c),active:l};socketNotify(r),updRealtimeResult(r)}}function clickRound(a){var b=$(a).val();currentround=b;console.log("clicked round "+b),$("#popResult #ckfineround").prop("checked",!1).checkboxradio("refresh");var g="<span style='color: orange;'>IN CORSO</span>";$("#popResult label[for=ckpausematch]").html(g.replace("MATCH ","")),$("#popResult #ckpausematch").prop("checked",!0).checkboxradio("refresh"),
$("#popResult .roundnumber").css("background","silver").css("font-weight","normal"),$(a).css("background","green").css("font-weight","bold");var h=$("#popResult #ck_realtime:checked");if(h.length>0){var i=$("#popResult #matchid").val(),k=($("#popResult #matchnumber").val(),getConsolesIndex(i)),l=consoles[k];l.round=b,l.running=!0,l.paused=!1,l.fineround=!1,sendRealtime()}}function viewCronacaElements(){var a=jcurrentgara.id,b="http://tkdr.herokuapp.com/matches/viewcronacaelements/"+a;$.get(b,function(a){$("#viewCelem [data-role=content]").html(a),$("#viewCelem [data-role=content] ul").listview(),$.mobile.changePage("#viewCelem")})}function sendCronacaElements(){var a="#cronacaelements",b=!1,c={foto:!1,audio:!1,text:!1},d={text:"",image:"",sound:""},e=$(a+" #ckFotoCelem:checked").length;if(e>0?(b=b||!0,console.log("sending foto"),""!=fotodata.trim()&&(d.image=fotodata,c.foto=!0)):delete d.image,e=$(a+" #ckTestoCelem:checked").length,e>0&&(b=b||!0,console.log("sending text"),text=$(a+" textarea#testo").val(),d.text=text,c.text=!0,c.textmsg=text),e=$(a+" #ckAudioCelem:checked").length,e>0?(b=b||!0,console.log("sending audio"),console.log(sounddata),""!=sounddata.trim()&&(d.sound=sounddata,c.audio=!0)):delete d.sound,!b)return void alert("Per aggiornare la cronaca selezionare almeno un elemento testo, audio o immagine");console.log(d),progressStart("Caricamento");var f="/matches/addcronacaelement/"+jcurrentgara.id;$.ajax({type:"POST",url:rooturl+f,async:!0,data:d,success:function(a){console.log("send elements result:",a),progressStop(),$.mobile.back(),socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,event:"refreshcronaca",cron:c}),$.ajax({url:rooturl+"/matches/getcronaca/"+jcurrentgara.id,type:"GET"}).done(function(a){jGara.cronaca=a,renderCronaca(jGara.cronaca),activeTab=2,setActiveTab(activeTab)})},error:function(a){alert("errore nell'invio"),progressStop(),console.log("errore nell'invio",a)}})}function toDataUrl(a,b){var c=new XMLHttpRequest;c.responseType="blob",c.onload=function(){var a=new FileReader;a.onloadend=function(){b(a.result)},a.readAsDataURL(c.response)},c.open("GET",a),c.send()}function getChatAudio(){}function getChatFoto(){if(!navigator.camera)return conslog("Camera API not supported in getFoto"),void toDataUrl(defaultimage,function(a){fotodata=a});var a={quality:100,destinationType:Camera.DestinationType.DATA_URL,sourceType:1,encodingType:0,targetWidth:800,targetHeight:800,correctOrientation:!0};navigator.camera.getPicture(function(a){conslog("photo length: "+a.length);var b="data:image/jpeg;base64,"+a,c={garaid:"",nickname:chatuser.nickname,sockid:chatuser.sockid,foto:b,text:""};console.log(c);var d=new EJS({url:"tpl/chatsingle.ejs"}).render(c);$("#page_chat").find(".container").append(d),chatScrollBottom(),postChat(c)},function(){console.log("Error taking picture","Error")},a)}function getFoto(){if(!navigator.camera)return conslog("Camera API not supported in getFoto"),$(".fotoview").css("background-image","url("+defaultimage+")").css("width","100%").css("height","300px"),toDataUrl(defaultimage,function(a){fotodata=a}),void $(".fotoview").show();var a={quality:25,destinationType:Camera.DestinationType.DATA_URL,sourceType:1,encodingType:0,targetWidth:500,targetHeight:500,correctOrientation:!0};navigator.camera.getPicture(function(a){$(".fotoview img").attr("src","url(data:image/jpeg;base64,"+a+")"),$(".fotoview").css("background-image","url(data:image/jpeg;base64,"+a+")").css("width","100%").css("height","250px"),$(".fotoview").show(),conslog("photo length: "+a.length),fotodata="data:image/jpeg;base64,"+a},function(){alert("Error taking picture","Error")},a)}function sendFoto(){realtime.foto=fotodata,sendRealtime(),delete realtime.foto,$.mobile.back()}function createCronacaElement(){return conslog("createCronacaElement"),$("#cronacaelements .fotoview").css("width","100%"),void $.mobile.changePage("#cronacaelements")}function clickRealtime(){var a=$("#popResult #ck_realtime:checked"),b=$("#popResult #realtimediv"),c=$("#popResult #risult").val(),d=$("#popResult #matchid").val(),f=($("#popResult #matchnumber").val(),"Tempo reale"),g="black",h=!1,i="0-0";if(a.length>0){b.show(),g="lightgreen",f="TEMPO REALE ATTIVO",h=!0,i=c;({active:!0,match:getMatchById(d),result:"0-0",round:"1",paused:!0,running:!1});$("#popResult .roundnumber").css("background","silver")}else b.hide(),g="black",f="Tempo reale",h=!1;var k="<span style='color: "+g+";'>"+f+"</span>";$("#popResult label[for=ck_realtime]").html(k.replace("MATCH ",""));var l="/matches/update/"+jcurrentgara.id+"/"+d,m={realtime:h},n="disattivato";h&&(n="attivato"),console.log("realtimeindex before call: "+realtimeindex),$.post(rooturl+l,m,function(){console.log("realtime setted to "+h+" for matchid "+d),refreshCurrentGara(function(){refreshChat(!0),renderRealtimeTabs(),""!=lastDisplayedAtletaId.trim()&&showMatchesForAtleta(lastDisplayedAtletaId),renderRealtimeTabs(),renderConsoleTabs()}),settings.notifiche&&socketNotify({type:"notification",to:"all",text:"",garaid:jcurrentgara.id,updategara:"yes"})})}function getConsolesIndex(a){for(var b=0;b<consoles.length;b++){var c=consoles[b].match.id;if(c==a)return b}}function clickPausa(){conslog("clicked fine round");var a=$("#popResult #ckfineround:checked").length,b=realtimeArray[realtimeindex],c=$("#popResult #matchid").val(),d=$("#popResult #matchnumber").val(),e=getConsolesIndex(c);b=consoles[e];var f=!1,g="black",h="MATCH IN PAUSA";if(a>0?(conslog("checked"),f=!0,b.fineround=!0,b.running=!1,b.paused=!0,g="black",h="MATCH IN PAUSA"):(b.fineround=!1,b.running=!0,b.paused=!1),0==a&&conslog("unchecked"),b.fineround){$("#popResult #ckpausematch").prop("checked",!1).checkboxradio("refresh");var i="<span style='color: "+g+";'>"+h+"</span>";$("#popResult label[for=ckpausematch]").html(i.replace("MATCH ",""))}var j=$("#popResult #ck_realtime:checked"),k="Fine match n."+currentround;"gp"==currentround.toLowerCase()&&(k="Fine GoldenPoint"),j.length>0&&(console.log("notify realtime result for "+d),b.active=!0,realtime.active=!0,realtime.running=!f,realtime.fineround=f,sendRealtime())}function clickPauseMatch(){console.log("clicked pausa match");var a=$("#popResult #ckpausematch:checked").length,b="MATCH IN PAUSA",c="black",d=$("#popResult #matchid").val(),e=$("#popResult #matchnumber").val(),f=getConsolesIndex(d),g=consoles[f];console.log(g),a>0?(console.log("checked, match in corso"),b="MATCH IN CORSO",c="orange",g.paused=!1,g.running=!0,g.fineround=!1):(console.log("unchecked, match in pausa"),b="MATCH IN PAUSA",c="black",g.running=!1,g.fineround=!1,g.paused=!0),$("#popResult #ckfineround").prop("checked",g.fineround).checkboxradio("refresh");var h="<span style='color: "+c+";'>"+b+"</span>";$("#popResult label[for=ckpausematch]").html(h.replace("MATCH ",""));var i=$("#popResult #ck_realtime:checked"),j="Round "+currentround+", "+b+", punteggio: "+currentresult;"gp"==currentround.toLowerCase()&&(j="GoldenPoint, "+b+", punteggio: "+currentresult),i.length>0&&(console.log("notify realtime result for "+e),g.active=!0,sendRealtime())}function refreshRealtime(a){conslog("refreshrealtime");for(var b=0;b<a.rows.length;b++){var c=a.rows[b],d=c.doc,e=!1;d.realtime&&"true"==String(d.realtime)&&(e=!0);var f={active:e,garaid:d.garaid,matchid:d.id,match:d};if(e){for(var g=!1,h=0;h<realtimeArray.length;h++)d.id==realtimeArray[h].match.id&&(g=!0,conslog("!!! match "+d.id+" already in realtimearray, will not touch it"));g||(conslog("match "+d.id+" not found in realtimearray, pushing it"),realtimeArray.push(f));for(var i=!1,j=0;j<consoles.length;j++){var k=consoles[j],l=k.match;l.id==d.id&&(i=!0)}i||(consoles.push(f),conslog("realtime match "+d.id+" not found in consoles, adding it"))}else deleteFromRealtimeArray(d.garaid+"_"+d.id)}var m=new EJS({url:"tpl/matchesrealtime2.ejs"}).render(realtimeArray);$("#page_chat .chatrealtime .rtul").empty().append(m)}function updRealtimeResult(a){var b=a.matchid,c=a.result,f=(a.ammoniz1,a.match,a.event);conslog("updateRealtimeResult "+b+" - "+c);for(var h=0;h<realtimeArray.length;h++){var i=realtimeArray[h];i.match.id==b&&(realtimeArray[h]=a,conslog("found this match in realtimearray, setting its data to "),conslog(realtimeArray[h]))}var j=a.text;"true"==String(a.active)&&(j="<font style='color: blue'>"+a.text+"</font>"),realtimeArray.length>0?($("#index #lichat a table tr td:eq(1)").css("color","lightgreen").html("Chatkwondo - Tempo reale"),$("#gara #lichat a").css("color","lightgreen").html("Chatkwondo - Tempo reale").css("font-weight","bold")):($("#index #lichat a table tr td:eq(1)").css("color","black").html("Chatkwondo"),$("#gara #lichat a").css("color","white").html("Chatkwondo").css("font-weight","normal")),$("#page_chat .chatrealtime .rtul li").each(function(){var c=$(this).attr("id").replace("match_",""),d=$(this).find("a");c==b&&($(this).css(""),colog("found match to update in realtime"),"matchupdate"==f?(d.find("span.soft").html(j),d.find("img.imgicon").attr("src","images/greenblink.gif")):"matchstart"==f?d.find("img.imgicon").attr("src","images/greenblink.gif"):a.active&&(conslog("realtime active !"),0==d.find("span.realtime").length&&(d.find("div").append("<span class='realtime'></span>"),conslog("creating realtime div "+d.find("span.realtime").length),conslog(j)),d.find("span.vinto").hide(),d.find("span.realtime").html(j),0==d.find("img.blinkicon").length&&d.prepend("<img src='images/greenblink.gif' class='imgicon blinkicon' />"),d.find("img.imgicon:eq(1)").hide(),d.find("span.vinto").hide()))})}function updRealtimeResult_old(a){var b=a.matchid,c=a.result,f=(a.ammoniz1,a.match,a.event);conslog("updateRealtimeResult "+b+" - "+c),conslog("updrealtimeresult "),conslog(a),conslog("rtarray: ",realtimeArray);var g=a.text;a.active&&(g="<font style='color: blue'>"+a.text+"</font>"),$("#page_chat .chatrealtime .rtul li").each(function(){var c=$(this).attr("id").replace("match_",""),d=$(this).find("a");c==b&&($(this).css(""),colog("found match to update in realtime"),"matchupdate"==f?(d.find("span.soft").html(g),d.find("img.imgicon").attr("src","images/greenblink.gif")):"matchstart"==f?d.find("img.imgicon").attr("src","images/greenblink.gif"):a.active?(conslog("realtime active !"),0==d.find("span.realtime").length&&(d.find("div").append("<span class='realtime'></span>"),console.log("creating realtime div "+d.find("span.realtime").length),console.log(g)),d.find("span.vinto").hide(),d.find("span.realtime").html(g),0==d.find("img.blinkicon").length&&d.prepend("<img src='images/greenblink.gif' class='imgicon blinkicon' />"),d.find("img.imgicon:eq(1)").hide(),d.find("span.vinto").hide()):(conslog("realtime not active !"),d.find("span.realtime").remove(),d.find("span.vinto").show(),d.find("img.blinkicon").remove(),d.find("img.imgicon:first").show(),d.find("span.vinto").show()))})}function exitapp(){app.exit()}function setChatBubbles(){var a=chatunreadcount;a>0?($("#gara #chatgarabubble").html(a).show(),$("#index #chatcountbubble").html(a).show()):($("#gara #chatgarabubble").html("0").hide(),$("#index #chatcountbubble").html("0").hide()),setBadge()}function refreshGareServer(a){var c=($.mobile.activePage.attr("id"),imgtext+"Caricamento....");$("#gare #recnum span").html(c),app.loadAllGare(function(b){if(b.error)myToast({body:"errore"});else{conslog("Gare caricate da "+rooturl),$gare=b;var c=$("#listagare");c.html("");var d='<li data-role="list-divider" role="heading" data-theme="b">'+b.rows.length+" gare</li>";c.append(d),b.rows.sort(function(a,b){if(a.doc.data&&b.doc.data){var c=getNormalD(a.doc.data),d=getNormalD(b.doc.data);if(c>d)return-1;if(c<d)return 1}return 0}),a&&(b=filterRows(b,{stato:a},!0));var e=new EJS({url:"tpl/gare.ejs"}).render(b.rows);c.empty().append(e),progressStop(),$("#gare #recnum span").html(b.rows.length+" gare"),c.find("li").off(tapevent),c.find("li").on(tapevent,function(){playFeedback();var a=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+a),$("#gara #listabyprog").empty(),setCookie("lastcronaca",""),$.mobile.changePage("#gara"),openGara(a,function(){garaid=a,$gara=b}),!1}),c.find("li").off("taphold"),c.find("li").on("taphold",function(){if("tkdradmin"==role){var a=$(this).find("a").attr("id").split("_")[0],b=$(this).find("a").attr("id").split("_")[1],c=getGaraById(a);colog(c);var d={id:a,rev:b,doc:c.doc},e=new EJS({url:"tpl/popgare.ejs"}).render(d);$("#gare div[data-role=content] #popGare").remove(),$("#gare div[data-role=content]").append(e),$("#gare #popGare #ulpopgare").listview(),$("#gare #popGare").popup(),$("#gare #popGare").popup("open")}}),c.listview(),c.listview("refresh")}})}function markGara(a,b){var c={id:a,stato:b};$.ajax({url:rooturl+"/gare/update",type:"POST",data:c}).done(function(a){popGareCancel(),refreshGareServer()})}function editGara(a){console.log("editgara");var b=getGaraById(a),c=$("#page_editgara");c.find(".jform").each(function(){var a=$(this).attr("id");$(this).val(b.doc[a])}),$.mobile.changePage("#page_editgara"),popGareCancel()}function editGaraOk(){var a=$("#page_editgara #id").val(),b={id:a},c=$("#page_editgara"),d=checkValidGaraForm(c);return 1==d.error?void alert("Errore di inserimento:\n\n"+d.errors):(c.find(".jform").each(function(){var a=$(this).attr("id");b[a]=$(this).val()}),console.log(b),void $.ajax({url:rooturl+"/gare/update",type:"POST",data:b}).done(function(a){a.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#gare"),refreshGareServer())}).fail(function(){myToast({body:"Error posting"})}))}function refreshCurrentGara(a){autorefreshcount=0;var b=imgtext+"Refresh in corso...";$("#gara .medals").html(b);var c=jcurrentgara.id;conslog("refreshCurrentGara - id= "+c),openGara(c,a)}function popGareCloseRemove(){$("#gare #popGare").popup("close").remove()}function loadFullGaraById(a,b){$.ajax({url:rooturl+"/gare/fullgarabyid/"+a+"?societaid="+settings.mysocieta,dataType:"json",type:"GET"}).done(function(a){b&&b(a)})}function renderGaraInfo(a){var b="";isFiltered&&(b=" (filtri applicati) ");var c=filterRows(a,{dadisputare:"yes"}),d=filterRows(c,{disputato:"yes"});colog("$C--->"+JSON.stringify(d));var e=filterRows(d,{vinto:"yes"}),f=filterRows(d,{vinto:"no"}),g=d.rows.length-e.rows.length,h=getMaschiFemmine(c.rows),i=c.rows.length+" match da disputare ( M: "+h.maschi+", F: "+h.femmine+" )";h=getMaschiFemmine(e.rows);var j=getMaschiFemmine(d.rows),k=getMaschiFemmine(f.rows);i+="<br>"+d.rows.length+" match disputati ( M: "+j.maschi+", F: "+j.femmine+" ) <br>"+e.rows.length+" vinti ( M: "+h.maschi+", F: "+h.femmine+" ) <br>"+g+" persi ( M: "+k.maschi+", F: "+k.femmine+" )"+b,$("#limatches").html(i);var l=filterRows(d,{medagliamatch:"oro"}),m=filterRows(d,{medagliamatch:"argento"}),n=filterRows(d,{medagliamatch:"bronzo"}),o=getMaschiFemmine(l.rows),p=getMaschiFemmine(m.rows),q=getMaschiFemmine(n.rows);i="ORI: "+l.rows.length+" ( M: "+o.maschi+", F: "+o.femmine+" ) - punti: "+getPunti(l.rows.length,0,0)+"<br>ARGENTI: "+m.rows.length+" ( M: "+p.maschi+", F: "+p.femmine+" ) - punti: "+getPunti(0,m.rows.length,0)+"<br>BRONZI: "+n.rows.length+" ( M: "+q.maschi+", F: "+q.femmine+" ) - punti: "+getPunti(0,0,n.rows.length)+"<br><br>Punteggio totale medaglie: "+getPunti(l.rows.length,m.rows.length,n.rows.length)+" "+b,$("#limedaglie").html(i);var r=new Date,s=r.toLocaleDateString()+" "+r.toLocaleTimeString();$("#lilastupdate").html("<span color=gray><i>Ultimo aggiornamento: "+s+"</i></span>"),$("#gara #ulinfogara span").html(getMedaglieGara(a)),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var b=($(this).index(),$(this).children("a").attr("data-tab-class"));$("."+prevSelection).addClass("ui-screen-hidden"),$("."+b).removeClass("ui-screen-hidden"),prevSelection=b,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var c=$(this).find("a").attr("data-tab-class");$("#gara .ul"+c).show()})}function openGara(a,b){colog("opengara "+a),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var a=$(this).index(),b=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+b).removeClass("ui-screen-hidden"),prevSelection=b,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var c=$(this).find("a").attr("data-tab-class");$("#gara .ul"+c).show(),activeTab=a,cacheViews()});var c=imgtext+"Caricamento...";$("#gara .medals").html(c),loadFullGaraById(a,function(a){jGara=a,jcurrentgara=a.gara.rows[0].doc,jmatchesbyprog=a.matchesbyprog,jmatchesbyprog=filterMatches(a.matchesbyprog.rows,!0),jmatchesbyatleta=filterMatchesByAtleta(a.matchesbyatleta.rows),renderMatchesByProg(jmatchesbyprog),renderMatchesByAtleta(jmatchesbyatleta),renderCronaca(a.cronaca),renderGaraInfo(jmatchesbyprog),refreshRealtime(jmatchesbyprog);var c={doc:jcurrentgara};$("#gara #hdr").find("#hgara a").html(c.doc.location+" -     "+c.doc.data),$("#gara #hdriscritti").find("h1").html(c.doc.title+" "+c.doc.location+" -     "+c.doc.data);var d=[];c.doc.myiscritti&&(d=c.doc.myiscritti.split(","));var e=d.length,f="";iscrittiincat=[],iscrittiincat=filterIscritti(d),e=iscrittiincat.length,mf=getMaschiFemmine(iscrittiincat,"iscritti"),$("#gara #lisocieta").html("<b>"+settings.mysocietaname+"</b>"),$("#gara #ligaratitle").html("Gara: <b>"+c.doc.title+"</b>");var g="";c.doc.maplocation&&""!=c.doc.maplocation.trim()&&(g="&nbsp;&nbsp;<a sclass='ui-btn ui-mini' href='#' onclick='garaMaps()' class='pulsante' style='width:40px;'>Mappa</a>"),$("#gara #ligaralocation").html("Location: "+c.doc.location+g),$("#liiscritti").text(e+" atleti iscritti"+f+" --  F: "+mf.femmine+" M: "+mf.maschi),setChatBubbles(),$("#gara #hgara a").css("width","100%");for(var h=0;h<consoles.length;h++){var i=consoles[h],j=i.match,k=getMatchById(j.id);i.match=k;var l=k.realtime;i.active=l}b&&b(),colog("stato gara: "+jcurrentgara.stato),"disputata"==jcurrentgara.stato?$("#iscrittiPage #btnAddIscritto").hide():"tkdradmin"==role&&$("#iscrittiPage #btnAddIscritto").show()})}function doLogin(){console.log("socket",socket),socket||(socket=io.connect(rooturl)),console.log("socket",socket);var a=$("#login"),b=a.find("#txt-email").val(),c=a.find("#txt-password").val(),d=a.find("#chck-rememberme").prop("checked"),e=a.find("#chck-autologin").prop("checked"),f=rooturl+"/atleti/login";conslog("Accessing url "+f),progressStart("Accesso in corso...","Log-in"),$.ajax({url:f,data:{email:b,password:c},type:"POST"}).done(function(a){if(progressStop(),colog("login result: "+JSON.stringify(a)),role=a.role,loggedin=!0,"true"==a.loggedin){myToast({body:"login eseguito con successo"}),chatuser.nickname=b;var f={device:"browser",type:"clientspecs",nickname:chatuser.nickname,appversion:appversion};isPhone&&(f.device="mobile"),socket.send(f),"tkdradmin"==role?($("#index .loginspan").html("Accesso amministratore eseguito"),$("#index #lilogout").show(),$("#index #lilogin").hide(),$("#index #liatleti").show(),$("#index #lisockets").show(),$("#gara #liresetcronaca").show(),$("#gara #lisysmsg").show(),$("#gare #liaggiungigara").show(),$("#page_atleti #liaggiungiatleta").show(),$("#iscrittiPage #btnAddIscritto").show(),$("#gare #test").show(),$(".showadmin").show()):$(".showadmin").hide(),console.log("ckal: "+e),e&&(console.log("setting autologin true"),setCookie("autologin","true",cookieDays)),d?(setCookie("email",b,cookieDays),setCookie("psw",c,cookieDays),colog("setted rememberme cookies")):(deleteCookie("email"),deleteCookie("psw"),colog("deleted rememberme cookies")),$.mobile.changePage("#index"),refreshNews(),conslog("sono qui qui"),updateHomeInfos()}else $("#login #dlg-invalid-credentials").popup().popup("open"),deleteCookie("email"),deleteCookie("psw"),deleteCookie("autologin"),$("#index .loginspan").html(""),console.log("showin login page"),showLoginPage()}).fail(function(a){progressStop(),conslog("error:"),conslog(a),myToast({body:"Error"})})}function refreshNews(a){$.ajax({url:rooturl+"/news",dataType:"json",type:"GET"}).done(function(b){var c=new EJS({url:"tpl/news.ejs"}).render(b.rows);$("#page_news #content").html(c),a&&a(b)})}function initTabs(){$("#gara a[data-role=tab]").each(function(a){$(this).unbind(tapevent),$(this).bind(tapevent,function(){sdebug($(this).attr("id")),activeTab=a,setActiveTab(activeTab)})})}function setActiveTab(a){return void $("#gara #navbar ul li:eq("+a+")").trigger("vclick")}function loadCronaca(a,b){colog("loadcronaca for gara "+a),$.ajax({url:rooturl+"/matches/getcronaca/"+a,type:"GET"}).done(function(c){if($("#gara #listacronaca").empty(),c.error)console.log("error reading cronaca for this gara id="+a);else{console.log("cronaca: "+c.rows.length),colog(c);c.rows;cronaca=c,jGara.cronaca=cronaca,renderCronaca(cronaca)}b&&b()})}function setCronacaRead(a){var b=jcurrentgara.id+"_"+a;"disputata"!=jcurrentgara.stato.toLowerCase()&&(cronaca_read.indexOf(b)==-1&&(cronaca_read.push(b),crnonletti++),renderCronaca(jGara.cronaca))}function findCronacaRead(a){var b=!1,c=jcurrentgara.stato;conslog("status",c);var d=jcurrentgara.id+"_"+a.time;return cronaca_read.indexOf(d)>-1&&(b=!0),b}function findCronacaUnread(a){var b=!1;return $(cronaca_unread).each(function(c){var d=cronaca_unread[c];conslog("crow",d),d.time==a.time&&d.garaid==jcurrentgara.id&&(b=!0,conslog("questo non è stato letto"))}),b}function renderCronaca(a){var b=cronaca_read.length,c=a.rows.length-b;conslog("non letti prima del <0: "+c);var d=jcurrentgara.stato.toLowerCase();"disputata"==d&&(c=0,deleteCronacaReadForGara(jcurrentgara.id)),c<0&&(c=0,deleteCronacaReadForGara(jcurrentgara.id)),setCookie("cronaca_read",JSON.stringify(cronaca_read)),conslog("cronaca non letti per questa gara: "+c),conslog("cronaca letti per questa gara",b),conslog("cronaca non letti globale: "+crnonletti);var e=new EJS({url:"tpl/cronaca2.ejs"}).render(a);$("#gara #listacronaca").empty(),$("#gara #listacronaca").append(e),$("#gara #listacronaca").listview(),$("#gara #listacronaca").listview("refresh")}function getPunti(a,b,c){var d=0;return d=7*a+3*b+1*c}function resetFilters(){$("#temppopup #sex").val("_"),$("#temppopup #categ").val("_"),$("#temppopup #medag").val("_"),$("#temppopup #quadrato").val("_")}function setFilters(){var a="";$("#temppopup #sex").val()&&(a=$("#temppopup #sex").val()),"_"==a&&(a="");var b="";$("#temppopup #categ").val()&&(b=$("#temppopup #categ").val()),"_"==b&&(b="");var c="";$("#temppopup #medag").val()&&(c=$("#temppopup #medag").val()),"_"==c&&(c="");var d="";$("#temppopup #quadrato").val()&&(d=$("#temppopup #quadrato").val()),"_"==d&&(d=""),garaFilters={categoria:b.toLowerCase().trim(),sesso:a,medaglia:c,quadrato:d};var e="<font color='yellow'><b>Filtri applicati</b></font>",f="2px solid yellow";""==garaFilters.categoria&&""==garaFilters.sesso&&""==garaFilters.medaglia&&""==garaFilters.quadrato&&(e="Nessun filtro",f="0px solid white"),$("#gara .spanfilt").html(e).css("border",f),popCloseRemove(),refreshCurrentGara()}function loadMatchesByProgOld(a,b){var c={matches:$allmatches,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(c,b),colog("loadmatchesbyprog "+a),$.ajax({url:rooturl+"/matches/findbygaraid/"+a+"?societa="+settings.mysocieta,type:"GET"}).done(function(a){$matches=a,$allmatches=a,colog("total matches: "+$matches.rows.length);var b=[];if(""!=cat){var b={rows:[]};$(a.rows).each(function(c){var d=a.rows[c].doc.datanascita;colog("datanascita: "+d),getCategoria(d).toLowerCase()==cat.toLowerCase()&&b.rows.push(a.rows[c])}),$matches=b,colog("matches after categoria "+cat+": "+$matches.rows.length)}var d=new EJS({url:"tpl/matchesbyprog2.ejs"}).render($matches.rows),e="listabyprog",f=$("#gara ul#"+e);f.empty(),f.append(d),f.listview(),f.listview("refresh");var g="";""!=$.trim(viewcat)&&(g=" in cat. "+viewcat.toUpperCase()),colog("$allmatches for cat "+viewcat+"-------->"+JSON.stringify($allmatches));var h=filterRows($matches,{dadisputare:"yes"}),i=filterRows(h,{disputato:"yes"});colog("$C--->"+JSON.stringify(i));var j=filterRows(i,{vinto:"yes"}),k=filterRows(i,{vinto:"no"}),l=i.rows.length-j.rows.length,m=getMaschiFemmine(h.rows),n=h.rows.length+" match da disputare ( M: "+m.maschi+", F: "+m.femmine+" )";m=getMaschiFemmine(j.rows);var o=getMaschiFemmine(i.rows),p=getMaschiFemmine(k.rows);n+="<br>"+i.rows.length+" match disputati ( M: "+o.maschi+", F: "+o.femmine+" ) <br>"+j.rows.length+" vinti ( M: "+m.maschi+", F: "+m.femmine+" ) <br>"+l+" persi ( M: "+p.maschi+", F: "+p.femmine+" )"+g,$("#limatches").html(n);var q=filterRows(i,{medagliamatch:"oro"}),r=filterRows(i,{medagliamatch:"argento"}),s=filterRows(i,{medagliamatch:"bronzo"}),t=getMaschiFemmine(q.rows),u=getMaschiFemmine(r.rows),v=getMaschiFemmine(s.rows);n="ORI: "+q.rows.length+" ( M: "+t.maschi+", F: "+t.femmine+" ) - punti: "+getPunti(q.rows.length,0,0)+"<br>ARGENTI: "+r.rows.length+" ( M: "+u.maschi+", F: "+u.femmine+" ) - punti: "+getPunti(0,r.rows.length,0)+"<br>BRONZI: "+s.rows.length+" ( M: "+v.maschi+", F: "+v.femmine+" ) - punti: "+getPunti(0,0,s.rows.length)+"<br><br>Punteggio totale medaglie: "+getPunti(q.rows.length,r.rows.length,s.rows.length)+" "+g,$("#limedaglie").html(n),$("#gara #ulinfogara span").html(getMedaglieGara($matches)),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var a=$(this).index(),b=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+b).removeClass("ui-screen-hidden"),prevSelection=b,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var d=$(this).find("a").attr("data-tab-class");$("#gara .ul"+d).show(),activeTab=a,cacheViews(),c.callback&&c.callback()}),setActiveTab(activeTab)})}function cacheViews(){}function filterMatches(a,b){b||(b=!1);var c={rows:[]},d=!1;return $(a).each(function(e){var g="",h="",i="",j="",k="";b?(g=a[e].doc.datanascita,h=a[e].doc.medagliamatch,i=a[e].doc.matchid,j=i.substring(0,i.length-2),k=a[e].doc.atletaid):(g=a[e].datanascita,h=a[e].medagliamatch,i=a[e].matchid,j=i.substring(0,i.length-2),k=a[e].atletaid),colog("datanascita: "+g);var l=!0;for(f in garaFilters)if(""!=garaFilters[f]){if(d=!0,"categoria"==f){var m=getCategoria(g).toLowerCase().trim()!=garaFilters.categoria.toLowerCase().trim();garaFilters.categoria.toLowerCase().trim().indexOf("senior")>-1&&(m=getCategoria(g).toLowerCase().trim().indexOf("senior")==-1),m&&(l=l&&!1)}if("medaglia"==f&&h.toLowerCase().trim()!=garaFilters.medaglia.toLowerCase().trim()&&(l=l&&!1),"quadrato"==f&&j.toLowerCase().trim()!=garaFilters.quadrato.toLowerCase().trim()&&(l=l&&!1),"sesso"==f){$a=getAtletaById(k);var n=$a.sesso;n.toLowerCase().trim()!=garaFilters.sesso.toLowerCase().trim()&&(l=l&&!1)}}d?l&&c.rows.push(a[e]):c.rows.push(a[e])}),isFiltered=d,c}function filterMatchesByAtleta(a,b){b||(b=!1);var c={rows:[]},d=!1;return $(a).each(function(e){var g="",k="";b?(g=a[e].doc.datanascita,k=a[e].doc.id):(g=a[e].datanascita,k=a[e].id),colog("datanascita: "+g);var l=!0;for(f in garaFilters)if(""!=garaFilters[f]){if(d=!0,"categoria"==f){var m=getCategoria(g).toLowerCase().trim()!=garaFilters.categoria.toLowerCase().trim();garaFilters.categoria.toLowerCase().trim().indexOf("senior")>-1&&(m=getCategoria(g).toLowerCase().trim().indexOf("senior")==-1),m&&(l=l&&!1)}if("sesso"==f){$a=getAtletaById(k);var n=$a.sesso;n.toLowerCase().trim()!=garaFilters.sesso.toLowerCase().trim()&&(l=l&&!1)}}d?l&&c.rows.push(a[e]):c.rows.push(a[e])}),isFiltered=d,c}function loadMatchesByProg(a,b){var c={matches:$allmatches,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(c,b),colog("loadmatchesbyprog "+a),$.ajax({url:rooturl+"/matches/findbygaraid/"+a+"?societa="+settings.mysocieta,type:"GET"}).done(function(a){$matches=a,$allmatches=a,colog("total matches: "+$matches.rows.length);var b={rows:[]};b=filterMatches(a.rows,!0),$matches=b,colog("matches after categoria "+cat+": "+$matches.rows.length),jmatchesbyprog=$matches,renderMatchesByProg();var d="";isFiltered&&(d=" (filtri applicati) "),colog("$allmatches -------->"+JSON.stringify($allmatches));var e=filterRows($matches,{dadisputare:"yes"}),f=filterRows(e,{disputato:"yes"});colog("$C--->"+JSON.stringify(f));var g=filterRows(f,{vinto:"yes"}),h=filterRows(f,{vinto:"no"}),i=f.rows.length-g.rows.length,j=getMaschiFemmine(e.rows),k=e.rows.length+" match da disputare ( M: "+j.maschi+", F: "+j.femmine+" )";j=getMaschiFemmine(g.rows);var l=getMaschiFemmine(f.rows),m=getMaschiFemmine(h.rows);k+="<br>"+f.rows.length+" match disputati ( M: "+l.maschi+", F: "+l.femmine+" ) <br>"+g.rows.length+" vinti ( M: "+j.maschi+", F: "+j.femmine+" ) <br>"+i+" persi ( M: "+m.maschi+", F: "+m.femmine+" )"+d,$("#limatches").html(k);var n=filterRows(f,{medagliamatch:"oro"}),o=filterRows(f,{medagliamatch:"argento"}),p=filterRows(f,{medagliamatch:"bronzo"}),q=getMaschiFemmine(n.rows),r=getMaschiFemmine(o.rows),s=getMaschiFemmine(p.rows);k="ORI: "+n.rows.length+" ( M: "+q.maschi+", F: "+q.femmine+" ) - punti: "+getPunti(n.rows.length,0,0)+"<br>ARGENTI: "+o.rows.length+" ( M: "+r.maschi+", F: "+r.femmine+" ) - punti: "+getPunti(0,o.rows.length,0)+"<br>BRONZI: "+p.rows.length+" ( M: "+s.maschi+", F: "+s.femmine+" ) - punti: "+getPunti(0,0,p.rows.length)+"<br><br>Punteggio totale medaglie: "+getPunti(n.rows.length,o.rows.length,p.rows.length)+" "+d,$("#limedaglie").html(k),$("#gara #ulinfogara span").html(getMedaglieGara($matches)),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var a=$(this).index(),b=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+b).removeClass("ui-screen-hidden"),prevSelection=b,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var d=$(this).find("a").attr("data-tab-class");$("#gara .ul"+d).show(),activeTab=a,cacheViews(),c.callback&&c.callback()}),setActiveTab(activeTab)})}function renderMatchesByProg(a){var b=new EJS({url:"tpl/matchesbyprog2.ejs"}).render(a.rows),c="listabyprog",d=$("#gara ul#"+c);if(d.empty(),d.append(b),d.listview(),d.listview("refresh"),$("#gara #nomatches").hide(),"tkdradmin"==role&&(d.find("li").off("taphold"),d.find("li").on("taphold",function(){var b=$(this).index(),c=a.rows[b].doc;conslog(c.doc);var d="Attivazione",e=!0;c.realtime&&"true"==String(c.realtime)&&(e=!1,d="Disattivazione"),gConfirm(d+" TempoReale per il match "+c.matchid+" ?",d+" TempoReale",function(){selectedid=c.id,selectedmatchid=c.matchid,realtime.active=e;var a="/matches/update/"+c.garaid+"/"+c.id,b={realtime:e},d="disattivato";e&&(d="attivato"),$.post(rooturl+a,b,function(){console.log("realtime setted to "+realtime.active+" for matchid "+selectedid),refreshCurrentGara(function(){refreshChat(!0);var a=-1;if("true"==String(realtime.active)){for(var b=0;b<realtimeArray.length;b++)realtimeArray[b].match.id==selectedid&&(a=b);conslog("realtimeindex: ",a),realtimeindex=a}sendRealtime(!0)}),settings.notifiche&&socketNotify({type:"notification",to:"all",text:"",garaid:c.garaid,updategara:"yes"})}),socketNotify({type:"realtime",to:"all",garaid:c.garaid,matchid:c.id,matchnumber:c.matchid,result:"0-0",ammoniz1:"0",ammoniz2:"0",event:"startmatch",text:"startmatch"
})},function(){})})),0==a.rows.length){var e=refreshIscritti(!0);b=new EJS({url:"tpl/iscritti.ejs"}).render(e);var f=$("#gara #nomatches ul.iscritti_nomatches");f.empty(),f.append(b),f.listview(),f.listview("refresh");var g=$("#gara p.iscrittilength");g.html(e.length+" iscritti a questa gara"),isFiltered||$("#gara #nomatches").show()}}function loadMatchesByAtletaOld(a){colog("loadmatchesbyatleta "+a),$.ajax({url:rooturl+"/matches/findbygaraid/byatleta/"+a+"?societa="+settings.mysocieta,type:"GET"}).done(function(a){var b=a;if(colog("total matches: "+b.length),""!=cat){var c=[];$(a).each(function(b){var d=a[b].datanascita;colog("datanascita: "+d),getCategoria(d).toLowerCase()==cat.toLowerCase()&&c.push(a[b])}),b=c,colog("matches after categoria "+cat+": "+b.length)}var d=new EJS({url:"tpl/matchesbyatleta4.ejs"}).render(b),e="listabyatleta",f=$("ul#"+e);f.empty(),f.append(d),f.listview(),f.listview("refresh"),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var a=$(this).index(),b=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+b).removeClass("ui-screen-hidden"),prevSelection=b,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var c=$(this).find("a").attr("data-tab-class");$("#gara .ul"+c).show(),activeTab=a,cacheViews()}),setActiveTab(activeTab)})}function loadMatchesByAtleta(a){colog("loadmatchesbyatleta "+a),$.ajax({url:rooturl+"/matches/findbygaraid/byatleta/"+a+"?societa="+settings.mysocieta,type:"GET"}).done(function(a){var b=a;colog("total matches: "+b.length);var c=[],d=!1;$(a).each(function(b){var e=a[b].datanascita,f=a[b].id;colog("datanascita: "+e);var g=!0;for(var h in garaFilters)if(""!=garaFilters[h]&&(d=!0,"categoria"==h&&(garaFilters[h].toLowerCase().trim().indexOf("senior")>-1?getCategoria(e).toLowerCase().trim().indexOf("senior")==-1&&(g=g&&!1):getCategoria(e).toLowerCase().trim()!=garaFilters.categoria.toLowerCase().trim()&&(g=g&&!1)),"sesso"==h)){var i=getAtletaById(f),j=i.sesso;j.toLowerCase().trim()!=garaFilters.sesso.toLowerCase().trim()&&(g=g&&!1)}d?g&&c.push(a[b]):c.push(a[b])}),isFiltered=d,b=c,colog("matches after categoria "+cat+": "+b.length),renderMatchesByAtleta(b)})}function renderMatchesByAtleta(a){conslog(a);var b=new EJS({url:"tpl/matchesbyatleta4.ejs"}).render(a),c="listabyatleta",d=$("ul#"+c);d.empty(),d.append(b),d.listview(),d.listview("refresh"),$("#gara #navbar ul li").unbind(tapevent).bind(tapevent,function(){var a=$(this).index(),b=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+b).removeClass("ui-screen-hidden"),prevSelection=b,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var c=$(this).find("a").attr("data-tab-class");$("#gara .ul"+c).show(),activeTab=a,cacheViews(),setActiveTab(activeTab)})}function refreshMeByProg(a){var b=$matches;sdebug("$mm.lenght: "+b.find("match").length);var c={matches:b,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(c,a);var d=c.matches;sdebug("refreshMeByProg matches: "+d.find("match").length+" - shownullmatches: "+c.showNullMatches+" - ulSelector: "+c.ulSelector),refreshMode="byprog";var e=$.parseXML("<matches></matches>"),f=$(e);sdebug("matches: "+$matches.find("match").length);var g=garaid,h="";d.find("match").each(function(){var a=$(this),b=$(this).find("garaid").text();if(sdebug("match: "+b),b==g){var c=$(this).find("progid").text(),d=$(this).find("atletaid").text(),e=$.trim($(this).find("datanascita").text());sdebug(c+" - "+d+" datanasc: "+e);var h=a.clone();if(""!=$.trim(viewcat)){var i=getCategoria(e);sdebug("categoria for "+d+": "+i),$.trim(viewcat)==$.trim(i)&&f.find("matches").append(h)}else f.find("matches").append(h)}}),matches=f.find("match"),matches.sort(function(a,b){var c=$(a).find("progid").text(),d=$(b).find("progid").text();return c<d?-1:c>d?1:0}),matches.each(function(){var a=$(this).clone(),b=$(this).find("id").text(),e=($(this).find("progid").text(),$(this).find("matchid").text()),f=$(this).find("vinto").text(),g=$(this).find("disputato").text(),i=$(this).find("dadisputare").text(),j=$(this).find("medagliamatch").text(),k=$(this).find("risultato").text(),l=$(this).find("datanascita").text(),m=getCategoria(l).toUpperCase(),n=$(this).find("atletaid").text(),o=$(this).find("atletaname").text();a.append("<atletaname></atletaname>"),a.find("atletaname").text(o),$msav.find("matches").append(a);var p="",q=!1,r="";if("yes"==$.trim(i)&&(q=!0),"no"==$.trim(i)&&(q=!1,r="black",c.showNullMatches&&(q=!0)),"yes"==$.trim(g)&&("yes"==$.trim(f)&&(p=" style='background-color: green' ",r="green"),"no"==$.trim(f)&&(p=" style='background-color: #C00000 ' ",r="red")),q){var s="matchtoplay.png";"oro"==j&&(s="medaglia_oro.png"),"argento"==j&&(s="medaglia_argento.png"),"bronzo"==j&&(s="medaglia_bronzo.png"),"yes"==$.trim(g)&&"none"==j&&("yes"==$.trim(f)&&(s="matchok.png"),"yes"!=$.trim(f)&&(s="matchko.png"));var t="",u="Non disputato",v="nondisputato";"yes"==$.trim(g)&&(v="vinto",u="Vinto, ",t="risultato: "+k,"yes"!=$.trim(f)&&(u="Perso, ",v="perso")),t=u+t,p="";var w="onclick='setResult(this)'";c.clickAtletaMatches&&(w="onclick=\"matchesPerAtleta('"+n+"','"+o+"','"+l+"')\""),h+="<li "+p+" tkdr-matchid='"+e+"' data-icon='false' id='match_"+b+"' ><a  shref=javascript:matchAtletaDetail('"+n+"') id='prog"+b+"' data-ajax='false'  href='#' "+w+" shref='gareatleta.html?atletaid="+n+"&garaid="+garaid+"'><img swidth='50' sheight='50' src='images/"+s+"' class='imgicon sui-li-icon ui-corner-none' ><div><span class='match "+r+"'>"+e+"</span><br><span class='categoria'>"+m+"</span><br><span class='atleta'>"+o+"</span><br><span class='soft "+v+"'>"+t+"</span></div></a><input type='hidden' class='datanascita' value='"+l+"' /><input type='hidden' class='atletaid' value='"+n+"' /><input type='hidden' class='atletaname' value='"+o+"'/></li>"}});var i=c.ulSelector,j=$("ul#"+i);if(j.empty(),j.append(h),j.listview(),j.listview("refresh"),c.showUpdated){$("#ulinfogara li span.left").html(sgetMedaglieGara(garaid));var k="";""!=$.trim(viewcat)&&(k=" in cat. "+viewcat.toUpperCase());var l=filterRows($allMatches,{dadisputare:"yes"}),n=(filterRows(l,{disputato:"yes"}),filterRows(l,{vinto:"yes"})),o=filterRows(l,{vinto:"no"}),p=l.rows.length+" incontri da disputare";p+="<br>"+l.rows.length+" incontri disputati, "+n.length+" vinti, "+o.length+" persi",$("#limatches").html(p+k),$("#gara #ulinfogara span").html(getMedaglieGara($a));var q=new Date,r=formatDateTime(q);sdebug("data "+r),$("li.liprog").find("span").html("Aggiornato: "+r)}null!=c.callback&&c.callback()}function refreshSocietaServer(){var a=imgtext+"Caricamento...";$("#page_societa #recnum span").html(a),debugga("refreshSocietaServer"),$.ajax({url:rooturl+"/societa/findall",type:"GET"}).done(function(a){if(a.error)toast("errore","long");else{toast("Societa caricate da "+rooturl);var b=$("#lista_societa");b.html("");var c='<li data-role="list-divider" role="heading" data-theme="b">'+a.rows.length+" atleti</li>";b.append(c);var d=new EJS({url:"tpl/societa.ejs"}).render(a.rows);b.empty().append(d),progressStop(),$("#page_societa #recnum span").html(a.rows.length+" societa"),b.find("li").off(tapevent),b.find("li").on(tapevent,function(){var a=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+a),progressStart("Lettura dati"),$.ajax({url:rooturl+"/societa/findall",type:"GET"}).done(function(b){progressStop();var c=b.data.rows[0].doc,e=(createHtmGrid(c),createHtmListview(c));$("#page_societa  #listax_societa").empty().append(e),$("#page_societa #societa").val(a),$.mobile.changePage("#page_societa"),$("#page_societa  #listax_societa").listview()}),!1}),b.find("li").off("taphold"),b.find("li").on("taphold",function(){if(loggedin&&"tkdradmin"==role){var a=$(this).find("a").attr("id").split("_")[0],b=$(this).find("a").attr("id").split("_")[1];gConfirm("Confermi l'eliminazione della societa ?","Conferma eliminazione",function(){var c={};c.id=a,c.rev=b,$.ajax({url:rooturl+"/societa/delete",type:"POST",data:c}).done(function(a){a.error?console.log("error"):(console.log("posted"),refreshSocietaServer())}).fail(function(){toast("Error posting","long")})},function(){})}}),b.listview(),b.listview("refresh")}})}function getHistoryForAtleta(a){var b=$("#page_atleta").find("input#atletaid").val();console.log(b);var c=rooturl+"/gare/history/"+b;progressStart("Calcolo storico in corso"),$.get(c,function(a){console.log(a),console.log(a.rows.length);var b=new EJS({url:"tpl/historyatleta.ejs"}).render(a);$("#page_atleta .historyatleta").html(b),progressStop()})}function refreshAtletiServer(){debugga("refreshAtletiServer");var a=imgtext+"Caricamento...";$("#page_atleti #recnum span").html(a),app.loadAllSchede(function(a){if(a.error)toast("errore","long");else{conslog("Atleti caricati da "+rooturl);var b=$("#lista_atleti");b.html("");var c='<li data-role="list-divider" role="heading" data-theme="b">'+a.rows.length+" atleti</li>";b.append(c);var d=new EJS({url:"tpl/atleti.ejs"}).render(a.rows);b.empty().append(d),progressStop(),$("#page_atleti #recnum span").html(a.rows.length+" atleti in "+settings.mysocietaname),b.find("li").off(tapevent),b.find("li").on(tapevent,function(){playFeedback();var a=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+a),progressStart("Lettura dati"),atleta.loadById(a,function(b){progressStop();var c=b.data.rows[0].doc,e=(createHtmGrid(c),createHtmListview(c));$("#page_atleta  #listax_atleta").empty().append(e),$("#page_atleta #atletaid").val(a),$("#page_atleta .historyatleta").empty(),getHistoryForAtleta(),$.mobile.changePage("#page_atleta"),$("#page_atleta  #listax_atleta").listview()}),!1}),b.find("li").off("taphold"),b.find("li").on("taphold",function(){if(loggedin&&"tkdradmin"==role){var a=$(this).find("a").attr("id").split("_")[0],b=$(this).find("a").attr("id").split("_")[1];gConfirm("Confermi l'eliminazione dell'atleta ?","Conferma eliminazione",function(){var c={};c.id=a,c.rev=b,$.ajax({url:rooturl+"/atleti/delete",type:"POST",data:c}).done(function(a){a.error?console.log("error"):(console.log("posted"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")})},function(){})}}),b.listview(),b.listview("refresh")}})}function progressStart(a){$.mobile.loading("show",{text:a,textVisible:!0,theme:"b",html:""})}function progressStop(){$.mobile.loading("hide")}function refreshSchede(){var a=$("#liElencoSchede");a.html("");var b='<li data-role="list-divider" role="heading" data-theme="b">'+app.storage.length+" schede</li>";a.append(b);for(var c=0;c<app.storage.length;c++){var d=$("<li data-theme='c'><a href='#' data-transition='slide'>"+app.storage.key(c)+"</a></li>");d.off(tapevent),d.on(tapevent,function(){scheda.load($(this).text()),$("#txtNome").val(scheda.data.nome),$("#txtIndirizzo").val(scheda.data.indirizzo),$("#txtDescrizione").val(scheda.data.descrizione),$("#txtPrezzo").val(scheda.data.prezzo),$("#scanDiv").html(scheda.data.barcode),""!=$.trim(scheda.data.photoURI)?($("#fotoAnteprima").attr("src",scheda.data.photoURI).css({width:"128px",height:"128px"}),$("#fotoAnteprima").on(tapevent,function(){$("#fullPhoto").attr("src",scheda.data.photoURI).css({width:"400px",height:"700px"}),$.mobile.changePage("#viewPhoto",{role:"dialog"})})):$("#fotoAnteprima").attr("src","img/nophoto.jpg").css({width:"128px",height:"128px"}),$("#scheda h3").html("Modifica "+boname),$.mobile.changePage("#scheda")}),d.off("taphold"),d.on("taphold",function(){var a=$(this).text();navigator.notification.confirm("Confermi l'eliminazione della scheda?",function(b){1==b&&(scheda.remove(a),$.mobile.changePage("#elencoSchede"))},"Conferma eliminazione","Sì,No")}),a.append(d)}a.listview("refresh")}function alerta(a){isPhone?navigator.notification.alert(a,function(){},"Avviso"):debugga(a)}function debugga(a){colog(a)}function newScheda(){delete scheda.data._id,delete scheda.data._rev,scheda.data.nome="",scheda.data.indirizzo="",scheda.data.descrizione="",scheda.data.prezzo="",scheda.data.coordinate="",scheda.data.photoURI="",scheda.data.barcode="",$("#txtNome").val(""),$("#txtIndirizzo").val(""),$("#txtDescrizione").val(""),$("#txtPrezzo").val(""),$("#scanDiv").html("No code"),$("#fotoAnteprima").attr("src","img/nophoto.jpg").css({width:"128px",height:"128px"}),$("#scheda h3").html("Nuova "+boname),$.mobile.changePage("#scheda")}function toast(a,b){myToast({body:a})}function gConfirm(a,b,c,d){isPhone?navigator.notification.confirm(a,function(a){1==a?c():d()},b,"Sì,No"):confirm(a)?c():d()}function importAtleti(){$.ajax({url:rooturl+"/atleti/findall",type:"GET"}).done(function(a){alert(a.length)})}function getNormalD(a){var b=a.substring(6)+a.substring(3,5)+a.substring(0,2);return b}function createPopup(a){var b=$('<a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-right">Close</a>').button(),c=$("<div/>",{"data-role":"popup"}).css({width:$(window).width()/1.5+"px"}).append(b).append(a);$(".ui-page-active").append(c),$("[data-role=popup]").on("popupafterclose",function(){$(this).remove()}).on("popupafteropen",function(){$(this).popup("reposition",{positionTo:"window"})}).popup({dismissible:!1,history:!1,theme:"b",overlayTheme:"b"}).popup("open")}function createHtmGrid(a){var b="<table border=1 width='300'>";for(var c in a)colog(" name="+c+" value="+a[c]),b+="<tr><td>"+c+"</td><td>"+a[c]+"</td></tr>";return b+="</table>"}function createHtmListview(a){var b='<ul data-role="listview">',b="";for(var c in a){colog(" name="+c+" value="+a[c]);var d=a[c];"categoria"==c.toLowerCase()&&(d=getCategoria(a.datanascita,!0).toUpperCase()),b+='<li class="gradient ui-li-static ui-body-inherit"><span class="small">'+c+'</span><br><span class="medium">'+d+"</li>"}return b}function bindGaraPage(){colog("bindaGaraPage"),$(document).on("pageshow","#gara",function(){var a=$(this).data("url");debug("durl: "+a),garaid=parm_garaid,setActiveTab(activeTab),$("#gara #dialogCategorie").popup(),$("#gara #dialogForAtleta").popup(),$("#gara #refresh").off(tapevent),$("#gara #refresh").on(tapevent,function(){debug("activetab: "+activeTab)}),$(".tb").remove(),$("#av_toolbar_regdiv").remove(),$("#av_toolbar_iframe").remove(),$("#gara .spancat").off(tapevent),$("#gara .spancat").on(tapevent,function(a){sdebug("clicked on categorie");var b=$("#gara ul#ulcategorie");b.listview(),b.listview("refresh"),a.preventDefault();var c=new EJS({url:"tpl/popcategorie.ejs"}).render({});openPopup(c,"Categorie")}),$("#gara .spanfilt").off(tapevent),$("#gara .spanfilt").on(tapevent,function(a){sdebug("clicked on filters");var b=$("#gara ul#ulcategorie");b.listview(),b.listview("refresh"),a.preventDefault();var c=new EJS({url:"tpl/popfilters.ejs"}).render({});openPopup(c,"Filtri"),$("#temppopup #setfilt").button(),$("#temppopup #resetfilt").button(),$("#temppopup td").css("padding","5px"),$("#temppopup").css("padding","5px").css("top","10px !important"),""!=garaFilters.categoria?$("#temppopup #categ").val(garaFilters.categoria):$("#temppopup #categ").val("_"),""!=garaFilters.sesso?$("#temppopup #sex").val(garaFilters.sesso):$("#temppopup #sex").val("_"),""!=garaFilters.medaglia?$("#temppopup #medag").val(garaFilters.medaglia):$("#temppopup #medag").val("_"),""!=garaFilters.quadrato?$("#temppopup #quadrato").val(garaFilters.quadrato):$("#temppopup #quadrato").val("_")}),$("#gara #ulcategorie li").off(tapevent),$("#gara #ulcategorie li").on(tapevent,function(){var a=$(this).text();viewcat=a.toLowerCase();var b=a.toLowerCase();"tutte"==viewcat.toLowerCase()&&(viewcat=""),cat=viewcat,document.cookie="cookiecat="+viewcat+"; expires=Thu, 18 Dec 2023 12:00:00 UTC",$("#dialogCategorie").popup("close"),b.indexOf("esordienti")>-1&&(b=b.replace("esordienti","eso")),b.indexOf("cadetti")>-1&&(b=b.replace("cadetti","cad")),b.indexOf("junior")>-1&&(b=b.replace("junior","jun")),b.indexOf("senior")>-1&&(b=b.replace("senior","sen")),$(".spancat").text(cattxt+b.toUpperCase()),refreshCurrentGara()}),$("#gara #listabyprog li").off(tapevent),$("#gara #listabyprog li").on(tapevent,function(){var a=$(this).attr("id"),a=a.replace("prog","")}),$("#gara #navbar ul li").on("vclick",function(){var a=$(this).index(),b=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+b).removeClass("ui-screen-hidden"),prevSelection=b,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var c=$(this).find("a").attr("data-tab-class");$("#gara .ul"+c).show(),activeTab=a,cacheViews()}),setActiveTab(activeTab),$("#gara #bubble").off(tapevent),$("#gara #bubble").on(tapevent,function(){if(setAllCronacaRead(jcurrentgara.id),notifyseen=!0,notifycount=0,nonletti=0,$("#gara .nonvisto").removeClass("nonvisto"),$("#gara #bubble").html("0").hide(),cronaca.rows.length>0){setCookie("lastcronaca",cronaca.rows[0].time);var a=getCookie("cronacaletti_"+jcurrentgara.id);a||(a=""),$(cronaca.rows).each(function(b){var c=cronaca.rows[b];""!=a.trim()&&(a+=","),a+=c.time}),setCookie("cronacaletti_"+jcurrentgara.id,a)}$("#gara a#tab_cronaca").trigger("click")}),$("#gara #panelright").off(tapevent),$("#gara #panelright").on(tapevent,function(){$(this).panel("close")}),anninascita="",cat="",searchgara="",""!=$.trim(cat)&&(debug("viewing category: "+cat),viewcat=cat);var b=getCookie("cookiecat");""!=$.trim(b)&&(viewcat=b);var c="";""==$.trim(c)&&(c="tutte"),c.indexOf("esordienti")>-1&&(c=c.replace("esordienti","eso")),c.indexOf("cadetti")>-1&&(c=c.replace("cadetti","cad")),c.indexOf("junior")>-1&&(c=c.replace("junior","jun")),c.indexOf("senior")>-1&&(c=c.replace("senior","sen")),c=c.toUpperCase(),$("#gara .spancat").text(cattxt+c),debug("cookiecat: "+b),""==$.trim(garaid)&&""==$.trim(searchgara)&&(searchgara="corna"),showMsg&&$("#msgBar").show()})}function setAllCronacaRead(a){var b=jGara.cronaca;$(b.rows).each(function(c){var d=b.rows[c],e=d.time,f=a+"_"+e;"disputata"!=jcurrentgara.stato.toLowerCase()&&cronaca_read.indexOf(f)==-1&&(cronaca_read.push(f),crnonletti--,crnonletti<0&&(crnonletti=0))}),renderCronaca(b)}function setCategoria(a){var b=$(a).text();viewcat=b.toLowerCase();var c=b.toLowerCase();"tutte"==viewcat.toLowerCase()&&(viewcat=""),cat=viewcat,document.cookie="cookiecat="+viewcat+"; expires=Thu, 18 Dec 2023 12:00:00 UTC",$("#dialogCategorie").popup("close"),c.indexOf("esordienti")>-1&&(c=c.replace("esordienti","eso")),c.indexOf("cadetti")>-1&&(c=c.replace("cadetti","cad")),c.indexOf("junior")>-1&&(c=c.replace("junior","jun")),c.indexOf("senior")>-1&&(c=c.replace("senior","sen")),$(".spancat").text(cattxt+c.toUpperCase()),refreshCurrentGara(),popCloseRemove()}function sdebug(a){debugga(a)}function debug(a){debugga(a)}function captureAudio(){navigator.device.capture.captureAudio(function(a){var d,b=a[0],c=new FileReader;c.onload=function(a){a.target.result},d=new window.File(b.name,b.localURL,b.type,b.lastModifiedDate,b.size),c.readAsDataURL(d)})}function openChatFoto(a){if(console.log("openchatfoto"),isPhone){if(a.toLowerCase().trim().indexOf("http:")>-1)return void window.cordova.plugins.FileOpener.openFile(a,function(b){conslog("file "+a+" successfully opened")},function(b){console.log("error opening file "+a),console.log(b)});var b=a.replace("data:image/jpeg;base64,","");window.Base64ImageSaverPlugin.saveImageDataToLibrary(function(a){console.log(a),a="file://"+a,window.cordova.plugins.FileOpener.openFile(a,function(b){conslog("file "+a+" successfully opened")},function(b){console.log("error opening file "+a),console.log(b)})},function(a){console.log(a)},b)}else window.open(a,"_system","width=310,height=30")}function openImage(a){var b=a.replace("thumb_","");if(isPhone)window.cordova.plugins.FileOpener.openFile(b,function(a){conslog("file "+b+" successfully opened")},function(a){console.log("error opening file "+b)});else{"<img id='img1' src='"+a.replace("thumb_","")+"' />";$("#viewimage #img1").attr("src",a.replace("thumb_","")),$.mobile.changePage("#viewimage")}}function getCookie(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1);if(0==e.indexOf(b))return e.substring(b.length,e.length)}return""}function filterIscritti(a){var b=[],c=!1;$(a).each(function(d){var e=getAtletaById(a[d]),g=e.datanascita,h=getCategoria(g),i=e.sesso,j=!0;""==a[d].trim()&&(j=j&&!1);for(f in garaFilters)""!=garaFilters[f]&&(c=!0,"sesso"==f&&i.toLowerCase().trim()!=garaFilters[f].toLowerCase().trim()&&(j=j&&!1),"categoria"==f&&(garaFilters[f].toLowerCase().trim().indexOf("senior")>-1?h.toLowerCase().trim().indexOf("senior")==-1&&(j=j&&!1):h.toLowerCase().trim()!=garaFilters[f].toLowerCase().trim()&&(j=j&&!1)));c?j&&b.push(a[d]):j&&b.push(a[d])});b.length;return b}function refreshGara(a,b){var c={callback:null};$.extend(c,b),refreshCronaca(),oldupdatetext=$("#gara #ulinfogara li span.left").html(),$("#gara #ulinfogara li span.left").html("Aggiornamento...");colog("gara: "+JSON.stringify($gara));var e=$gara;$("#gara #hdr").find("#hgara a").html(e.doc.location+" -     "+e.doc.data+" - "+settings.mysocietaname),$("#hdriscritti").find("h1").html(e.doc.title+" "+e.doc.location+" -     "+e.doc.data);var f=e.doc.iscritti.split(","),g=filterIscritti(f),h=g.length;$("#ligaratitle").html("Gara: <b>"+e.doc.title+"</b>"),$("#ligaralocation").html("Location: "+e.doc.location),$("#liiscritti").text(h+" atleti iscritti "),datagara=e.doc.data;var i=datagara.split("/");annogara=i[2];new Date;$("#gara #hgara a").css("width","100%")}function getMaschiFemmine(a,b){colog("getmaschifemmine"),colog(jcurrentgara.iscritti);var d=(jcurrentgara.iscritti.split(","),0),e=0;$(a).each(function(c){var f;f=getAtletaById("iscritti"==b?a[c]:a[c].doc.atletaid);var g="M";f.sesso&&(g=f.sesso.toUpperCase()),"M"==g&&d++,"F"==g&&e++});var f={maschi:d,femmine:e};return f}function refreshCronaca(){}function getMedaglieGara(a){var b=0,c=0,d=0;$(a.rows).each(function(e){var f=a.rows[e].doc,i=(f.garaid,f.datanascita,$.trim(f.medagliamatch)),j=!0;j&&("oro"==$.trim(i)&&b++,"argento"==$.trim(i)&&c++,"bronzo"==$.trim(i)&&d++)});var e="<span style='color: yellow;'>ORI: <b>"+b+"</b></span>&nbsp;&nbsp;&nbsp;<span style='color: silver;'>ARG: <b>"+c+"</b></span>&nbsp;&nbsp;&nbsp;<span style='color: orange;'>BRO: <b>"+d+"</b></span>";return e}function getCategoria(a,b){var c="senior a",d=(new Date).getFullYear();if(jcurrentgara.data||(b=!0),1!=b){var e=jcurrentgara.data.split("/"),f=e[2];d=f}if(""==$.trim(a))return"senior b";var g=a.split("."),h=g[2],i=parseInt(d,10)-parseInt(h,10);return i>=18&&i<=35&&(c="senior a"),i>=15&&i<=17&&(c="junior"),i>=12&&i<=14&&(c="cadetti a"),i>=10&&i<=11&&(c="cadetti b"),i>35&&(c="senior b"),i<10&&(c="esordienti"),c}function showIscritti(){refreshIscritti(),$("#iscrittiPage #selectiscr").controlgroup(),$("#iscrittiPage #selectiscr").controlgroup("refresh",{shadow:!0}),$("#iscrittiPage input:checkbox").checkboxradio(),$("#iscrittiPage input:checkbox").checkboxradio("refresh"),$("#iscrittiPage input[type='checkbox']").attr("checked",!0).checkboxradio("refresh"),$("#iscrittiPage #selectiscr").trigger("create"),$.mobile.changePage("#iscrittiPage"),$("#iscrittiPage").page()}function getMatchesCountForAtleta(a){colog("getmatchescount for atleta "+a),colog($allmatches);var b=jGara.matchesbyprog,c=0;return $(b.rows).each(function(d){var e=b.rows[d].doc.atletaid;e==a&&c++}),c}function refreshIscritti(a){a||(a=!1);var b="",c=jGara.gara.rows[0].doc;conslog("refreshiscritti:"),conslog(c),c.myiscritti&&(b=c.myiscritti),colog("iscritti: "+b);var d=b.split(","),e=filterIscritti(d),f="",g=[];if($(e).each(function(a){var b=getAtletaById(e[a]),c={};c.nome=b.cognome+" "+b.nome,c.id=b.id,c.sesso=b.sesso,c.categoria=getCategoria(b.datanascita),g.push(c)}),g.sort(function(a,b){var c=a.nome.trim(),d=b.nome.trim();return c>d?1:c<d?-1:0}),1==a)return g;conslog("atls",g);var f=new EJS({url:"tpl/iscritti.ejs"}).render(g),h=$("#iscrittiPage #uliscritti");h.empty(),h.append(f),h.listview(),h.listview("refresh"),$("#iscrittiPage #infogaraiscritti").html(g.length+" iscritti")}function getAtletaById(a,b){var c="";return $($atleti.rows).each(function(b){var d=$atleti.rows[b].doc,e=d.id;d.cognome,d.nome;if(e==a)return c=d}),c}function showMatchesForAtleta(a){lastDisplayedAtletaId=a,$("#matchesatleta #atletaid").val(a);var b=[],c=getAtletaById(a);selectedAtl=c;var d=jGara.matchesbyprog;$(d.rows).each(function(c){var e=d.rows[c],f=e.doc.atletaid;f==a&&b.push(e)}),b.sort(function(a,b){var c=a.doc.progid,d=b.doc.progid;return c>d?1:c<d?-1:0});var e=new EJS({url:"tpl/matchesforatleta2.ejs"}).render(b),f=$("#matchesatleta #listampa");f.empty(),f.append(e),$(document).off("taphold","#matchesatleta ul#listampa li"),$("#matchesatleta ul#listampa li").off("taphold"),$("#matchesatleta ul#listampa li").on("taphold",function(a){if("tkdradmin"==role&&loggedin){$(this).addClass("tapped");var b=$(this).attr("id").replace("match_","");delmatchid=b,"disputata"!=jcurrentgara.stato&&$("#popDelMatch").popup("open")}}),$("#matchesatleta #mparecnum").html(b.length+" incontri per "+c.cognome+" "+c.nome)}function sysMsg(a){var b=$.mobile.activePage.attr("id"),c="";if(a&&(c=a),loggedin&&"tkdradmin"==role){var d={destsocket:c},e=new EJS({url:"tpl/sysmsg.ejs"}).render(d);$("#"+b+" div[data-role=content]").append(e),$("#"+b+" #popSysMsg #dest").val(c),$("#"+b+" #popSysMsg").popup(),$("#"+b+" #popSysMsg").popup("open")}}function sysMsgOk(){var a=$.mobile.activePage.attr("id"),b=$("#"+a+" #popSysMsg #tamsg").val(),c=$("#"+a+" #popSysMsg #dest").val();if(""==b.trim())return void $("#gara #popSysMsg").popup("close").remove();var d="all";""!=c.trim()&&(d=c),socketNotify({type:"notification",to:d,text:b}),$("#"+a+" #popSysMsg").popup("close").remove()}function sysMsgCancel(){var a=$.mobile.activePage.attr("id");$("#"+a+" #popSysMsg").popup("close").remove()}function popGareOk(){$("#gare #popGare").popup("close").remove()}function popGareCancel(){$("#gare #popGare").popup("close").remove()}function sendRtCmd(a,b){var c=$("#matchConsole #rtidx").val(),d=realtimeArray[c],e=d.result;if("p1plus"==a){var f=e.split("-")[0],g=e.split("-")[1],h=f,i=g;h=parseInt(f,10)+1;var j=h+"-"+i;realtimeArray[c].result=j}if("p1minus"==a){var f=e.split("-")[0],g=e.split("-")[1],h=f,i=g;h=parseInt(f,10)-1,h<0&&(h=0);var j=h+"-"+i;realtimeArray[c].result=j}if("p2plus"==a){var f=e.split("-")[0],g=e.split("-")[1],h=f,i=g;i=parseInt(g,10)+1;var j=h+"-"+i;realtimeArray[c].result=j}if("p2minus"==a){var f=e.split("-")[0],g=e.split("-")[1],h=f,i=g;i=parseInt(f,10)-1,i<0&&(i=0);var j=h+"-"+i;realtimeArray[c].result=j}if(a.indexOf("pause")>-1){var k=!1,k=!1;d.paused&&(k=d.paused),k=!k}if(a.indexOf("round_")>-1){var l=a.split("_")[1];d.round=l}if(a.indexOf("endround")>-1){var m=!1;m=$(b).find(":checked").length>0,d.endround=m}console.log("rtcmd",d),mapConsole(c)}function updateConsole(a){var b=realtimeArray[a],c=$("div#popResult .ui-content");c.find("#risult").val(b.result)}function viewConsoleOld(a){return conslog("viewConsole",a,realtimeArray[a]),void $.mobile.changePage("#matchConsole")}function viewConsole(a){mapConsoles(a)}function mapConsoles(a){var b=$("#popResult #realtimediv");$("#popResult #consolenavb");console.log("mapconsoles "+a);var d={},e=!1;if(a>-1){d=consoles[a],conslog(d),selectedid=d.match.id,selectedmatchid=d.match.matchid;var g=(d.match.id,d.match.matchid);d.match.realtime&&"true"==String(d.match.realtime)&&(e=!0)}$("#popResult #matchid").val(d.match.id),$("#popResult #matchnumber").val(d.match.matchid),e?b.show():b.hide();var h=$("#popResult .ui-content");h.find("#ck_realtime").prop("checked",e).checkboxradio("refresh");var i=!0,j=!1,k=!1,l="0-0",m="1";d.paused&&(i=d.paused),d.fineround&&(j=d.fineround),d.running&&(k=d.running),d.result&&(l=d.result),d.round&&(m=d.round),k?(i=!1,j=!1):i=!0,conslog("paused",i,"running",k,"round",m),$("#popResult #hdrpopresult h1").html(g+" - "+d.match.atletaname);var n=!1,o="black",p="IN PAUSA";"false"==String(i)&&(n=!0),h.find("#ckpausematch").prop("checked",n).checkboxradio("refresh"),n&&(o="orange",p="IN CORSO");var q="<span style='color: "+o+";'>"+p+"</span>";$("#popResult label[for=ckpausematch]").html(q),n=!1,j&&(n=!0),h.find("#ckfineround").prop("checked",n).checkboxradio("refresh"),h.find("#risult").val(d.result),$("#popResult .roundnumber").css("background","silver");var r=-1;r="gp"==m.toLowerCase()?3:parseInt(m,10)-1,$("#popResult .roundnumber:eq("+r+")").css("background","green")}function mapConsole(a){var b=$("#popResult #realtimediv"),c=$("#popResult #navb");conslog("mapconsole "+a);var d={};a>-1?(d=realtimeArray[a],conslog(d),selectedid=d.match.id,selectedmatchid=d.match.matchid,b.show(),lastrealtime=d,c.removeClass("translucid")):(console.log("lastenteredmatch",lastenteredmatch),selectedid=lastenteredmatch.id,selectedmatchid=lastenteredmatch.matchid,console.log("selectedid",selectedid,"selectedmatchid",selectedmatchid),d=lastrealtime,d.match=lastenteredmatch,console.log("idx=-1, rta:",d),b.hide(),c.addClass("translucid")),realtimeindex=a;var e=!0,f=!1,g=!1,h="0-0",i="1";d.paused&&(e=d.paused),d.fineround&&(f=d.fineround),d.running&&(g=d.running),d.result&&(h=d.result),d.round&&(i=d.round),g?(e=!1,f=!1):e=!0,conslog("paused",e,"running",g,"round",i);var j=$("#popResult .ui-content");$("#popResult #hdrpopresult h1").html(selectedmatchid+" - "+d.match.atletaname);var k=!1,l="black",m="IN PAUSA";"false"==String(e)&&(k=!0),j.find("#ckpausematch").prop("checked",k).checkboxradio("refresh"),k&&(l="orange",m="IN CORSO");var n="<span style='color: "+l+";'>"+m+"</span>";$("#popResult label[for=ckpausematch]").html(n),k=!1,f&&(k=!0),j.find("#ckfineround").prop("checked",k).checkboxradio("refresh"),j.find("#risult").val(d.result),$("#popResult .roundnumber").css("background","silver");var o=-1;o="gp"==i.toLowerCase()?3:parseInt(i,10)-1,$("#popResult .roundnumber:eq("+o+")").css("background","green")}function renderRealtimeTabs(a){return}function showMatchConsole(a){console.log("showMatchConsole",a),$.mobile.changePage("#popResult");var b=!1;a.realtime&&"true"==String(a.realtime)&&(b=!0),$("#popResult #ck_realtime").prop("checked",b).checkboxradio().checkboxradio("refresh")}function renderConsoleTabs(){if(console.log("renderconsoletabs",consoles),0==consoles.length)return $("#popResult #consolenavb").remove(),void conslog("consoles array=0");for(var a="",b=!1,c=0;c<consoles.length;c++){selectedid==consoles[c].match.id&&(b=!0),conslog("selid",selectedid,"matchid",consoles[c].match.id);var d="gray",e="normal";consoles[c].match.realtime&&"true"==String(consoles[c].match.realtime)&&(d="lightgreen",e="normal");var f=consoles[c].match.atletaname.substring(0,10)+"...";a+='<li><a onclick="mapConsoles('+c+')"  style="font-size: 13px; font-weight: '+e+"; color: "+d+';" data-href="a">'+consoles[c].match.matchid+" "+f+"</a></li>"}conslog(selectedid,b),$("#popResult #consolenavb").remove();var g=$('<div data-role="navbar" id="consolenavb" style="border: 0px solid yellow"><ul>'+a+"</ul></div>");conslog(g.html()),$("#popResult #hdrpopresult #navcontainer").append(g).trigger("create");var h=$("#popResult #matchid").val();$("#popResult #consolenavb li a").removeClass("ui-btn-active");for(var c=0;c<consoles.length;c++)consoles[c].match.id==h&&$("#popResult #consolenavb li a:eq("+c+")").addClass("ui-btn-active")}function deleteFromConsoles(a){for(var b=0;b<consoles.length;b++){
var c=consoles[b],d=c.match;d.id==selectedid&&(consoles.splice(b,1),console.log("match "+a+" deleted from consoles array"))}$(consoles).each(function(a){var b=consoles[a],c=b.match;c.id==selectedid&&(found=!0,matchToAdd=c)})}function checkConsoles(a,b){console.log("checking if match "+a+" already in consoles array");var c=!1;if($(consoles).each(function(a){var b=consoles[a],d=b.match;d.id==selectedid&&(c=!0)}),c)console.log("match "+a+" already in consoles array, doing nothing");else{console.log("match is not into consoles array, adding it");var d={active:!1,match:getMatchById(a),result:"0-0",round:"1",paused:!0,running:!1};b&&(d=b),consoles.push(d),console.log("match "+a+" added to consoles array")}}function setResult(a){if(loggedin&&"tkdradmin"==role){var b=jcurrentgara.stato,c=!1;if("disputata"==b&&(c=!0),!c){sdebug("setresult");var d=$(a).closest("li");d.addClass("liselected");var e=d.attr("id").replace("match_","");sdebug("clicked matchid: "+e),selectedid=e;var f=e,g=d.attr("tkdr-matchid");selectedmatchid=d.attr("tkdr-matchid");var h=getMatchById(e);lastenteredmatch=jQuery.extend(!0,{},h),console.log("last entered match",lastenteredmatch),conslog(h);var i=!1;h.realtime&&"true"==String(h.realtime)&&(i=!0),$("#popResult #hdrpopresult #navb").remove(),$.mobile.changePage("#popResult"),$("#popResult #matchid").val(f),$("#popResult #matchnumber").val(g),$("#popResult #hdrpopresult h1").html(g+" - "+h.atletaname),conslog("mtch",h),$("#popResult #risult").val("0-0"),checkConsoles(f);var j=getConsolesIndex(f);$("#popResult #risult").val(consoles[j].result),$("#popResult #ck_realtime").prop("checked",i).checkboxradio().checkboxradio("refresh");var k=$("#popResult #realtimediv");if(i){console.log("you entered a realtime match");var l=0;k.show(),$("#popResult #navb ul li:eq("+l+") a").addClass("ui-btn-active")}else conslog("This match is not realtime"),k.hide();renderConsoleTabs()}}}function selectRealtimeTab(a){for(var b=0;b<realtimeArray.length;b++){var c=realtimeArray[b];c.match.id==selectedid&&(a=b)}$("#popResult #navb ul li:eq("+a+") a").addClass("ui-btn-active")}function removeFromConsoles(){var a=$("#popResult #ck_realtime:checked");if(a.length>0)return void alert("Disattivare il realtime prima di eliminare una console");var b=$("#popResult #matchid").val();deleteFromConsoles(b)}function setResultOld(a){var b=!1;if(loggedin&&"tkdradmin"==role){var c=jcurrentgara.stato,d=!1;if("disputata"==c&&(d=!0),!d){sdebug("setresult");var e=$(a).closest("li");e.addClass("liselected");var f=e.attr("id").replace("match_","");sdebug("clicked matchid: "+f),selectedid=f,selectedmatchid=e.attr("tkdr-matchid"),renderRealtimeTabs();var g=getMatchById(selectedid);$("#popResult #hdrpopresult h1").html(selectedmatchid+" - "+g.atletaname),console.log("mtch",g),$("#popResult #risult").val("0-0"),console.log("usepopup",b),b?($("#popResult #checkgp").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_round1").prop("checked",!0).checkboxradio("refresh")):($("#popResult #checkgp").prop("checked",!1).checkboxradio().checkboxradio("refresh"),$("#popResult #radio_round1").prop("checked",!0).checkboxradio().checkboxradio("refresh"));var h=!1;g.realtime&&"true"==String(g.realtime)&&(h=!0),console.log("rt: "+h),$("#popResult #ck_realtime").prop("checked",h).checkboxradio().checkboxradio("refresh"),$.mobile.changePage("#popResult",{changeHash:!0}),$("#popResult").css("padding",".4em"),h?$("#popResult #realtimediv").show():$("#popResult #realtimediv").hide()}}}function setResultById(a,b){if(loggedin&&"tkdradmin"==role){var c=jcurrentgara.stato,d=filterRows($allmatches,{id:a}),e=!1;if(0==d.rows.length&&(e=!0),"disputata"==c&&(e=!0),!e){colog("setresultbyid "+a),colog(d),sdebug("setting result2 for matchid: "+a),selectedid=a,selectedmatchid=d.rows[0].doc.matchid,$("#popResult #risult").val(b.risultato);var f=!1;b.goldenpoint&&"yes"==b.glodenpoint&&(f=!0),$("#popResult #checkgp").prop("checked",f).checkboxradio("refresh")}}}function setResultCancel(){$("ul#listampa li").removeClass("liselected"),selectedid="",selectedmatchid="",$.mobile.changePage("#matchesatleta")}function setResultOK(){var b=!0,c="",d="",e=new Array("primo","secondo","terzo","quarto","quinto","sesto","settimo","ottavo","nono","decimo"),f=new Array("finale","semifinale","quarto di finale","ottavo di finale","sedicesimo di finale","trentaduesimo di finale"),g=$("#popResult #risult").val(),h=$("#popResult #checkgp").prop("checked");colog("goldenpoint: "+h);var i=selectedid;i=$("#popResult #matchid").val();var j=$("#popResult #matchnumber").val();conslog("setting result for match "+i),delMatchFromRealtime(i),deleteFromConsoles(i);var k=getAtletaById(getMatchById(i).atletaid);console.log("atleta: ",k),progressStart("Aggiornamento..","Aggiornamento");var l=k.cognome+" "+k.nome,m=getCategoria(k.datanascita),o=(k.cognome+" "+k.nome,"nondisputato");$("#popResult #radio_vinto:checked").length>0&&(o="vinto"),$("#popResult #radio_perso:checked").length>0&&(o="perso"),$("#popResult #radio_nondisputato:checked").length>0&&(o="nondisputato");var p={},q="updagent.php?action=edit&tag=match",r="/matches/update/"+jcurrentgara.id+"/"+i,s=$("#matchesatleta ul#listampa li").length,t=$("#matchesatleta ul#listampa li#match_"+i).index(),u=s-t-1,v=u-1,w="",x="",y="",A="none",B="vince";if("nondisputato"==o)w="no",y="yes",x="no",A="none",b=!1,p={vinto:w,disputato:x,dadisputare:y,realtime:!1};else{"vinto"==o&&(w="yes",B="vince"),"perso"==o&&(w="no",B="perde"),x="yes",y="yes";var C=j,D="";1==s&&(D=" e unico ");var E="";u<4&&(E=", "+f[u]),c+=l+" "+B+" il suo "+e[t]+" "+D+"incontro (n."+C+E+") ",""!=$.trim(g)&&(c+=" per "+g),p={vinto:w,disputato:x,dadisputare:y,realtime:!1},console.log("docvintoperso",p),p.goldenpoint=h,h&&"true"==String(h)&&(c+=" al golden point ");var F="";v<2&&(F=" !!"),v>-1&&"yes"==w&&(c+=" e va in "+f[v]+F+". ")}q+="&id="+i,q+="&garaid="+garaid,q+="&vinto="+w,q+="&disputato="+x,q+="&dadisputare="+y,""!=$.trim(g)&&(q+="&risultato="+g,p.risultato=g),sdebug("ln: "+s),sdebug("ord: "+t),parseInt(t,10)==parseInt(s,10)-1&&("yes"==x?("no"==w&&(A="argento"),"yes"==w&&(A="oro")):A="none"),parseInt(t,10)==parseInt(s,10)-2&&("yes"==x?"no"==w&&(A="bronzo"):A="none"),"none"!=A&&(c+=". E' "+A.toUpperCase()+" !"),q+="&medagliamatch="+A,p.medagliamatch=A;var G=0;$("#matchesatleta ul#listampa li").each(function(a){var b=$(this).attr("id").replace("match_",""),c="updagent.php?action=edit&tag=match&garaid="+garaid+"&id="+b,e={};if(a<t&&(sdebug("gara precedente "+a),"yes"==x&&(c+="&disputato=yes&vinto=yes&dadisputare=yes&medagliamatch=none",e.disputato="yes",e.vinto="yes",e.dadisputare="yes",e.medagliamatch="none"),sdebug(c),c="/matches/update/"+jcurrentgara.id+"/"+b,$.ajax({type:"POST",url:rooturl+c,data:e,async:!1})),a>t){if(sdebug("gara successiva "+a),G++,1==G){var f=getDerby(b,m);$(f.rows).each(function(a){colog("derby con "+f.rows[a].doc.atletaname),d=" .Sarà derby con "+f.rows[a].doc.atletaname+" al "+f.rows[a].doc.matchid+" ! ";var c=f.rows[a].doc.id,e="/matches/update/"+jcurrentgara.id+"/"+c;"yes"==w?($.ajax({type:"POST",url:rooturl+e,data:{derby:b},async:!1}),e="/matches/update/"+jcurrentgara.id+"/"+b,$.ajax({type:"POST",url:rooturl+e,data:{derby:c},async:!1})):(d="",$.ajax({type:"POST",url:rooturl+e,data:{derby:null},async:!1}),e="/matches/update/"+jcurrentgara.id+"/"+b,$.ajax({type:"POST",url:rooturl+e,data:{derby:null},async:!1}))}),G=0}"yes"==x&&("yes"==w&&(c+="&disputato=no&vinto=no&dadisputare=yes&medagliamatch=none",e.disputato="no",e.vinto="no",e.dadisputare="yes",e.medagliamatch="none"),"no"==w&&(c+="&disputato=no&vinto=no&dadisputare=no&medagliamatch=none",e.disputato="no",e.vinto="no",e.dadisputare="no",e.medagliamatch="none")),"no"==x&&(c+="&disputato=no&vinto=no&dadisputare=yes&medagliamatch=none",e.disputato="no",e.vinto="no",e.dadisputare="yes",e.medagliamatch="none"),c="/matches/update/"+jcurrentgara.id+"/"+b,sdebug(c),$.ajax({type:"POST",url:rooturl+c,data:e,async:!1})}}),c+=d;var H="savecronaca.php?garaid="+garaid+"&text="+encodeURI(c);H="/matches/addcronaca/"+jcurrentgara.id,console.log("posting doc",p),$.post(rooturl+r,p,function(){$.mobile.back();$("ul#listampa li.liselected").find("input:hidden.atletaid").val();$("#matchesatleta ul#listampa li").removeClass("liselected");var d=getCookie("notifiche_atleta");d&&""!=d.trim()&&d.indexOf(k.id.trim())>-1;var e={type:"realtime",to:"all",garaid:jcurrentgara.id,matchid:i,matchnumber:j,result:"",ammoniz1:0,ammoniz2:0,event:"realtime",text:"",match:getMatchById(i),active:!1};socketNotify(e),b&&socketNotify({type:"notification",to:"all",text:c,garaid:jcurrentgara.id,updategara:"yes"}),postChat({garaid:jcurrentgara.id,nickname:chatuser.nickname,sockid:chatuser.sockid,color:"yellow",text:c}),$.ajax({type:"POST",url:rooturl+H,async:!1,data:{text:c}},function(){loadCronaca()}),openGara(jGara.gara.rows[0].doc.id,function(){showMatchesForAtleta(k.id),progressStop()})})}function getDerby(a,b){colog("getDerby for matchid "+a+" in category "+b);var c={rows:[]},d={rows:[]};colog("allmatches");var e=jGara.matchesbyprog;colog(e);var f=filterRows(e,{id:a}),g=f.rows[0].doc.matchid,h=f.rows[0].doc.datanascita,i=getCategoria(h),j=filterRows(e,{matchid:g,dadisputare:"yes",disputato:"no"});return colog("incontri con matchid="+g+": "+j.rows.length+" in categoria "+i),$(j.rows).each(function(c){var e=j.rows[c],f=e.doc.id;if(f!=a){var h=getCategoria(e.doc.datanascita),i=!0;h.trim().toLowerCase()!=b.trim().toLowerCase()&&(i=!1,colog("match "+g+" in category "+h+" ignored, searching for category "+b)),i&&d.rows.push(e)}}),$(d.rows).each(function(a){var b=d.rows[a],f=b.doc.atletaname,h=b.doc.atletaid,i=filterRows(e,{atletaid:h});i.rows.sort(function(a,b){var c=a.doc.matchid,d=b.doc.matchid;return c>d?1:c<d?-1:0});var j=0;colog("analisi incontri di "+f),$(i.rows).each(function(a){var b=i.rows[a],d=b.doc.matchid,e=b.doc.disputato,f=b.doc.dadisputare,h=!1;"no"==e&&"yes"==f&&(j++,h=!0),colog("matchid "+d+" - eligible: "+h),d==g&&1==j&&(c.rows.push(b),colog("è il primo prossimo incontro, DERBY OK"))})}),colog("Derby trovati per match id "+a+": "+c.rows.length),c}function setCorazzaColor(a){$("#popAddMatch").find("#color").val(a),$("#popAddMatch").find("#blue").css("border","4px solid yellow"),$("#popAddMatch").find("#red").css("border","0px solid yellow"),"red"==a&&($("#popAddMatch").find("#red").css("border","4px solid yellow"),$("#popAddMatch").find("#blue").css("border","0px solid yellow"))}function addMatch(){$("#popAddMatch").popup("open")}function addMatchCancel(){$("#popAddMatch").popup("close")}function refreshMatches(a){colog("RefreshMatches");var b=imgtext+"Aggiornamento match...";$("#gara .medals").html(b),mf={maschi:"0",femmine:"0"},loadMatchesByProg(jcurrentgara.id,{callback:function(){progressStop(),a&&a()}}),loadMatchesByAtleta(jcurrentgara.id),loadCronaca(jcurrentgara.id),autorefresh&&setMatchesRefresh()}function addMatchOK(){var a=$("#matchid"),b=$("#popAddMatch #color").val(),c=Right(a.val(),2),d=selectedAtl.datanascita,e=selectedAtl.cognome+" "+selectedAtl.nome,f=selectedAtl.id,g={progid:c,societaid:settings.mysocieta,societaname:settings.mysocietaname,garaid:jcurrentgara.id,atletaid:f,atletaname:e,risultato:"",ordine:"1",vinto:"no",disputato:"no",dadisputare:"yes",matchid:a.val().toUpperCase().trim(),color:b,lastupdate:"never",datanascita:d};$.ajax({url:rooturl+"/matches/add/"+jcurrentgara.id,type:"POST",data:g}).done(function(a){a.error?console.log("error"):(console.log("posted"),$(a.addedmatches.rows).each(function(b){var c=a.addedmatches.rows[b],d=c.doc.id,e=getCategoria(c.doc.datanascita);colog("derbies"),colog("$allmatches");var f=jGara.matchesbyprog;colog(f),f.rows.push(c);var g=getDerby(d,e);if(colog(g),g.rows.length>0&&f.rows.length>0){var h=g.rows[0].doc.id,i="/matches/update/"+jcurrentgara.id+"/"+d;$.ajax({type:"POST",url:rooturl+i,data:{derby:h},async:!1}),i="/matches/update/"+jcurrentgara.id+"/"+h,$.ajax({type:"POST",url:rooturl+i,data:{derby:d},async:!1})}}),toast("Match "+g.matchid+" added for atleta "+selectedAtl.cognome+" "+selectedAtl.nome),openGara(jGara.gara.rows[0].doc.id,function(){refreshIscritti(),$("#popAddMatch").popup("close"),showMatchesForAtleta(selectedAtl.id)}))}).fail(function(){toast("Error posting","long")})}function test(){var a=filterRows($allmatches,{vinto:"yes",datanascita:".2003"}),b=new EJS({url:"tpl/matchesbyprog2.ejs"}).render(a.rows),c="listabyprog",d=$("ul#"+c);d.empty(),d.append(b),d.listview(),d.listview("refresh"),$("#limatches").html($matches.rows.length+" incontri"),$("#gara #ulinfogara span").html(getMedaglieGara($matches))}function filterAndRender(a){colog("filterandrender "+JSON.stringify(a));var b=filterRows($allmatches,a),c=new EJS({url:"tpl/matchesbyprog2.ejs"}).render(b.rows),d="listabyprog",e=$("ul#"+d);e.empty(),e.append(c),e.listview(),e.listview("refresh");var f=filterRows(b,{dadisputare:"yes"}),h=(filterRows(f,{disputato:"yes"}),filterRows(f,{vinto:"yes"})),i=filterRows(f,{vinto:"no"}),j=f.rows.length+" incontri da disputare";j+="<br>"+f.rows.length+" incontri disputati, "+h.length+" vinti, "+i.length+" persi",$("#limatches").html(j),$("#gara #ulinfogara span").html(getMedaglieGara(b))}function filterRows(a,b,c){c||(c=!1),colog("filterrows: ");var d={rows:[]},e=a.rows;return $(e).each(function(a){var f=e[a],g=!0;for(var h in f.doc)for(var i in b)if(i==h){var j=b[i].toLowerCase();if(""!=j.trim()){var k=f.doc[h].toLowerCase();c?k.trim()==j.trim()||(g=g&&!1):k.indexOf(j)>-1||(g=g&&!1)}}g&&d.rows.push(f)}),d}function searchMatches(){var a=[],b=0,c=0,d=0,e=0,f=0,g=0,h=0,j="M";j=$("#searchMatches #sex").val();var k=$("#searchMatches #categ").val(),l=$("#searchMatches #medag").val(),m="";$("#searchMatches #quadrato").val()&&(m=$("#searchMatches #quadrato").val().trim()),m||(m=""),"_"==m&&(m="");var n=[{name:"sesso",value:j},{name:"categoria",value:k},{name:"medagliamatch",value:l}],o={rows:[]};$($allmatches.rows).each(function(a){var b=$allmatches.rows[a].doc,c=b.atletaid,d=getAtletaById(c),e={};b.sesso=d.sesso,b.categoria=getCategoria(d.datanascita),e=b,o.rows.push(e)}),$(o.rows).each(function(b){var c=o.rows[b],d=!0;$(n).each(function(a){var b=n[a];if(c[b.name]){var e=c[b.name].toLowerCase(),f="";null!=b.value&&(f=b.value.toLowerCase());var g=!0;""==f.trim()&&(g=!1),"_"==f.trim()&&(g=!1),g&&e.indexOf(f)==-1&&(d=!1)}else d=!1});getAtletaById(c.atletaid);if(d)if(""!=m.trim()){var f=c.matchid.trim(),g=f.substring(0,f.length-2).trim();g==m&&a.push(c)}else a.push(c)});var p="";$(a).each(function(i){var j=a[i].disputato,k=a[i].dadisputare,l=a[i].vinto,m="",n="",o="blacknormal";"yes"==k.toLowerCase().trim()?(o="blacknormal","yes"==j.toLowerCase().trim()&&(m="<b>",n="</b>",o="yes"==l.toLowerCase().trim()?"green":"red")):o="black",p+="<li class='"+o+"'><span class='"+o+"'>"+m+a[i].atletaname+" - "+a[i].matchid+n+"</span></li>","yes"==a[i].disputato?("yes"==a[i].vinto?b++:c++,d++,"oro"==a[i].medagliamatch&&f++,"argento"==a[i].medagliamatch&&g++,"bronzo"==a[i].medagliamatch&&h++):e++});var q="";q+="<b>totale incontri trovati: "+a.length+"</b><br>",q+="disputati: "+d+"<br>",q+="vinti: "+b+"<br>",q+="persi: "+c+"<br>",q+="non disputati: "+e+"<br>",q+="ori: "+f+"<br>",q+="argenti: "+g+"<br>",q+="bronzi: "+h+"<br><br><br>",$("#searchMatches #searchResults").empty().html(q),$("#searchMatches #searchlist").empty(),$("#searchMatches #searchlist").append(p),$("#searchMatches #searchlist").listview(),$("#searchMatches #searchlist").listview("refresh")}function addGara(){conslog("addgara"),$.mobile.changePage("#page_addgara")}function addSocieta(){conslog("addsocieta"),$.mobile.changePage("#page_addsocieta")}function addAtleta(){conslog("addatleta"),$("#page_addatleta").find("#societaid").val(settings.mysocieta),getSocietaById(settings.mysocieta,function(a){a.rows.length>0&&$("#page_addatleta").find("#societa").html("Società: <b>"+a.rows[0].doc.nome.toUpperCase()+"</b>"),$.mobile.changePage("#page_addatleta")})}function addAtletaOk(a){var b=$(a).closest("div[data-role=page]"),c={},d=checkValidAtletaForm(b);return 1==d.error?void alert("Errore di inserimento:\n\n"+d.errors):(b.find(".jform").each(function(){var a=$(this).attr("id");c[a]=$(this).val()}),void $.ajax({url:rooturl+"/atleti/add",type:"POST",data:c}).done(function(a){a.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_atleti"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")}))}function addSocietaOk(a){var b=$(a).closest("div[data-role=page]"),c={};b.find(".jform").each(function(){var a=$(this).attr("id");c[a]=$(this).val()}),$.ajax({url:rooturl+"/societa/add",type:"POST",data:c}).done(function(a){a.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_societa"),refreshSocietaServer())}).fail(function(){toast("Error posting","long")})}function addGaraOk(a){var b=$(a).closest("div[data-role=page]"),c=checkValidGaraForm(b);if(1==c.error)return void alert("Errore di inserimento:\n\n"+c.errors);var d={};b.find(".jform").each(function(){var a=$(this).attr("id");d[a]=$(this).val()}),$.ajax({url:rooturl+"/gare/add",type:"POST",data:d}).done(function(a){a.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#gare"),refreshGareServer())}).fail(function(){toast("Error posting","long")})}function editAtleta(a){console.log("editatleta");var b=$(a).closest("div[data-role=page]"),c=b.find("#atletaid"),d=c.val();colog("Editing atletaid "+d);var e=getAtletaById(d);$("#page_editatleta").find(".jform").each(function(){var a=$(this).attr("id");colog("campo "+a+" - "+e[a]),$(this).val(e[a])}),$("#page_editatleta").find("#atletaid").val(d),$("#page_editatleta").find("#societaid").val(settings.mysocieta),getSocietaById(settings.mysocieta,function(a){a.rows.length>0&&$("#page_editatleta").find("#societa").html("Società: "+a.rows[0].doc.nome.toUpperCase()),$.mobile.changePage("#page_editatleta")})}function checkValidGaraForm(a){var b="",c=!1,d="",e="location,title,data,stato",f=e.split(",");$(f).each(function(d){var e=a.find("#"+f[d]).val();""==e.trim()&&(c=!0,b+="- il campo "+f[d]+" non può essere vuoto\n")}),d=a.find("#data").val();var f=d.split("/");3!=f.length&&(c=!0,b+="- la data deve essere nel formato gg/mm/aaaa\n"),d=a.find("#stato").val();var g="nondisputata,disputata,incorso",h=!1,i=g.split(",");$(i).each(function(a){i[a]==d&&(h=!0)}),h||(c=!0,b+="- stato invalido, stati validi sono nondisputata,disputata,incorso\n");var j={error:c,errors:b};return j}function checkValidAtletaForm(a){var b="",c=!1,d="";d=a.find("#nome").val(),""==d.trim()&&(c=!0,b+="- il nome non può essere vuoto\n"),d=a.find("#cognome").val(),""==d.trim()&&(c=!0,b+="- il cognome non può essere vuoto\n"),d=a.find("#datanascita").val();var e=d.split(".");3!=e.length&&(c=!0,b+="- la data di nascita deve essere nel formato gg.mm.aaaa\n");var f={error:c,errors:b};return f}function editAtletaOk(a){var b=$(a).closest("div[data-role=page]"),c=b.find("#atletaid").val(),d={},e=checkValidAtletaForm(b);return 1==e.error?void alert("Errore di inserimento:\n\n"+e.errors):(b.find(".jform").each(function(){var a=$(this).attr("id");d[a]=$(this).val()}),void $.ajax({url:rooturl+"/atleti/update/"+c,type:"POST",data:d}).done(function(a){a.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_atleti"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")}))}function getAllAtleti(a){$.ajax({type:"GET",url:rooturl+"/atleti/findall/",success:function(b){a(b)}})}function addIscritto(){var a=[];jcurrentgara.iscritti;progressStart(),getAllAtleti(function(b){$(b.rows).each(function(c){var d=b.rows[c];d.doc.id.trim();a.push(d)}),a.sort(function(a,b){var c=a.doc.cognome.trim(),d=b.doc.cognome.trim();return c>d?1:c<d?-1:0}),progressStop();var c=new EJS({url:"tpl/selectiscritti.ejs"}).render(a);$("#selectIscrittiPage #selectiscr").empty().append(c),$.mobile.changePage("#selectIscrittiPage")})}function addIscrittiOk(){var a="";$("#selectIscrittiPage :checkbox:checked").each(function(b){var c=$(this).val();""!=a.trim()&&(a+=","),a+=c}),jcurrentgara.iscritti=a;var b={};b.id=jcurrentgara.id,b.iscritti=a,$.ajax({url:rooturl+"/gare/update",type:"POST",data:b}).done(function(a){a.error?toast("error"):(console.log("posted"),refreshCurrentGara(function(){showIscritti(),refreshGareServer()}))}).fail(function(){toast("Error posting update","long")})}function saveOptions(){rooturl=$("#optionsPage #server").val();var a=$("#optionsPage #ckNotifiche").prop("checked"),b=$("#optionsPage #societaid").val(),c=$("#optionsPage #societaid option:selected").text(),d={server:rooturl,notifiche:a,mysocieta:b,mysocietaname:c};setCookie("options",JSON.stringify(d)),settings=d,$(".serverspan").html("Server: "+rooturl),refreshAtletiServer(),refreshGareServer(),refreshNews(function(a){}),$.mobile.changePage("#index"),updateHomeInfos()}function setServer(a){$("#optionsPage #server").val(a)}function getSocieta(a){$.ajax({type:"GET",url:rooturl+"/societa/findall/",success:function(b){a(b)}})}function getSocietaById(a,b){$.ajax({type:"GET",url:rooturl+"/societa/findbyid/"+a,success:function(a){b(a)}})}function loadOptions(a){console.log("loadOptions");var b={server:rooturl,notifiche:!0,mysocieta:"20160217220400",mysocietaname:"ASD TAEKWONDO ROZZANO"};settings=b,getSocieta(function(c){var d=new EJS({url:"tpl/selectsocieta.ejs"}).render(c.rows);$("#optionsPage #societaid").empty().append(d);var e=getCookie("options");if(null==e)setCookie("options",JSON.stringify(b)),settings=b,$("#optionsPage #server").val(settings.server),$("#optionsPage #ckNotifiche").prop("checked",settings.notifiche),$("#optionsPage #societaid").val(settings.mysocieta);else{var f=JSON.parse(e);f.server||(f.server=b.server),f.notifiche||(f.notifiche=b.notifiche),f.mysocieta||(f.mysocieta=b.mysocieta),f.mysocietaname||(f.mysocietaname=b.mysocietaname),$("#optionsPage #server").val(f.server),$("#optionsPage #ckNotifiche").prop("checked",f.notifiche),$("#optionsPage #societaid").val(f.mysocieta),settings=f}a&&a()})}function delMatch(){var a=delmatchid;gConfirm("Sei sicuro di voler cancellare l'incontro ?","Conferma",function(){colog("deleting matchid "+a);var b="updagent.php?action=delete&tag=match",c=jGara.matchesbyprog;$(c.rows).each(function(b){var d=c.rows[b].doc.id,e=c.rows[b].doc;if(d.trim()==a.trim()&&e.derby&&""!=e.derby.trim()){var f=e.derby,g="/matches/update/"+jcurrentgara.id+"/"+f;$.ajax({type:"POST",url:rooturl+g,data:{derby:null},async:!1}),colog("resetted derby flag on matchid "+f)}}),b+="&id="+a,b+="&garaid="+garaid,b="/matches/delete/"+jcurrentgara.id+"/"+a,$.post(rooturl+b,{a:"1"},function(){delmatchid="",openGara(jcurrentgara.id,function(){$("#matchesatleta #popDelMatch").popup("close"),showMatchesForAtleta(selectedAtl.id)})})},function(){cancelDelMatch()})}function cancelDelMatch(){$("#matchesatleta #popDelMatch").popup("close")}function getCookie(a){var b;if(colog("isPhone: "+isPhone),isPhone){var c=window.localStorage;colog("storage: "+c),b=c.getItem(a)}else{b=document.cookie;var d=b.indexOf(" "+a+"=");if(d==-1&&(d=b.indexOf(a+"=")),d==-1)b=null;else{d=b.indexOf("=",d)+1;var e=b.indexOf(";",d);e==-1&&(e=b.length),b=unescape(b.substring(d,e))}}return b}function setCookie(a,b,c){if(isPhone){var d=window.localStorage;d.setItem(a,b)}else{var e=new Date;e.setDate(e.getDate()+c);var f=escape(b)+(null==c?"":"; expires="+e.toUTCString());document.cookie=a+"="+f}}function autoLogin(){var a=getCookie("email"),b=getCookie("psw"),c=getCookie("autologin");fbloggedin=!0,colog("autologin cookie: "+c),c&&"true"==c&&(a&&b?(console.log("doing autologin"),$("#login #txt-email").val(a),$("#login #txt-password").val(b),doLogin()):(toast("Login automatico fallito"),deleteCookie("email"),deleteCookie("psw"),deleteCookie("autologin"),showLoginPage()))}function showLoginPage(){var a=getCookie("email"),b=getCookie("psw"),c=getCookie("autologin");return console.log(c),a&&b?($("#login #txt-email").val(a),$("#login #txt-password").val(b)):($("#login #txt-email").val(""),$("#login #txt-password").val("")),c&&"true"==String(c)?(console.log("autologin is true, autologgin in"),void autoLogin()):void $.mobile.changePage("#login")}function enableAudioJS(){}function loadChatFile(a){var b=$("#page_chat"),c=rooturl+"/chat/getfile/"+a;$.ajax({type:"GET",url:c,success:function(a){var c=a.rows,d=new EJS({url:"tpl/chat.ejs"}).render(c);b.find(".container").empty().append(d),enableAudioJS(),tapholdBubble(),!self;var e=new EJS({url:"tpl/matchesrealtime2.ejs"}).render(realtimeArray);b.find(".chatrealtime .rtul").empty().append(e),$.mobile.changePage("#page_chat")},error:function(a){}})}function listChats(){$.mobile.changePage("#page_chatlist"),progressStart();var a=rooturl+"/chat/list";$.ajax({url:a,type:"GET",data:{}}).done(function(a){conslog("chat listate"),progressStop();var b=new EJS({url:"tpl/chatlist.ejs"}).render(a.rows);$("#page_chatlist").find(".content ul").empty().append(b),$("#page_chatlist").find(".content ul").listview().listview("refresh"),$("#page_chatlist").find(".content ul li").off("taphold"),$("#page_chatlist").find(".content ul li").on("taphold",function(){var a=$(this).find(".medium").text();a.indexOf("_")>-1&&gConfirm("Sei sicuro di voler cancellare la chat "+a+" ?","Cancella chat",function(){var b=rooturl+"/chat/delete/"+a.split("_")[1].replace(".json","");$.ajax({url:b,type:"GET",data:{}}).done(function(a){console.log("data"),listChats()})},function(){})}),refreshChat()})}function resetChat(){var a=rooturl+"/chat/archive/"+jcurrentgara.id;chatmultiroom||(a=rooturl+"/chat/archive"),gConfirm("Sei sicuro di voler resettare la chat per questa gara ? ?","Reset chat",function(){$.ajax({url:a,type:"GET",data:{}}).done(function(a){conslog("chat resettata"),refreshChat(),socketNotify({type:"refreshchat",to:"all",nickname:chatuser.nickname}),gotoChat(!0)})},function(){})}function postChat(a){var b={sockid:chatuser.sockid,nickname:chatuser.nickname,garaid:jcurrentgara.id,text:$("#page_chat #chatmsg").val()};a||(a=b);var c=!1,d=!1,e=!1;a.foto&&""!=a.foto.trim()&&(d=!0),a.audio&&""!=a.audio.trim()&&(e=!0);var f=d||e;if(""!=a.text.trim()||f||(c=!0),!c){var g=rooturl+"/chat/put/"+jcurrentgara.id;chatmultiroom||(g=rooturl+"/chat/put"),playSound("img/chatsend"),$("#page_chat #chatmsg").val(""),$.ajax({url:g,type:"POST",data:a}).done(function(a){console.log(a),$("#page_chat #chatmsg").val("")}).error(function(a){console.log("error",a)})}}function gotoChat(a){var b=!1;a&&1==a&&(b=!0);$("#page_chat");$.mobile.changePage("#page_chat"),chatScrollBottom(),chatunreadcount=0,setCookie("chat_unread",chatunreadcount),setChatBubbles()}function refreshChat(a){var b=!1;a&&1==a&&(b=!0);var c=$("#page_chat"),d=rooturl+"/chat/get/"+jcurrentgara.id;chatmultiroom||(d=rooturl+"/chat/get"),$.ajax({type:"GET",url:d,success:function(a){var d=a.rows,e=new EJS({url:"tpl/chat.ejs"}).render(d);c.find(".container").empty().append(e);var f=new EJS({url:"tpl/matchesrealtime2.ejs"}).render(realtimeArray);c.find(".chatrealtime .rtul").empty().append(f),tapholdBubble()},error:function(a){}})}function gotoSocieta(){$.mobile.changePage("#page_societa"),refreshSocietaServer()}function doLogout(){gConfirm("Sei sicuro di volerti scollegare ?","Log out",function(){loggedin=!1,$("#index #lilogin").show(),$("#index #liatleti").hide(),$("#index #lisockets").hide(),$("#gare #liaggiungigara").hide(),$("#gara #liresetcronaca").hide(),$("#gara #lisysmsg").hide(),$("#page_atleti #liaggiungiatleta").hide(),$("#iscrittiPage #btnAddIscritto").hide(),$("#gare #test").hide(),$("#index .loginspan").html(""),$(".showadmin").hide(),deleteCookie("autologin"),$.mobile.changePage("#index_fb")},function(){})}function showNotifications(){var a=jcurrentgara.iscritti;colog("iscritti: "+a);var b=a.split(",");""==a.trim()&&(b=[]);var c=[];$(b).each(function(a){var d=getAtletaById(b[a]),e={};e.nome=d.cognome+" "+d.nome,e.id=d.id,c.push(e)}),c.sort(function(a,b){var c=a.nome.trim(),d=b.nome.trim();return c>d?1:c<d?-1:0}),html=new EJS({url:"tpl/selectnotifiche.ejs"}).render(c),$("#page_notifiche #ulatleti").empty().append(html),$.mobile.changePage("#page_notifiche")}function setNotificheOk(){var a="";$("#page_notifiche :checkbox:checked").each(function(b){var c=$(this).val();colog(c),""!=a.trim()&&(a+=","),a+=c}),setCookie("notifiche_atleta",a),$.mobile.changePage("#gara")}function notify(a,b){if(isPhone){notcount++,notcount>3&&(notcount=1);cordova.plugins.notification.local.schedule({id:1,text:a,title:"AppKwonDo",icon:"file://img/logotkdrozzano_icon.png"}),cordova.plugins.notification.local.on("click",function(a){console.log("clicked notification"),$.mobile.changePage("#page_chat"),chatScrollBottom(),chatunreadcount=0,setCookie("chat_unread",chatunreadcount),setChatBubbles()})}else console.log("Notification: "+a)}function clickNotification(){console.log("clicked notifichation"),$.mobile.changePage("#gara"),openGara(garanotifyid,function(){garaid=id,$gara=data,gotoChat()})}function pushSuccessHandler(a){var b="Push Callback Success! Result = "+a;console.log(b)}function pushErrorHandler(a){console.log("pushError: "+a)}function onNotificationGCM(a){switch(console.log("onNotificationGCM"),a.event){case"registered":a.regid.length>0&&(console.log("Regid "+a.regid),toast("Registered on GCM"),cordova.plugins.notification.local.on("click",function(a){toast("clicked notification"),$("#dialogNotifiche #content").empty.html(a.text),$.mobile.changePage("#dialogNotifiche",{role:"dialog"})}));break;case"message":notify(a.message);break;case"error":console.log("GCM error "+a.msg);break;default:console.log("An unknown GCM event has occurred")}}function sendGCM(a){console.log("sendGCM: "+a);var b={};b.message=a,b.title="AppKwonDo",b.msgcnt="3",b.soundname="beep.wav",$.ajax({url:rooturl+"/matches/notify",type:"POST",data:b}).done(function(a){a.error?(colog("error posting notification"),toast("error")):colog("posted GCM notification")}).fail(function(){toast("Error posting GCM push","long")})}function deleteCronacaReadForGara(a){conslog("deleteCronacaRead for gara "+a),conslog("parto con cronaca_read: "+cronaca_read.length),conslog(cronaca_read);for(var b=0;b<cronaca_read.length;b++){var c=cronaca_read[b];conslog("row: ",c);var d=c.split("_"),e=d[0],f=d[1];e==a&&(conslog("elimino "+f),cronaca_read.splice(b,1))}conslog("cronaca_read restante: "+cronaca_read.length),conslog(cronaca_read)}function resetCronaca(){var a=jcurrentgara.id;gConfirm("Vuoi veramente resettare la cronaca per questa gara ?","conferma",function(){socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,event:"resetcronaca"}),deleteCronacaReadForGara(a),$.ajax({type:"GET",url:rooturl+"/gare/resetcronaca/"+a,success:function(a){toast("Cronaca resettata"),socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,event:"refreshcronaca"}),refreshCurrentGara()}})},function(){})}function socketNotify(a){sendSocketMessage(a)}function sendSocketMessage(a){var b={to:"all",text:"sample message",type:"notification"};a&&(b=a),socket.send(b),colog("socket message sent to socket.io server")}function getGaraById(a){var b=null;sdebug("getGaraById "+a);var b={};return $($gare.rows).each(function(c){var d=$gare.rows[c],e=d.doc.id;$.trim(e)==$.trim(a)&&(sdebug("trovata gara"),b=d)}),b}function mapOpened(){console.log("mapOpened")}function garaMaps(a){var b=jcurrentgara,c="";b.maplocation&&(c=b.maplocation);var d=new EJS({url:"tpl/garamap.ejs"}).render(c);$("#garamaps #content").html(d),$.mobile.changePage("#garamaps")}function deleteGara(a){var b=a;gConfirm("Confermi l'eliminazione della gara ?","Conferma eliminazione",function(){var c={};c.id=a,c.rev=b,$.ajax({url:rooturl+"/gare/delete",type:"POST",data:c}).done(function(a){a.error?console.log("error"):(console.log("posted"),refreshGareServer())}).fail(function(){toast("Error posting","long")})},function(){}),popGareCancel()}function showSocketsPage(){showSockets(function(){$.mobile.changePage("#page_sockets")})}function showSockets(a){var b={};$("#page_sockets #pconn").html("Aggiornamento..."),$.ajax({url:rooturl+"/socketusers",
type:"GET",data:b}).done(function(b){var c=new EJS({url:"tpl/sockets.ejs"}).render(b);$("#page_sockets #content").html(c),$("#page_sockets #ulsockets").listview(),$("#page_sockets #pconn").html(b.length+" utenti connessi ad AppKwonDo"),a&&a()})}function resetLog(){var a=rooturl+"/clearlog";progressStart(),$.ajax({url:a,type:"GET"}).done(function(a){console.log(a),a=a.replace(/(?:\r\n|\r|\n)/g,"<br />"),progressStop(),gotoLog()})}function gotoLog(){var a=rooturl+"/log.txt";progressStart(),$.ajax({url:a,type:"GET"}).done(function(a){a=a.replace(/(?:\r\n|\r|\n)/g,"<br />"),$("#page_log #content").html(a),progressStop(),$.mobile.changePage("#page_log")})}function clickSocket(a){var b=$.mobile.activePage.attr("id"),c={destsocket:a},d=new EJS({url:"tpl/sysmsg.ejs"}).render(c);return $("#"+b+" div[data-role=content]").append(d),$("#"+b+" #popSysMsg #dest").val(a),$("#"+b+" #popSysMsg").popup(),void $("#"+b+" #popSysMsg").popup("open")}function fb_login(){facebookcheck?openFB.login(function(a){"connected"===a.status?(colog("Facebook login succeeded, got access token: "+a.authResponse.token),$("#index_fb #errormsg").html(""),fb_getInfo(function(){fbCheckGroup("116270558490682",fb_user,function(a){var b="holly ozoora",c=b.toLowerCase().split(",");if($(c).each(function(b){var d=c[b].trim();fb_user.name.toLowerCase().indexOf(d)>-1&&(a=!0)}),a){colog("bravo, fai parte del gruppo facebook asd taekwondorozzano"),$("#index_fb #errormsg").html(""),fbloggedin=!0,refreshNews(),$.mobile.changePage("#index");var d={device:"browser",type:"clientspecs",nickname:socketnickname,appversion:appversion};isPhone&&(d.device="mobile"),socket.send(d)}else{var e="Non fai attualmente parte del gruppo Facebook ASD Taekwondo Rozzano.";$("#index_fb #errormsg").html(e)}})})):(colog("Login Facebook fallito: "+a.error),$("#index_fb #errormsg").html("Accesso a Facebook fallito"))},{scope:"email,publish_actions,user_managed_groups"}):(fbloggedin=!0,refreshNews(),$.mobile.changePage("#index"))}function fb_getInfo(a){openFB.api({path:"/me",success:function(b){colog(JSON.stringify(b)),fb_userid=b.id,fb_user.id=b.id,fb_user.name=b.name,socketnickname=fb_user.name,colog("fb_userid: "+fb_userid),colog("fb_name: "+b.name),colog("socketnickname: "+socketnickname),$("#index #fbuser #userName").html(chatuser.nickname),$("#index #fbuser #userPic").attr("src","http://graph.facebook.com/"+b.id+"/picture?type=small"),$("#index #fbuser").show(),a&&a()},error:fb_errorHandler})}function fb_share(){openFB.api({method:"POST",path:"/me/feed",params:{message:document.getElementById("Message").value||"Testing Facebook APIs"},success:function(){alert("the item was posted on Facebook")},error:fb_errorHandler})}function fb_revoke(){openFB.revokePermissions(function(){alert("Permissions revoked")},fb_errorHandler)}function fb_logout(a){openFB.logout(function(){colog("Logout successful"),fbloggedin=!1,a&&a()},fb_errorHandler)}function fb_errorHandler(a){alert(a.message)}function fb_checkgroup(){fbCheckGroup("116270558490682",fb_user,function(a){a&&alert("bravo, fai parte del gruppo")})}function getQueryString(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}}function Right(a,b){if(b<=0)return"";if(b>String(a).length)return a;var c=String(a).length;return String(a).substring(c,c-b)}function addCronaca(){$.mobile.changePage("#page_editcronaca")}function addCronacaOk(){var a="/matches/addcronaca/"+jcurrentgara.id,b=$("#page_editcronaca #testo").val();progressStart(),$.ajax({type:"POST",url:rooturl+a,async:!0,data:{text:b},success:function(){progressStop();var a=!1,c=$("#page_editcronaca input:checkbox[name=ckNotifica]");a=c.is(":checked"),a&&socketNotify({type:"notification",to:"all",text:b,garaid:jcurrentgara.id,updategara:"yes"}),loadCronaca(jcurrentgara.id,function(){$.mobile.changePage("#gara")})},error:function(){progressStop(),alert("errore")}})}function delCronaca(a){confirm("Sicuro di voler cancellare questa riga di cronaca da questa gara ?","Conferma")&&$.ajax({type:"POST",url:rooturl+"/matches/delcronaca/"+jcurrentgara.id+"/"+a,success:function(a){toast("Cronaca aggiornata"),loadCronaca(jcurrentgara.id)}})}function toggleConsole(a){var b=$(a).find("div.console");b.toggle()}function gotoTempoReale(){var a="#realtimeconsole",b=$(a),c=new EJS({url:"tpl/realtimeconsole.ejs"}).render(realtimeArray);b.find("#content").html(c),b.trigger("create"),b.trigger("pagecreate"),$.mobile.changePage(a)}function updateRankingTkdr(){var a=$("#page_ranking #selanno").val(),b="";""!=a.trim()&&(b=" per l'anno "+a);var c="Calcolo ranking TKDR "+b+" in corso....";$("#page_ranking #ranking").html(c),progressStart(c),$.ajax({type:"GET",url:rooturl+"/atleti/ranking/",async:!0,success:function(a){var b=new EJS({url:"tpl/ranking.ejs"}).render(a.rows);$("#page_ranking #ranking").html(b),progressStop()}})}function updateRankingTkdr_old(){var a,b,c=$("#page_ranking #selanno").val(),d="";""!=c.trim()&&(d=" per l'anno "+c);var e="Calcolo ranking TKDR "+d+" in corso....";$("#page_ranking #ranking").html(e),progressStart(e),$.ajax({type:"GET",url:rooturl+"/atleti/findall?societaid="+settings.mysocieta,async:!0,success:function(d){a=d,$.ajax({type:"GET",async:!0,url:rooturl+"/gare/findall?societa="+settings.mysocieta,success:function(d){b=d,$(b.rows).each(function(a){var c=b.rows[a].doc,d=c.id;$.ajax({type:"GET",async:!1,url:rooturl+"/matches/findbygaraid/"+d+"?societa="+settings.mysocieta,success:function(c){b.rows[a].doc.matches=c}})}),$(a.rows).each(function(d){var e=a.rows[d].doc,f=e.datanascita,h=(getCategoria(f,!0),!0);h&&(a.rows[d].doc.ranking_tkdr=0,a.rows[d].doc.ori=0,a.rows[d].doc.argenti=0,a.rows[d].doc.bronzi=0,a.rows[d].doc.garedisputate=0,colog("calcolo ranking per "+e.cognome+" "+e.nome),$(b.rows).each(function(f){var g=b.rows[f].doc,i=(g.id,g.data),j=!1;if(""==c?j=!0:i.indexOf("/"+c)>-1&&(j=!0),j){var k=b.rows[f].doc.matches,l=!1;$(k.rows).each(function(b){var c=k.rows[b].doc,f=c.atletaid;if(f==e.id&&(l=!0,c.medagliamatch)){var g=c.medagliamatch.toLowerCase();"oro"==g&&(a.rows[d].doc.ranking_tkdr+=7,a.rows[d].doc.ori++),"argento"==g&&(a.rows[d].doc.ranking_tkdr+=3,a.rows[d].doc.argenti++),"bronzo"==g&&(a.rows[d].doc.ranking_tkdr+=1,a.rows[d].doc.bronzi++)}}),1==l&&a.rows[d].doc.garedisputate++}}))}),a.rows.sort(function(a,b){var c=a.doc.ranking_tkdr,d=b.doc.ranking_tkdr;return c>d?-1:c<d?1:0});var e=new EJS({url:"tpl/ranking.ejs"}).render(a.rows);$("#page_ranking #ranking").html(e),progressStop()}})}})}function padZeros(a,b){for(var c=String(a);c.length<b;)c="0"+c;return c}function formatBytes(a){return a<1024?a+" Bytes":a<1048576?(a/1024).toFixed(3)+" KB":a<1073741824?(a/1048576).toFixed(3)+" MB":(a/1073741824).toFixed(3)+" GB"}function chatScrollTop(){$.mobile.silentScroll(0)}function chatScrollBottom(){var a=$("#page_chat #chatscroll");a.attr("data-icon","arrow-u"),a.addClass("ui-icon-arrow-u").removeClass("ui-icon-arrow-d");var b=99999;$.mobile.silentScroll(b)}function chatScroll(){var a=$("#page_chat #chatscroll"),b=a.attr("data-icon");console.log(b);var c=0;"arrow-d"==b?(console.log("giu"),a.attr("data-icon","arrow-u"),a.addClass("ui-icon-arrow-u").removeClass("ui-icon-arrow-d"),c=99999):(console.log("su"),c=0,a.attr("data-icon","arrow-d"),a.addClass("ui-icon-arrow-d").removeClass("ui-icon-arrow-u")),console.log(c),$.mobile.silentScroll(c)}var pictureSource,destinationType,scheda={},loggedin=!1,role="tkdruser",fbloggedin=!1,chatrefreshcount=0,lastenteredmatch={},consoles=[],page_popup=!0,appversion="1.2.6",crnonletti=0,garanotifyid="",facebookcheck=!0,debugActive=!1,defaultimage="img/logotkdrozzano.jpg",tapevent="tap",cronaca_unread=[],cronaca_read=[],chatnonletti=[],chatunreadcount=0,fotodata="",sounddata="",currentround="1",currentresult="0-0",currentammon=0,chatmultiroom=!1,tkdt_iscritti={tabulati:[],avversari:[],rows:[]},realtime={round:"1",result:"0-0",ammoniz:0,running:!1,active:!1,fineround:!1},realtimeArray=[],realtimeindex=-1,chatuser={sockid:"",nickname:""},rtmatches=[],rooturl="http://tkdr.herokuapp.com",typingtimeout=null,caricamentotext="<img style='position: relative; top: 4px;' src='images/ajax-loader2.gif' />&nbsp;&nbsp;&nbsp;Caricamento...",imgtext="<img style='position: relative; top: 4px;' src='images/ajax-loader2.gif' />&nbsp;&nbsp;&nbsp;",settings=null,garaFilters={categoria:"",sesso:"",medaglia:"",quadrato:""},isFiltered=!1,socketnickname="",socket,isPhone=!1,boname="scheda",bonames="Schede",parm_garaid="",cattxt="Categoria: ",showMsg=null,garaid="",jGara={cronaca:{rows:[]}},$gara={},$gare={},jcurrentgara={},activeTab=0,jmatchesbyatleta=[],jmatchesbyprog=[],$atleti={},$allatleti={},delmatchid="",prevSelection="tab1",$matches,$allmatches={},cat="",selectedAtl={},selectedid="",cookieDays=3,storage,cronaca={rows:[]},autorefresh=!1,timerMatches=2e4,mf={},iscrittiincat=[],viewcat="",fb_userid="",fb_user={};$(window).resize(function(){resizeImage("#viewimage #img1")});var autorefreshcount=0,app={initialize:function(){colog("app.initialize"),this.bind()},onCameraSuccess:function(a){toast("Photo acquired","long");var b,c,d;for(b=0,d=a.length;b<d;b+=1)c=a[b].fullPath,$("#fotoAnteprima").attr("src",c).css({width:"128px",height:"128px"})},onCameraError:function(a){toast("Error acquiring photo: "+a,"long")},onMenuButton:function(){return console.log("menubutton pressed"),void toggleLeftMenu()},onBackButton:function(){var a=$.mobile.activePage.attr("id");$("#"+a+" #btnBack").trigger("click")},online:function(){$("#btnInviaSchede").removeClass("ui-disabled")},offline:function(){$("#btnInviaSchede").addClass("ui-disabled")},isOnline:function(){var a=navigator.connection.type;return toast(a,"short"),a!=Connection.NONE&&a!=Connection.UNKNOWN},bind:function(){colog("app.bind"),document.addEventListener("deviceready",this.deviceready,!1)},deviceready:function(){colog("deviceready !"),document.addEventListener("online",app.online,!1),document.addEventListener("offline",app.offline,!1),document.addEventListener("menubutton",app.onMenuButton,!1),document.addEventListener("backbutton",app.onBackButton,!1),storage=window.localStorage,pictureSource=navigator.camera.PictureSourceType,destinationType=navigator.camera.DestinationType,colog("Navigator user agent from deviceready: "+navigator.userAgent),navigator.userAgent.indexOf("Android")!=-1&&($.mobile.defaultPageTransition="none",$.mobile.defaultDialogTransition="none",$.mobile.buttonMarkup.hoverDelay=0),isPhone=!!navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/),docready(),app.start()},start:function(){},exit:function(){navigator.notification.confirm("Vuoi veramente chiudere AppKwonDo ?",function(a){1==a&&navigator.app.exitApp()},"Informazione","Sì,No")},storage:window.localStorage,initialize:function(){this.bind()},loadAllSchede:function(a){$.ajax({url:rooturl+"/atleti/findall?societaid="+settings.mysocieta,type:"GET"}).done(function(b){$atleti=b,a(b)})},loadAllGare:function(a){$.ajax({url:rooturl+"/gare/findall?societa="+settings.mysocieta,type:"GET"}).done(function(b){a(b)})}};$(document).ready(function(){initApp()});var recorder=new Object,recording=!1,errorHandler=function(a,b){var c="";switch(b.code){case FileError.QUOTA_EXCEEDED_ERR:c="Storage quota exceeded";break;case FileError.NOT_FOUND_ERR:c="File not found";break;case FileError.SECURITY_ERR:c="Security error";break;case FileError.INVALID_MODIFICATION_ERR:c="Invalid modification";break;case FileError.INVALID_STATE_ERR:c="Invalid state";break;default:c="Unknown error"}console.log("Error ("+a+"): "+c)},printEventType=function(a){console.log("got event: "+a.type)},waittkdttimer,waitactive=!1,waitinterval=6e4,tkdtcontent="",silenttkdt=!1,enableprogress=!0,isIOS=!1,lastrealtime={},scheda={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","Sì,No")},save:function(a,b,c){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var d="addScheda";scheda.data._id&&(d="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+d,type:"POST",data:scheda.data}).done(function(a){a.error?c():(app.storage.clear(),colog("save result: "+JSON.stringify(a)),b())}).fail(function(){myToast({body:"Error posting"})})}},onPositionSuccess:function(a){scheda.data.coordinate=a.coords,myToast({body:JSON.stringify(scheda.data)}),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(a){var b="";switch(a.code){case PositionError.PERMISSION_DENIED:b="L'applicazione non è autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:b="Non è disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:b="Non è stato possibile rilevare la posizione corrente"}myToast({body:b})},load:function(a){if(""!=a){var b=app.storage.getItem($.trim(a));scheda.data=JSON.parse(b)}},loadById:function(a,b){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/schede/findById/"+a,type:"GET"}).done(function(c){colog("loadbyid "+a+": "+JSON.stringify(c)),scheda.data=c,b(scheda)})},remove:function(a,b){debugga(a+" "+b),""!=a&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:a,rev:b}}).done(function(a){app.storage.clear(),refreshSchedeServer()}).fail(function(){myToast({body:"Error posting"})})},send:function(a,b,c){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:a}).done(function(a){app.storage.clear(),b()}).fail(c)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},gara={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","Sì,No")},save:function(a,b,c){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var d="addScheda";scheda.data._id&&(d="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+d,type:"POST",data:scheda.data}).done(function(a){a.error?c():(app.storage.clear(),colog("save result: "+JSON.stringify(a)),b())}).fail(function(){myToast({body:"Error posting"})})}},onPositionSuccess:function(a){scheda.data.coordinate=a.coords,myToast({body:JSON.stringify(scheda.data)}),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(a){var b="";switch(a.code){case PositionError.PERMISSION_DENIED:b="L'applicazione non è autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:b="Non è disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:b="Non è stato possibile rilevare la posizione corrente"}myToast({body:b})},load:function(a){if(""!=a){var b=app.storage.getItem($.trim(a));scheda.data=JSON.parse(b)}},loadById:function(a,b){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/gare/findById/"+a+"?societa="+settings.mysocieta,type:"GET"}).done(function(c){$gara=c.rows[0],jcurrentgara=$gara.doc,colog("jcurrentgara: "+JSON.stringify(jcurrentgara));colog("loadbyid "+a+": "+JSON.stringify(c)),scheda.data=c,b(scheda)})},remove:function(a,b){debugga(a+" "+b),""!=a&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:a,rev:b}}).done(function(a){app.storage.clear(),refreshSchedeServer()}).fail(function(){myToast({body:"Error posting"})})},send:function(a,b,c){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:a}).done(function(a){app.storage.clear(),b()}).fail(c)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},atleta={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","Sì,No")},save:function(a,b,c){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var d="addScheda";scheda.data._id&&(d="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+d,type:"POST",data:scheda.data}).done(function(a){a.error?c():(app.storage.clear(),colog("save result: "+JSON.stringify(a)),b())}).fail(function(){myToast({body:"Error posting"})})}},onPositionSuccess:function(a){scheda.data.coordinate=a.coords,myToast({body:JSON.stringify(scheda.data)}),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(a){var b="";switch(a.code){case PositionError.PERMISSION_DENIED:b="L'applicazione non è autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:b="Non è disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:b="Non è stato possibile rilevare la posizione corrente"}myToast({body:b})},load:function(a){if(""!=a){var b=app.storage.getItem($.trim(a));scheda.data=JSON.parse(b)}},loadById:function(a,b){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/atleti/findById/"+a,type:"GET"}).done(function(c){colog("loadbyid "+a+": "+JSON.stringify(c)),scheda.data=c,b(scheda)})},remove:function(a,b){debugga(a+" "+b),""!=a&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:a,rev:b}}).done(function(a){app.storage.clear(),refreshSchedeServer()}).fail(function(){myToast({body:"Error posting"})})},send:function(a,b,c){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:a}).done(function(a){app.storage.clear(),b()}).fail(c)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},lastDisplayedAtletaId="",mf={maschi:"0",femmine:"0"},deleteCookie=function(a){if(isPhone){var b=window.localStorage;b.removeItem(a)}else document.cookie=a+"=;expires=Thu, 01 Jan 1970 00:00:01 GMT;"},notcount=0,fbCheckGroup=function(a,b,c){var d=b.id;openFB.api({path:"/"+a+"/members",params:{limit:400},success:function(a){colog(JSON.stringify(a)),colog(a.data.length+" users nel gruppo");for(var b=!1,e=0;e<a.data.length;e++){var f=a.data[e],g=f.id;g==d&&(b=!0)}c&&c(b)},error:fb_errorHandler})};Date.prototype.juliandate=function(){var a=this.getFullYear().toString(),b=(this.getMonth()+1).toString(),c=this.getDate().toString(),d=this.getHours(),e=this.getMinutes(),f=this.getSeconds(),g=this.getMilliseconds();console.log("milliseconds: "+g);var h=2,i=a+padZeros(b,h)+padZeros(c,h)+padZeros(d,h)+padZeros(e,h)+padZeros(f,h)+padZeros(g,3);return console.log("jdate: "+i),i},Date.prototype.juliandateshort=function(){var a=this.getFullYear().toString(),b=(this.getMonth()+1).toString(),c=this.getDate().toString(),d=this.getHours(),e=this.getMinutes(),f=this.getSeconds(),g=2,h=a+padZeros(b,g)+padZeros(c,g)+padZeros(d,g)+padZeros(e,g)+padZeros(f,g);return console.log("jdate: "+h),h};