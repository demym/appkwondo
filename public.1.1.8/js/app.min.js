function resizeImage(e){var a=$(e);a.removeAttr("width").removeAttr("height");var t=jQuery(e).parent();conslog("cw: "+t.css("width")+" - ch: "+t.css("height"));var o=parseInt(a.css("width").replace("px",""),10),r=parseInt(a.css("height").replace("px",""),10);o=$(e).get(0).naturalWidth,r=$(e).get(0).naturalHeight;var i=t.css("width")/o,n=t.css("height")/r;Math.max(i,n);conslog("w: "+o+" - height: "+r);var s=parseInt(t.css("width").replace("px",""),10),c=s/o;conslog("ratio2: "+c);var l=Math.ceil(c*r);conslog("newwidth: "+s+" - newheight: "+l),a.css({width:s,height:l})}function colog(e){debugActive&&console.log(e)}function toggleLeftMenu(){var e=$.mobile.activePage.attr("id"),a=$("#"+e+" #menuPanel").length;a>0&&$("#"+e+" #menuPanel").remove();var t={loggedin:loggedin},o=new EJS({url:"tpl/menupanel.ejs"}).render(t);$("#"+e).append(o),$("#"+e+" #menuPanel").panel(),$("#"+e+" #menuPanel").panel("toggle")}function toggleRightMenu(e){var a=$.mobile.activePage.attr("id"),t=$("#"+a+" #"+e).length;t>0&&$("#"+a+" #"+e).remove();var o={loggedin:loggedin,role:role},r=new EJS({url:"tpl/"+e+".ejs"}).render(o);$("#"+a).append(r),$("#"+a+" #"+e).panel(),$("#"+a+" #"+e).panel("toggle")}function setMatchesRefresh(){autorefresh&&(autorefreshcount++,console.log("running "),1==autorefreshcount&&setInterval(function(){refreshMatches()},timerMatches))}function toggleCheckbox(e,a){var t=$(e).prop("checked"),o=$("#"+a);conslog(t),t?o.show():o.hide()}function openPopup(e,a){a||(a="");var t=$.mobile.activePage.attr("id");conslog("current pageid: "+t),$("#"+t+" div[data-role=content] #temppopup").remove();var o=new EJS({url:"tpl/genericpop.ejs"}).render(e);$("#"+t+" div[data-role=content]").append(o),$("#"+t+" #temppopup h5").html(a),$("#"+t+" #temppopup").popup(),$("#"+t).page("destroy").page(),$("#"+t+" #temppopup").popup("open",{transition:"flip"})}function popCloseRemove(){var e=$.mobile.activePage.attr("id");colog("current pageid: "+e),$("#"+e+" #temppopup").popup("close").remove()}function openTabulato(e){progressStart("Caricamento.."),$.ajax({url:e,type:"GET",dataType:"html"}).done(function(e){colog(e);var a=$(e).find("img[alt=drawing_load_error]"),t=a.attr("src").replace("./","");colog(t);var o="<img style='width: 400px; height: 500px;' src='http://demo.tkdtechnology.it/"+t+"' />";openPopup(o),progressStop()})}function openTabulatoPage(e,a){var t=$(e).html(),o=rooturl+"/gettkdtabulato";progressStart("Caricamento.."),$.ajax({url:o,type:"POST",dataType:"html",data:{url:a}}).done(function(e){colog(e);var o=$(e).find("img[alt=drawing_load_error]"),r=o.attr("src").replace("./","");colog(r);var i="<img style='width: 600px; height: 600px;' src='http://demo.tkdtechnology.it/"+r+"' />";$("#page_tabulato #cat").html(t),$("#page_tabulato #cont").html(i),progressStop(),$("#page_tabulato #url").val(a),$.mobile.changePage("#page_tabulato");var n=$("#page_tabulato #cont img").get(0);n.addEventListener("gesturechange",function(e){console.log(e.scale),e.scale>1||e.scale<1})})}function openTabulatoImage(){var e=$("#page_tabulato #url").val();window.open(e,"_blank","location=no&toolbar=yes")}function getTabulatoImg(e,a){progressStart("Caricamento.."),$.ajax({url:e,type:"GET",dataType:"html"}).done(function(e){colog(e);var t=$(e).find("img[alt=drawing_load_error]"),o=t.attr("src").replace("./","");colog(o);var r="<img style='width: 500px; height: 600px;' src='http://demo.tkdtechnology.it/"+o+"' />";a(r),progressStop()})}function getTkdTechnology(){progressStart("Caricamento..");var e=rooturl+"/gettkdtech";$.ajax({url:e,type:"GET"}).done(function(e){var a=$(e).find("div#tab-63-atl-cls"),t=($(e).find("div#tab-63"),$(e).find("div.tabs:first ul:first li"));colog("navtabs: "+t.length);var o="";colog(e),$(t).each(function(a){var t=$(this).find("a").attr("href"),r=$(this).find("a").html();colog(r);var i=$(e).find("div"+t+"-atl-int"),n=$(e).find("div"+t+"-atl-cls"),s=$(e).find("div"+t+"-atl-tab"),c=$(e).find("div"+t+"-atl-cat"),l=n.find("table"),d=i.find("table");getTkdtInteractive(d),l.css("border","2px solid black"),l.css("width","100%"),l.find("thead tr").prepend("<th width=8>&nbsp;</th>"),l.find("th").css("background","#f6f6f6"),l.find("tr").each(function(e){var a=$(this);e>0&&$(this).prepend("<td width=10>"+e+"</td>");var t=$(this).find("td:first");colog(t.length),a.html().toLowerCase().indexOf("rozzano")>-1&&(a.find("td").css("font-weight","bold"),a.css("background","lightgreen"))});var g="";s.find("a").each(function(e){var a=$(this).html(),t=($(this),$(this).attr("href"));g+="<a style='font-size: 10px; white-space: normal;' class=tabbutton href='#' onclick=openTabulatoPage(this,'"+t+"') >"+a+"</a>"}),l.find("td").css("text-align","center"),l.find("td,th").css("font-size","12px"),l.find("td").css("border-top","1px solid gray"),o+='<div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">'+r+'</h5><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Classifica</h5>'+n.html()+'</div><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Tabulati</h5>'+g+'</div><div data-role="collapsible" data-collapsed="true" data-theme="c" data-mini="true"><h5 id="results-header">Atleti per categoria</h5>'+c.html()+"</div></div>"});t.html()+a.html();$("#page_tkdt").find("#cont").html(o),$("#page_tdkt").is(":visible")||(colog("page_tkdt not visible, showing it"),$.mobile.changePage("#page_tkdt")),$("#temppopup").find("div[data-role=collapsible]").collapsible({theme:"c",refresh:!0}),$("#page_tkdt").find("div[data-role=collapsible]").collapsible({theme:"c",refresh:!0}),$("#page_tkdt").find("a.tabbutton").button(),progressStop();var r=$.mobile.activePage.attr("id");$("#"+r+" #menuPanel").panel("close")})}function getTkdtInteractive(e){console.log("getTkdInteractive");var a=e.find("tbody"),t=a.find("tr");t.each(function(){var e=$(this),a=e.find("td:eq(0)").remove("span").html(),t=e.find("td:eq(1)").remove("span").html(),o=e.find("td:eq(2)").remove("span").html(),r=e.find("td:eq(3)").remove("span").html(),i=e.find("td:eq(4)").remove("span").html(),n=e.find("td:eq(5)").remove("span").html(),s=e.find("td:eq(6)").remove("span").html();if(o.toLowerCase().trim().indexOf("rozzano")>-1){var c={cognome:a,nome:t,categoria:r,categoria_cintura:i,categoria_peso:n,sesso:s};console.log("interactive: "+a+" "+t+" - "+r+" - "+n+" - "+i),tkdt_iscritti.rows.push(c)}})}function cancelDelMatch(){$("#matchesatleta #popDelMatch").popup("close")}function isCordovaApp(){var e=!1;return colog("isCordovaApp URL:"+document.URL),-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")&&(e=!0),1!=e||navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)||(e=!1),e}function initApp(){app.initialize(),colog("Navigator user agent from docready "+navigator.userAgent);var e=isCordovaApp();colog("isCordovaApp: "+e),isPhone=e?!0:!1,colog("Running on phone: "+isPhone),isPhone||docready()}function playSound(e){document.getElementById("sound").innerHTML='<audio autoplay="autoplay"><source src="'+e+'.mp3" type="audio/mpeg" /><source src="'+e+'.ogg" type="audio/ogg" /><embed hidden="true" autostart="true" loop="false" src="'+e+'.mp3" /></audio>'}function myToast(e){var a=new EJS({url:"tpl/popnotification.ejs"}).render(e),t=$.mobile.activePage.attr("id");colog("current pageid: "+t),$("#"+t+" div[data-role=content]").append(a),$("#"+t+" #popNotification").popup(),$("#"+t+" #popNotification").popup("open"),playSound("img/chimes"),setTimeout(function(){$("#"+t+" #popNotification").popup("close").remove()},1800)}function snotify(e){if(colog("Snotify:"),colog(e),0==settings.notifiche)return void colog("notifiche non attive nei settings, esco senza notificare");var a={body:e.text,icon:"img/logotkdrozzano.png"};if(isPhone){notify(e.text);var t=new EJS({url:"tpl/popnotification.ejs"}).render(a),o=$.mobile.activePage.attr("id");colog("current pageid: "+o),$("#"+o+" div[data-role=content]").append(t),$("#"+o+" #popNotification").popup(),$("#"+o+" #popNotification").popup("open"),playSound("img/chimes"),setTimeout(function(){$("#"+o+" #popNotification").popup("close").remove()},6e3)}else{var t=new EJS({url:"tpl/popnotification.ejs"}).render(a),o=$.mobile.activePage.attr("id");if(colog("current pageid: "+o),$("#"+o+" div[data-role=content]").append(t),$("#"+o+" #popNotification").popup(),$("#"+o+" #popNotification").popup("open"),playSound("img/chimes"),setTimeout(function(){$("#"+o+" #popNotification").popup("close").remove()},6e3),"Notification"in window)if("granted"===Notification.permission){colog("notification are granted");new Notification("AppKwonDo",a)}else"denied"!==Notification.permission&&(colog("asking grant for notifications"),Notification.requestPermission(function(e){if("granted"===e){new Notification("AppKwonDo",a)}}));else colog("This browser does not support system notifications")}}function conslog(e){}function closePanel(){conslog("panels found: "+$("[data-role=panel]:visible").length),$("[data-role=panel]:visible").panel("close")}function updateHomeInfos(){$(".serverspan").html("Connesso al server: "+rooturl.replace("http://","").replace("https://","")),$(".societaspan").html("Societ√†: "+settings.mysocietaname)}function recordAudio(){console.log("recordAudio "+recording),recording&&($("#cronacaelements a#recordaudio span").text("REGISTRA").css("color","black"),$("#cronacaelements a#recordaudio").css("background","silver"),recorder.stop()),recording||($("#cronacaelements  a#recordaudio span").text("FERMA REGISTRAZIONE").css("color","yellow"),$("#cronacaelements  a#recordaudio").css("background","red"),recorder.record()),recording=!recording}function playAudio(){recorder.playback()}function sendAudio(){alert("non ancora implementato")}function readAudioFile(e){function a(a){a.root.getFile(e,{},function(e){e.file(function(e){var a=new FileReader;a.onloadend=function(e){var a=document.getElementById("textarea");a.value=this.result},a.readAsText(e)},t)},t)}function t(e){alert("ERROR: "+e.code),console.log("ERROR: ",e)}var o=window.TEMPORARY,r=5242880;window.requestFileSystem(o,r,a,t)}function docready(){var e=getCookie("cronaca_read");console.log("cronaca_read cookie: ",e),null!=e&&(console.log("ripristino cookie cronaca_read"),cronaca_read=JSON.parse(e),console.log(cronaca_read)),isPhone&&(recorder.stop=function(){window.plugins.audioRecorderAPI.stop(function(e){var a=e.substring(1);e.split("/");a="file://"+e,conslog("STOP, fname: "+a),conslog("msg: "+e),myToast({body:a+"<br>"+e}),window.resolveLocalFileSystemURL(a,function(e){conslog("fileEntry: ",e),e.file(function(e){conslog("file: ",e);var a=new FileReader;conslog("reader",a),a.onload=function(){conslog("onload readystate: "+a.readyState);var e=a.result;conslog(e),sounddata=e},a.onloadend=function(e){conslog("onloadend",e)},a.onloadstart=printEventType,a.onprogress=printEventType,a.readAsDataURL(e)})},function(e){console.log("error reading file",e)}),conslog("stopaudio ok: "+e)},function(e){conslog("stopaudio ko!!: "+e)})},recorder.record=function(){window.plugins.audioRecorderAPI.record(function(e){conslog("recordaudio ok: "+e);var a=e.split("/");a[a.length-1]},function(e){conslog("recordaudio ko!!!: "+e)},10)},recorder.playback=function(){window.plugins.audioRecorderAPI.playback(function(e){conslog("playbackaudio ok: "+e)},function(e){conslog("playbackaudio ko!!: "+e)})}),$("a.sgradient").removeClass("sgradient"),$("a").addClass("fastClick"),$("a.ui-btn-left,a.ui-btn-right").addClass("transparentborderbutton").addClass("ui-nodisc-icon"),$.mobile.defaultPageTransition="none",$.mobile.defaultDialogTransition="none",$.mobile.page.prototype.options.addBackBtn=!0,$.mobile.useFastClick=!0,$("#popResult #roundfieldset").find(".roundnumber").off(tapevent),$("#popResult #roundfieldset").find(".foundnumber").on(tapevent,function(){conslog("clicked roundnumber");var e=!1;$("#popResult #radio_round1").is(":checked")&&(e=!0),$("#popResult #radio_round2").is(":checked")&&(e=!0),$("#popResult #radio_round3").is(":checked")&&(e=!0),$("#popResult #radio_gp").is(":checked")&&(e=!0),e&&$("#popResult #ckfineround").prop("checked",!1).checkboxradio("refresh")}),$("#popResult .incbutton").off(tapevent),$("#popResult .incbutton").on(tapevent,function(){var e=$("#popResult #risult").val(),a=$("#popResult #ammoniz1").val(),t=$("#popResult #ammoniz1").val();""==e.trim()&&(e="0-0"),""==a.trim()&&(a="0"),""==t.trim()&&(t="0");var o=$(this).attr("id"),r=parseInt(e.split("-")[0].trim(),10),i=parseInt(e.split("-")[1].trim(),10),n=parseInt(a,10),s=parseInt(t,10);colog("r1: "+r),colog("r2: "+i),conslog("ammon1: "+n),conslog("ammon2: "+s);var c=o.substring(o.length-1),l=o.substring(0,o.length-1);conslog(c+" - "+l),"plus"==l&&(1==c&&r++,2==c&&i++),"minus"==l&&(1==c&&r--,2==c&&i--,0>r&&(r=0),0>i&&(i=0)),"ammplus"==l&&(1==c&&n++,2==c&&s++,0>n&&(n=0),0>s&&(s=0)),"ammminus"==l&&(1==c&&n--,2==c&&s--,0>n&&(n=0),0>s&&(s=0));var d=r+"-"+i;conslog("r1: "+r+" - r2: "+i+" - ammon1: "+n),r>i&&($("#popResult #radio_vinto").click(),$("#popResult #radio_vinto").click()),i>r&&($("#popResult #radio_perso").click(),$("#popResult #radio_perso").click()),r==i&&($("#popResult #radio_nondisputato").click(),$("#popResult #radio_nondisputato").click()),$("#popResult #risult").val(d),$("#popResult #ammoniz1").val(n);var g=$("#popResult #ck_realtime:checked");g.length>0&&(console.log("notify realtime result for "+selectedmatchid+" - "+d+" - "),realtime.active=!0,realtime.running=!0,realtime.result=d,sendRealtime())}),$("#popResult #ck_realtime").off(tapevent),$("#popResult #ck_realtime").on(tapevent,function(){var e=$("#popResult #ck_realtime:checked");e.length>0?(realtime.active=!0,sendRealtime(),socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,matchid:selectedid,matchnumber:selectedmatchid,result:rf,ammoniz1:ammon1,ammoniz2:ammon2,event:"startmatch",text:rf})):realtime.active=!1});var a=window.location.href;if(openFB.init({appId:"924594024295731",tokenStore:window.localStorage}),colog("docready !"),colog("url: "+a),a.indexOf("#")>-1)return colog("back to index"),void(window.location.href="index.html");jQuery.support.cors=!0,storage=window.localStorage,socket=io.connect(rooturl),colog("socket connected to socket server"),$.ajaxSetup({cache:!1}),$.event.special.tap.emitTapOnTaphold=!1,FastClick.attach(document.body),socket.on("realtime",function(e){console.log("realtime update:",e);var a;if(e.event&&(a=e.event),"refreshcronaca"==a&&(console.log("refreshcronaca"),$.ajax({url:rooturl+"/matches/getcronaca/"+jcurrentgara.id,type:"GET"}).done(function(e){jGara.cronaca=e,renderCronaca(jGara.cronaca)})),"resetcronaca"==a){console.log("realtime resetcronaca, letti "+cronaca_read.length);var t=e.garaid;return void deleteCronacaReadForGara(t)}e.garaid==jcurrentgara.id&&updRealtimeResult(e)}),socket.on("sysmsg",function(e){snotify(e)}),socket.on("refreshsockets",function(e){console.log("refreshsockets"),showSockets()}),socket.on("getnickname",function(e){console.log("getnickname: "+e.sockid),setCookie("socketid",e.sockid)}),socket.on("notification",function(e){if(colog("received notification from socket.io server:"),colog(e),snotify(e),e.updategara&&"yes"==e.updategara){$.mobile.activePage.attr("id");jcurrentgara&&jcurrentgara.id==e.garaid&&refreshCurrentGara()}}),socket.on("refreshgara",function(e){if(colog("received refreshgara from socket.io server:"),colog(e),e.updategara&&"yes"==e.updategara){$.mobile.activePage.attr("id");jcurrentgara&&jcurrentgara.id==e.garaid&&refreshCurrentGara()}}),socket.on("connect",function(){colog("Client has connected to the server!")}),socket.on("message",function(e){colog("Received a message from the server!"),colog(e)}),socket.on("disconnect",function(){colog("The client has disconnected!")}),$("#optionsPage #server").val(rooturl),$("#matchesatleta #dialogForAtleta").popup(),$("#gara #popResult").popup(),$("#gara  #popDelMatch").popup(),$("#gara  #popAddMatch").popup(),$("#page_atleti #atleti_categorie").panel(),bindGaraPage(),$("#menuExit").off(tapevent),$("#menuExit").on(tapevent,function(e){exitapp()}),loadOptions(function(){refreshAtletiServer(),refreshGareServer(),updateHomeInfos()}),autoLogin(),$(document).on("pagebeforeshow",function(e){colog("pagebeforeshow"),colog("fbloggedin "+fbloggedin),fbloggedin||(window.location.href="index.html")}),$(document).on("pageshow",function(e){return colog("pageshow"),colog("fbloggedin "+fbloggedin),void(fbloggedin||(window.location.href="index.html"))});var t=getQueryString("mode");"open"==t&&$.mobile.changePage("#index")}function getMatchById(e){var a={};return $(jGara.matchesbyprog.rows).each(function(t){var o=jGara.matchesbyprog.rows[t],r=o.doc,i=r.id;return e==i?a=r:void 0}),a}function displayRtMatches(){conslog(rtmatches)}function addMatchToRealtime(e){conslog("adding match "+e+" to realtime");var a=!1;if($(rtmatches).each(function(t){var o=rtmatches[t].id;o==e&&(a=!0)}),a)conslog("match already in realtime list");else{var t=getMatchById(e);rtmatches.push(t),conslog("added match to realtime list")}}function delMatchFromRealtime(e){$(rtmatches).each(function(a){var t=rtmatches[a].id;t==e&&(rtmatches.splice(a,1),conslog("match "+e+" removed from relatime list"))})}function sendRealtime(e){var a=!1;if(realtime.active&&(a=!0),e&&1==e&&(a=!0),a){var t="TEMPO REALE !<br> ",o="black",r="in pausa";realtime.running&&(r="IN CORSO",o="blue"),realtime.fineround&&(r="FINE ROUND "+realtime.round,o="black");var i="<font color='"+o+"'>Round "+realtime.round;"GP"==realtime.round&&(i="<font color='"+o+"'>GoldenPoint"),t+=" "+i,t+=", "+r,t+=", "+realtime.result+"</font>",conslog(realtime),realtime.foto&&(t+="<br><img style='float: left' src='"+realtime.foto+"' width='60px' height='60px' />"),addMatchToRealtime(selectedid);var o="black";realtime.active&&(o="blue");socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,matchid:selectedid,matchnumber:selectedmatchid,result:realtime.result,ammoniz1:0,ammoniz2:0,event:"realtime",text:t,active:realtime.active})}}function clickRound(e){realtime.round=e,realtime.active=!0,realtime.running=!0,realtime.fineround=!1,currentround=e;var a="Round "+e;"gp"==e.toLowerCase()&&(e="GoldenPoint"),conslog("clicked round"),$("#popResult #ckfineround").prop("checked",!1).checkboxradio("refresh");var t=!0;$("#popResult #ckpausematch").prop("checked",t).checkboxradio("refresh"),clickPauseMatch();var o=$("#popResult #ck_realtime:checked");o.length>0&&(console.log("notify realtime result for "+selectedmatchid+" - "+a+" - "),sendRealtime())}function viewCronacaElements(){var e=jcurrentgara.id,a="http://tkdr.herokuapp.com/matches/viewcronacaelements/"+e;$.get(a,function(e){$("#viewCelem [data-role=content]").html(e),$("#viewCelem [data-role=content] ul").listview(),$.mobile.changePage("#viewCelem")})}function sendCronacaElements(){var e="#cronacaelements",a=!1,t=$(e+" #ckFotoCelem:checked").length,o={text:"",image:"",sound:""};if(t>0?(a=a||!0,console.log("sending foto"),""!=fotodata.trim()&&(o.image=fotodata)):delete o.image,t=$(e+" #ckTestoCelem:checked").length,t>0&&(a=a||!0,console.log("sending text"),text=$(e+" textarea#testo").val(),o.text=text),t=$(e+" #ckAudioCelem:checked").length,t>0?(a=a||!0,console.log("sending audio"),console.log(sounddata),""!=sounddata.trim()&&(o.sound=sounddata)):delete o.sound,!a)return void alert("Per aggiornare la cronaca selezionare almeno un elemento testo, audio o immagine");console.log(o),progressStart("Caricamento");var r="/matches/addcronacaelement/"+jcurrentgara.id;$.ajax({type:"POST",url:rooturl+r,async:!0,data:o,success:function(e){console.log("send elements result:",e),progressStop(),$.mobile.back(),socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,event:"refreshcronaca"}),$.ajax({url:rooturl+"/matches/getcronaca/"+jcurrentgara.id,type:"GET"}).done(function(e){jGara.cronaca=e,renderCronaca(jGara.cronaca),activeTab=2,setActiveTab(activeTab)})},error:function(e){alert("errore nell'invio"),progressStop(),console.log("errore nell'invio",e)}})}function toDataUrl(e,a){var t=new XMLHttpRequest;t.responseType="blob",t.onload=function(){var e=new FileReader;e.onloadend=function(){a(e.result)},e.readAsDataURL(t.response)},t.open("GET",e),t.send()}function getFoto(){if(!navigator.camera)return conslog("Camera API not supported in getFoto"),$(".fotoview").css("background-image","url("+defaultimage+")").css("width","100%").css("height","300px"),toDataUrl(defaultimage,function(e){fotodata=e}),void $(".fotoview").show();var e={quality:50,destinationType:Camera.DestinationType.DATA_URL,sourceType:1,encodingType:0,correctOrientation:!0};navigator.camera.getPicture(function(e){$(".fotoview img").attr("src","url(data:image/jpeg;base64,"+e+")"),$(".fotoview").css("background-image","url(data:image/jpeg;base64,"+e+")").css("width","100%").css("height","250px"),$(".fotoview").show(),conslog("photo length: "+e.length),fotodata="data:image/jpeg;base64,"+e,console.log("fotodata"),console.log(fotodata)},function(){alert("Error taking picture","Error")},e)}function sendFoto(){realtime.foto=fotodata,sendRealtime(),delete realtime.foto,$.mobile.back()}function createCronacaElement(){return conslog("createCronacaElement"),$("#cronacaelements .fotoview").css("width","100%"),void $.mobile.changePage("#cronacaelements")}function clickRealtime(){var e=$("#popResult #ck_realtime:checked"),a=$("#popResult #realtimediv"),t="Tempo reale",o="black";e.length>0?(a.show(),o="lightgreen",t="TEMPO REALE ATTIVO",realtime.active=!0):(a.hide(),o="black",t="Tempo reale",realtime.active=!1);var r="<span style='color: "+o+";'>"+t+"</span>";$("#popResult label[for=ck_realtime]").html(r.replace("MATCH ","")),sendRealtime(!0)}function clickPausa(){conslog("clicked fine round");var e=$("#popResult #ckfineround:checked").length,a=!1;e>0&&(conslog("checked"),a=!0),0==e&&conslog("unchecked"),$("#popResult #ckpausematch").prop("checked",!a).checkboxradio("refresh"),clickPauseMatch();var t=$("#popResult #ck_realtime:checked"),o="Fine match n."+currentround;"gp"==currentround.toLowerCase()&&(o="Fine GoldenPoint"),t.length>0&&(console.log("notify realtime result for "+selectedmatchid),realtime.active=!0,realtime.running=!a,realtime.fineround=a,sendRealtime())}function clickPauseMatch(){conslog("clicked pausa match");var e=$("#popResult #ckpausematch:checked").length,a="MATCH IN PAUSA",t="black";realtime.running=!1,realtime.fineround=!1,e>0&&(conslog("checked, match in corso"),a="MATCH IN CORSO",t="orange",realtime.running=!0),0==e&&conslog("unchecked, match in pausa");var o="<span style='color: "+t+";'>"+a+"</span>";$("#popResult label[for=ckpausematch]").html(o.replace("MATCH ",""));var r=$("#popResult #ck_realtime:checked"),i="Round "+currentround+", "+a+", punteggio: "+currentresult;"gp"==currentround.toLowerCase()&&(i="GoldenPoint, "+a+", punteggio: "+currentresult),r.length>0&&(console.log("notify realtime result for "+selectedmatchid),realtime.active=!0,sendRealtime())}function updRealtimeResult(e){var a=e.matchid,t=e.result,o=(e.ammoniz1,e.event);colog("updateRealtimeResult "+a+" - "+t),conslog("updrealtimeresult "),conslog(e);var r=e.text;e.active&&(r="<font style='color: blue'>"+e.text+"</font>"),$("#gara ul#listabyprog li").each(function(){var t=$(this).attr("id").replace("match_",""),i=$(this).find("a");t==a&&($(this).css(""),colog("found match to update in realtime"),"matchupdate"==o?(i.find("span.soft").html(r),i.find("img.imgicon").attr("src","images/greenblink.gif")):"matchstart"==o?i.find("img.imgicon").attr("src","images/greenblink.gif"):e.active?(conslog("realtime active !"),0==i.find("span.realtime").length&&(i.find("div").append("<span class='realtime'></span>"),console.log("creating realtime div "+i.find("span.realtime").length),console.log(r)),i.find("span.vinto").hide(),i.find("span.realtime").html(r),0==i.find("img.blinkicon").length&&i.prepend("<img src='images/greenblink.gif' class='imgicon blinkicon' />"),i.find("img.imgicon:eq(1)").hide(),i.find("span.vinto").hide()):(conslog("realtime not active !"),i.find("span.realtime").remove(),i.find("span.vinto").show(),i.find("img.blinkicon").remove(),i.find("img.imgicon:first").show(),i.find("span.vinto").show()))}),$("#matchesatleta ul#listampa li").each(function(){var e=$(this).attr("id").replace("match_",""),t=$(this).find("a");e==a&&(colog("found match to update in realtime"),t.find("span.soft").html(r))})}function exitapp(){app.exit()}function refreshGareServer(e){var a=($.mobile.activePage.attr("id"),imgtext+"Caricamento....");$("#gare #recnum span").html(a),app.loadAllGare(function(a){if(a.error)myToast({body:"errore"});else{conslog("Gare caricate da "+rooturl),$gare=a;var t=$("#listagare");t.html("");var o='<li data-role="list-divider" role="heading" data-theme="b">'+a.rows.length+" gare</li>";t.append(o),a.rows.sort(function(e,a){if(e.doc.data&&a.doc.data){var t=getNormalD(e.doc.data),o=getNormalD(a.doc.data);if(t>o)return-1;if(o>t)return 1}return 0}),e&&(a=filterRows(a,{stato:e},!0));var r=new EJS({url:"tpl/gare.ejs"}).render(a.rows);t.empty().append(r),progressStop(),$("#gare #recnum span").html(a.rows.length+" gare"),t.find("li").off(tapevent),t.find("li").on(tapevent,function(){var e=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+e),$("#gara #listabyprog").empty(),setCookie("lastcronaca",""),$.mobile.changePage("#gara"),openGara(e,function(){garaid=e,$gara=a}),!1}),t.find("li").off("taphold"),t.find("li").on("taphold",function(){if("tkdradmin"==role){var e=$(this).find("a").attr("id").split("_")[0],a=$(this).find("a").attr("id").split("_")[1],t=getGaraById(e);colog(t);var o={id:e,rev:a,doc:t.doc},r=new EJS({url:"tpl/popgare.ejs"}).render(o);$("#gare div[data-role=content] #popGare").remove(),$("#gare div[data-role=content]").append(r),$("#gare #popGare #ulpopgare").listview(),$("#gare #popGare").popup(),$("#gare #popGare").popup("open")}}),t.listview(),t.listview("refresh")}})}function markGara(e,a){var t={id:e,stato:a};$.ajax({url:rooturl+"/gare/update",type:"POST",data:t}).done(function(e){popGareCancel(),refreshGareServer()})}function editGara(e){console.log("editgara");var a=getGaraById(e),t=$("#page_editgara");t.find(".jform").each(function(){var e=$(this).attr("id");$(this).val(a.doc[e])}),$.mobile.changePage("#page_editgara"),popGareCancel()}function editGaraOk(){var e=$("#page_editgara #id").val(),a={id:e},t=$("#page_editgara"),o=checkValidGaraForm(t);return 1==o.error?void alert("Errore di inserimento:\n\n"+o.errors):(t.find(".jform").each(function(){var e=$(this).attr("id");a[e]=$(this).val()}),console.log(a),void $.ajax({url:rooturl+"/gare/update",type:"POST",data:a}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#gare"),refreshGareServer())}).fail(function(){myToast({body:"Error posting"})}))}function refreshCurrentGara(e){autorefreshcount=0;var a=imgtext+"Refresh in corso...";$("#gara .medals").html(a);var t=jcurrentgara.id;colog("refreshCurrentGara - id= "+t),openGara(t,e)}function popGareCloseRemove(){$("#gare #popGare").popup("close").remove()}function loadFullGaraById(e,a){$.ajax({url:rooturl+"/gare/fullgarabyid/"+e+"?societaid="+settings.mysocieta,dataType:"json",type:"GET"}).done(function(e){a&&a(e)})}function renderGaraInfo(e){var a="";isFiltered&&(a=" (filtri applicati) ");var t=filterRows(e,{dadisputare:"yes"}),o=filterRows(t,{disputato:"yes"});colog("$C--->"+JSON.stringify(o));var r=filterRows(o,{vinto:"yes"}),i=filterRows(o,{vinto:"no"}),n=o.rows.length-r.rows.length,s=getMaschiFemmine(t.rows),c=t.rows.length+" match da disputare ( M: "+s.maschi+", F: "+s.femmine+" )";s=getMaschiFemmine(r.rows);var l=getMaschiFemmine(o.rows),d=getMaschiFemmine(i.rows);c+="<br>"+o.rows.length+" match disputati ( M: "+l.maschi+", F: "+l.femmine+" ) <br>"+r.rows.length+" vinti ( M: "+s.maschi+", F: "+s.femmine+" ) <br>"+n+" persi ( M: "+d.maschi+", F: "+d.femmine+" )"+a,$("#limatches").html(c);var g=filterRows(o,{medagliamatch:"oro"}),p=filterRows(o,{medagliamatch:"argento"}),u=filterRows(o,{medagliamatch:"bronzo"}),m=getMaschiFemmine(g.rows),h=getMaschiFemmine(p.rows),f=getMaschiFemmine(u.rows);c="ORI: "+g.rows.length+" ( M: "+m.maschi+", F: "+m.femmine+" ) - punti: "+getPunti(g.rows.length,0,0)+"<br>ARGENTI: "+p.rows.length+" ( M: "+h.maschi+", F: "+h.femmine+" ) - punti: "+getPunti(0,p.rows.length,0)+"<br>BRONZI: "+u.rows.length+" ( M: "+f.maschi+", F: "+f.femmine+" ) - punti: "+getPunti(0,0,u.rows.length)+"<br><br>Punteggio totale medaglie: "+getPunti(g.rows.length,p.rows.length,u.rows.length)+" "+a,$("#limedaglie").html(c);var v=new Date,b=v.toLocaleDateString()+" "+v.toLocaleTimeString();$("#lilastupdate").html("<span color=gray><i>Ultimo aggiornamento: "+b+"</i></span>"),$("#gara #ulinfogara span").html(getMedaglieGara(e)),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var e=($(this).index(),$(this).children("a").attr("data-tab-class"));$("."+prevSelection).addClass("ui-screen-hidden"),$("."+e).removeClass("ui-screen-hidden"),prevSelection=e,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var a=$(this).find("a").attr("data-tab-class");$("#gara .ul"+a).show()})}function openGara(e,a){colog("opengara "+e),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var t=$(this).find("a").attr("data-tab-class");$("#gara .ul"+t).show(),activeTab=e,cacheViews()});var t=imgtext+"Caricamento...";$("#gara .medals").html(t),loadFullGaraById(e,function(e){jGara=e,jcurrentgara=e.gara.rows[0].doc,jmatchesbyprog=e.matchesbyprog,jmatchesbyprog=filterMatches(e.matchesbyprog.rows,!0),jmatchesbyatleta=filterMatchesByAtleta(e.matchesbyatleta.rows),renderMatchesByProg(jmatchesbyprog),renderMatchesByAtleta(jmatchesbyatleta),renderCronaca(e.cronaca),renderGaraInfo(jmatchesbyprog);var t={doc:jcurrentgara};$("#gara #hdr").find("#hgara a").html(t.doc.location+" -     "+t.doc.data+" - "+settings.mysocietaname),$("#gara #hdriscritti").find("h1").html(t.doc.title+" "+t.doc.location+" -     "+t.doc.data);var o=[];t.doc.myiscritti&&(o=t.doc.myiscritti.split(","));var r=o.length,i="";iscrittiincat=[],iscrittiincat=filterIscritti(o),r=iscrittiincat.length,mf=getMaschiFemmine(iscrittiincat,"iscritti"),$("#gara #lisocieta").html("<b>"+settings.mysocietaname+"</b>"),$("#gara #ligaratitle").html("Gara: <b>"+t.doc.title+"</b>");var n="";t.doc.maplocation&&""!=t.doc.maplocation.trim()&&(n="&nbsp;&nbsp;<a href='#' onclick='garaMaps()' class='pulsante' style='width:40px;'>Mappa</a>"),$("#gara #ligaralocation").html("Location: "+t.doc.location+n),$("#liiscritti").text(r+" atleti iscritti"+i+" --  F: "+mf.femmine+" M: "+mf.maschi),a&&a(),colog("stato gara: "+jcurrentgara.stato),"disputata"==jcurrentgara.stato&&($("#matchesatleta #actionpanela").hide(),$("#iscrittiPage #btnAddIscritto").hide())})}function doLogin(){var e=$("#login"),a=e.find("#txt-email").val(),t=e.find("#txt-password").val(),o=e.find("#chck-rememberme").prop("checked"),r=e.find("#chck-autologin").prop("checked");progressStart("Accesso in corso...","Log-in"),$.ajax({url:rooturl+"/atleti/login",data:{email:a,password:t},type:"POST"}).done(function(e){progressStop(),colog("login result: "+JSON.stringify(e)),role=e.role,loggedin=!0,"true"==e.loggedin?(myToast({body:"login eseguito con successo"}),"tkdradmin"==role&&($("#index .loginspan").html("Accesso amministratore eseguito"),
$("#index #lilogout").show(),$("#index #lilogin").hide(),$("#index #liatleti").show(),$("#index #lisockets").show(),$("#gara #liresetcronaca").show(),$("#gara #lisysmsg").show(),$("#gare #liaggiungigara").show(),$("#page_atleti #liaggiungiatleta").show(),$("#matchesatleta #actionpanela").show(),$("#iscrittiPage #btnAddIscritto").show(),$("#gare #test").show(),$(".showadmin").show()),colog("ckal: "+r),r?(colog("setting autologin true"),setCookie("autologin","true",cookieDays)):deleteCookie("autologin"),o?(setCookie("email",a,cookieDays),setCookie("psw",t,cookieDays),colog("setted rememberme cookies")):(deleteCookie("email"),deleteCookie("psw"),colog("deleted rememberme cookies")),$.mobile.changePage("#index"),refreshNews()):($("#login #dlg-invalid-credentials").popup("open"),$("#index .loginspan").html(""))}).fail(function(){progressStop(),myToast({body:"Error"})})}function refreshNews(e){$.ajax({url:rooturl+"/news",dataType:"json",type:"GET"}).done(function(a){var t=new EJS({url:"tpl/news.ejs"}).render(a.rows);$("#page_news #content").html(t),e&&e(a)})}function initTabs(){$("#gara a[data-role=tab]").each(function(e){$(this).unbind(tapevent),$(this).bind(tapevent,function(){sdebug($(this).attr("id")),activeTab=e,setActiveTab(activeTab)})})}function setActiveTab(e){return void $("#gara #navbar ul li:eq("+e+")").trigger("vclick")}function loadCronaca(e,a){colog("loadcronaca for gara "+e),$.ajax({url:rooturl+"/matches/getcronaca/"+e,type:"GET"}).done(function(t){if($("#gara #listacronaca").empty(),t.error)console.log("error reading cronaca for this gara id="+e);else{console.log("cronaca: "+t.rows.length),colog(t);t.rows;cronaca=t,jGara.cronaca=cronaca,renderCronaca(cronaca)}a&&a()})}function setCronacaRead(e){var a=jcurrentgara.id+"_"+e;-1==cronaca_read.indexOf(a)&&cronaca_read.push(a),renderCronaca(jGara.cronaca)}function findCronacaRead(e){var a=!1,t=jcurrentgara.stato;console.log("status",t),conslog("guardo se messaggio non letto",e);var o=jcurrentgara.id+"_"+e.time;return cronaca_read.indexOf(o)>-1&&(a=!0),a}function findCronacaUnread(e){var a=!1;return conslog("guardo se messaggio non letto",e),$(cronaca_unread).each(function(t){var o=cronaca_unread[t];conslog("crow",o),o.time==e.time&&o.garaid==jcurrentgara.id&&(a=!0,conslog("questo non √® stato letto"))}),a}function renderCronaca(e){var a=cronaca_read.length,t=e.rows.length-a;console.log("non letti prima del <0: "+t),0>t&&(t=0,deleteCronacaReadForGara(jcurrentgara.id)),setCookie("cronaca_read",JSON.stringify(cronaca_read)),console.log("cronaca non letti: "+t),console.log("cronaca letti",a);var o=new EJS({url:"tpl/cronaca2.ejs"}).render(e);$("#gara #listacronaca").empty(),$("#gara #listacronaca").append(o),$("#gara #listacronaca").listview(),$("#gara #listacronaca").listview("refresh"),t>0?($("#gara #bubble").html(t).show(),isPhone&&cordova.plugins.notification.badge.set(t)):($("#gara #bubble").html("0").hide(),isPhone&&cordova.plugins.notification.badge.clear())}function getPunti(e,a,t){var o=0;return o=7*e+3*a+1*t}function resetFilters(){$("#temppopup #sex").val("_"),$("#temppopup #categ").val("_"),$("#temppopup #medag").val("_"),$("#temppopup #quadrato").val("_")}function setFilters(){var e="";$("#temppopup #sex").val()&&(e=$("#temppopup #sex").val()),"_"==e&&(e="");var a="";$("#temppopup #categ").val()&&(a=$("#temppopup #categ").val()),"_"==a&&(a="");var t="";$("#temppopup #medag").val()&&(t=$("#temppopup #medag").val()),"_"==t&&(t="");var o="";$("#temppopup #quadrato").val()&&(o=$("#temppopup #quadrato").val()),"_"==o&&(o=""),garaFilters={categoria:a.toLowerCase().trim(),sesso:e,medaglia:t,quadrato:o};var r="<font color='yellow'><b>Filtri applicati</b></font>",i="2px solid yellow";""==garaFilters.categoria&&""==garaFilters.sesso&&""==garaFilters.medaglia&&""==garaFilters.quadrato&&(r="Nessun filtro",i="0px solid white"),$("#gara .spanfilt").html(r).css("border",i),popCloseRemove(),refreshCurrentGara()}function loadMatchesByProgOld(e,a){var t={matches:$allmatches,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(t,a),colog("loadmatchesbyprog "+e),$.ajax({url:rooturl+"/matches/findbygaraid/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){$matches=e,$allmatches=e,colog("total matches: "+$matches.rows.length);var a=[];if(""!=cat){var a={rows:[]};$(e.rows).each(function(t){var o=e.rows[t].doc.datanascita;colog("datanascita: "+o),getCategoria(o).toLowerCase()==cat.toLowerCase()&&a.rows.push(e.rows[t])}),$matches=a,colog("matches after categoria "+cat+": "+$matches.rows.length)}var o=new EJS({url:"tpl/matchesbyprog.ejs"}).render($matches.rows),r="listabyprog",i=$("#gara ul#"+r);i.empty(),i.append(o),i.listview(),i.listview("refresh");var n="";""!=$.trim(viewcat)&&(n=" in cat. "+viewcat.toUpperCase()),colog("$allmatches for cat "+viewcat+"-------->"+JSON.stringify($allmatches));var s=filterRows($matches,{dadisputare:"yes"}),c=filterRows(s,{disputato:"yes"});colog("$C--->"+JSON.stringify(c));var l=filterRows(c,{vinto:"yes"}),d=filterRows(c,{vinto:"no"}),g=c.rows.length-l.rows.length,p=getMaschiFemmine(s.rows),u=s.rows.length+" match da disputare ( M: "+p.maschi+", F: "+p.femmine+" )";p=getMaschiFemmine(l.rows);var m=getMaschiFemmine(c.rows),h=getMaschiFemmine(d.rows);u+="<br>"+c.rows.length+" match disputati ( M: "+m.maschi+", F: "+m.femmine+" ) <br>"+l.rows.length+" vinti ( M: "+p.maschi+", F: "+p.femmine+" ) <br>"+g+" persi ( M: "+h.maschi+", F: "+h.femmine+" )"+n,$("#limatches").html(u);var f=filterRows(c,{medagliamatch:"oro"}),v=filterRows(c,{medagliamatch:"argento"}),b=filterRows(c,{medagliamatch:"bronzo"}),w=getMaschiFemmine(f.rows),y=getMaschiFemmine(v.rows),k=getMaschiFemmine(b.rows);u="ORI: "+f.rows.length+" ( M: "+w.maschi+", F: "+w.femmine+" ) - punti: "+getPunti(f.rows.length,0,0)+"<br>ARGENTI: "+v.rows.length+" ( M: "+y.maschi+", F: "+y.femmine+" ) - punti: "+getPunti(0,v.rows.length,0)+"<br>BRONZI: "+b.rows.length+" ( M: "+k.maschi+", F: "+k.femmine+" ) - punti: "+getPunti(0,0,b.rows.length)+"<br><br>Punteggio totale medaglie: "+getPunti(f.rows.length,v.rows.length,b.rows.length)+" "+n,$("#limedaglie").html(u),$("#gara #ulinfogara span").html(getMedaglieGara($matches)),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var o=$(this).find("a").attr("data-tab-class");$("#gara .ul"+o).show(),activeTab=e,cacheViews(),t.callback&&t.callback()}),setActiveTab(activeTab)})}function cacheViews(){}function filterMatches(e,a){a||(a=!1);var t={rows:[]},o=!1;return $(e).each(function(r){var i="",n="",s="",c="",l="";a?(i=e[r].doc.datanascita,n=e[r].doc.medagliamatch,s=e[r].doc.matchid,c=s.substring(0,s.length-2),l=e[r].doc.atletaid):(i=e[r].datanascita,n=e[r].medagliamatch,s=e[r].matchid,c=s.substring(0,s.length-2),l=e[r].atletaid),colog("datanascita: "+i);var d=!0;for(f in garaFilters)if(""!=garaFilters[f]){if(o=!0,"categoria"==f){var g=getCategoria(i).toLowerCase().trim()!=garaFilters.categoria.toLowerCase().trim();garaFilters.categoria.toLowerCase().trim().indexOf("senior")>-1&&(g=-1==getCategoria(i).toLowerCase().trim().indexOf("senior")),g&&(d=d&&!1)}if("medaglia"==f&&n.toLowerCase().trim()!=garaFilters.medaglia.toLowerCase().trim()&&(d=d&&!1),"quadrato"==f&&c.toLowerCase().trim()!=garaFilters.quadrato.toLowerCase().trim()&&(d=d&&!1),"sesso"==f){$a=getAtletaById(l);var p=$a.sesso;p.toLowerCase().trim()!=garaFilters.sesso.toLowerCase().trim()&&(d=d&&!1)}}o?d&&t.rows.push(e[r]):t.rows.push(e[r])}),isFiltered=o,t}function filterMatchesByAtleta(e,a){a||(a=!1);var t={rows:[]},o=!1;return $(e).each(function(r){var i="",n="";a?(i=e[r].doc.datanascita,n=e[r].doc.id):(i=e[r].datanascita,n=e[r].id),colog("datanascita: "+i);var s=!0;for(f in garaFilters)if(""!=garaFilters[f]){if(o=!0,"categoria"==f){var c=getCategoria(i).toLowerCase().trim()!=garaFilters.categoria.toLowerCase().trim();garaFilters.categoria.toLowerCase().trim().indexOf("senior")>-1&&(c=-1==getCategoria(i).toLowerCase().trim().indexOf("senior")),c&&(s=s&&!1)}if("sesso"==f){$a=getAtletaById(n);var l=$a.sesso;l.toLowerCase().trim()!=garaFilters.sesso.toLowerCase().trim()&&(s=s&&!1)}}o?s&&t.rows.push(e[r]):t.rows.push(e[r])}),isFiltered=o,t}function loadMatchesByProg(e,a){var t={matches:$allmatches,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(t,a),colog("loadmatchesbyprog "+e),$.ajax({url:rooturl+"/matches/findbygaraid/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){$matches=e,$allmatches=e,colog("total matches: "+$matches.rows.length);var a={rows:[]};a=filterMatches(e.rows,!0),$matches=a,colog("matches after categoria "+cat+": "+$matches.rows.length),jmatchesbyprog=$matches,renderMatchesByProg();var o="";isFiltered&&(o=" (filtri applicati) "),colog("$allmatches -------->"+JSON.stringify($allmatches));var r=filterRows($matches,{dadisputare:"yes"}),i=filterRows(r,{disputato:"yes"});colog("$C--->"+JSON.stringify(i));var n=filterRows(i,{vinto:"yes"}),s=filterRows(i,{vinto:"no"}),c=i.rows.length-n.rows.length,l=getMaschiFemmine(r.rows),d=r.rows.length+" match da disputare ( M: "+l.maschi+", F: "+l.femmine+" )";l=getMaschiFemmine(n.rows);var g=getMaschiFemmine(i.rows),p=getMaschiFemmine(s.rows);d+="<br>"+i.rows.length+" match disputati ( M: "+g.maschi+", F: "+g.femmine+" ) <br>"+n.rows.length+" vinti ( M: "+l.maschi+", F: "+l.femmine+" ) <br>"+c+" persi ( M: "+p.maschi+", F: "+p.femmine+" )"+o,$("#limatches").html(d);var u=filterRows(i,{medagliamatch:"oro"}),m=filterRows(i,{medagliamatch:"argento"}),h=filterRows(i,{medagliamatch:"bronzo"}),f=getMaschiFemmine(u.rows),v=getMaschiFemmine(m.rows),b=getMaschiFemmine(h.rows);d="ORI: "+u.rows.length+" ( M: "+f.maschi+", F: "+f.femmine+" ) - punti: "+getPunti(u.rows.length,0,0)+"<br>ARGENTI: "+m.rows.length+" ( M: "+v.maschi+", F: "+v.femmine+" ) - punti: "+getPunti(0,m.rows.length,0)+"<br>BRONZI: "+h.rows.length+" ( M: "+b.maschi+", F: "+b.femmine+" ) - punti: "+getPunti(0,0,h.rows.length)+"<br><br>Punteggio totale medaglie: "+getPunti(u.rows.length,m.rows.length,h.rows.length)+" "+o,$("#limedaglie").html(d),$("#gara #ulinfogara span").html(getMedaglieGara($matches)),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var o=$(this).find("a").attr("data-tab-class");$("#gara .ul"+o).show(),activeTab=e,cacheViews(),t.callback&&t.callback()}),setActiveTab(activeTab)})}function renderMatchesByProg(e){var a=new EJS({url:"tpl/matchesbyprog.ejs"}).render(e.rows),t="listabyprog",o=$("#gara ul#"+t);if(o.empty(),o.append(a),o.listview(),o.listview("refresh"),$("#gara #nomatches").hide(),0==e.rows.length){var r=refreshIscritti(!0);a=new EJS({url:"tpl/iscritti.ejs"}).render(r);var i=$("#gara #nomatches ul.iscritti_nomatches");i.empty(),i.append(a),i.listview(),i.listview("refresh");var n=$("#gara p.iscrittilength");n.html(r.length+" iscritti a questa gara"),isFiltered||$("#gara #nomatches").show()}}function loadMatchesByAtletaOld(e){colog("loadmatchesbyatleta "+e),$.ajax({url:rooturl+"/matches/findbygaraid/byatleta/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){var a=e;if(colog("total matches: "+a.length),""!=cat){var t=[];$(e).each(function(a){var o=e[a].datanascita;colog("datanascita: "+o),getCategoria(o).toLowerCase()==cat.toLowerCase()&&t.push(e[a])}),a=t,colog("matches after categoria "+cat+": "+a.length)}var o=new EJS({url:"tpl/matchesbyatleta.ejs"}).render(a),r="listabyatleta",i=$("ul#"+r);i.empty(),i.append(o),i.listview(),i.listview("refresh"),$("#gara #navbar ul li").unbind(tapevent),$("#gara #navbar ul li").bind(tapevent,function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var t=$(this).find("a").attr("data-tab-class");$("#gara .ul"+t).show(),activeTab=e,cacheViews()}),setActiveTab(activeTab)})}function loadMatchesByAtleta(e){colog("loadmatchesbyatleta "+e),$.ajax({url:rooturl+"/matches/findbygaraid/byatleta/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(e){var a=e;colog("total matches: "+a.length);var t=[],o=!1;$(e).each(function(a){var r=e[a].datanascita,i=e[a].id;colog("datanascita: "+r);var n=!0;for(var s in garaFilters)if(""!=garaFilters[s]&&(o=!0,"categoria"==s&&(garaFilters[s].toLowerCase().trim().indexOf("senior")>-1?-1==getCategoria(r).toLowerCase().trim().indexOf("senior")&&(n=n&&!1):getCategoria(r).toLowerCase().trim()!=garaFilters.categoria.toLowerCase().trim()&&(n=n&&!1)),"sesso"==s)){var c=getAtletaById(i),l=c.sesso;l.toLowerCase().trim()!=garaFilters.sesso.toLowerCase().trim()&&(n=n&&!1)}o?n&&t.push(e[a]):t.push(e[a])}),isFiltered=o,a=t,colog("matches after categoria "+cat+": "+a.length),renderMatchesByAtleta(a)})}function renderMatchesByAtleta(e){console.log(e);var a=new EJS({url:"tpl/matchesbyatleta2.ejs"}).render(e),t="listabyatleta",o=$("ul#"+t);o.empty(),o.append(a),o.listview(),o.listview("refresh"),$("#gara #navbar ul li").unbind(tapevent).bind(tapevent,function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var t=$(this).find("a").attr("data-tab-class");$("#gara .ul"+t).show(),activeTab=e,cacheViews(),setActiveTab(activeTab)})}function refreshMeByProg(e){var a=$matches;sdebug("$mm.lenght: "+a.find("match").length);var t={matches:a,showNullMatches:!1,ulSelector:"listabyprog",showUpdated:!0,datarel:"popup",clickAtletaMatches:!0,callback:null};$.extend(t,e);var o=t.matches;sdebug("refreshMeByProg matches: "+o.find("match").length+" - shownullmatches: "+t.showNullMatches+" - ulSelector: "+t.ulSelector),refreshMode="byprog";var r=$.parseXML("<matches></matches>"),i=$(r);sdebug("matches: "+$matches.find("match").length);var n=garaid,s="";o.find("match").each(function(){var e=$(this),a=$(this).find("garaid").text();if(sdebug("match: "+a),a==n){var t=$(this).find("progid").text(),o=$(this).find("atletaid").text(),r=$.trim($(this).find("datanascita").text());sdebug(t+" - "+o+" datanasc: "+r);var s=e.clone();if(""!=$.trim(viewcat)){var c=getCategoria(r);sdebug("categoria for "+o+": "+c),$.trim(viewcat)==$.trim(c)&&i.find("matches").append(s)}else i.find("matches").append(s)}}),matches=i.find("match"),matches.sort(function(e,a){var t=$(e).find("progid").text(),o=$(a).find("progid").text();return o>t?-1:t>o?1:0}),matches.each(function(){var e=$(this).clone(),a=$(this).find("id").text(),o=($(this).find("progid").text(),$(this).find("matchid").text()),r=$(this).find("vinto").text(),i=$(this).find("disputato").text(),n=$(this).find("dadisputare").text(),c=$(this).find("medagliamatch").text(),l=$(this).find("risultato").text(),d=$(this).find("datanascita").text(),g=getCategoria(d).toUpperCase(),p=$(this).find("atletaid").text(),u=$(this).find("atletaname").text();e.append("<atletaname></atletaname>"),e.find("atletaname").text(u),$msav.find("matches").append(e);var m="",h=!1,f="";if("yes"==$.trim(n)&&(h=!0),"no"==$.trim(n)&&(h=!1,f="black",t.showNullMatches&&(h=!0)),"yes"==$.trim(i)&&("yes"==$.trim(r)&&(m=" style='background-color: green' ",f="green"),"no"==$.trim(r)&&(m=" style='background-color: #C00000 ' ",f="red")),h){var v="matchtoplay.png";"oro"==c&&(v="medaglia_oro.png"),"argento"==c&&(v="medaglia_argento.png"),"bronzo"==c&&(v="medaglia_bronzo.png"),"yes"==$.trim(i)&&"none"==c&&("yes"==$.trim(r)&&(v="matchok.png"),"yes"!=$.trim(r)&&(v="matchko.png"));var b="",w="Non disputato",y="nondisputato";"yes"==$.trim(i)&&(y="vinto",w="Vinto, ",b="risultato: "+l,"yes"!=$.trim(r)&&(w="Perso, ",y="perso")),b=w+b,m="";var k="onclick='setResult(this)'";t.clickAtletaMatches&&(k="onclick=\"matchesPerAtleta('"+p+"','"+u+"','"+d+"')\""),s+="<li "+m+" tkdr-matchid='"+o+"' data-icon='false' id='match_"+a+"' ><a  shref=javascript:matchAtletaDetail('"+p+"') id='prog"+a+"' data-ajax='false'  href='#' "+k+" shref='gareatleta.html?atletaid="+p+"&garaid="+garaid+"'><img swidth='50' sheight='50' src='images/"+v+"' class='imgicon sui-li-icon ui-corner-none' ><div><span class='match "+f+"'>"+o+"</span><br><span class='categoria'>"+g+"</span><br><span class='atleta'>"+u+"</span><br><span class='soft "+y+"'>"+b+"</span></div></a><input type='hidden' class='datanascita' value='"+d+"' /><input type='hidden' class='atletaid' value='"+p+"' /><input type='hidden' class='atletaname' value='"+u+"'/></li>"}});var c=t.ulSelector,l=$("ul#"+c);if(l.empty(),l.append(s),l.listview(),l.listview("refresh"),t.showUpdated){$("#ulinfogara li span.left").html(sgetMedaglieGara(garaid));var d="";""!=$.trim(viewcat)&&(d=" in cat. "+viewcat.toUpperCase());var g=filterRows($allMatches,{dadisputare:"yes"}),p=(filterRows(g,{disputato:"yes"}),filterRows(g,{vinto:"yes"})),u=filterRows(g,{vinto:"no"}),m=g.rows.length+" incontri da disputare";m+="<br>"+g.rows.length+" incontri disputati, "+p.length+" vinti, "+u.length+" persi",$("#limatches").html(m+d),$("#gara #ulinfogara span").html(getMedaglieGara($a));var h=new Date,f=formatDateTime(h);sdebug("data "+f),$("li.liprog").find("span").html("Aggiornato: "+f)}null!=t.callback&&t.callback()}function refreshSocietaServer(){var e=imgtext+"Caricamento...";$("#page_societa #recnum span").html(e),debugga("refreshSocietaServer"),$.ajax({url:rooturl+"/societa/findall",type:"GET"}).done(function(e){if(e.error)toast("errore","long");else{toast("Societa caricate da "+rooturl);var a=$("#lista_societa");a.html("");var t='<li data-role="list-divider" role="heading" data-theme="b">'+e.rows.length+" atleti</li>";a.append(t);var o=new EJS({url:"tpl/societa.ejs"}).render(e.rows);a.empty().append(o),progressStop(),$("#page_societa #recnum span").html(e.rows.length+" societa"),a.find("li").off(tapevent),a.find("li").on(tapevent,function(){var e=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+e),progressStart("Lettura dati"),$.ajax({url:rooturl+"/societa/findall",type:"GET"}).done(function(a){progressStop();var t=a.data.rows[0].doc,o=(createHtmGrid(t),createHtmListview(t));$("#page_societa  #listax_societa").empty().append(o),$("#page_societa #societa").val(e),$.mobile.changePage("#page_societa"),$("#page_societa  #listax_societa").listview()}),!1}),a.find("li").off("taphold"),a.find("li").on("taphold",function(){if(loggedin&&"tkdradmin"==role){var e=$(this).find("a").attr("id").split("_")[0],a=$(this).find("a").attr("id").split("_")[1];gConfirm("Confermi l'eliminazione della societa ?","Conferma eliminazione",function(){var t={};t.id=e,t.rev=a,$.ajax({url:rooturl+"/societa/delete",type:"POST",data:t}).done(function(e){e.error?console.log("error"):(console.log("posted"),refreshSocietaServer())}).fail(function(){toast("Error posting","long")})},function(){})}}),a.listview(),a.listview("refresh")}})}function refreshAtletiServer(){debugga("refreshAtletiServer");var e=imgtext+"Caricamento...";$("#page_atleti #recnum span").html(e),app.loadAllSchede(function(e){if(e.error)toast("errore","long");else{conslog("Atleti caricati da "+rooturl);var a=$("#lista_atleti");a.html("");var t='<li data-role="list-divider" role="heading" data-theme="b">'+e.rows.length+" atleti</li>";a.append(t);var o=new EJS({url:"tpl/atleti.ejs"}).render(e.rows);a.empty().append(o),progressStop(),$("#page_atleti #recnum span").html(e.rows.length+" atleti in "+settings.mysocietaname),a.find("li").off(tapevent),a.find("li").on(tapevent,function(){var e=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+e),progressStart("Lettura dati"),atleta.loadById(e,function(a){progressStop();var t=a.data.rows[0].doc,o=(createHtmGrid(t),createHtmListview(t));$("#page_atleta  #listax_atleta").empty().append(o),$("#page_atleta #atletaid").val(e),$.mobile.changePage("#page_atleta"),$("#page_atleta  #listax_atleta").listview()}),!1}),a.find("li").off("taphold"),a.find("li").on("taphold",function(){if(loggedin&&"tkdradmin"==role){var e=$(this).find("a").attr("id").split("_")[0],a=$(this).find("a").attr("id").split("_")[1];gConfirm("Confermi l'eliminazione dell'atleta ?","Conferma eliminazione",function(){var t={};t.id=e,t.rev=a,$.ajax({url:rooturl+"/atleti/delete",type:"POST",data:t}).done(function(e){e.error?console.log("error"):(console.log("posted"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")})},function(){})}}),a.listview(),a.listview("refresh")}})}function progressStart(e){$.mobile.loading("show",{text:e,textVisible:!0,theme:"b",html:""})}function progressStop(){$.mobile.loading("hide")}function refreshSchede(){var e=$("#liElencoSchede");e.html("");var a='<li data-role="list-divider" role="heading" data-theme="b">'+app.storage.length+" schede</li>";e.append(a);for(var t=0;t<app.storage.length;t++){var o=$("<li data-theme='c'><a href='#' data-transition='slide'>"+app.storage.key(t)+"</a></li>");o.off(tapevent),o.on(tapevent,function(){scheda.load($(this).text()),$("#txtNome").val(scheda.data.nome),$("#txtIndirizzo").val(scheda.data.indirizzo),$("#txtDescrizione").val(scheda.data.descrizione),$("#txtPrezzo").val(scheda.data.prezzo),$("#scanDiv").html(scheda.data.barcode),""!=$.trim(scheda.data.photoURI)?($("#fotoAnteprima").attr("src",scheda.data.photoURI).css({width:"128px",height:"128px"}),$("#fotoAnteprima").on(tapevent,function(){$("#fullPhoto").attr("src",scheda.data.photoURI).css({width:"400px",height:"700px"}),$.mobile.changePage("#viewPhoto",{role:"dialog"})})):$("#fotoAnteprima").attr("src","img/nophoto.jpg").css({width:"128px",height:"128px"}),$("#scheda h3").html("Modifica "+boname),$.mobile.changePage("#scheda")}),o.off("taphold"),o.on("taphold",function(){var e=$(this).text();navigator.notification.confirm("Confermi l'eliminazione della scheda?",function(a){1==a&&(scheda.remove(e),$.mobile.changePage("#elencoSchede"))},"Conferma eliminazione","S√¨,No")}),e.append(o)}e.listview("refresh")}function alerta(e){isPhone?navigator.notification.alert(e,function(){},"Avviso"):debugga(e)}function debugga(e){colog(e)}function newScheda(){delete scheda.data._id,delete scheda.data._rev,scheda.data.nome="",scheda.data.indirizzo="",scheda.data.descrizione="",scheda.data.prezzo="",scheda.data.coordinate="",scheda.data.photoURI="",scheda.data.barcode="",$("#txtNome").val(""),$("#txtIndirizzo").val(""),$("#txtDescrizione").val(""),$("#txtPrezzo").val(""),$("#scanDiv").html("No code"),$("#fotoAnteprima").attr("src","img/nophoto.jpg").css({width:"128px",height:"128px"}),$("#scheda h3").html("Nuova "+boname),$.mobile.changePage("#scheda")}function toast(e,a){myToast({body:e})}function gConfirm(e,a,t,o){isPhone?navigator.notification.confirm(e,function(e){1==e?t():o()},a,"S√¨,No"):confirm(e)?t():o()}function importAtleti(){$.ajax({url:rooturl+"/atleti/findall",type:"GET"}).done(function(e){alert(e.length)})}function getNormalD(e){var a=e.substring(6)+e.substring(3,5)+e.substring(0,2);return a}function createPopup(e){var a=$('<a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-right">Close</a>').button(),t=$("<div/>",{"data-role":"popup"}).css({width:$(window).width()/1.5+"px"}).append(a).append(e);$(".ui-page-active").append(t),$("[data-role=popup]").on("popupafterclose",function(){$(this).remove()}).on("popupafteropen",function(){$(this).popup("reposition",{positionTo:"window"})}).popup({dismissible:!1,history:!1,theme:"b",overlayTheme:"b"}).popup("open")}function createHtmGrid(e){var a="<table border=1 width='300'>";for(var t in e)colog(" name="+t+" value="+e[t]),a+="<tr><td>"+t+"</td><td>"+e[t]+"</td></tr>";return a+="</table>"}function createHtmListview(e){var a='<ul data-role="listview">',a="";for(var t in e){colog(" name="+t+" value="+e[t]);var o=e[t];"categoria"==t.toLowerCase()&&(o=getCategoria(e.datanascita,!0).toUpperCase()),a+='<li class="gradient ui-li-static ui-body-inherit"><span class="small">'+t+'</span><br><span class="medium">'+o+"</li>"}return a}function bindGaraPage(){colog("bindaGaraPage"),$(document).on("pageshow","#gara",function(){var e=$(this).data("url");debug("durl: "+e),garaid=parm_garaid,setActiveTab(activeTab),$("#gara #dialogCategorie").popup(),$("#gara #dialogForAtleta").popup(),$("#gara #refresh").off(tapevent),$("#gara #refresh").on(tapevent,function(){debug("activetab: "+activeTab)}),$(".tb").remove(),$("#av_toolbar_regdiv").remove(),$("#av_toolbar_iframe").remove(),$("#gara .spancat").off(tapevent),$("#gara .spancat").on(tapevent,function(e){sdebug("clicked on categorie");var a=$("#gara ul#ulcategorie");a.listview(),a.listview("refresh"),e.preventDefault();var t=new EJS({url:"tpl/popcategorie.ejs"}).render({});openPopup(t,"Categorie")}),$("#gara .spanfilt").off(tapevent),$("#gara .spanfilt").on(tapevent,function(e){sdebug("clicked on filters");var a=$("#gara ul#ulcategorie");a.listview(),a.listview("refresh"),e.preventDefault();var t=new EJS({url:"tpl/popfilters.ejs"}).render({});openPopup(t,"Filtri"),$("#temppopup #setfilt").button(),$("#temppopup #resetfilt").button(),$("#temppopup td").css("padding","5px"),$("#temppopup").css("padding","5px").css("top","10px !important"),""!=garaFilters.categoria?$("#temppopup #categ").val(garaFilters.categoria):$("#temppopup #categ").val("_"),""!=garaFilters.sesso?$("#temppopup #sex").val(garaFilters.sesso):$("#temppopup #sex").val("_"),""!=garaFilters.medaglia?$("#temppopup #medag").val(garaFilters.medaglia):$("#temppopup #medag").val("_"),""!=garaFilters.quadrato?$("#temppopup #quadrato").val(garaFilters.quadrato):$("#temppopup #quadrato").val("_")}),$("#gara #ulcategorie li").off(tapevent),$("#gara #ulcategorie li").on(tapevent,function(){var e=$(this).text();viewcat=e.toLowerCase();var a=e.toLowerCase();"tutte"==viewcat.toLowerCase()&&(viewcat=""),cat=viewcat,document.cookie="cookiecat="+viewcat+"; expires=Thu, 18 Dec 2023 12:00:00 UTC",$("#dialogCategorie").popup("close"),a.indexOf("esordienti")>-1&&(a=a.replace("esordienti","eso")),a.indexOf("cadetti")>-1&&(a=a.replace("cadetti","cad")),a.indexOf("junior")>-1&&(a=a.replace("junior","jun")),a.indexOf("senior")>-1&&(a=a.replace("senior","sen")),$(".spancat").text(cattxt+a.toUpperCase()),refreshCurrentGara()}),$("#gara #listabyprog li").off(tapevent),$("#gara #listabyprog li").on(tapevent,function(){var e=$(this).attr("id"),e=e.replace("prog","")}),$("#gara #navbar ul li").on("vclick",function(){var e=$(this).index(),a=$(this).children("a").attr("data-tab-class");$("."+prevSelection).addClass("ui-screen-hidden"),$("."+a).removeClass("ui-screen-hidden"),prevSelection=a,$("#gara #navbar ul li").removeClass("tabselected"),$("#gara #navbar ul li a").removeClass("ui-btn-active"),$(this).addClass("tabselected"),$(this).find("a").addClass("tabselected").addClass("ui-btn-active").addClass("ui-state-persist"),$("#gara .ulupdate").hide();var t=$(this).find("a").attr("data-tab-class");$("#gara .ul"+t).show(),activeTab=e,cacheViews()}),setActiveTab(activeTab),$("#gara #bubble").off(tapevent),$("#gara #bubble").on(tapevent,function(){if(setAllCronacaRead(jcurrentgara.id),notifyseen=!0,notifycount=0,nonletti=0,$("#gara .nonvisto").removeClass("nonvisto"),$("#gara #bubble").html("0").hide(),cronaca.rows.length>0){setCookie("lastcronaca",cronaca.rows[0].time);var e=getCookie("cronacaletti_"+jcurrentgara.id);e||(e=""),$(cronaca.rows).each(function(a){var t=cronaca.rows[a];""!=e.trim()&&(e+=","),e+=t.time}),setCookie("cronacaletti_"+jcurrentgara.id,e)}$("#gara a#tab_cronaca").trigger("click")}),$("#gara #panelright").off(tapevent),$("#gara #panelright").on(tapevent,function(){$(this).panel("close")}),anninascita="",cat="",searchgara="",""!=$.trim(cat)&&(debug("viewing category: "+cat),viewcat=cat);var a=getCookie("cookiecat");""!=$.trim(a)&&(viewcat=a);var t="";""==$.trim(t)&&(t="tutte"),t.indexOf("esordienti")>-1&&(t=t.replace("esordienti","eso")),t.indexOf("cadetti")>-1&&(t=t.replace("cadetti","cad")),t.indexOf("junior")>-1&&(t=t.replace("junior","jun")),t.indexOf("senior")>-1&&(t=t.replace("senior","sen")),t=t.toUpperCase(),$("#gara .spancat").text(cattxt+t),debug("cookiecat: "+a),""==$.trim(garaid)&&""==$.trim(searchgara)&&(searchgara="corna"),showMsg&&$("#msgBar").show()})}function setAllCronacaRead(e){var a=jGara.cronaca;$(a.rows).each(function(t){var o=a.rows[t],r=o.time,i=e+"_"+r;-1==cronaca_read.indexOf(i)&&cronaca_read.push(i)}),renderCronaca(a)}function setCategoria(e){var a=$(e).text();viewcat=a.toLowerCase();var t=a.toLowerCase();"tutte"==viewcat.toLowerCase()&&(viewcat=""),cat=viewcat,document.cookie="cookiecat="+viewcat+"; expires=Thu, 18 Dec 2023 12:00:00 UTC",$("#dialogCategorie").popup("close"),t.indexOf("esordienti")>-1&&(t=t.replace("esordienti","eso")),t.indexOf("cadetti")>-1&&(t=t.replace("cadetti","cad")),t.indexOf("junior")>-1&&(t=t.replace("junior","jun")),t.indexOf("senior")>-1&&(t=t.replace("senior","sen")),$(".spancat").text(cattxt+t.toUpperCase()),refreshCurrentGara(),popCloseRemove()}function sdebug(e){debugga(e)}function debug(e){debugga(e)}function captureAudio(){navigator.device.capture.captureAudio(function(e){var a,t=e[0],o=new FileReader;o.onload=function(e){e.target.result},a=new window.File(t.name,t.localURL,t.type,t.lastModifiedDate,t.size),o.readAsDataURL(a)})}function openImage(e){var a=e.replace("thumb_","");if(isPhone)window.cordova.plugins.FileOpener.openFile(a,function(e){conslog("file "+a+" successfully opened")},function(e){console.log("error opening file "+a)});else{"<img id='img1' src='"+e.replace("thumb_","")+"' />";$("#viewimage #img1").attr("src",e.replace("thumb_","")),$.mobile.changePage("#viewimage")}}function getCookie(e){for(var a=e+"=",t=document.cookie.split(";"),o=0;o<t.length;o++){for(var r=t[o];" "==r.charAt(0);)r=r.substring(1);if(0==r.indexOf(a))return r.substring(a.length,r.length)}return""}function filterIscritti(e){var a=[],t=!1;$(e).each(function(o){var r=getAtletaById(e[o]),i=r.datanascita,n=getCategoria(i),s=r.sesso,c=!0;""==e[o].trim()&&(c=c&&!1);for(f in garaFilters)""!=garaFilters[f]&&(t=!0,"sesso"==f&&s.toLowerCase().trim()!=garaFilters[f].toLowerCase().trim()&&(c=c&&!1),"categoria"==f&&(garaFilters[f].toLowerCase().trim().indexOf("senior")>-1?-1==n.toLowerCase().trim().indexOf("senior")&&(c=c&&!1):n.toLowerCase().trim()!=garaFilters[f].toLowerCase().trim()&&(c=c&&!1)));t?c&&a.push(e[o]):c&&a.push(e[o])});a.length;return a}function refreshGara(e,a){var t={callback:null};$.extend(t,a),refreshCronaca(),oldupdatetext=$("#gara #ulinfogara li span.left").html(),$("#gara #ulinfogara li span.left").html("Aggiornamento...");colog("gara: "+JSON.stringify($gara));var o=$gara;$("#gara #hdr").find("#hgara a").html(o.doc.location+" -     "+o.doc.data+" - "+settings.mysocietaname),
$("#hdriscritti").find("h1").html(o.doc.title+" "+o.doc.location+" -     "+o.doc.data);var r=o.doc.iscritti.split(","),i=filterIscritti(r),n=i.length;$("#ligaratitle").html("Gara: <b>"+o.doc.title+"</b>"),$("#ligaralocation").html("Location: "+o.doc.location),$("#liiscritti").text(n+" atleti iscritti "),datagara=o.doc.data;var s=datagara.split("/");annogara=s[2];new Date}function getMaschiFemmine(e,a){colog("getmaschifemmine"),colog(jcurrentgara.iscritti);var t=(jcurrentgara.iscritti.split(","),0),o=0;$(e).each(function(r){var i;i=getAtletaById("iscritti"==a?e[r]:e[r].doc.atletaid);var n="M";i.sesso&&(n=i.sesso.toUpperCase()),"M"==n&&t++,"F"==n&&o++});var r={maschi:t,femmine:o};return r}function refreshCronaca(){}function getMedaglieGara(e){var a=0,t=0,o=0;$(e.rows).each(function(r){var i=e.rows[r].doc,n=(i.garaid,i.datanascita,$.trim(i.medagliamatch)),s=!0;s&&("oro"==$.trim(n)&&a++,"argento"==$.trim(n)&&t++,"bronzo"==$.trim(n)&&o++)});var r="<span style='color: yellow;'>ORI: <b>"+a+"</b></span>&nbsp;&nbsp;&nbsp;<span style='color: silver;'>ARG: <b>"+t+"</b></span>&nbsp;&nbsp;&nbsp;<span style='color: orange;'>BRO: <b>"+o+"</b></span>";return r}function getCategoria(e,a){var t="senior a",o=(new Date).getFullYear();if(1!=a){var r=jcurrentgara.data.split("/"),i=r[2];o=i}if(""==$.trim(e))return"senior b";var n=e.split("."),s=n[2],c=parseInt(o,10)-parseInt(s,10);return c>=18&&35>=c&&(t="senior a"),c>=15&&17>=c&&(t="junior"),c>=12&&14>=c&&(t="cadetti a"),c>=10&&11>=c&&(t="cadetti b"),c>35&&(t="senior b"),10>c&&(t="esordienti"),t}function showIscritti(){refreshIscritti(),$("#iscrittiPage #selectiscr").controlgroup(),$("#iscrittiPage #selectiscr").controlgroup("refresh",{shadow:!0}),$("#iscrittiPage input:checkbox").checkboxradio(),$("#iscrittiPage input:checkbox").checkboxradio("refresh"),$("#iscrittiPage input[type='checkbox']").attr("checked",!0).checkboxradio("refresh"),$("#iscrittiPage #selectiscr").trigger("create"),$.mobile.changePage("#iscrittiPage"),$("#iscrittiPage").page()}function getMatchesCountForAtleta(e){colog("getmatchescount for atleta "+e),colog($allmatches);var a=0;return $($allmatches.rows).each(function(t){var o=$allmatches.rows[t].doc.atletaid;o==e&&a++}),a}function refreshIscritti(e){e||(e=!1);var a="",t=jGara.gara.rows[0].doc;conslog("refreshiscritti:",t),t.myiscritti&&(a=t.myiscritti),colog("iscritti: "+a);var o=a.split(","),r=filterIscritti(o),i="",n=[];if($(r).each(function(e){var a=getAtletaById(r[e]),t={};t.nome=a.cognome+" "+a.nome,t.id=a.id,t.sesso=a.sesso,t.categoria=getCategoria(a.datanascita),n.push(t)}),n.sort(function(e,a){var t=e.nome.trim(),o=a.nome.trim();return t>o?1:o>t?-1:0}),1==e)return n;conslog("atls",n);var i=new EJS({url:"tpl/iscritti.ejs"}).render(n),s=$("#iscrittiPage #uliscritti");s.empty(),s.append(i),s.listview(),s.listview("refresh"),$("#iscrittiPage #infogaraiscritti").html(n.length+" iscritti")}function getAtletaById(e,a){var t="";return $($atleti.rows).each(function(a){var o=$atleti.rows[a].doc,r=o.id;o.cognome,o.nome;return r==e?t=o:void 0}),t}function showMatchesForAtleta(e){var a=[],t=getAtletaById(e);selectedAtl=t;var o=jGara.matchesbyprog;$(o.rows).each(function(t){var r=o.rows[t],i=r.doc.atletaid;i==e&&a.push(r)}),a.sort(function(e,a){var t=e.doc.progid,o=a.doc.progid;return t>o?1:o>t?-1:0});var r=new EJS({url:"tpl/matchesforatleta.ejs"}).render(a),i=$("#matchesatleta #listampa");i.empty(),i.append(r),$(document).off("taphold","#matchesatleta ul#listampa li"),$(document).on("taphold","#matchesatleta ul#listampa li",function(e){if("tkdradmin"==role&&loggedin){$(this).addClass("tapped");var a=$(this).attr("id").replace("match_","");delmatchid=a,"disputata"!=jcurrentgara.stato&&$("#popDelMatch").popup("open")}}),$("#matchesatleta #mparecnum").html(a.length+" incontri per "+t.cognome+" "+t.nome)}function sysMsg(e){var a=$.mobile.activePage.attr("id"),t="";if(e&&(t=e),loggedin&&"tkdradmin"==role){var o={destsocket:t},r=new EJS({url:"tpl/sysmsg.ejs"}).render(o);$("#"+a+" div[data-role=content]").append(r),$("#"+a+" #popSysMsg #dest").val(t),$("#"+a+" #popSysMsg").popup(),$("#"+a+" #popSysMsg").popup("open")}}function sysMsgOk(){var e=$.mobile.activePage.attr("id"),a=$("#"+e+" #popSysMsg #tamsg").val(),t=$("#"+e+" #popSysMsg #dest").val();if(""==a.trim())return void $("#gara #popSysMsg").popup("close").remove();var o="all";""!=t.trim()&&(o=t),socketNotify({type:"notification",to:o,text:a}),$("#"+e+" #popSysMsg").popup("close").remove()}function sysMsgCancel(){var e=$.mobile.activePage.attr("id");$("#"+e+" #popSysMsg").popup("close").remove()}function popGareOk(){$("#gare #popGare").popup("close").remove()}function popGareCancel(){$("#gare #popGare").popup("close").remove()}function setResult(e){var a=!1;if(loggedin&&"tkdradmin"==role){var t=jcurrentgara.stato,o=!1;if("disputata"==t&&(o=!0),!o){sdebug("setresult");var r=$(e).closest("li");r.addClass("liselected");var i=r.attr("id").replace("match_","");sdebug("clicked matchid: "+i),selectedid=i,selectedmatchid=r.attr("tkdr-matchid"),$("#popResult #risult").val(""),a?($("#popResult #checkgp").prop("checked",!1).checkboxradio("refresh"),$("#popResult #radio_round1").prop("checked",!0).checkboxradio("refresh")):($("#popResult #checkgp").prop("checked",!1),$("#popResult #radio_round1").prop("checked",!0)),$.mobile.changePage("#popResult",{changeHash:!0}),$(".ui-controlgroup-controls .incbutton").css("width","0.4em"),$("#popResult").css("padding",".4em")}}}function setResultById(e,a){if(loggedin&&"tkdradmin"==role){var t=jcurrentgara.stato,o=filterRows($allmatches,{id:e}),r=!1;if(0==o.rows.length&&(r=!0),"disputata"==t&&(r=!0),!r){colog("setresultbyid "+e),colog(o),sdebug("setting result2 for matchid: "+e),selectedid=e,selectedmatchid=o.rows[0].doc.matchid,$("#popResult #risult").val(a.risultato);var i=!1;a.goldenpoint&&"yes"==a.glodenpoint&&(i=!0),$("#popResult #checkgp").prop("checked",i).checkboxradio("refresh")}}}function setResultCancel(){$("ul#listampa li").removeClass("liselected"),selectedid="",selectedmatchid="",$.mobile.changePage("#matchesatleta")}function setResultOK(){var e=!0;progressStart("Aggiornamento..","Aggiornamento");var a="",t="",o=new Array("primo","secondo","terzo","quarto","quinto","sesto","settimo","ottavo","nono","decimo"),r=new Array("finale","semifinale","quarto di finale","ottavo di finale","sedicesimo di finale","trentaduesimo di finale"),i=$("#popResult #risult").val(),n=$("#popResult #checkgp").prop("checked"),s=selectedid;delMatchFromRealtime(s);var c=selectedAtl.cognome+" "+selectedAtl.nome,l=getCategoria(selectedAtl.datanascita),d=(selectedAtl.cognome+" "+selectedAtl.nome,$("input:radio[name=radio-choice-0]:checked").val()),g="updagent.php?action=edit&tag=match",p="/matches/update/"+jcurrentgara.id+"/"+s,u=$("#matchesatleta ul#listampa li").length,m=$("#matchesatleta ul#listampa li#match_"+s).index(),h=u-m-1,f=h-1,v="",b="",w="",y="none",k="vince";if("nondisputato"==d)v="no",w="yes",b="no",y="none",e=!1;else{"vinto"==d&&(v="yes",k="vince"),"perso"==d&&(v="no",k="perde"),b="yes",w="yes";var C=selectedmatchid,S="";1==u&&(S=" e unico ");var x="";4>h&&(x=", "+r[h]),a+=c+" "+k+" il suo "+o[m]+" "+S+"incontro (n."+C+x+") ",""!=$.trim(i)&&(a+=" per "+i),n&&(a+=" al golden point ");var _="";2>f&&(_=" !!"),f>-1&&"yes"==v&&(a+=" e va in "+r[f]+_+". ")}var P={vinto:v,disputato:b,dadisputare:w};g+="&id="+s,g+="&garaid="+garaid,g+="&vinto="+v,g+="&disputato="+b,g+="&dadisputare="+w,""!=$.trim(i)&&(g+="&risultato="+i,P.risultato=i),sdebug("ln: "+u),sdebug("ord: "+m),parseInt(m,10)==parseInt(u,10)-1&&("yes"==b?("no"==v&&(y="argento"),"yes"==v&&(y="oro")):y="none"),parseInt(m,10)==parseInt(u,10)-2&&("yes"==b?"no"==v&&(y="bronzo"):y="none"),"none"!=y&&(a+=". E' "+y.toUpperCase()+" !"),g+="&medagliamatch="+y,P.medagliamatch=y;var j=0;$("#matchesatleta ul#listampa li").each(function(e){var a=$(this).attr("id").replace("match_",""),o="updagent.php?action=edit&tag=match&garaid="+garaid+"&id="+a,r={};if(m>e&&(sdebug("gara precedente "+e),"yes"==b&&(o+="&disputato=yes&vinto=yes&dadisputare=yes&medagliamatch=none",r.disputato="yes",r.vinto="yes",r.dadisputare="yes",r.medagliamatch="none"),sdebug(o),o="/matches/update/"+jcurrentgara.id+"/"+a,$.ajax({type:"POST",url:rooturl+o,data:r,async:!1})),e>m){if(sdebug("gara successiva "+e),j++,1==j){var i=getDerby(a,l);$(i.rows).each(function(e){colog("derby con "+i.rows[e].doc.atletaname),t=" .Sar√† derby con "+i.rows[e].doc.atletaname+" al "+i.rows[e].doc.matchid+" ! ";var o=i.rows[e].doc.id,r="/matches/update/"+jcurrentgara.id+"/"+o;"yes"==v?($.ajax({type:"POST",url:rooturl+r,data:{derby:a},async:!1}),r="/matches/update/"+jcurrentgara.id+"/"+a,$.ajax({type:"POST",url:rooturl+r,data:{derby:o},async:!1})):(t="",$.ajax({type:"POST",url:rooturl+r,data:{derby:null},async:!1}),r="/matches/update/"+jcurrentgara.id+"/"+a,$.ajax({type:"POST",url:rooturl+r,data:{derby:null},async:!1}))}),j=0}"yes"==b&&("yes"==v&&(o+="&disputato=no&vinto=no&dadisputare=yes&medagliamatch=none",r.disputato="no",r.vinto="no",r.dadisputare="yes",r.medagliamatch="none"),"no"==v&&(o+="&disputato=no&vinto=no&dadisputare=no&medagliamatch=none",r.disputato="no",r.vinto="no",r.dadisputare="no",r.medagliamatch="none")),"no"==b&&(o+="&disputato=no&vinto=no&dadisputare=yes&medagliamatch=none",r.disputato="no",r.vinto="no",r.dadisputare="yes",r.medagliamatch="none"),o="/matches/update/"+jcurrentgara.id+"/"+a,sdebug(o),$.ajax({type:"POST",url:rooturl+o,data:r,async:!1})}}),a+=t;var R="savecronaca.php?garaid="+garaid+"&text="+encodeURI(a);R="/matches/addcronaca/"+jcurrentgara.id,$.post(rooturl+p,P,function(){$.mobile.back();$("ul#listampa li.liselected").find("input:hidden.atletaid").val();$("#matchesatleta ul#listampa li").removeClass("liselected");var t=getCookie("notifiche_atleta");t&&""!=t.trim()&&t.indexOf(selectedAtl.id.trim())>-1,e&&socketNotify({type:"notification",to:"all",text:a,garaid:jcurrentgara.id,updategara:"yes"}),$.ajax({type:"POST",url:rooturl+R,async:!1,data:{text:a}},function(){loadCronaca()}),openGara(jGara.gara.rows[0].doc.id,function(){showMatchesForAtleta(selectedAtl.id),progressStop()})})}function getDerby(e,a){colog("getDerby for matchid "+e+" in category "+a);var t={rows:[]},o={rows:[]};colog("allmatches");var r=jGara.matchesbyprog;colog(r);var i=filterRows(r,{id:e}),n=i.rows[0].doc.matchid,s=i.rows[0].doc.datanascita,c=getCategoria(s),l=filterRows(r,{matchid:n,dadisputare:"yes",disputato:"no"});return colog("incontri con matchid="+n+": "+l.rows.length+" in categoria "+c),$(l.rows).each(function(t){var r=l.rows[t],i=r.doc.id;if(i!=e){var s=getCategoria(r.doc.datanascita),c=!0;s.trim().toLowerCase()!=a.trim().toLowerCase()&&(c=!1,colog("match "+n+" in category "+s+" ignored, searching for category "+a)),c&&o.rows.push(r)}}),$(o.rows).each(function(e){var a=o.rows[e],i=a.doc.atletaname,s=a.doc.atletaid,c=filterRows(r,{atletaid:s});c.rows.sort(function(e,a){var t=e.doc.matchid,o=a.doc.matchid;return t>o?1:o>t?-1:0});var l=0;colog("analisi incontri di "+i),$(c.rows).each(function(e){var a=c.rows[e],o=a.doc.matchid,r=a.doc.disputato,i=a.doc.dadisputare,s=!1;"no"==r&&"yes"==i&&(l++,s=!0),colog("matchid "+o+" - eligible: "+s),o==n&&1==l&&(t.rows.push(a),colog("√® il primo prossimo incontro, DERBY OK"))})}),colog("Derby trovati per match id "+e+": "+t.rows.length),t}function addMatch(){$("#popAddMatch").popup("open")}function addMatchCancel(){$("#popAddMatch").popup("close")}function refreshMatches(e){colog("RefreshMatches");var a=imgtext+"Aggiornamento match...";$("#gara .medals").html(a),mf={maschi:"0",femmine:"0"},loadMatchesByProg(jcurrentgara.id,{callback:function(){progressStop(),e&&e()}}),loadMatchesByAtleta(jcurrentgara.id),loadCronaca(jcurrentgara.id),autorefresh&&setMatchesRefresh()}function addMatchOK(){var e=$("#matchid"),a=Right(e.val(),2),t=selectedAtl.datanascita,o=selectedAtl.cognome+" "+selectedAtl.nome,r=selectedAtl.id,i={progid:a,societaid:settings.mysocieta,societaname:settings.mysocietaname,garaid:jcurrentgara.id,atletaid:r,atletaname:o,risultato:"",ordine:"1",vinto:"no",disputato:"no",dadisputare:"yes",matchid:e.val().toUpperCase().trim(),lastupdate:"never",datanascita:t};$.ajax({url:rooturl+"/matches/add/"+jcurrentgara.id,type:"POST",data:i}).done(function(e){e.error?console.log("error"):(console.log("posted"),$(e.addedmatches.rows).each(function(a){var t=e.addedmatches.rows[a],o=t.doc.id,r=getCategoria(t.doc.datanascita);colog("derbies"),colog("$allmatches");var i=jGara.matchesbyprog;colog(i),i.rows.push(t);var n=getDerby(o,r);if(colog(n),n.rows.length>0&&i.rows.length>0){var s=n.rows[0].doc.id,c="/matches/update/"+jcurrentgara.id+"/"+o;$.ajax({type:"POST",url:rooturl+c,data:{derby:s},async:!1}),c="/matches/update/"+jcurrentgara.id+"/"+s,$.ajax({type:"POST",url:rooturl+c,data:{derby:o},async:!1})}}),toast("Match "+i.matchid+" added for atleta "+selectedAtl.cognome+" "+selectedAtl.nome),openGara(jGara.gara.rows[0].doc.id,function(){$("#popAddMatch").popup("close"),showMatchesForAtleta(selectedAtl.id)}))}).fail(function(){toast("Error posting","long")})}function test(){var e=filterRows($allmatches,{vinto:"yes",datanascita:".2003"}),a=new EJS({url:"tpl/matchesbyprog.ejs"}).render(e.rows),t="listabyprog",o=$("ul#"+t);o.empty(),o.append(a),o.listview(),o.listview("refresh"),$("#limatches").html($matches.rows.length+" incontri"),$("#gara #ulinfogara span").html(getMedaglieGara($matches))}function filterAndRender(e){colog("filterandrender "+JSON.stringify(e));var a=filterRows($allmatches,e),t=new EJS({url:"tpl/matchesbyprog.ejs"}).render(a.rows),o="listabyprog",r=$("ul#"+o);r.empty(),r.append(t),r.listview(),r.listview("refresh");var i=filterRows(a,{dadisputare:"yes"}),n=(filterRows(i,{disputato:"yes"}),filterRows(i,{vinto:"yes"})),s=filterRows(i,{vinto:"no"}),c=i.rows.length+" incontri da disputare";c+="<br>"+i.rows.length+" incontri disputati, "+n.length+" vinti, "+s.length+" persi",$("#limatches").html(c),$("#gara #ulinfogara span").html(getMedaglieGara(a))}function filterRows(e,a,t){t||(t=!1),colog("filterrows: ");var o={rows:[]},r=e.rows;return $(r).each(function(e){var i=r[e],n=!0;for(var s in i.doc)for(var c in a)if(c==s){var l=a[c].toLowerCase();if(""!=l.trim()){var d=i.doc[s].toLowerCase();t?d.trim()==l.trim()||(n=n&&!1):d.indexOf(l)>-1||(n=n&&!1)}}n&&o.rows.push(i)}),o}function searchMatches(){var e=[],a=0,t=0,o=0,r=0,i=0,n=0,s=0,c="M";c=$("#searchMatches #sex").val();var l=$("#searchMatches #categ").val(),d=$("#searchMatches #medag").val(),g="";$("#searchMatches #quadrato").val()&&(g=$("#searchMatches #quadrato").val().trim()),g||(g=""),"_"==g&&(g="");var p=[{name:"sesso",value:c},{name:"categoria",value:l},{name:"medagliamatch",value:d}],u={rows:[]};$($allmatches.rows).each(function(e){var a=$allmatches.rows[e].doc,t=a.atletaid,o=getAtletaById(t),r={};a.sesso=o.sesso,a.categoria=getCategoria(o.datanascita),r=a,u.rows.push(r)}),$(u.rows).each(function(a){var t=u.rows[a],o=!0;$(p).each(function(e){var a=p[e];if(t[a.name]){var r=t[a.name].toLowerCase(),i="";null!=a.value&&(i=a.value.toLowerCase());var n=!0;""==i.trim()&&(n=!1),"_"==i.trim()&&(n=!1),n&&-1==r.indexOf(i)&&(o=!1)}else o=!1});getAtletaById(t.atletaid);if(o)if(""!=g.trim()){var r=t.matchid.trim(),i=r.substring(0,r.length-2).trim();i==g&&e.push(t)}else e.push(t)});var m="";$(e).each(function(c){var l=e[c].disputato,d=e[c].dadisputare,g=e[c].vinto,p="",u="",h="blacknormal";"yes"==d.toLowerCase().trim()?(h="blacknormal","yes"==l.toLowerCase().trim()&&(p="<b>",u="</b>",h="yes"==g.toLowerCase().trim()?"green":"red")):h="black",m+="<li class='"+h+"'><span class='"+h+"'>"+p+e[c].atletaname+" - "+e[c].matchid+u+"</span></li>","yes"==e[c].disputato?("yes"==e[c].vinto?a++:t++,o++,"oro"==e[c].medagliamatch&&i++,"argento"==e[c].medagliamatch&&n++,"bronzo"==e[c].medagliamatch&&s++):r++});var h="";h+="<b>totale incontri trovati: "+e.length+"</b><br>",h+="disputati: "+o+"<br>",h+="vinti: "+a+"<br>",h+="persi: "+t+"<br>",h+="non disputati: "+r+"<br>",h+="ori: "+i+"<br>",h+="argenti: "+n+"<br>",h+="bronzi: "+s+"<br><br><br>",$("#searchMatches #searchResults").empty().html(h),$("#searchMatches #searchlist").empty(),$("#searchMatches #searchlist").append(m),$("#searchMatches #searchlist").listview(),$("#searchMatches #searchlist").listview("refresh")}function addGara(){conslog("addgara"),$.mobile.changePage("#page_addgara")}function addSocieta(){conslog("addsocieta"),$.mobile.changePage("#page_addsocieta")}function addAtleta(){conslog("addatleta"),$("#page_addatleta").find("#societaid").val(settings.mysocieta),getSocietaById(settings.mysocieta,function(e){e.rows.length>0&&$("#page_addatleta").find("#societa").html("Societ√†: <b>"+e.rows[0].doc.nome.toUpperCase()+"</b>"),$.mobile.changePage("#page_addatleta")})}function addAtletaOk(e){var a=$(e).closest("div[data-role=page]"),t={},o=checkValidAtletaForm(a);return 1==o.error?void alert("Errore di inserimento:\n\n"+o.errors):(a.find(".jform").each(function(){var e=$(this).attr("id");t[e]=$(this).val()}),void $.ajax({url:rooturl+"/atleti/add",type:"POST",data:t}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_atleti"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")}))}function addSocietaOk(e){var a=$(e).closest("div[data-role=page]"),t={};a.find(".jform").each(function(){var e=$(this).attr("id");t[e]=$(this).val()}),$.ajax({url:rooturl+"/societa/add",type:"POST",data:t}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_societa"),refreshSocietaServer())}).fail(function(){toast("Error posting","long")})}function addGaraOk(e){var a=$(e).closest("div[data-role=page]"),t=checkValidGaraForm(a);if(1==t.error)return void alert("Errore di inserimento:\n\n"+t.errors);var o={};a.find(".jform").each(function(){var e=$(this).attr("id");o[e]=$(this).val()}),$.ajax({url:rooturl+"/gare/add",type:"POST",data:o}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#gare"),refreshGareServer())}).fail(function(){toast("Error posting","long")})}function editAtleta(e){console.log("editatleta");var a=$(e).closest("div[data-role=page]"),t=a.find("#atletaid"),o=t.val();colog("Editing atletaid "+o);var r=getAtletaById(o);$("#page_editatleta").find(".jform").each(function(){var e=$(this).attr("id");colog("campo "+e+" - "+r[e]),$(this).val(r[e])}),$("#page_editatleta").find("#atletaid").val(o),$("#page_editatleta").find("#societaid").val(settings.mysocieta),getSocietaById(settings.mysocieta,function(e){e.rows.length>0&&$("#page_editatleta").find("#societa").html("Societ√†: "+e.rows[0].doc.nome.toUpperCase()),$.mobile.changePage("#page_editatleta")})}function checkValidGaraForm(e){var a="",t=!1,o="",r="location,title,data,stato",i=r.split(",");$(i).each(function(o){var r=e.find("#"+i[o]).val();""==r.trim()&&(t=!0,a+="- il campo "+i[o]+" non pu√≤ essere vuoto\n")}),o=e.find("#data").val();var i=o.split("/");3!=i.length&&(t=!0,a+="- la data deve essere nel formato gg/mm/aaaa\n"),o=e.find("#stato").val();var n="nondisputata,disputata,incorso",s=!1,c=n.split(",");$(c).each(function(e){c[e]==o&&(s=!0)}),s||(t=!0,a+="- stato invalido, stati validi sono nondisputata,disputata,incorso\n");var l={error:t,errors:a};return l}function checkValidAtletaForm(e){var a="",t=!1,o="";o=e.find("#nome").val(),""==o.trim()&&(t=!0,a+="- il nome non pu√≤ essere vuoto\n"),o=e.find("#cognome").val(),""==o.trim()&&(t=!0,a+="- il cognome non pu√≤ essere vuoto\n"),o=e.find("#datanascita").val();var r=o.split(".");3!=r.length&&(t=!0,a+="- la data di nascita deve essere nel formato gg.mm.aaaa\n");var i={error:t,errors:a};return i}function editAtletaOk(e){var a=$(e).closest("div[data-role=page]"),t=a.find("#atletaid").val(),o={},r=checkValidAtletaForm(a);return 1==r.error?void alert("Errore di inserimento:\n\n"+r.errors):(a.find(".jform").each(function(){var e=$(this).attr("id");o[e]=$(this).val()}),void $.ajax({url:rooturl+"/atleti/update/"+t,type:"POST",data:o}).done(function(e){e.error?console.log("error"):(console.log("posted"),$.mobile.changePage("#page_atleti"),refreshAtletiServer())}).fail(function(){toast("Error posting","long")}))}function getAllAtleti(e){$.ajax({type:"GET",url:rooturl+"/atleti/findall/",success:function(a){e(a)}})}function addIscritto(){var e=[];jcurrentgara.iscritti;progressStart(),getAllAtleti(function(a){$(a.rows).each(function(t){var o=a.rows[t];o.doc.id.trim();e.push(o)}),e.sort(function(e,a){var t=e.doc.cognome.trim(),o=a.doc.cognome.trim();return t>o?1:o>t?-1:0}),progressStop();var t=new EJS({url:"tpl/selectiscritti.ejs"}).render(e);$("#selectIscrittiPage #selectiscr").empty().append(t),$.mobile.changePage("#selectIscrittiPage")})}function addIscrittiOk(){var e="";$("#selectIscrittiPage :checkbox:checked").each(function(a){var t=$(this).val();""!=e.trim()&&(e+=","),e+=t}),jcurrentgara.iscritti=e;var a={};a.id=jcurrentgara.id,a.iscritti=e,$.ajax({url:rooturl+"/gare/update",type:"POST",data:a}).done(function(e){e.error?toast("error"):(console.log("posted"),refreshCurrentGara(function(){showIscritti()}))}).fail(function(){toast("Error posting update","long")})}function saveOptions(){rooturl=$("#optionsPage #server").val();var e=$("#optionsPage #ckNotifiche").prop("checked"),a=$("#optionsPage #societaid").val(),t=$("#optionsPage #societaid option:selected").text(),o={server:rooturl,notifiche:e,mysocieta:a,mysocietaname:t};setCookie("options",JSON.stringify(o)),settings=o,$(".serverspan").html("Server: "+rooturl),refreshAtletiServer(),refreshGareServer(),refreshNews(function(e){}),$.mobile.changePage("#index"),updateHomeInfos()}function setServer(e){$("#optionsPage #server").val(e)}function getSocieta(e){$.ajax({type:"GET",url:rooturl+"/societa/findall/",success:function(a){e(a)}})}function getSocietaById(e,a){$.ajax({type:"GET",url:rooturl+"/societa/findbyid/"+e,success:function(e){a(e)}})}function loadOptions(e){var a={server:rooturl,notifiche:!0,mysocieta:"20160217220400",mysocietaname:"ASD TAEKWONDO ROZZANO"};settings=a,getSocieta(function(t){var o=new EJS({url:"tpl/selectsocieta.ejs"}).render(t.rows);$("#optionsPage #societaid").empty().append(o);var r=getCookie("options");if(null==r)setCookie("options",JSON.stringify(a)),settings=a,$("#optionsPage #server").val(settings.server),$("#optionsPage #ckNotifiche").prop("checked",settings.notifiche),$("#optionsPage #societaid").val(settings.mysocieta);else{var i=JSON.parse(r);i.server||(i.server=a.server),i.notifiche||(i.notifiche=a.notifiche),i.mysocieta||(i.mysocieta=a.mysocieta),i.mysocietaname||(i.mysocietaname=a.mysocietaname),$("#optionsPage #server").val(i.server),$("#optionsPage #ckNotifiche").prop("checked",i.notifiche),$("#optionsPage #societaid").val(i.mysocieta),settings=i}e()})}function delMatch(){var e=delmatchid;gConfirm("Sei sicuro di voler cancellare l'incontro ?","Conferma",function(){colog("deleting matchid "+e);var a="updagent.php?action=delete&tag=match",t=jGara.matchesbyprog;$(t.rows).each(function(a){var o=t.rows[a].doc.id,r=t.rows[a].doc;if(o.trim()==e.trim()&&r.derby&&""!=r.derby.trim()){var i=r.derby,n="/matches/update/"+jcurrentgara.id+"/"+i;$.ajax({type:"POST",url:rooturl+n,data:{derby:null},async:!1}),colog("resetted derby flag on matchid "+i)}}),a+="&id="+e,a+="&garaid="+garaid,a="/matches/delete/"+jcurrentgara.id+"/"+e,$.post(rooturl+a,{a:"1"},function(){delmatchid="",openGara(jcurrentgara.id,function(){$("#matchesatleta #popDelMatch").popup("close"),showMatchesForAtleta(selectedAtl.id)})})},function(){cancelDelMatch()})}function cancelDelMatch(){$("#matchesatleta #popDelMatch").popup("close")}function getCookie(e){var a;if(colog("isPhone: "+isPhone),isPhone){var t=window.localStorage;colog("storage: "+t),a=t.getItem(e)}else{a=document.cookie;var o=a.indexOf(" "+e+"=");if(-1==o&&(o=a.indexOf(e+"=")),-1==o)a=null;else{o=a.indexOf("=",o)+1;var r=a.indexOf(";",o);-1==r&&(r=a.length),a=unescape(a.substring(o,r))}}return a}function setCookie(e,a,t){if(isPhone){var o=window.localStorage;o.setItem(e,a)}else{var r=new Date;r.setDate(r.getDate()+t);var i=escape(a)+(null==t?"":"; expires="+r.toUTCString());document.cookie=e+"="+i}}function autoLogin(){var e=getCookie("email"),a=getCookie("psw"),t=getCookie("autologin");colog("autologin cookie: "+t),t&&"true"==t&&(e&&a?($("#login #txt-email").val(e),$("#login #txt-password").val(a),doLogin()):toast("Login automatico fallito"))}function showLoginPage(){var e=getCookie("email"),a=getCookie("psw"),t=getCookie("autologin");e&&a?($("#login #txt-email").val(e),$("#login #txt-password").val(a)):($("#login #txt-email").val(""),$("#login #txt-password").val("")),t?$("#login #chck-autologin").attr("data-cacheval","false"):$("#login #chck-autologin").attr("data-cacheval","true"),$.mobile.changePage("#login")}function gotoSocieta(){$.mobile.changePage("#page_societa"),refreshSocietaServer()}function doLogout(){gConfirm("Sei sicuro di volerti scollegare ?","Log out",function(){loggedin=!1,$("#index #lilogin").show(),$("#index #liatleti").hide(),$("#index #lisockets").hide(),$("#gare #liaggiungigara").hide(),$("#gara #liresetcronaca").hide(),$("#gara #lisysmsg").hide(),$("#page_atleti #liaggiungiatleta").hide(),$("#matchesatleta #actionpanela").hide(),$("#iscrittiPage #btnAddIscritto").hide(),$("#gare #test").hide(),$("#index .loginspan").html(""),$(".showadmin").hide(),$.mobile.changePage("#index_fb")},function(){})}function showNotifications(){var e=jcurrentgara.iscritti;colog("iscritti: "+e);var a=e.split(",");""==e.trim()&&(a=[]);var t=[];$(a).each(function(e){var o=getAtletaById(a[e]),r={};r.nome=o.cognome+" "+o.nome,r.id=o.id,t.push(r)}),t.sort(function(e,a){var t=e.nome.trim(),o=a.nome.trim();return t>o?1:o>t?-1:0}),html=new EJS({url:"tpl/selectnotifiche.ejs"}).render(t),$("#page_notifiche #ulatleti").empty().append(html),$.mobile.changePage("#page_notifiche")}function setNotificheOk(){var e="";$("#page_notifiche :checkbox:checked").each(function(a){var t=$(this).val();colog(t),""!=e.trim()&&(e+=","),e+=t}),setCookie("notifiche_atleta",e),$.mobile.changePage("#gara")}function notify(e){if(isPhone){notcount++,notcount>3&&(notcount=1);cordova.plugins.notification.local.schedule({id:1,text:e,title:"AppKwonDo",icon:"file://img/logotkdrozzano_icon.png"})}else console.log("Notification: "+e)}function pushSuccessHandler(e){var a="Push Callback Success! Result = "+e;console.log(a)}function pushErrorHandler(e){console.log("pushError: "+e)}function onNotificationGCM(e){switch(console.log("onNotificationGCM"),e.event){case"registered":e.regid.length>0&&(console.log("Regid "+e.regid),toast("Registered on GCM"),cordova.plugins.notification.local.on("click",function(e){toast("clicked notification"),$("#dialogNotifiche #content").empty.html(e.text),$.mobile.changePage("#dialogNotifiche",{role:"dialog"})}));break;case"message":notify(e.message);break;case"error":console.log("GCM error "+e.msg);break;default:console.log("An unknown GCM event has occurred")}}function sendGCM(e){console.log("sendGCM: "+e);var a={};a.message=e,a.title="AppKwonDo",a.msgcnt="3",a.soundname="beep.wav",$.ajax({url:rooturl+"/matches/notify",type:"POST",data:a}).done(function(e){e.error?(colog("error posting notification"),toast("error")):colog("posted GCM notification")}).fail(function(){toast("Error posting GCM push","long")})}function deleteCronacaReadForGara(e){conslog("deleteCronacaRead for gara "+e),conslog("parto con cronaca_read: "+cronaca_read.length),conslog(cronaca_read);for(var a=0;a<cronaca_read.length;a++){var t=cronaca_read[a];conslog("row: ",t);var o=t.split("_"),r=o[0],i=o[1];r==e&&(conslog("elimino "+i),cronaca_read.splice(a,1))}conslog("cronaca_read restante: "+cronaca_read.length),conslog(cronaca_read)}function resetCronaca(){var e=jcurrentgara.id;gConfirm("Vuoi veramente resettare la cronaca per questa gara ?","conferma",function(){socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,event:"resetcronaca"}),deleteCronacaReadForGara(e),$.ajax({type:"GET",url:rooturl+"/gare/resetcronaca/"+e,success:function(e){toast("Cronaca resettata"),socketNotify({type:"realtime",to:"all",garaid:jcurrentgara.id,event:"refreshcronaca"}),refreshCurrentGara()}})},function(){})}function socketNotify(e){sendSocketMessage(e)}function sendSocketMessage(e){var a={to:"all",text:"sample message",type:"notification"};e&&(a=e),socket.send(a),colog("socket message sent to socket.io server")}function getGaraById(e){var a=null;sdebug("getGaraById "+e);var a={};return $($gare.rows).each(function(t){var o=$gare.rows[t],r=o.doc.id;$.trim(r)==$.trim(e)&&(sdebug("trovata gara"),a=o)}),a}function mapOpened(){console.log("mapOpened")}function garaMaps(e){var a=jcurrentgara,t="";a.maplocation&&(t=a.maplocation);var o=new EJS({url:"tpl/garamap.ejs"}).render(t);$("#garamaps #content").html(o),$.mobile.changePage("#garamaps")}function deleteGara(e){var a=e;gConfirm("Confermi l'eliminazione della gara ?","Conferma eliminazione",function(){var t={};t.id=e,t.rev=a,$.ajax({url:rooturl+"/gare/delete",type:"POST",data:t}).done(function(e){e.error?console.log("error"):(console.log("posted"),refreshGareServer())}).fail(function(){toast("Error posting","long")})},function(){}),popGareCancel()}function showSocketsPage(){showSockets(function(){$.mobile.changePage("#page_sockets")})}function showSockets(e){var a={};$("#page_sockets #pconn").html("Aggiornamento..."),$.ajax({url:rooturl+"/socketusers",type:"GET",data:a}).done(function(a){var t=new EJS({url:"tpl/sockets.ejs"}).render(a);$("#page_sockets #content").html(t),$("#page_sockets #ulsockets").listview(),$("#page_sockets #pconn").html(a.length+" utenti connessi ad AppKwonDo"),e&&e()})}function clickSocket(e){var a=$.mobile.activePage.attr("id"),t={destsocket:e},o=new EJS({url:"tpl/sysmsg.ejs"}).render(t);return $("#"+a+" div[data-role=content]").append(o),$("#"+a+" #popSysMsg #dest").val(e),$("#"+a+" #popSysMsg").popup(),void $("#"+a+" #popSysMsg").popup("open")}function fb_login(){facebookcheck?openFB.login(function(e){"connected"===e.status?(colog("Facebook login succeeded, got access token: "+e.authResponse.token),$("#index_fb #errormsg").html(""),fb_getInfo(function(){fbCheckGroup("116270558490682",fb_user,function(e){var a="holly ozoora",t=a.toLowerCase().split(",");if($(t).each(function(a){var o=t[a].trim();fb_user.name.toLowerCase().indexOf(o)>-1&&(e=!0)}),e){colog("bravo, fai parte del gruppo facebook asd taekwondorozzano"),$("#index_fb #errormsg").html(""),fbloggedin=!0,refreshNews(),$.mobile.changePage("#index"),autoLogin();var o={device:"browser",type:"clientspecs",nickname:socketnickname};isPhone&&(o.device="mobile"),socket.send(o)}else{var r="Non fai attualmente parte del gruppo Facebook ASD Taekwondo Rozzano.";$("#index_fb #errormsg").html(r)}})})):(colog("Login Facebook fallito: "+e.error),$("#index_fb #errormsg").html("Accesso a Facebook fallito"))},{scope:"email,publish_actions,user_managed_groups"}):(fbloggedin=!0,refreshNews(),$.mobile.changePage("#index"))}function fb_getInfo(e){openFB.api({path:"/me",success:function(a){colog(JSON.stringify(a)),fb_userid=a.id,fb_user.id=a.id,fb_user.name=a.name,socketnickname=fb_user.name,colog("fb_userid: "+fb_userid),colog("fb_name: "+a.name),colog("socketnickname: "+socketnickname),$("#index #fbuser #userName").html(a.name),$("#index #fbuser #userPic").attr("src","http://graph.facebook.com/"+a.id+"/picture?type=small"),$("#index #fbuser").show(),e&&e()},error:fb_errorHandler})}function fb_share(){openFB.api({method:"POST",path:"/me/feed",params:{message:document.getElementById("Message").value||"Testing Facebook APIs"},success:function(){alert("the item was posted on Facebook")},error:fb_errorHandler})}function fb_revoke(){openFB.revokePermissions(function(){alert("Permissions revoked")},fb_errorHandler)}function fb_logout(e){openFB.logout(function(){colog("Logout successful"),fbloggedin=!1,e&&e()},fb_errorHandler)}function fb_errorHandler(e){alert(e.message)}function fb_checkgroup(){fbCheckGroup("116270558490682",fb_user,function(e){e&&alert("bravo, fai parte del gruppo");
})}function getQueryString(e){for(var a=window.location.search.substring(1),t=a.split("&"),o=0;o<t.length;o++){var r=t[o].split("=");if(r[0]==e)return r[1]}}function Right(e,a){if(0>=a)return"";if(a>String(e).length)return e;var t=String(e).length;return String(e).substring(t,t-a)}function addCronaca(){$.mobile.changePage("#page_editcronaca")}function addCronacaOk(){var e="/matches/addcronaca/"+jcurrentgara.id,a=$("#page_editcronaca #testo").val();progressStart(),$.ajax({type:"POST",url:rooturl+e,async:!0,data:{text:a},success:function(){progressStop();var e=!1,t=$("#page_editcronaca input:checkbox[name=ckNotifica]");e=t.is(":checked"),e&&socketNotify({type:"notification",to:"all",text:a,garaid:jcurrentgara.id,updategara:"yes"}),loadCronaca(jcurrentgara.id,function(){$.mobile.changePage("#gara")})},error:function(){progressStop(),alert("errore")}})}function delCronaca(e){confirm("Sicuro di voler cancellare questa riga di cronaca da questa gara ?","Conferma")&&$.ajax({type:"POST",url:rooturl+"/matches/delcronaca/"+jcurrentgara.id+"/"+e,success:function(e){toast("Cronaca aggiornata"),loadCronaca(jcurrentgara.id)}})}function updateRankingTkdr(){var e=$("#page_ranking #selanno").val(),a="";""!=e.trim()&&(a=" per l'anno "+e);var t="Calcolo ranking TKDR "+a+" in corso....";$("#page_ranking #ranking").html(t),progressStart(t),$.ajax({type:"GET",url:rooturl+"/atleti/ranking/",async:!0,success:function(e){var a=new EJS({url:"tpl/ranking.ejs"}).render(e.rows);$("#page_ranking #ranking").html(a),progressStop()}})}function updateRankingTkdr_old(){var e,a,t=$("#page_ranking #selanno").val(),o="";""!=t.trim()&&(o=" per l'anno "+t);var r="Calcolo ranking TKDR "+o+" in corso....";$("#page_ranking #ranking").html(r),progressStart(r),$.ajax({type:"GET",url:rooturl+"/atleti/findall?societaid="+settings.mysocieta,async:!0,success:function(o){e=o,$.ajax({type:"GET",async:!0,url:rooturl+"/gare/findall?societa="+settings.mysocieta,success:function(o){a=o,$(a.rows).each(function(e){var t=a.rows[e].doc,o=t.id;$.ajax({type:"GET",async:!1,url:rooturl+"/matches/findbygaraid/"+o+"?societa="+settings.mysocieta,success:function(t){a.rows[e].doc.matches=t}})}),$(e.rows).each(function(o){var r=e.rows[o].doc,i=r.datanascita,n=(getCategoria(i,!0),!0);n&&(e.rows[o].doc.ranking_tkdr=0,e.rows[o].doc.ori=0,e.rows[o].doc.argenti=0,e.rows[o].doc.bronzi=0,e.rows[o].doc.garedisputate=0,colog("calcolo ranking per "+r.cognome+" "+r.nome),$(a.rows).each(function(i){var n=a.rows[i].doc,s=(n.id,n.data),c=!1;if(""==t?c=!0:s.indexOf("/"+t)>-1&&(c=!0),c){var l=a.rows[i].doc.matches,d=!1;$(l.rows).each(function(a){var t=l.rows[a].doc,i=t.atletaid;if(i==r.id&&(d=!0,t.medagliamatch)){var n=t.medagliamatch.toLowerCase();"oro"==n&&(e.rows[o].doc.ranking_tkdr+=7,e.rows[o].doc.ori++),"argento"==n&&(e.rows[o].doc.ranking_tkdr+=3,e.rows[o].doc.argenti++),"bronzo"==n&&(e.rows[o].doc.ranking_tkdr+=1,e.rows[o].doc.bronzi++)}}),1==d&&e.rows[o].doc.garedisputate++}}))}),e.rows.sort(function(e,a){var t=e.doc.ranking_tkdr,o=a.doc.ranking_tkdr;return t>o?-1:o>t?1:0});var r=new EJS({url:"tpl/ranking.ejs"}).render(e.rows);$("#page_ranking #ranking").html(r),progressStop()}})}})}var pictureSource,destinationType,scheda={},loggedin=!1,role="tkdruser",fbloggedin=!1,facebookcheck=!0,debugActive=!1,defaultimage="img/logotkdrozzano.jpg",tapevent="tap",cronaca_unread=[],cronaca_read=[],fotodata="",sounddata="",currentround="1",currentresult="0-0",currentammon=0,realtime={round:"1",result:"0-0",ammoniz:0,running:!1,active:!1,fineround:!1},rtmatches=[],rooturl="http://tkdr.herokuapp.com",caricamentotext="<img style='position: relative; top: 4px;' src='images/ajax-loader2.gif' />&nbsp;&nbsp;&nbsp;Caricamento...",imgtext="<img style='position: relative; top: 4px;' src='images/ajax-loader2.gif' />&nbsp;&nbsp;&nbsp;",settings=null,garaFilters={categoria:"",sesso:"",medaglia:"",quadrato:""},isFiltered=!1,socketnickname="",socket,isPhone=!1,boname="scheda",bonames="Schede",parm_garaid="",cattxt="Categoria: ",showMsg=null,garaid="",jGara={},$gara={},$gare={},jcurrentgara={},activeTab=0,jmatchesbyatleta=[],jmatchesbyprog=[],$atleti={},$allatleti={},delmatchid="",prevSelection="tab1",$matches,$allmatches={},cat="",selectedAtl={},selectedid="",cookieDays=3,storage,cronaca={rows:[]},autorefresh=!1,timerMatches=2e4,mf={},iscrittiincat=[],viewcat="",fb_userid="",fb_user={};$(window).resize(function(){resizeImage("#viewimage #img1")});var autorefreshcount=0,tkdt_iscritti={rows:[]},app={initialize:function(){colog("app.initialize"),this.bind()},onCameraSuccess:function(e){toast("Photo acquired","long");var a,t,o;for(a=0,o=e.length;o>a;a+=1)t=e[a].fullPath,$("#fotoAnteprima").attr("src",t).css({width:"128px",height:"128px"})},onCameraError:function(e){toast("Error acquiring photo: "+e,"long")},onMenuButton:function(){return console.log("menubutton pressed"),void toggleLeftMenu()},onBackButton:function(){var e=$.mobile.activePage.attr("id");$("#"+e+" #btnBack").trigger("click")},online:function(){$("#btnInviaSchede").removeClass("ui-disabled")},offline:function(){$("#btnInviaSchede").addClass("ui-disabled")},isOnline:function(){var e=navigator.connection.type;return toast(e,"short"),e!=Connection.NONE&&e!=Connection.UNKNOWN},bind:function(){colog("app.bind"),document.addEventListener("deviceready",this.deviceready,!1)},deviceready:function(){colog("deviceready !"),document.addEventListener("online",app.online,!1),document.addEventListener("offline",app.offline,!1),document.addEventListener("menubutton",app.onMenuButton,!1),document.addEventListener("backbutton",app.onBackButton,!1),storage=window.localStorage,pictureSource=navigator.camera.PictureSourceType,destinationType=navigator.camera.DestinationType,colog("Navigator user agent from deviceready: "+navigator.userAgent),-1!=navigator.userAgent.indexOf("Android")&&($.mobile.defaultPageTransition="none",$.mobile.defaultDialogTransition="none",$.mobile.buttonMarkup.hoverDelay=0),isPhone=navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)?!0:!1,docready(),app.start()},start:function(){},exit:function(){navigator.notification.confirm("Vuoi veramente chiudere AppKwonDo ?",function(e){1==e&&navigator.app.exitApp()},"Informazione","S√¨,No")},storage:window.localStorage,initialize:function(){this.bind()},loadAllSchede:function(e){$.ajax({url:rooturl+"/atleti/findall?societaid="+settings.mysocieta,type:"GET"}).done(function(a){$atleti=a,e(a)})},loadAllGare:function(e){$.ajax({url:rooturl+"/gare/findall?societa="+settings.mysocieta,type:"GET"}).done(function(a){e(a)})}};$(document).ready(function(){initApp()});var recorder=new Object,recording=!1,errorHandler=function(e,a){var t="";switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:t="Storage quota exceeded";break;case FileError.NOT_FOUND_ERR:t="File not found";break;case FileError.SECURITY_ERR:t="Security error";break;case FileError.INVALID_MODIFICATION_ERR:t="Invalid modification";break;case FileError.INVALID_STATE_ERR:t="Invalid state";break;default:t="Unknown error"}console.log("Error ("+e+"): "+t)},printEventType=function(e){console.log("got event: "+e.type)},scheda={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","S√¨,No")},save:function(e,a,t){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var o="addScheda";scheda.data._id&&(o="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+o,type:"POST",data:scheda.data}).done(function(e){e.error?t():(app.storage.clear(),colog("save result: "+JSON.stringify(e)),a())}).fail(function(){myToast({body:"Error posting"})})}},onPositionSuccess:function(e){scheda.data.coordinate=e.coords,myToast({body:JSON.stringify(scheda.data)}),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(e){var a="";switch(e.code){case PositionError.PERMISSION_DENIED:a="L'applicazione non √® autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:a="Non √® disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:a="Non √® stato possibile rilevare la posizione corrente"}myToast({body:a})},load:function(e){if(""!=e){var a=app.storage.getItem($.trim(e));scheda.data=JSON.parse(a)}},loadById:function(e,a){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/schede/findById/"+e,type:"GET"}).done(function(t){colog("loadbyid "+e+": "+JSON.stringify(t)),scheda.data=t,a(scheda)})},remove:function(e,a){debugga(e+" "+a),""!=e&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:e,rev:a}}).done(function(e){app.storage.clear(),refreshSchedeServer()}).fail(function(){myToast({body:"Error posting"})})},send:function(e,a,t){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:e}).done(function(e){app.storage.clear(),a()}).fail(t)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},gara={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","S√¨,No")},save:function(e,a,t){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var o="addScheda";scheda.data._id&&(o="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+o,type:"POST",data:scheda.data}).done(function(e){e.error?t():(app.storage.clear(),colog("save result: "+JSON.stringify(e)),a())}).fail(function(){myToast({body:"Error posting"})})}},onPositionSuccess:function(e){scheda.data.coordinate=e.coords,myToast({body:JSON.stringify(scheda.data)}),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(e){var a="";switch(e.code){case PositionError.PERMISSION_DENIED:a="L'applicazione non √® autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:a="Non √® disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:a="Non √® stato possibile rilevare la posizione corrente"}myToast({body:a})},load:function(e){if(""!=e){var a=app.storage.getItem($.trim(e));scheda.data=JSON.parse(a)}},loadById:function(e,a){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/gare/findById/"+e+"?societa="+settings.mysocieta,type:"GET"}).done(function(t){$gara=t.rows[0],jcurrentgara=$gara.doc,colog("jcurrentgara: "+JSON.stringify(jcurrentgara));colog("loadbyid "+e+": "+JSON.stringify(t)),scheda.data=t,a(scheda)})},remove:function(e,a){debugga(e+" "+a),""!=e&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:e,rev:a}}).done(function(e){app.storage.clear(),refreshSchedeServer()}).fail(function(){myToast({body:"Error posting"})})},send:function(e,a,t){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:e}).done(function(e){app.storage.clear(),a()}).fail(t)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},atleta={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","S√¨,No")},save:function(e,a,t){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var o="addScheda";scheda.data._id&&(o="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+o,type:"POST",data:scheda.data}).done(function(e){e.error?t():(app.storage.clear(),colog("save result: "+JSON.stringify(e)),a())}).fail(function(){myToast({body:"Error posting"})})}},onPositionSuccess:function(e){scheda.data.coordinate=e.coords,myToast({body:JSON.stringify(scheda.data)}),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(e){var a="";switch(e.code){case PositionError.PERMISSION_DENIED:a="L'applicazione non √® autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:a="Non √® disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:a="Non √® stato possibile rilevare la posizione corrente"}myToast({body:a})},load:function(e){if(""!=e){var a=app.storage.getItem($.trim(e));scheda.data=JSON.parse(a)}},loadById:function(e,a){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/atleti/findById/"+e,type:"GET"}).done(function(t){colog("loadbyid "+e+": "+JSON.stringify(t)),scheda.data=t,a(scheda)})},remove:function(e,a){debugga(e+" "+a),""!=e&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:e,rev:a}}).done(function(e){app.storage.clear(),refreshSchedeServer()}).fail(function(){myToast({body:"Error posting"})})},send:function(e,a,t){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:e}).done(function(e){app.storage.clear(),a()}).fail(t)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},mf={maschi:"0",femmine:"0"},deleteCookie=function(e){if(isPhone){var a=window.localStorage;a.removeItem(e)}else document.cookie=e+"=;expires=Thu, 01 Jan 1970 00:00:01 GMT;"},notcount=0,fbCheckGroup=function(e,a,t){var o=a.id;openFB.api({path:"/"+e+"/members",params:{limit:400},success:function(e){colog(JSON.stringify(e)),colog(e.data.length+" users nel gruppo");for(var a=!1,r=0;r<e.data.length;r++){var i=e.data[r],n=i.id;n==o&&(a=!0)}t&&t(a)},error:fb_errorHandler})};